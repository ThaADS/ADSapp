{"version":3,"names":["GET","cov_15phlzsbql","f","s","POST","uploadRateLimit","_apiutils","rateLimit","windowMs","max","keyGenerator","request","b","headers","get","user","requireAuthenticatedUser","profile","getUserOrganization","id","formData","file","generateThumbnail","category","_server","NextResponse","json","error","status","allowedTypes","includes","type","maxSize","size","buffer","Buffer","from","arrayBuffer","mediaStorage","_storage","MediaStorageService","mediaFile","uploadFile","name","organizationId","organization_id","uploadedBy","createSuccessResponse","console","createErrorResponse","searchParams","URL","url","limit","Math","min","parseInt","offset","mimeType","undefined","result","listFiles","files","total","pagination","hasMore"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\media\\upload\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { requireAuthenticatedUser, getUserOrganization, createErrorResponse, createSuccessResponse, rateLimit } from '@/lib/api-utils'\nimport { MediaStorageService } from '@/lib/media/storage'\n\n// Rate limit media uploads\nconst uploadRateLimit = rateLimit({\n  windowMs: 60 * 1000, // 1 minute\n  max: 20, // 20 uploads per minute\n  keyGenerator: (request) => request.headers.get('x-user-id') || 'anonymous'\n})\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Apply rate limiting\n    await uploadRateLimit(request)\n\n    // Authenticate user\n    const user = await requireAuthenticatedUser()\n    const profile = await getUserOrganization(user.id)\n\n    // Parse form data\n    const formData = await request.formData()\n    const file = formData.get('file') as File\n    const generateThumbnail = formData.get('generateThumbnail') === 'true'\n    const category = formData.get('category') as string || 'general'\n\n    if (!file) {\n      return NextResponse.json(\n        { error: 'No file provided' },\n        { status: 400 }\n      )\n    }\n\n    // Validate file\n    const allowedTypes = [\n      'image/jpeg', 'image/png', 'image/gif', 'image/webp',\n      'video/mp4', 'video/quicktime', 'video/webm',\n      'audio/mpeg', 'audio/wav', 'audio/ogg',\n      'application/pdf', 'text/plain',\n      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'\n    ]\n\n    if (!allowedTypes.includes(file.type)) {\n      return NextResponse.json(\n        { error: `File type ${file.type} is not allowed` },\n        { status: 400 }\n      )\n    }\n\n    const maxSize = 16 * 1024 * 1024 // 16MB\n    if (file.size > maxSize) {\n      return NextResponse.json(\n        { error: `File size exceeds maximum allowed size of ${maxSize} bytes` },\n        { status: 400 }\n      )\n    }\n\n    // Convert file to buffer\n    const buffer = Buffer.from(await file.arrayBuffer())\n\n    // Upload file\n    const mediaStorage = new MediaStorageService()\n    const mediaFile = await mediaStorage.uploadFile(\n      buffer,\n      file.name,\n      file.type,\n      {\n        organizationId: profile.organization_id,\n        uploadedBy: user.id,\n        generateThumbnail,\n        maxSize,\n        allowedTypes\n      }\n    )\n\n    return createSuccessResponse({\n      file: mediaFile,\n      category\n    }, 201)\n\n  } catch (error) {\n    console.error('Media upload error:', error)\n    return createErrorResponse(error)\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Authenticate user\n    const user = await requireAuthenticatedUser()\n    const profile = await getUserOrganization(user.id)\n\n    const { searchParams } = new URL(request.url)\n    const limit = Math.min(50, Math.max(1, parseInt(searchParams.get('limit') || '20')))\n    const offset = Math.max(0, parseInt(searchParams.get('offset') || '0'))\n    const mimeType = searchParams.get('mimeType') || undefined\n    const uploadedBy = searchParams.get('uploadedBy') || undefined\n\n    const mediaStorage = new MediaStorageService()\n    const result = await mediaStorage.listFiles(profile.organization_id, {\n      limit,\n      offset,\n      mimeType,\n      uploadedBy\n    })\n\n    return createSuccessResponse({\n      files: result.files,\n      total: result.total,\n      pagination: {\n        limit,\n        offset,\n        hasMore: offset + limit < result.total\n      }\n    })\n\n  } catch (error) {\n    console.error('Media list error:', error)\n    return createErrorResponse(error)\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MAuFsBA,IAAA;IAAA;IAAAC,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;WAAAH,GAAA;;MA5EAI,KAAA;IAAA;IAAAH,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;WAAAC,IAAA;;;;;kCAXoB;;;kCAC2E;;;kCACjF;AAEpC;AACA,MAAMC,eAAA;AAAA;AAAA,CAAAJ,cAAA,GAAAE,CAAA,OAAkB,IAAAG,SAAA,CAAAC,SAAS,EAAC;EAChCC,QAAA,EAAU,KAAK;EACfC,GAAA,EAAK;EACLC,YAAA,EAAeC,OAAA,IAAY;IAAA;IAAAV,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;IAAA,kCAAAF,cAAA,GAAAW,CAAA,UAAAD,OAAA,CAAQE,OAAO,CAACC,GAAG,CAAC;IAAA;IAAA,CAAAb,cAAA,GAAAW,CAAA,UAAgB;EAAA;AACjE;AAEO,eAAeR,KAAKO,OAAoB;EAAA;EAAAV,cAAA,GAAAC,CAAA;EAAAD,cAAA,GAAAE,CAAA;EAC7C,IAAI;IAAA;IAAAF,cAAA,GAAAE,CAAA;IACF;IACA,MAAME,eAAA,CAAgBM,OAAA;IAEtB;IACA,MAAMI,IAAA;IAAA;IAAA,CAAAd,cAAA,GAAAE,CAAA,QAAO,MAAM,IAAAG,SAAA,CAAAU,wBAAwB;IAC3C,MAAMC,OAAA;IAAA;IAAA,CAAAhB,cAAA,GAAAE,CAAA,QAAU,MAAM,IAAAG,SAAA,CAAAY,mBAAmB,EAACH,IAAA,CAAKI,EAAE;IAEjD;IACA,MAAMC,QAAA;IAAA;IAAA,CAAAnB,cAAA,GAAAE,CAAA,QAAW,MAAMQ,OAAA,CAAQS,QAAQ;IACvC,MAAMC,IAAA;IAAA;IAAA,CAAApB,cAAA,GAAAE,CAAA,QAAOiB,QAAA,CAASN,GAAG,CAAC;IAC1B,MAAMQ,iBAAA;IAAA;IAAA,CAAArB,cAAA,GAAAE,CAAA,QAAoBiB,QAAA,CAASN,GAAG,CAAC,yBAAyB;IAChE,MAAMS,QAAA;IAAA;IAAA,CAAAtB,cAAA,GAAAE,CAAA;IAAW;IAAA,CAAAF,cAAA,GAAAW,CAAA,UAAAQ,QAAA,CAASN,GAAG,CAAC;IAAA;IAAA,CAAAb,cAAA,GAAAW,CAAA,UAAyB;IAAA;IAAAX,cAAA,GAAAE,CAAA;IAEvD,IAAI,CAACkB,IAAA,EAAM;MAAA;MAAApB,cAAA,GAAAW,CAAA;MAAAX,cAAA,GAAAE,CAAA;MACT,OAAOqB,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;QAAEC,KAAA,EAAO;MAAmB,GAC5B;QAAEC,MAAA,EAAQ;MAAI;IAElB;IAAA;IAAA;MAAA3B,cAAA,GAAAW,CAAA;IAAA;IAEA;IACA,MAAMiB,YAAA;IAAA;IAAA,CAAA5B,cAAA,GAAAE,CAAA,QAAe,CACnB,cAAc,aAAa,aAAa,cACxC,aAAa,mBAAmB,cAChC,cAAc,aAAa,aAC3B,mBAAmB,cACnB,2EACA,oEACD;IAAA;IAAAF,cAAA,GAAAE,CAAA;IAED,IAAI,CAAC0B,YAAA,CAAaC,QAAQ,CAACT,IAAA,CAAKU,IAAI,GAAG;MAAA;MAAA9B,cAAA,GAAAW,CAAA;MAAAX,cAAA,GAAAE,CAAA;MACrC,OAAOqB,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;QAAEC,KAAA,EAAO,aAAaN,IAAA,CAAKU,IAAI;MAAkB,GACjD;QAAEH,MAAA,EAAQ;MAAI;IAElB;IAAA;IAAA;MAAA3B,cAAA,GAAAW,CAAA;IAAA;IAEA,MAAMoB,OAAA;IAAA;IAAA,CAAA/B,cAAA,GAAAE,CAAA,QAAU,KAAK,OAAO,MAAK;IAAA;;;IACjC,IAAIkB,IAAA,CAAKY,IAAI,GAAGD,OAAA,EAAS;MAAA;MAAA/B,cAAA,GAAAW,CAAA;MAAAX,cAAA,GAAAE,CAAA;MACvB,OAAOqB,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;QAAEC,KAAA,EAAO,6CAA6CK,OAAA;MAAgB,GACtE;QAAEJ,MAAA,EAAQ;MAAI;IAElB;IAAA;IAAA;MAAA3B,cAAA,GAAAW,CAAA;IAAA;IAEA;IACA,MAAMsB,MAAA;IAAA;IAAA,CAAAjC,cAAA,GAAAE,CAAA,QAASgC,MAAA,CAAOC,IAAI,CAAC,MAAMf,IAAA,CAAKgB,WAAW;IAEjD;IACA,MAAMC,YAAA;IAAA;IAAA,CAAArC,cAAA,GAAAE,CAAA,QAAe,IAAIoC,QAAA,CAAAC,mBAAmB;IAC5C,MAAMC,SAAA;IAAA;IAAA,CAAAxC,cAAA,GAAAE,CAAA,QAAY,MAAMmC,YAAA,CAAaI,UAAU,CAC7CR,MAAA,EACAb,IAAA,CAAKsB,IAAI,EACTtB,IAAA,CAAKU,IAAI,EACT;MACEa,cAAA,EAAgB3B,OAAA,CAAQ4B,eAAe;MACvCC,UAAA,EAAY/B,IAAA,CAAKI,EAAE;MACnBG,iBAAA;MACAU,OAAA;MACAH;IACF;IAAA;IAAA5B,cAAA,GAAAE,CAAA;IAGF,OAAO,IAAAG,SAAA,CAAAyC,qBAAqB,EAAC;MAC3B1B,IAAA,EAAMoB,SAAA;MACNlB;IACF,GAAG;EAEL,EAAE,OAAOI,KAAA,EAAO;IAAA;IAAA1B,cAAA,GAAAE,CAAA;IACd6C,OAAA,CAAQrB,KAAK,CAAC,uBAAuBA,KAAA;IAAA;IAAA1B,cAAA,GAAAE,CAAA;IACrC,OAAO,IAAAG,SAAA,CAAA2C,mBAAmB,EAACtB,KAAA;EAC7B;AACF;AAEO,eAAe3B,IAAIW,OAAoB;EAAA;EAAAV,cAAA,GAAAC,CAAA;EAAAD,cAAA,GAAAE,CAAA;EAC5C,IAAI;IACF;IACA,MAAMY,IAAA;IAAA;IAAA,CAAAd,cAAA,GAAAE,CAAA,QAAO,MAAM,IAAAG,SAAA,CAAAU,wBAAwB;IAC3C,MAAMC,OAAA;IAAA;IAAA,CAAAhB,cAAA,GAAAE,CAAA,QAAU,MAAM,IAAAG,SAAA,CAAAY,mBAAmB,EAACH,IAAA,CAAKI,EAAE;IAEjD,MAAM;MAAE+B;IAAY,CAAE;IAAA;IAAA,CAAAjD,cAAA,GAAAE,CAAA,QAAG,IAAIgD,GAAA,CAAIxC,OAAA,CAAQyC,GAAG;IAC5C,MAAMC,KAAA;IAAA;IAAA,CAAApD,cAAA,GAAAE,CAAA,QAAQmD,IAAA,CAAKC,GAAG,CAAC,IAAID,IAAA,CAAK7C,GAAG,CAAC,GAAG+C,QAAA;IAAS;IAAA,CAAAvD,cAAA,GAAAW,CAAA,UAAAsC,YAAA,CAAapC,GAAG,CAAC;IAAA;IAAA,CAAAb,cAAA,GAAAW,CAAA,UAAY;IAC7E,MAAM6C,MAAA;IAAA;IAAA,CAAAxD,cAAA,GAAAE,CAAA,QAASmD,IAAA,CAAK7C,GAAG,CAAC,GAAG+C,QAAA;IAAS;IAAA,CAAAvD,cAAA,GAAAW,CAAA,UAAAsC,YAAA,CAAapC,GAAG,CAAC;IAAA;IAAA,CAAAb,cAAA,GAAAW,CAAA,UAAa;IAClE,MAAM8C,QAAA;IAAA;IAAA,CAAAzD,cAAA,GAAAE,CAAA;IAAW;IAAA,CAAAF,cAAA,GAAAW,CAAA,UAAAsC,YAAA,CAAapC,GAAG,CAAC;IAAA;IAAA,CAAAb,cAAA,GAAAW,CAAA,UAAe+C,SAAA;IACjD,MAAMb,UAAA;IAAA;IAAA,CAAA7C,cAAA,GAAAE,CAAA;IAAa;IAAA,CAAAF,cAAA,GAAAW,CAAA,UAAAsC,YAAA,CAAapC,GAAG,CAAC;IAAA;IAAA,CAAAb,cAAA,GAAAW,CAAA,UAAiB+C,SAAA;IAErD,MAAMrB,YAAA;IAAA;IAAA,CAAArC,cAAA,GAAAE,CAAA,QAAe,IAAIoC,QAAA,CAAAC,mBAAmB;IAC5C,MAAMoB,MAAA;IAAA;IAAA,CAAA3D,cAAA,GAAAE,CAAA,QAAS,MAAMmC,YAAA,CAAauB,SAAS,CAAC5C,OAAA,CAAQ4B,eAAe,EAAE;MACnEQ,KAAA;MACAI,MAAA;MACAC,QAAA;MACAZ;IACF;IAAA;IAAA7C,cAAA,GAAAE,CAAA;IAEA,OAAO,IAAAG,SAAA,CAAAyC,qBAAqB,EAAC;MAC3Be,KAAA,EAAOF,MAAA,CAAOE,KAAK;MACnBC,KAAA,EAAOH,MAAA,CAAOG,KAAK;MACnBC,UAAA,EAAY;QACVX,KAAA;QACAI,MAAA;QACAQ,OAAA,EAASR,MAAA,GAASJ,KAAA,GAAQO,MAAA,CAAOG;MACnC;IACF;EAEF,EAAE,OAAOpC,KAAA,EAAO;IAAA;IAAA1B,cAAA,GAAAE,CAAA;IACd6C,OAAA,CAAQrB,KAAK,CAAC,qBAAqBA,KAAA;IAAA;IAAA1B,cAAA,GAAAE,CAAA;IACnC,OAAO,IAAAG,SAAA,CAAA2C,mBAAmB,EAACtB,KAAA;EAC7B;AACF","ignoreList":[]}