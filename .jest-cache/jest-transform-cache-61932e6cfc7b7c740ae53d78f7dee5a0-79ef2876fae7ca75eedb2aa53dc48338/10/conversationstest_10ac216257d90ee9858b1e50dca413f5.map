{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\integration\\api\\conversations.test.ts"],"sourcesContent":["/**\n * Conversations API Integration Tests\n *\n * Tests for conversation management including listing, filtering,\n * message handling, status updates, and multi-tenant isolation.\n */\n\nimport { describe, it, expect, beforeEach, jest } from '@jest/globals'\nimport { NextRequest } from 'next/server'\nimport {\n  createAuthenticatedRequest,\n  parseResponse,\n  expectErrorResponse,\n  expectPaginatedResponse,\n} from '../../utils/api-test-helpers'\nimport {\n  createMockUser,\n  createMockConversation,\n  createMockMessage,\n  createMockSupabaseClient,\n  generateMockConversations,\n  generateMockMessages,\n} from '../../utils/test-helpers'\n\njest.mock('@/lib/supabase/server')\n\ndescribe('GET /api/conversations', () => {\n  let mockSupabase: any\n  let mockUser: any\n  let mockConversations: any[]\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    mockUser = createMockUser()\n    mockConversations = generateMockConversations(20, { organization_id: mockUser.organization_id })\n    jest.clearAllMocks()\n  })\n\n  it('should list conversations with pagination', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      order: jest.fn().mockReturnThis(),\n      range: jest.fn().mockResolvedValue({\n        data: mockConversations.slice(0, 10),\n        error: null,\n        count: 20,\n      }),\n    })\n\n    const request = createAuthenticatedRequest('GET', '/api/conversations?page=1&limit=10', mockUser.id, mockUser.organization_id)\n    const response = await simulateGetConversations(request, mockSupabase, mockUser)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expectPaginatedResponse(data)\n    expect(data.conversations).toHaveLength(10)\n  })\n\n  it('should filter conversations by status', async () => {\n    const openConversations = mockConversations.filter(c => c.status === 'open')\n\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      order: jest.fn().mockReturnThis(),\n      range: jest.fn().mockResolvedValue({\n        data: openConversations,\n        error: null,\n        count: openConversations.length,\n      }),\n    })\n\n    const request = createAuthenticatedRequest('GET', '/api/conversations?status=open', mockUser.id, mockUser.organization_id)\n    const response = await simulateGetConversations(request, mockSupabase, mockUser)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.filters.status).toBe('open')\n  })\n\n  it('should enforce tenant isolation', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockImplementation((field, value) => {\n        if (field === 'organization_id') {\n          expect(value).toBe(mockUser.organization_id)\n        }\n        return { order: jest.fn().mockReturnThis(), range: jest.fn().mockResolvedValue({ data: mockConversations, error: null, count: mockConversations.length }) }\n      }),\n    })\n\n    const request = createAuthenticatedRequest('GET', '/api/conversations', mockUser.id, mockUser.organization_id)\n    const response = await simulateGetConversations(request, mockSupabase, mockUser)\n    const { status } = await parseResponse(response)\n\n    expect(status).toBe(200)\n  })\n})\n\ndescribe('GET /api/conversations/[id]', () => {\n  let mockSupabase: any\n  let mockUser: any\n  let mockConversation: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    mockUser = createMockUser()\n    mockConversation = createMockConversation({ organization_id: mockUser.organization_id })\n    jest.clearAllMocks()\n  })\n\n  it('should get single conversation', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({ data: mockConversation, error: null }),\n    })\n\n    const request = createAuthenticatedRequest('GET', `/api/conversations/${mockConversation.id}`, mockUser.id, mockUser.organization_id)\n    const response = await simulateGetConversation(request, mockSupabase, mockUser, mockConversation.id)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.id).toBe(mockConversation.id)\n  })\n\n  it('should return 404 for non-existent conversation', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({ data: null, error: { code: 'PGRST116' } }),\n    })\n\n    const request = createAuthenticatedRequest('GET', '/api/conversations/non-existent-id', mockUser.id, mockUser.organization_id)\n    const response = await simulateGetConversation(request, mockSupabase, mockUser, 'non-existent-id')\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(404)\n    expectErrorResponse(data, 404, 'not found')\n  })\n})\n\ndescribe('GET /api/conversations/[id]/messages', () => {\n  let mockSupabase: any\n  let mockUser: any\n  let mockConversation: any\n  let mockMessages: any[]\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    mockUser = createMockUser()\n    mockConversation = createMockConversation({ organization_id: mockUser.organization_id })\n    mockMessages = generateMockMessages(30, { conversation_id: mockConversation.id })\n    jest.clearAllMocks()\n  })\n\n  it('should list conversation messages with pagination', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      order: jest.fn().mockReturnThis(),\n      range: jest.fn().mockResolvedValue({\n        data: mockMessages.slice(0, 20),\n        error: null,\n        count: 30,\n      }),\n    })\n\n    const request = createAuthenticatedRequest('GET', `/api/conversations/${mockConversation.id}/messages`, mockUser.id, mockUser.organization_id)\n    const response = await simulateGetMessages(request, mockSupabase, mockUser, mockConversation.id)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expectPaginatedResponse(data)\n    expect(data.messages).toHaveLength(20)\n  })\n})\n\ndescribe('POST /api/conversations/[id]/messages', () => {\n  let mockSupabase: any\n  let mockUser: any\n  let mockConversation: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    mockUser = createMockUser()\n    mockConversation = createMockConversation({ organization_id: mockUser.organization_id })\n    jest.clearAllMocks()\n  })\n\n  it('should send message in conversation', async () => {\n    const messageData = { content: 'Test message', message_type: 'text' }\n\n    mockSupabase.from = jest.fn().mockImplementation((table) => {\n      if (table === 'conversations') {\n        return {\n          select: jest.fn().mockReturnThis(),\n          eq: jest.fn().mockReturnThis(),\n          single: jest.fn().mockResolvedValue({ data: mockConversation, error: null }),\n        }\n      }\n      return {\n        insert: jest.fn().mockReturnThis(),\n        select: jest.fn().mockReturnThis(),\n        single: jest.fn().mockResolvedValue({\n          data: { ...messageData, id: 'new-message-id', conversation_id: mockConversation.id },\n          error: null,\n        }),\n      }\n    })\n\n    const request = createAuthenticatedRequest('POST', `/api/conversations/${mockConversation.id}/messages`, mockUser.id, mockUser.organization_id, messageData)\n    const response = await simulateSendMessage(request, mockSupabase, mockUser, mockConversation.id)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(201)\n    expect(data.content).toBe(messageData.content)\n  })\n\n  it('should validate message content', async () => {\n    const request = createAuthenticatedRequest('POST', `/api/conversations/${mockConversation.id}/messages`, mockUser.id, mockUser.organization_id, {})\n    const response = await simulateSendMessage(request, mockSupabase, mockUser, mockConversation.id)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(400)\n    expectErrorResponse(data, 400, 'Content is required')\n  })\n})\n\ndescribe('PUT /api/conversations/[id]', () => {\n  let mockSupabase: any\n  let mockUser: any\n  let mockConversation: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    mockUser = createMockUser()\n    mockConversation = createMockConversation({ organization_id: mockUser.organization_id })\n    jest.clearAllMocks()\n  })\n\n  it('should update conversation status', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({ data: mockConversation, error: null }),\n      update: jest.fn().mockReturnThis(),\n    })\n\n    const request = createAuthenticatedRequest('PUT', `/api/conversations/${mockConversation.id}`, mockUser.id, mockUser.organization_id, { status: 'closed' })\n    const response = await simulateUpdateConversation(request, mockSupabase, mockUser, mockConversation.id)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.status).toBe('closed')\n  })\n\n  it('should assign agent to conversation', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({ data: mockConversation, error: null }),\n      update: jest.fn().mockReturnThis(),\n    })\n\n    const agentId = 'agent-user-id'\n    const request = createAuthenticatedRequest('PUT', `/api/conversations/${mockConversation.id}`, mockUser.id, mockUser.organization_id, { assigned_to: agentId })\n    const response = await simulateUpdateConversation(request, mockSupabase, mockUser, mockConversation.id)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.assigned_to).toBe(agentId)\n  })\n})\n\ndescribe('DELETE /api/conversations/[id]', () => {\n  let mockSupabase: any\n  let mockUser: any\n  let mockConversation: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    mockUser = createMockUser()\n    mockConversation = createMockConversation({ organization_id: mockUser.organization_id })\n    jest.clearAllMocks()\n  })\n\n  it('should soft delete conversation', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({ data: mockConversation, error: null }),\n      update: jest.fn().mockReturnThis(),\n    })\n\n    const request = createAuthenticatedRequest('DELETE', `/api/conversations/${mockConversation.id}`, mockUser.id, mockUser.organization_id)\n    const response = await simulateDeleteConversation(request, mockSupabase, mockUser, mockConversation.id)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.message).toContain('deleted')\n  })\n\n  it('should prevent deleting conversation from different organization', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({ data: null, error: { code: 'PGRST116' } }),\n    })\n\n    const request = createAuthenticatedRequest('DELETE', '/api/conversations/other-org-conv', mockUser.id, mockUser.organization_id)\n    const response = await simulateDeleteConversation(request, mockSupabase, mockUser, 'other-org-conv')\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(404)\n    expectErrorResponse(data, 404, 'not found')\n  })\n})\n\n// Simplified simulator functions\nasync function simulateGetConversations(request: NextRequest, supabase: any, user: any): Promise<any> {\n  const { searchParams } = new URL(request.url)\n  const page = parseInt(searchParams.get('page') || '1')\n  const limit = parseInt(searchParams.get('limit') || '20')\n  const status = searchParams.get('status')\n  const offset = (page - 1) * limit\n\n  let query = supabase.from('conversations').select('*', { count: 'exact' }).eq('organization_id', user.organization_id)\n  if (status) query = query.eq('status', status)\n  const { data: conversations, count } = await query.order('last_message_at', { ascending: false }).range(offset, offset + limit - 1)\n\n  return new Response(JSON.stringify({ conversations, pagination: { page, limit, total: count }, filters: { status } }), {\n    status: 200,\n    headers: { 'Content-Type': 'application/json' },\n  })\n}\n\nasync function simulateGetConversation(request: NextRequest, supabase: any, user: any, conversationId: string): Promise<any> {\n  const { data, error } = await supabase.from('conversations').select('*').eq('id', conversationId).eq('organization_id', user.organization_id).single()\n  if (error || !data) return new Response(JSON.stringify({ error: 'Conversation not found' }), { status: 404, headers: { 'Content-Type': 'application/json' } })\n  return new Response(JSON.stringify(data), { status: 200, headers: { 'Content-Type': 'application/json' } })\n}\n\nasync function simulateGetMessages(request: NextRequest, supabase: any, user: any, conversationId: string): Promise<any> {\n  const { searchParams } = new URL(request.url)\n  const page = parseInt(searchParams.get('page') || '1')\n  const limit = parseInt(searchParams.get('limit') || '20')\n  const offset = (page - 1) * limit\n\n  const { data: messages, count } = await supabase.from('messages').select('*', { count: 'exact' }).eq('conversation_id', conversationId).order('created_at', { ascending: false }).range(offset, offset + limit - 1)\n\n  return new Response(JSON.stringify({ messages, pagination: { page, limit, total: count } }), { status: 200, headers: { 'Content-Type': 'application/json' } })\n}\n\nasync function simulateSendMessage(request: NextRequest, supabase: any, user: any, conversationId: string): Promise<any> {\n  const body = await request.json()\n  if (!body.content) return new Response(JSON.stringify({ error: 'Content is required' }), { status: 400, headers: { 'Content-Type': 'application/json' } })\n\n  const { data: conversation } = await supabase.from('conversations').select('*').eq('id', conversationId).eq('organization_id', user.organization_id).single()\n  if (!conversation) return new Response(JSON.stringify({ error: 'Conversation not found' }), { status: 404, headers: { 'Content-Type': 'application/json' } })\n\n  const { data: message } = await supabase.from('messages').insert({ conversation_id: conversationId, ...body }).select().single()\n  return new Response(JSON.stringify(message), { status: 201, headers: { 'Content-Type': 'application/json' } })\n}\n\nasync function simulateUpdateConversation(request: NextRequest, supabase: any, user: any, conversationId: string): Promise<any> {\n  const body = await request.json()\n  const { data: conversation } = await supabase.from('conversations').select('*').eq('id', conversationId).eq('organization_id', user.organization_id).single()\n  if (!conversation) return new Response(JSON.stringify({ error: 'Conversation not found' }), { status: 404, headers: { 'Content-Type': 'application/json' } })\n\n  const { data: updated } = await supabase.from('conversations').update(body).eq('id', conversationId).select().single()\n  return new Response(JSON.stringify(updated), { status: 200, headers: { 'Content-Type': 'application/json' } })\n}\n\nasync function simulateDeleteConversation(request: NextRequest, supabase: any, user: any, conversationId: string): Promise<any> {\n  const { data: conversation } = await supabase.from('conversations').select('*').eq('id', conversationId).eq('organization_id', user.organization_id).single()\n  if (!conversation) return new Response(JSON.stringify({ error: 'Conversation not found' }), { status: 404, headers: { 'Content-Type': 'application/json' } })\n\n  await supabase.from('conversations').update({ deleted_at: new Date().toISOString() }).eq('id', conversationId)\n  return new Response(JSON.stringify({ message: 'Conversation deleted successfully' }), { status: 200, headers: { 'Content-Type': 'application/json' } })\n}\n"],"names":["jest","mock","describe","mockSupabase","mockUser","mockConversations","beforeEach","createMockSupabaseClient","createMockUser","generateMockConversations","organization_id","clearAllMocks","it","from","fn","mockReturnValue","select","mockReturnThis","eq","order","range","mockResolvedValue","data","slice","error","count","request","createAuthenticatedRequest","id","response","simulateGetConversations","status","parseResponse","expect","toBe","expectPaginatedResponse","conversations","toHaveLength","openConversations","filter","c","length","filters","mockImplementation","field","value","mockConversation","createMockConversation","single","simulateGetConversation","code","expectErrorResponse","mockMessages","generateMockMessages","conversation_id","simulateGetMessages","messages","messageData","content","message_type","table","insert","simulateSendMessage","update","simulateUpdateConversation","agentId","assigned_to","simulateDeleteConversation","message","toContain","supabase","user","searchParams","URL","url","page","parseInt","get","limit","offset","query","ascending","Response","JSON","stringify","pagination","total","headers","conversationId","body","json","conversation","updated","deleted_at","Date","toISOString"],"mappings":"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"}