{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\security\\secure-rpc.ts"],"sourcesContent":["/**\n * Secure RPC Wrapper for SQL Injection Prevention\n *\n * Provides a secure wrapper around Supabase RPC function calls with automatic\n * input validation, parameter sanitization, and SQL injection prevention.\n *\n * Security Features:\n * - Automatic parameter validation and sanitization\n * - Function name whitelist enforcement\n * - SQL injection detection and blocking\n * - Audit logging of all RPC calls\n * - Rate limiting support\n * - Type-safe parameter passing\n *\n * Usage:\n * ```typescript\n * import { secureRpc } from '@/lib/security/secure-rpc';\n *\n * const result = await secureRpc(supabase, 'get_user_conversations', {\n *   user_id: userId,\n *   limit: 10\n * });\n * ```\n *\n * @module secure-rpc\n */\n\nimport type { SupabaseClient } from '@supabase/supabase-js';\nimport {\n  InputValidator,\n  ValidationResult,\n  ValidationErrorCodes,\n  type ValidationSchema,\n} from './input-validation';\n\n// ============================================================================\n// TYPE DEFINITIONS\n// ============================================================================\n\nexport interface SecureRpcOptions {\n  skipValidation?: boolean;  // Bypass validation (use with extreme caution)\n  skipAuditLog?: boolean;  // Skip audit logging\n  timeout?: number;  // Timeout in milliseconds\n  retries?: number;  // Number of retry attempts\n  customValidators?: Record<string, (value: any) => ValidationResult>;\n}\n\nexport interface SecureRpcResult<T = any> {\n  data: T | null;\n  error: Error | null;\n  validationErrors?: Record<string, string>;\n  executionTime?: number;\n}\n\nexport interface RpcFunctionConfig {\n  name: string;\n  description: string;\n  parameterSchema: ValidationSchema;\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n  requiresAuth: boolean;\n  rateLimitPerMinute?: number;\n}\n\n// ============================================================================\n// WHITELISTED RPC FUNCTIONS\n// ============================================================================\n\n/**\n * Whitelist of allowed RPC functions with their validation schemas\n * This prevents calling arbitrary functions and ensures proper validation\n */\nexport const WHITELISTED_RPC_FUNCTIONS: Record<string, RpcFunctionConfig> = {\n  // ========================================\n  // REPORTING & ANALYTICS FUNCTIONS\n  // ========================================\n  get_revenue_analytics: {\n    name: 'get_revenue_analytics',\n    description: 'Get comprehensive revenue analytics for a period',\n    parameterSchema: {\n      start_date: {\n        validator: InputValidator.validateDate,\n        required: true,\n      },\n      end_date: {\n        validator: InputValidator.validateDate,\n        required: true,\n      },\n      granularity: {\n        validator: (value) => InputValidator.validateEnum(value, ['day', 'week', 'month']),\n        required: false,\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 60,\n  },\n\n  get_user_engagement_metrics: {\n    name: 'get_user_engagement_metrics',\n    description: 'Get user engagement metrics for analytics',\n    parameterSchema: {\n      start_date: {\n        validator: InputValidator.validateDate,\n        required: true,\n      },\n      end_date: {\n        validator: InputValidator.validateDate,\n        required: true,\n      },\n      organization_id: {\n        validator: InputValidator.validateUUID,\n        required: false,\n        options: { allowNull: true },\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 60,\n  },\n\n  get_system_performance_metrics: {\n    name: 'get_system_performance_metrics',\n    description: 'Get system performance monitoring metrics',\n    parameterSchema: {\n      start_date: {\n        validator: InputValidator.validateDate,\n        required: true,\n      },\n      end_date: {\n        validator: InputValidator.validateDate,\n        required: true,\n      },\n      interval_type: {\n        validator: (value) => InputValidator.validateEnum(value, ['minute', 'hour', 'day']),\n        required: false,\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 60,\n  },\n\n  predict_churn_rate: {\n    name: 'predict_churn_rate',\n    description: 'Predict churn rate for future periods',\n    parameterSchema: {\n      periods_ahead: {\n        validator: InputValidator.validateInteger,\n        required: true,\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 30,\n  },\n\n  predict_new_customers: {\n    name: 'predict_new_customers',\n    description: 'Predict new customer acquisition',\n    parameterSchema: {\n      periods_ahead: {\n        validator: InputValidator.validateInteger,\n        required: true,\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 30,\n  },\n\n  // ========================================\n  // SUPER ADMIN FUNCTIONS\n  // ========================================\n  log_super_admin_action: {\n    name: 'log_super_admin_action',\n    description: 'Log super admin actions for audit trail',\n    parameterSchema: {\n      admin_user_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n      action_name: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 100 }),\n        required: true,\n      },\n      target_type: {\n        validator: (value) =>\n          InputValidator.validateEnum(value, ['organization', 'profile', 'system', 'billing']),\n        required: true,\n      },\n      target_id: {\n        validator: InputValidator.validateUUID,\n        required: false,\n        options: { allowNull: true },\n      },\n      action_details: {\n        validator: InputValidator.validateJSON,\n        required: false,\n      },\n      ip_addr: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 45, allowNull: true }),\n        required: false,\n      },\n      user_agent: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 500, allowNull: true }),\n        required: false,\n      },\n    },\n    riskLevel: 'high',\n    requiresAuth: true,\n    rateLimitPerMinute: 100,\n  },\n\n  get_organization_metrics_summary: {\n    name: 'get_organization_metrics_summary',\n    description: 'Get organization metrics summary for super admin',\n    parameterSchema: {\n      org_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n      days: {\n        validator: InputValidator.validateInteger,\n        required: false,\n      },\n    },\n    riskLevel: 'medium',\n    requiresAuth: true,\n    rateLimitPerMinute: 60,\n  },\n\n  suspend_organization: {\n    name: 'suspend_organization',\n    description: 'Suspend an organization (super admin only)',\n    parameterSchema: {\n      org_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n      reason: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 500 }),\n        required: true,\n      },\n      suspended_by_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n    },\n    riskLevel: 'critical',\n    requiresAuth: true,\n    rateLimitPerMinute: 10,\n  },\n\n  reactivate_organization: {\n    name: 'reactivate_organization',\n    description: 'Reactivate a suspended organization',\n    parameterSchema: {\n      org_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n      reactivated_by_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n    },\n    riskLevel: 'critical',\n    requiresAuth: true,\n    rateLimitPerMinute: 10,\n  },\n\n  // ========================================\n  // TENANT & USAGE FUNCTIONS\n  // ========================================\n  track_usage_event: {\n    name: 'track_usage_event',\n    description: 'Track usage events for billing and analytics',\n    parameterSchema: {\n      org_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n      event_type_param: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 50 }),\n        required: true,\n      },\n      event_category_param: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 30 }),\n        required: true,\n      },\n      resource_amount_param: {\n        validator: InputValidator.validateInteger,\n        required: false,\n      },\n      bytes_consumed_param: {\n        validator: InputValidator.validateInteger,\n        required: false,\n      },\n      additional_metadata: {\n        validator: InputValidator.validateJSON,\n        required: false,\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 120,\n  },\n\n  check_usage_limits: {\n    name: 'check_usage_limits',\n    description: 'Check if organization is within usage limits',\n    parameterSchema: {\n      org_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n      limit_type_param: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 50 }),\n        required: true,\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 120,\n  },\n\n  get_tenant_by_domain: {\n    name: 'get_tenant_by_domain',\n    description: 'Get tenant organization by domain name',\n    parameterSchema: {\n      domain_name: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 255 }),\n        required: true,\n      },\n    },\n    riskLevel: 'medium',\n    requiresAuth: false,\n    rateLimitPerMinute: 60,\n  },\n\n  // ========================================\n  // CONVERSATION & MESSAGE FUNCTIONS\n  // ========================================\n  get_conversation_unread_count: {\n    name: 'get_conversation_unread_count',\n    description: 'Get unread message count for a conversation',\n    parameterSchema: {\n      conv_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 120,\n  },\n\n  // ========================================\n  // MEDIA & STORAGE FUNCTIONS\n  // ========================================\n  update_media_storage_usage: {\n    name: 'update_media_storage_usage',\n    description: 'Update media storage quota usage',\n    parameterSchema: {\n      org_id: {\n        validator: InputValidator.validateUUID,\n        required: true,\n      },\n      quota_type: {\n        validator: (value) => InputValidator.validateText(value, { maxLength: 50 }),\n        required: true,\n      },\n      usage_delta: {\n        validator: InputValidator.validateInteger,\n        required: true,\n      },\n    },\n    riskLevel: 'medium',\n    requiresAuth: true,\n    rateLimitPerMinute: 60,\n  },\n\n  // ========================================\n  // HELPER FUNCTIONS\n  // ========================================\n  is_super_admin: {\n    name: 'is_super_admin',\n    description: 'Check if user is a super admin',\n    parameterSchema: {\n      user_id: {\n        validator: InputValidator.validateUUID,\n        required: false,\n        options: { allowNull: true },\n      },\n    },\n    riskLevel: 'low',\n    requiresAuth: true,\n    rateLimitPerMinute: 120,\n  },\n};\n\n// ============================================================================\n// RATE LIMITING\n// ============================================================================\n\ninterface RateLimitEntry {\n  count: number;\n  resetTime: number;\n}\n\nconst rateLimitStore: Map<string, RateLimitEntry> = new Map();\n\nfunction checkRateLimit(functionName: string, userId: string | null): boolean {\n  const config = WHITELISTED_RPC_FUNCTIONS[functionName];\n  if (!config || !config.rateLimitPerMinute) {\n    return true; // No rate limit configured\n  }\n\n  const key = `${functionName}:${userId || 'anonymous'}`;\n  const now = Date.now();\n  const entry = rateLimitStore.get(key);\n\n  if (!entry || entry.resetTime < now) {\n    // Reset or create new entry\n    rateLimitStore.set(key, {\n      count: 1,\n      resetTime: now + 60000, // 1 minute from now\n    });\n    return true;\n  }\n\n  if (entry.count >= config.rateLimitPerMinute) {\n    return false; // Rate limit exceeded\n  }\n\n  entry.count++;\n  return true;\n}\n\n// ============================================================================\n// AUDIT LOGGING\n// ============================================================================\n\ninterface AuditLogEntry {\n  timestamp: string;\n  functionName: string;\n  userId: string | null;\n  parameters: Record<string, any>;\n  success: boolean;\n  error?: string;\n  executionTime?: number;\n  riskLevel: string;\n}\n\nconst auditLog: AuditLogEntry[] = [];\n\nasync function logRpcCall(\n  functionName: string,\n  userId: string | null,\n  parameters: Record<string, any>,\n  success: boolean,\n  error?: string,\n  executionTime?: number\n): Promise<void> {\n  const config = WHITELISTED_RPC_FUNCTIONS[functionName];\n\n  const entry: AuditLogEntry = {\n    timestamp: new Date().toISOString(),\n    functionName,\n    userId,\n    parameters: sanitizeParametersForLogging(parameters),\n    success,\n    error,\n    executionTime,\n    riskLevel: config?.riskLevel || 'unknown',\n  };\n\n  auditLog.push(entry);\n\n  // Keep only last 1000 entries in memory\n  if (auditLog.length > 1000) {\n    auditLog.shift();\n  }\n\n  // For critical operations, log to database or external service\n  if (config?.riskLevel === 'critical' || !success) {\n    // TODO: Implement database logging for critical operations\n    console.warn('[SECURE RPC AUDIT]', entry);\n  }\n}\n\nfunction sanitizeParametersForLogging(params: Record<string, any>): Record<string, any> {\n  const sanitized: Record<string, any> = {};\n\n  for (const [key, value] of Object.entries(params)) {\n    // Redact sensitive fields\n    if (\n      key.toLowerCase().includes('password') ||\n      key.toLowerCase().includes('secret') ||\n      key.toLowerCase().includes('token')\n    ) {\n      sanitized[key] = '[REDACTED]';\n    } else if (typeof value === 'string' && value.length > 100) {\n      sanitized[key] = value.substring(0, 100) + '...[TRUNCATED]';\n    } else {\n      sanitized[key] = value;\n    }\n  }\n\n  return sanitized;\n}\n\n// ============================================================================\n// SECURE RPC IMPLEMENTATION\n// ============================================================================\n\n/**\n * Secure wrapper around Supabase RPC function calls\n *\n * @param supabase - Supabase client instance\n * @param functionName - Name of the RPC function to call\n * @param params - Parameters to pass to the function\n * @param options - Additional options for the call\n * @returns Promise with result and error\n */\nexport async function secureRpc<T = any>(\n  supabase: SupabaseClient,\n  functionName: string,\n  params: Record<string, any> = {},\n  options: SecureRpcOptions = {}\n): Promise<SecureRpcResult<T>> {\n  const startTime = Date.now();\n  let userId: string | null = null;\n\n  try {\n    // Get current user for audit logging and rate limiting\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n    userId = user?.id || null;\n\n    // Step 1: Validate function name is whitelisted\n    const functionConfig = WHITELISTED_RPC_FUNCTIONS[functionName];\n    if (!functionConfig) {\n      const error = new Error(`RPC function '${functionName}' is not whitelisted`);\n      await logRpcCall(functionName, userId, params, false, error.message);\n      return {\n        data: null,\n        error,\n        executionTime: Date.now() - startTime,\n      };\n    }\n\n    // Step 2: Check authentication requirement\n    if (functionConfig.requiresAuth && !userId) {\n      const error = new Error(`Authentication required for '${functionName}'`);\n      await logRpcCall(functionName, userId, params, false, error.message);\n      return {\n        data: null,\n        error,\n        executionTime: Date.now() - startTime,\n      };\n    }\n\n    // Step 3: Check rate limit\n    if (!checkRateLimit(functionName, userId)) {\n      const error = new Error(`Rate limit exceeded for '${functionName}'`);\n      await logRpcCall(functionName, userId, params, false, error.message);\n      return {\n        data: null,\n        error,\n        executionTime: Date.now() - startTime,\n      };\n    }\n\n    // Step 4: Validate and sanitize parameters\n    let sanitizedParams = params;\n    let validationErrors: Record<string, string> = {};\n\n    if (!options.skipValidation) {\n      const validationResult = InputValidator.validateSchema(params, functionConfig.parameterSchema);\n\n      if (!validationResult.isValid) {\n        const error = new Error('Parameter validation failed');\n        await logRpcCall(functionName, userId, params, false, error.message);\n        return {\n          data: null,\n          error,\n          validationErrors: validationResult.errors,\n          executionTime: Date.now() - startTime,\n        };\n      }\n\n      sanitizedParams = validationResult.sanitizedData;\n    }\n\n    // Step 5: Apply custom validators if provided\n    if (options.customValidators) {\n      for (const [key, validator] of Object.entries(options.customValidators)) {\n        if (key in sanitizedParams) {\n          const result = validator(sanitizedParams[key]);\n          if (!result.isValid) {\n            const error = new Error(`Custom validation failed for parameter '${key}'`);\n            await logRpcCall(functionName, userId, params, false, error.message);\n            return {\n              data: null,\n              error,\n              validationErrors: { [key]: result.error || 'Validation failed' },\n              executionTime: Date.now() - startTime,\n            };\n          }\n          sanitizedParams[key] = result.sanitizedValue;\n        }\n      }\n    }\n\n    // Step 6: Execute the RPC function\n    const { data, error } = await supabase.rpc(functionName, sanitizedParams);\n\n    const executionTime = Date.now() - startTime;\n\n    // Step 7: Log the call\n    if (!options.skipAuditLog) {\n      await logRpcCall(\n        functionName,\n        userId,\n        sanitizedParams,\n        !error,\n        error?.message,\n        executionTime\n      );\n    }\n\n    // Step 8: Return result\n    if (error) {\n      return {\n        data: null,\n        error: new Error(error.message),\n        executionTime,\n      };\n    }\n\n    return {\n      data: data as T,\n      error: null,\n      executionTime,\n    };\n  } catch (error) {\n    const executionTime = Date.now() - startTime;\n    const err = error instanceof Error ? error : new Error('Unknown error');\n\n    await logRpcCall(functionName, userId, params, false, err.message, executionTime);\n\n    return {\n      data: null,\n      error: err,\n      executionTime,\n    };\n  }\n}\n\n// ============================================================================\n// UTILITY FUNCTIONS\n// ============================================================================\n\n/**\n * Get audit log for analysis\n */\nexport function getAuditLog(): AuditLogEntry[] {\n  return [...auditLog]; // Return copy\n}\n\n/**\n * Clear audit log (use with caution)\n */\nexport function clearAuditLog(): void {\n  auditLog.length = 0;\n}\n\n/**\n * Get rate limit statistics\n */\nexport function getRateLimitStats(): Map<string, RateLimitEntry> {\n  return new Map(rateLimitStore); // Return copy\n}\n\n/**\n * Clear rate limit cache\n */\nexport function clearRateLimitCache(): void {\n  rateLimitStore.clear();\n}\n\n/**\n * Check if a function is whitelisted\n */\nexport function isWhitelisted(functionName: string): boolean {\n  return functionName in WHITELISTED_RPC_FUNCTIONS;\n}\n\n/**\n * Get function configuration\n */\nexport function getFunctionConfig(functionName: string): RpcFunctionConfig | null {\n  return WHITELISTED_RPC_FUNCTIONS[functionName] || null;\n}\n\n/**\n * Add a new function to whitelist (use with caution in production)\n */\nexport function addToWhitelist(config: RpcFunctionConfig): void {\n  if (WHITELISTED_RPC_FUNCTIONS[config.name]) {\n    throw new Error(`Function '${config.name}' is already whitelisted`);\n  }\n  WHITELISTED_RPC_FUNCTIONS[config.name] = config;\n}\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport default secureRpc;\n"],"names":["WHITELISTED_RPC_FUNCTIONS","addToWhitelist","clearAuditLog","clearRateLimitCache","getAuditLog","getFunctionConfig","getRateLimitStats","isWhitelisted","secureRpc","get_revenue_analytics","name","description","parameterSchema","start_date","validator","InputValidator","validateDate","required","end_date","granularity","value","validateEnum","riskLevel","requiresAuth","rateLimitPerMinute","get_user_engagement_metrics","organization_id","validateUUID","options","allowNull","get_system_performance_metrics","interval_type","predict_churn_rate","periods_ahead","validateInteger","predict_new_customers","log_super_admin_action","admin_user_id","action_name","validateText","maxLength","target_type","target_id","action_details","validateJSON","ip_addr","user_agent","get_organization_metrics_summary","org_id","days","suspend_organization","reason","suspended_by_id","reactivate_organization","reactivated_by_id","track_usage_event","event_type_param","event_category_param","resource_amount_param","bytes_consumed_param","additional_metadata","check_usage_limits","limit_type_param","get_tenant_by_domain","domain_name","get_conversation_unread_count","conv_id","update_media_storage_usage","quota_type","usage_delta","is_super_admin","user_id","rateLimitStore","Map","checkRateLimit","functionName","userId","config","key","now","Date","entry","get","resetTime","set","count","auditLog","logRpcCall","parameters","success","error","executionTime","timestamp","toISOString","sanitizeParametersForLogging","push","length","shift","console","warn","params","sanitized","Object","entries","toLowerCase","includes","substring","supabase","startTime","data","user","auth","getUser","id","functionConfig","Error","message","sanitizedParams","validationErrors","skipValidation","validationResult","validateSchema","isValid","errors","sanitizedData","customValidators","result","sanitizedValue","rpc","skipAuditLog","err","clear"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;CAyBC;;;;;;;;;;;QA8CYA;eAAAA;;QA+nBGC;eAAAA;;QAnCAC;eAAAA;;QAcAC;eAAAA;;QA4BhB,+EAA+E;IAC/E,UAAU;IACV,+EAA+E;IAE/E;eAAA;;QArDgBC;eAAAA;;QAmCAC;eAAAA;;QArBAC;eAAAA;;QAcAC;eAAAA;;QA3KMC;eAAAA;;;iCA5ef;AAsCA,MAAMR,4BAA+D;IAC1E,2CAA2C;IAC3C,kCAAkC;IAClC,2CAA2C;IAC3CS,uBAAuB;QACrBC,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfC,YAAY;gBACVC,WAAWC,+BAAc,CAACC,YAAY;gBACtCC,UAAU;YACZ;YACAC,UAAU;gBACRJ,WAAWC,+BAAc,CAACC,YAAY;gBACtCC,UAAU;YACZ;YACAE,aAAa;gBACXL,WAAW,CAACM,QAAUL,+BAAc,CAACM,YAAY,CAACD,OAAO;wBAAC;wBAAO;wBAAQ;qBAAQ;gBACjFH,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEAC,6BAA6B;QAC3Bf,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfC,YAAY;gBACVC,WAAWC,+BAAc,CAACC,YAAY;gBACtCC,UAAU;YACZ;YACAC,UAAU;gBACRJ,WAAWC,+BAAc,CAACC,YAAY;gBACtCC,UAAU;YACZ;YACAS,iBAAiB;gBACfZ,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;gBACVW,SAAS;oBAAEC,WAAW;gBAAK;YAC7B;QACF;QACAP,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEAM,gCAAgC;QAC9BpB,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfC,YAAY;gBACVC,WAAWC,+BAAc,CAACC,YAAY;gBACtCC,UAAU;YACZ;YACAC,UAAU;gBACRJ,WAAWC,+BAAc,CAACC,YAAY;gBACtCC,UAAU;YACZ;YACAc,eAAe;gBACbjB,WAAW,CAACM,QAAUL,+BAAc,CAACM,YAAY,CAACD,OAAO;wBAAC;wBAAU;wBAAQ;qBAAM;gBAClFH,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEAQ,oBAAoB;QAClBtB,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfqB,eAAe;gBACbnB,WAAWC,+BAAc,CAACmB,eAAe;gBACzCjB,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEAW,uBAAuB;QACrBzB,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfqB,eAAe;gBACbnB,WAAWC,+BAAc,CAACmB,eAAe;gBACzCjB,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEA,2CAA2C;IAC3C,wBAAwB;IACxB,2CAA2C;IAC3CY,wBAAwB;QACtB1B,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfyB,eAAe;gBACbvB,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;YACAqB,aAAa;gBACXxB,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;oBAAI;gBAC1EvB,UAAU;YACZ;YACAwB,aAAa;gBACX3B,WAAW,CAACM,QACVL,+BAAc,CAACM,YAAY,CAACD,OAAO;wBAAC;wBAAgB;wBAAW;wBAAU;qBAAU;gBACrFH,UAAU;YACZ;YACAyB,WAAW;gBACT5B,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;gBACVW,SAAS;oBAAEC,WAAW;gBAAK;YAC7B;YACAc,gBAAgB;gBACd7B,WAAWC,+BAAc,CAAC6B,YAAY;gBACtC3B,UAAU;YACZ;YACA4B,SAAS;gBACP/B,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;wBAAIX,WAAW;oBAAK;gBAC1FZ,UAAU;YACZ;YACA6B,YAAY;gBACVhC,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;wBAAKX,WAAW;oBAAK;gBAC3FZ,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEAuB,kCAAkC;QAChCrC,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfoC,QAAQ;gBACNlC,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;YACAgC,MAAM;gBACJnC,WAAWC,+BAAc,CAACmB,eAAe;gBACzCjB,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEA0B,sBAAsB;QACpBxC,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfoC,QAAQ;gBACNlC,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;YACAkC,QAAQ;gBACNrC,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;oBAAI;gBAC1EvB,UAAU;YACZ;YACAmC,iBAAiB;gBACftC,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEA6B,yBAAyB;QACvB3C,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfoC,QAAQ;gBACNlC,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;YACAqC,mBAAmB;gBACjBxC,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEA,2CAA2C;IAC3C,2BAA2B;IAC3B,2CAA2C;IAC3C+B,mBAAmB;QACjB7C,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfoC,QAAQ;gBACNlC,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;YACAuC,kBAAkB;gBAChB1C,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;oBAAG;gBACzEvB,UAAU;YACZ;YACAwC,sBAAsB;gBACpB3C,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;oBAAG;gBACzEvB,UAAU;YACZ;YACAyC,uBAAuB;gBACrB5C,WAAWC,+BAAc,CAACmB,eAAe;gBACzCjB,UAAU;YACZ;YACA0C,sBAAsB;gBACpB7C,WAAWC,+BAAc,CAACmB,eAAe;gBACzCjB,UAAU;YACZ;YACA2C,qBAAqB;gBACnB9C,WAAWC,+BAAc,CAAC6B,YAAY;gBACtC3B,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEAqC,oBAAoB;QAClBnD,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfoC,QAAQ;gBACNlC,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;YACA6C,kBAAkB;gBAChBhD,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;oBAAG;gBACzEvB,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEAuC,sBAAsB;QACpBrD,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfoD,aAAa;gBACXlD,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;oBAAI;gBAC1EvB,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEA,2CAA2C;IAC3C,mCAAmC;IACnC,2CAA2C;IAC3CyC,+BAA+B;QAC7BvD,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfsD,SAAS;gBACPpD,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEA,2CAA2C;IAC3C,4BAA4B;IAC5B,2CAA2C;IAC3C2C,4BAA4B;QAC1BzD,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACfoC,QAAQ;gBACNlC,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;YACZ;YACAmD,YAAY;gBACVtD,WAAW,CAACM,QAAUL,+BAAc,CAACwB,YAAY,CAACnB,OAAO;wBAAEoB,WAAW;oBAAG;gBACzEvB,UAAU;YACZ;YACAoD,aAAa;gBACXvD,WAAWC,+BAAc,CAACmB,eAAe;gBACzCjB,UAAU;YACZ;QACF;QACAK,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;IAEA,2CAA2C;IAC3C,mBAAmB;IACnB,2CAA2C;IAC3C8C,gBAAgB;QACd5D,MAAM;QACNC,aAAa;QACbC,iBAAiB;YACf2D,SAAS;gBACPzD,WAAWC,+BAAc,CAACY,YAAY;gBACtCV,UAAU;gBACVW,SAAS;oBAAEC,WAAW;gBAAK;YAC7B;QACF;QACAP,WAAW;QACXC,cAAc;QACdC,oBAAoB;IACtB;AACF;AAWA,MAAMgD,iBAA8C,IAAIC;AAExD,SAASC,eAAeC,YAAoB,EAAEC,MAAqB;IACjE,MAAMC,SAAS7E,yBAAyB,CAAC2E,aAAa;IACtD,IAAI,CAACE,UAAU,CAACA,OAAOrD,kBAAkB,EAAE;QACzC,OAAO,MAAM,2BAA2B;IAC1C;IAEA,MAAMsD,MAAM,GAAGH,aAAa,CAAC,EAAEC,UAAU,aAAa;IACtD,MAAMG,MAAMC,KAAKD,GAAG;IACpB,MAAME,QAAQT,eAAeU,GAAG,CAACJ;IAEjC,IAAI,CAACG,SAASA,MAAME,SAAS,GAAGJ,KAAK;QACnC,4BAA4B;QAC5BP,eAAeY,GAAG,CAACN,KAAK;YACtBO,OAAO;YACPF,WAAWJ,MAAM;QACnB;QACA,OAAO;IACT;IAEA,IAAIE,MAAMI,KAAK,IAAIR,OAAOrD,kBAAkB,EAAE;QAC5C,OAAO,OAAO,sBAAsB;IACtC;IAEAyD,MAAMI,KAAK;IACX,OAAO;AACT;AAiBA,MAAMC,WAA4B,EAAE;AAEpC,eAAeC,WACbZ,YAAoB,EACpBC,MAAqB,EACrBY,UAA+B,EAC/BC,OAAgB,EAChBC,KAAc,EACdC,aAAsB;IAEtB,MAAMd,SAAS7E,yBAAyB,CAAC2E,aAAa;IAEtD,MAAMM,QAAuB;QAC3BW,WAAW,IAAIZ,OAAOa,WAAW;QACjClB;QACAC;QACAY,YAAYM,6BAA6BN;QACzCC;QACAC;QACAC;QACArE,WAAWuD,QAAQvD,aAAa;IAClC;IAEAgE,SAASS,IAAI,CAACd;IAEd,wCAAwC;IACxC,IAAIK,SAASU,MAAM,GAAG,MAAM;QAC1BV,SAASW,KAAK;IAChB;IAEA,+DAA+D;IAC/D,IAAIpB,QAAQvD,cAAc,cAAc,CAACmE,SAAS;QAChD,2DAA2D;QAC3DS,QAAQC,IAAI,CAAC,sBAAsBlB;IACrC;AACF;AAEA,SAASa,6BAA6BM,MAA2B;IAC/D,MAAMC,YAAiC,CAAC;IAExC,KAAK,MAAM,CAACvB,KAAK1D,MAAM,IAAIkF,OAAOC,OAAO,CAACH,QAAS;QACjD,0BAA0B;QAC1B,IACEtB,IAAI0B,WAAW,GAAGC,QAAQ,CAAC,eAC3B3B,IAAI0B,WAAW,GAAGC,QAAQ,CAAC,aAC3B3B,IAAI0B,WAAW,GAAGC,QAAQ,CAAC,UAC3B;YACAJ,SAAS,CAACvB,IAAI,GAAG;QACnB,OAAO,IAAI,OAAO1D,UAAU,YAAYA,MAAM4E,MAAM,GAAG,KAAK;YAC1DK,SAAS,CAACvB,IAAI,GAAG1D,MAAMsF,SAAS,CAAC,GAAG,OAAO;QAC7C,OAAO;YACLL,SAAS,CAACvB,IAAI,GAAG1D;QACnB;IACF;IAEA,OAAOiF;AACT;AAeO,eAAe7F,UACpBmG,QAAwB,EACxBhC,YAAoB,EACpByB,SAA8B,CAAC,CAAC,EAChCxE,UAA4B,CAAC,CAAC;IAE9B,MAAMgF,YAAY5B,KAAKD,GAAG;IAC1B,IAAIH,SAAwB;IAE5B,IAAI;QACF,uDAAuD;QACvD,MAAM,EACJiC,MAAM,EAAEC,IAAI,EAAE,EACf,GAAG,MAAMH,SAASI,IAAI,CAACC,OAAO;QAC/BpC,SAASkC,MAAMG,MAAM;QAErB,gDAAgD;QAChD,MAAMC,iBAAiBlH,yBAAyB,CAAC2E,aAAa;QAC9D,IAAI,CAACuC,gBAAgB;YACnB,MAAMxB,QAAQ,IAAIyB,MAAM,CAAC,cAAc,EAAExC,aAAa,oBAAoB,CAAC;YAC3E,MAAMY,WAAWZ,cAAcC,QAAQwB,QAAQ,OAAOV,MAAM0B,OAAO;YACnE,OAAO;gBACLP,MAAM;gBACNnB;gBACAC,eAAeX,KAAKD,GAAG,KAAK6B;YAC9B;QACF;QAEA,2CAA2C;QAC3C,IAAIM,eAAe3F,YAAY,IAAI,CAACqD,QAAQ;YAC1C,MAAMc,QAAQ,IAAIyB,MAAM,CAAC,6BAA6B,EAAExC,aAAa,CAAC,CAAC;YACvE,MAAMY,WAAWZ,cAAcC,QAAQwB,QAAQ,OAAOV,MAAM0B,OAAO;YACnE,OAAO;gBACLP,MAAM;gBACNnB;gBACAC,eAAeX,KAAKD,GAAG,KAAK6B;YAC9B;QACF;QAEA,2BAA2B;QAC3B,IAAI,CAAClC,eAAeC,cAAcC,SAAS;YACzC,MAAMc,QAAQ,IAAIyB,MAAM,CAAC,yBAAyB,EAAExC,aAAa,CAAC,CAAC;YACnE,MAAMY,WAAWZ,cAAcC,QAAQwB,QAAQ,OAAOV,MAAM0B,OAAO;YACnE,OAAO;gBACLP,MAAM;gBACNnB;gBACAC,eAAeX,KAAKD,GAAG,KAAK6B;YAC9B;QACF;QAEA,2CAA2C;QAC3C,IAAIS,kBAAkBjB;QACtB,IAAIkB,mBAA2C,CAAC;QAEhD,IAAI,CAAC1F,QAAQ2F,cAAc,EAAE;YAC3B,MAAMC,mBAAmBzG,+BAAc,CAAC0G,cAAc,CAACrB,QAAQc,eAAetG,eAAe;YAE7F,IAAI,CAAC4G,iBAAiBE,OAAO,EAAE;gBAC7B,MAAMhC,QAAQ,IAAIyB,MAAM;gBACxB,MAAM5B,WAAWZ,cAAcC,QAAQwB,QAAQ,OAAOV,MAAM0B,OAAO;gBACnE,OAAO;oBACLP,MAAM;oBACNnB;oBACA4B,kBAAkBE,iBAAiBG,MAAM;oBACzChC,eAAeX,KAAKD,GAAG,KAAK6B;gBAC9B;YACF;YAEAS,kBAAkBG,iBAAiBI,aAAa;QAClD;QAEA,8CAA8C;QAC9C,IAAIhG,QAAQiG,gBAAgB,EAAE;YAC5B,KAAK,MAAM,CAAC/C,KAAKhE,UAAU,IAAIwF,OAAOC,OAAO,CAAC3E,QAAQiG,gBAAgB,EAAG;gBACvE,IAAI/C,OAAOuC,iBAAiB;oBAC1B,MAAMS,SAAShH,UAAUuG,eAAe,CAACvC,IAAI;oBAC7C,IAAI,CAACgD,OAAOJ,OAAO,EAAE;wBACnB,MAAMhC,QAAQ,IAAIyB,MAAM,CAAC,wCAAwC,EAAErC,IAAI,CAAC,CAAC;wBACzE,MAAMS,WAAWZ,cAAcC,QAAQwB,QAAQ,OAAOV,MAAM0B,OAAO;wBACnE,OAAO;4BACLP,MAAM;4BACNnB;4BACA4B,kBAAkB;gCAAE,CAACxC,IAAI,EAAEgD,OAAOpC,KAAK,IAAI;4BAAoB;4BAC/DC,eAAeX,KAAKD,GAAG,KAAK6B;wBAC9B;oBACF;oBACAS,eAAe,CAACvC,IAAI,GAAGgD,OAAOC,cAAc;gBAC9C;YACF;QACF;QAEA,mCAAmC;QACnC,MAAM,EAAElB,IAAI,EAAEnB,KAAK,EAAE,GAAG,MAAMiB,SAASqB,GAAG,CAACrD,cAAc0C;QAEzD,MAAM1B,gBAAgBX,KAAKD,GAAG,KAAK6B;QAEnC,uBAAuB;QACvB,IAAI,CAAChF,QAAQqG,YAAY,EAAE;YACzB,MAAM1C,WACJZ,cACAC,QACAyC,iBACA,CAAC3B,OACDA,OAAO0B,SACPzB;QAEJ;QAEA,wBAAwB;QACxB,IAAID,OAAO;YACT,OAAO;gBACLmB,MAAM;gBACNnB,OAAO,IAAIyB,MAAMzB,MAAM0B,OAAO;gBAC9BzB;YACF;QACF;QAEA,OAAO;YACLkB,MAAMA;YACNnB,OAAO;YACPC;QACF;IACF,EAAE,OAAOD,OAAO;QACd,MAAMC,gBAAgBX,KAAKD,GAAG,KAAK6B;QACnC,MAAMsB,MAAMxC,iBAAiByB,QAAQzB,QAAQ,IAAIyB,MAAM;QAEvD,MAAM5B,WAAWZ,cAAcC,QAAQwB,QAAQ,OAAO8B,IAAId,OAAO,EAAEzB;QAEnE,OAAO;YACLkB,MAAM;YACNnB,OAAOwC;YACPvC;QACF;IACF;AACF;AASO,SAASvF;IACd,OAAO;WAAIkF;KAAS,EAAE,cAAc;AACtC;AAKO,SAASpF;IACdoF,SAASU,MAAM,GAAG;AACpB;AAKO,SAAS1F;IACd,OAAO,IAAImE,IAAID,iBAAiB,cAAc;AAChD;AAKO,SAASrE;IACdqE,eAAe2D,KAAK;AACtB;AAKO,SAAS5H,cAAcoE,YAAoB;IAChD,OAAOA,gBAAgB3E;AACzB;AAKO,SAASK,kBAAkBsE,YAAoB;IACpD,OAAO3E,yBAAyB,CAAC2E,aAAa,IAAI;AACpD;AAKO,SAAS1E,eAAe4E,MAAyB;IACtD,IAAI7E,yBAAyB,CAAC6E,OAAOnE,IAAI,CAAC,EAAE;QAC1C,MAAM,IAAIyG,MAAM,CAAC,UAAU,EAAEtC,OAAOnE,IAAI,CAAC,wBAAwB,CAAC;IACpE;IACAV,yBAAyB,CAAC6E,OAAOnE,IAAI,CAAC,GAAGmE;AAC3C;MAMA,WAAerE"}