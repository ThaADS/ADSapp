{"version":3,"names":["cov_1yp53m24wd","actualCoverage","s","POST","request","f","supabase","_server1","createClient","data","user","error","authError","auth","getUser","b","_server","NextResponse","json","status","profile","from","select","eq","id","single","organization_id","includes","role","body","contactIds","messageContent","messageType","templateId","priority","Array","isArray","length","contacts","contactsError","in","jobData","organizationId","userId","map","contact","phone","name","variables","custom_fields","undefined","metadata","requestedBy","email","requestedAt","Date","toISOString","queueManager","_queuemanager","getQueueManager","jobId","addJob","_bullconfig","QueueName","BULK_MESSAGE","JobPriority","CRITICAL","success","message","console","details","Error"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\jobs\\bulk-message\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\nimport { getQueueManager } from '@/lib/queue/queue-manager';\nimport { QueueName, JobPriority } from '@/lib/queue/bull-config';\nimport { BulkMessageJobData } from '@/lib/queue/processors/bulk-message-processor';\n\n/**\n * POST /api/jobs/bulk-message\n * Queue a bulk message sending job\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const supabase = await createClient();\n\n    // Get authenticated user\n    const {\n      data: { user },\n      error: authError\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    // Get user's organization\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('organization_id, role')\n      .eq('id', user.id)\n      .single();\n\n    if (!profile?.organization_id) {\n      return NextResponse.json(\n        { error: 'No organization found' },\n        { status: 400 }\n      );\n    }\n\n    // Check permissions (only agents and above can send bulk messages)\n    if (!['owner', 'admin', 'agent'].includes(profile.role)) {\n      return NextResponse.json(\n        { error: 'Insufficient permissions' },\n        { status: 403 }\n      );\n    }\n\n    // Parse request body\n    const body = await request.json();\n    const { contactIds, messageContent, messageType, templateId, priority } =\n      body;\n\n    // Validate required fields\n    if (!contactIds || !Array.isArray(contactIds) || contactIds.length === 0) {\n      return NextResponse.json(\n        { error: 'contactIds is required and must be a non-empty array' },\n        { status: 400 }\n      );\n    }\n\n    if (!messageContent || typeof messageContent !== 'string') {\n      return NextResponse.json(\n        { error: 'messageContent is required and must be a string' },\n        { status: 400 }\n      );\n    }\n\n    // Fetch contacts from database\n    const { data: contacts, error: contactsError } = await supabase\n      .from('contacts')\n      .select('id, phone, name, custom_fields')\n      .eq('organization_id', profile.organization_id)\n      .in('id', contactIds);\n\n    if (contactsError || !contacts || contacts.length === 0) {\n      return NextResponse.json(\n        { error: 'No valid contacts found' },\n        { status: 400 }\n      );\n    }\n\n    // Prepare job data\n    const jobData: BulkMessageJobData = {\n      organizationId: profile.organization_id,\n      userId: user.id,\n      contacts: contacts.map((contact) => ({\n        id: contact.id,\n        phone: contact.phone,\n        name: contact.name,\n        variables: contact.custom_fields || {}\n      })),\n      messageContent,\n      messageType: messageType || 'text',\n      templateId: templateId || undefined,\n      metadata: {\n        requestedBy: user.email,\n        requestedAt: new Date().toISOString()\n      }\n    };\n\n    // Get queue manager and add job\n    const queueManager = getQueueManager();\n    const jobId = await queueManager.addJob(\n      QueueName.BULK_MESSAGE,\n      'send-bulk-message',\n      jobData,\n      {\n        priority: priority || JobPriority.CRITICAL\n      }\n    );\n\n    return NextResponse.json(\n      {\n        success: true,\n        jobId,\n        message: `Bulk message job queued for ${contacts.length} contacts`\n      },\n      { status: 202 }\n    );\n  } catch (error) {\n    console.error('Error queuing bulk message job:', error);\n    return NextResponse.json(\n      {\n        error: 'Failed to queue bulk message job',\n        details: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}