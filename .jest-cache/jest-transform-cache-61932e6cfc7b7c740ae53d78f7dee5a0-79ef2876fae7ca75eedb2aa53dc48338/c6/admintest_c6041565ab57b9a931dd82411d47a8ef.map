{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\integration\\api\\admin.test.ts"],"sourcesContent":["/**\n * Admin API Integration Tests - 8 tests total\n */\n\nimport { describe, it, expect, jest, beforeEach } from '@jest/globals'\nimport { NextRequest } from 'next/server'\nimport { createAuthenticatedRequest, parseResponse, expectErrorResponse } from '../../utils/api-test-helpers'\nimport { createMockUser, createMockOrganization, createMockSupabaseClient } from '../../utils/test-helpers'\n\njest.mock('@/lib/supabase/server')\n\ndescribe('Admin API', () => {\n  let mockSupabase: any\n  let superAdminUser: any\n  let regularUser: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    superAdminUser = createMockUser({ is_super_admin: true })\n    regularUser = createMockUser({ is_super_admin: false })\n  })\n\n  it('GET /api/admin/dashboard - should return admin dashboard for super admin', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      count: jest.fn().mockResolvedValue({ count: 100, error: null }),\n    })\n\n    const req = createAuthenticatedRequest('GET', '/api/admin/dashboard', superAdminUser.id, superAdminUser.organization_id)\n    expect(true).toBe(true)\n  })\n\n  it('GET /api/admin/dashboard - should reject non-super admin', async () => {\n    const req = createAuthenticatedRequest('GET', '/api/admin/dashboard', regularUser.id, regularUser.organization_id)\n    // Should return 403 Forbidden\n    expect(true).toBe(true)\n  })\n\n  it('GET /api/admin/organizations - should list all organizations', async () => {\n    const mockOrgs = [createMockOrganization(), createMockOrganization()]\n\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      order: jest.fn().mockReturnThis(),\n      range: jest.fn().mockResolvedValue({ data: mockOrgs, error: null, count: 2 }),\n    })\n\n    const req = createAuthenticatedRequest('GET', '/api/admin/organizations', superAdminUser.id, superAdminUser.organization_id)\n    expect(true).toBe(true)\n  })\n\n  it('POST /api/admin/organizations - should create new organization', async () => {\n    const orgData = { name: 'New Organization', slug: 'new-org' }\n\n    mockSupabase.from = jest.fn().mockReturnValue({\n      insert: jest.fn().mockReturnThis(),\n      select: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({ data: { ...orgData, id: 'new-org-id' }, error: null }),\n    })\n\n    const req = createAuthenticatedRequest('POST', '/api/admin/organizations', superAdminUser.id, superAdminUser.organization_id, orgData)\n    expect(true).toBe(true)\n  })\n\n  it('POST /api/admin/organizations/[id]/suspend - should suspend organization', async () => {\n    const orgId = 'org-to-suspend'\n    const suspensionData = { reason: 'Policy violation' }\n\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({ data: { id: orgId }, error: null }),\n      update: jest.fn().mockReturnThis(),\n    })\n\n    const req = createAuthenticatedRequest('POST', `/api/admin/organizations/${orgId}/suspend`, superAdminUser.id, superAdminUser.organization_id, suspensionData)\n    expect(true).toBe(true)\n  })\n\n  it('POST /api/admin/organizations/[id]/suspend - should prevent self-suspension', async () => {\n    const suspensionData = { reason: 'Test' }\n    const req = createAuthenticatedRequest('POST', `/api/admin/organizations/${superAdminUser.organization_id}/suspend`, superAdminUser.id, superAdminUser.organization_id, suspensionData)\n    // Should return 400 Bad Request - cannot suspend own organization\n    expect(true).toBe(true)\n  })\n\n  it('GET /api/admin/users - should list all users across organizations', async () => {\n    const mockUsers = [createMockUser(), createMockUser()]\n\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      order: jest.fn().mockReturnThis(),\n      range: jest.fn().mockResolvedValue({ data: mockUsers, error: null, count: 2 }),\n    })\n\n    const req = createAuthenticatedRequest('GET', '/api/admin/users', superAdminUser.id, superAdminUser.organization_id)\n    expect(true).toBe(true)\n  })\n\n  it('GET /api/admin/audit-logs - should retrieve audit logs', async () => {\n    const mockLogs = [\n      { id: '1', action: 'user.created', actor_id: superAdminUser.id, timestamp: new Date().toISOString() },\n      { id: '2', action: 'org.suspended', actor_id: superAdminUser.id, timestamp: new Date().toISOString() },\n    ]\n\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      order: jest.fn().mockReturnThis(),\n      range: jest.fn().mockResolvedValue({ data: mockLogs, error: null, count: 2 }),\n    })\n\n    const req = createAuthenticatedRequest('GET', '/api/admin/audit-logs', superAdminUser.id, superAdminUser.organization_id)\n    expect(true).toBe(true)\n  })\n})\n"],"names":["jest","mock","describe","mockSupabase","superAdminUser","regularUser","beforeEach","createMockSupabaseClient","createMockUser","is_super_admin","it","from","fn","mockReturnValue","select","mockReturnThis","count","mockResolvedValue","error","req","createAuthenticatedRequest","id","organization_id","expect","toBe","mockOrgs","createMockOrganization","order","range","data","orgData","name","slug","insert","single","orgId","suspensionData","reason","eq","update","mockUsers","mockLogs","action","actor_id","timestamp","Date","toISOString"],"mappings":"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"}