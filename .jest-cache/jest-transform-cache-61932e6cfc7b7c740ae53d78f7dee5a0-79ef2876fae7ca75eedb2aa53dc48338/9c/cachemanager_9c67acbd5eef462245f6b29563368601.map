{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\cache\\cache-manager.ts"],"sourcesContent":["/**\n * Multi-Layer Cache Manager\n *\n * Implements 3-layer caching strategy:\n * - L1: In-memory cache (1 minute TTL) - Hot data\n * - L2: Redis cache (15 minutes TTL) - Shared data\n * - L3: Database (Source of truth) - Persistent data\n *\n * Features:\n * - Automatic cache warming\n * - Smart invalidation\n * - Cache-aside pattern\n * - Write-through option\n * - Tenant isolation\n * - Performance monitoring\n */\n\nimport { L1Cache, getL1Cache } from './l1-cache';\nimport {\n  getCached as getRedis,\n  setCached as setRedis,\n  deleteCached as deleteRedis,\n  deletePattern,\n  generateCacheKey,\n  isRedisAvailable,\n} from './redis-client';\n\nexport interface CacheManagerConfig {\n  l1Enabled: boolean;\n  l2Enabled: boolean;\n  l1TTL: number; // seconds\n  l2TTL: number; // seconds\n  enableMonitoring: boolean;\n  writeThrough: boolean; // Update cache on write\n  warmOnMiss: boolean; // Warm cache on read miss\n}\n\nexport interface CacheEntry<T> {\n  data: T;\n  metadata: {\n    tenant: string;\n    resource: string;\n    cachedAt: number;\n    source: 'l1' | 'l2' | 'l3';\n  };\n}\n\nexport interface CachePerformance {\n  l1HitRate: number;\n  l2HitRate: number;\n  averageLatency: number;\n  totalRequests: number;\n  l1Hits: number;\n  l2Hits: number;\n  l3Hits: number;\n}\n\n/**\n * Cache Manager implementing multi-layer strategy\n */\nexport class CacheManager {\n  private l1Cache: L1Cache;\n  private config: CacheManagerConfig;\n  private performance: CachePerformance;\n\n  constructor(config?: Partial<CacheManagerConfig>) {\n    this.config = {\n      l1Enabled: config?.l1Enabled ?? true,\n      l2Enabled: config?.l2Enabled ?? true,\n      l1TTL: config?.l1TTL || 60, // 1 minute\n      l2TTL: config?.l2TTL || 900, // 15 minutes\n      enableMonitoring: config?.enableMonitoring ?? true,\n      writeThrough: config?.writeThrough ?? true,\n      warmOnMiss: config?.warmOnMiss ?? true,\n    };\n\n    this.l1Cache = getL1Cache();\n    this.performance = {\n      l1HitRate: 0,\n      l2HitRate: 0,\n      averageLatency: 0,\n      totalRequests: 0,\n      l1Hits: 0,\n      l2Hits: 0,\n      l3Hits: 0,\n    };\n  }\n\n  /**\n   * Get cached data with multi-layer fallback\n   */\n  async get<T>(\n    tenant: string,\n    resource: string,\n    id: string | undefined,\n    fetchFn: () => Promise<T>\n  ): Promise<CacheEntry<T>> {\n    const startTime = Date.now();\n    const cacheKey = generateCacheKey(tenant, resource, id);\n\n    try {\n      // L1: Check in-memory cache\n      if (this.config.l1Enabled) {\n        const l1Data = this.l1Cache.get<T>(cacheKey);\n        if (l1Data !== null) {\n          this.recordHit('l1', startTime);\n          return this.wrapEntry(l1Data, tenant, resource, 'l1');\n        }\n      }\n\n      // L2: Check Redis cache\n      if (this.config.l2Enabled) {\n        const l2Data = await getRedis<T>(cacheKey);\n        if (l2Data !== null) {\n          // Warm L1 cache\n          if (this.config.l1Enabled && this.config.warmOnMiss) {\n            this.l1Cache.set(cacheKey, l2Data, this.config.l1TTL);\n          }\n\n          this.recordHit('l2', startTime);\n          return this.wrapEntry(l2Data, tenant, resource, 'l2');\n        }\n      }\n\n      // L3: Fetch from database\n      const l3Data = await fetchFn();\n\n      // Store in all cache layers (write-through)\n      if (this.config.writeThrough) {\n        await this.set(tenant, resource, id, l3Data);\n      }\n\n      this.recordHit('l3', startTime);\n      return this.wrapEntry(l3Data, tenant, resource, 'l3');\n    } catch (error) {\n      console.error('[CacheManager] Get error:', error);\n      // Fallback to database on cache failure\n      const data = await fetchFn();\n      this.recordHit('l3', startTime);\n      return this.wrapEntry(data, tenant, resource, 'l3');\n    }\n  }\n\n  /**\n   * Set data in cache layers\n   */\n  async set<T>(\n    tenant: string,\n    resource: string,\n    id: string | undefined,\n    data: T\n  ): Promise<void> {\n    const cacheKey = generateCacheKey(tenant, resource, id);\n\n    try {\n      // L1: Store in memory\n      if (this.config.l1Enabled) {\n        this.l1Cache.set(cacheKey, data, this.config.l1TTL);\n      }\n\n      // L2: Store in Redis\n      if (this.config.l2Enabled) {\n        await setRedis(cacheKey, data, { ttl: this.config.l2TTL });\n      }\n\n      if (this.config.enableMonitoring) {\n        console.log(`[CacheManager] SET: ${cacheKey}`);\n      }\n    } catch (error) {\n      console.error('[CacheManager] Set error:', error);\n      // Non-critical error - cache set failure shouldn't break the app\n    }\n  }\n\n  /**\n   * Delete data from all cache layers\n   */\n  async delete(tenant: string, resource: string, id?: string): Promise<void> {\n    const cacheKey = generateCacheKey(tenant, resource, id);\n\n    try {\n      // L1: Delete from memory\n      if (this.config.l1Enabled) {\n        this.l1Cache.delete(cacheKey);\n      }\n\n      // L2: Delete from Redis\n      if (this.config.l2Enabled) {\n        await deleteRedis(cacheKey);\n      }\n\n      if (this.config.enableMonitoring) {\n        console.log(`[CacheManager] DELETE: ${cacheKey}`);\n      }\n    } catch (error) {\n      console.error('[CacheManager] Delete error:', error);\n    }\n  }\n\n  /**\n   * Invalidate all cache entries for a tenant and resource\n   */\n  async invalidate(tenant: string, resource?: string): Promise<number> {\n    try {\n      const pattern = resource\n        ? `${tenant}:${resource}:*`\n        : `${tenant}:*`;\n\n      let count = 0;\n\n      // L1: Clear matching keys\n      if (this.config.l1Enabled) {\n        const keys = this.l1Cache.keys();\n        for (const key of keys) {\n          if (this.matchesPattern(key, pattern)) {\n            this.l1Cache.delete(key);\n            count++;\n          }\n        }\n      }\n\n      // L2: Clear matching keys in Redis\n      if (this.config.l2Enabled) {\n        const redisCount = await deletePattern(pattern);\n        count += redisCount;\n      }\n\n      if (this.config.enableMonitoring) {\n        console.log(`[CacheManager] INVALIDATE: ${pattern} (${count} keys)`);\n      }\n\n      return count;\n    } catch (error) {\n      console.error('[CacheManager] Invalidate error:', error);\n      return 0;\n    }\n  }\n\n  /**\n   * Warm cache with data\n   */\n  async warm<T>(\n    tenant: string,\n    resource: string,\n    items: Array<{ id?: string; data: T }>\n  ): Promise<void> {\n    try {\n      for (const item of items) {\n        await this.set(tenant, resource, item.id, item.data);\n      }\n\n      if (this.config.enableMonitoring) {\n        console.log(\n          `[CacheManager] WARM: ${tenant}:${resource} (${items.length} items)`\n        );\n      }\n    } catch (error) {\n      console.error('[CacheManager] Warm error:', error);\n    }\n  }\n\n  /**\n   * Get cache performance metrics\n   */\n  getPerformance(): CachePerformance {\n    this.updateHitRates();\n    return { ...this.performance };\n  }\n\n  /**\n   * Reset performance metrics\n   */\n  resetPerformance(): void {\n    this.performance = {\n      l1HitRate: 0,\n      l2HitRate: 0,\n      averageLatency: 0,\n      totalRequests: 0,\n      l1Hits: 0,\n      l2Hits: 0,\n      l3Hits: 0,\n    };\n  }\n\n  /**\n   * Check cache health\n   */\n  async healthCheck(): Promise<{\n    l1Available: boolean;\n    l2Available: boolean;\n    overall: 'healthy' | 'degraded' | 'down';\n  }> {\n    const l1Available = true; // L1 is always available (in-memory)\n    const l2Available = await isRedisAvailable();\n\n    let overall: 'healthy' | 'degraded' | 'down';\n    if (l1Available && l2Available) {\n      overall = 'healthy';\n    } else if (l1Available || l2Available) {\n      overall = 'degraded';\n    } else {\n      overall = 'down';\n    }\n\n    return { l1Available, l2Available, overall };\n  }\n\n  /**\n   * Get cache configuration\n   */\n  getConfig(): CacheManagerConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Update cache configuration\n   */\n  updateConfig(config: Partial<CacheManagerConfig>): void {\n    this.config = { ...this.config, ...config };\n  }\n\n  /**\n   * Wrap data in cache entry format\n   */\n  private wrapEntry<T>(\n    data: T,\n    tenant: string,\n    resource: string,\n    source: 'l1' | 'l2' | 'l3'\n  ): CacheEntry<T> {\n    return {\n      data,\n      metadata: {\n        tenant,\n        resource,\n        cachedAt: Date.now(),\n        source,\n      },\n    };\n  }\n\n  /**\n   * Record cache hit and update metrics\n   */\n  private recordHit(layer: 'l1' | 'l2' | 'l3', startTime: number): void {\n    this.performance.totalRequests++;\n\n    if (layer === 'l1') {\n      this.performance.l1Hits++;\n    } else if (layer === 'l2') {\n      this.performance.l2Hits++;\n    } else {\n      this.performance.l3Hits++;\n    }\n\n    // Update average latency\n    const latency = Date.now() - startTime;\n    const total = this.performance.totalRequests;\n    const currentAvg = this.performance.averageLatency;\n    this.performance.averageLatency =\n      (currentAvg * (total - 1) + latency) / total;\n  }\n\n  /**\n   * Update hit rate calculations\n   */\n  private updateHitRates(): void {\n    const total = this.performance.totalRequests;\n    if (total > 0) {\n      this.performance.l1HitRate =\n        (this.performance.l1Hits / total) * 100;\n      this.performance.l2HitRate =\n        ((this.performance.l1Hits + this.performance.l2Hits) / total) * 100;\n    }\n  }\n\n  /**\n   * Check if key matches pattern\n   */\n  private matchesPattern(key: string, pattern: string): boolean {\n    const regex = new RegExp('^' + pattern.replace(/\\*/g, '.*') + '$');\n    return regex.test(key);\n  }\n}\n\n// Global cache manager instance\nlet globalCacheManager: CacheManager | null = null;\n\n/**\n * Get global cache manager instance\n */\nexport function getCacheManager(\n  config?: Partial<CacheManagerConfig>\n): CacheManager {\n  if (!globalCacheManager) {\n    globalCacheManager = new CacheManager(config);\n  }\n  return globalCacheManager;\n}\n\n/**\n * Reset global cache manager instance\n */\nexport function resetCacheManager(): void {\n  globalCacheManager = null;\n}\n\n/**\n * Helper function for simple cached get\n */\nexport async function getCached<T>(\n  tenant: string,\n  resource: string,\n  id: string | undefined,\n  fetchFn: () => Promise<T>\n): Promise<T> {\n  const manager = getCacheManager();\n  const result = await manager.get(tenant, resource, id, fetchFn);\n  return result.data;\n}\n\n/**\n * Helper function for simple cached set\n */\nexport async function setCached<T>(\n  tenant: string,\n  resource: string,\n  id: string | undefined,\n  data: T\n): Promise<void> {\n  const manager = getCacheManager();\n  await manager.set(tenant, resource, id, data);\n}\n\n/**\n * Helper function for simple cached delete\n */\nexport async function deleteCached(\n  tenant: string,\n  resource: string,\n  id?: string\n): Promise<void> {\n  const manager = getCacheManager();\n  await manager.delete(tenant, resource, id);\n}\n\n/**\n * Helper function for cache invalidation\n */\nexport async function invalidateCache(\n  tenant: string,\n  resource?: string\n): Promise<number> {\n  const manager = getCacheManager();\n  return await manager.invalidate(tenant, resource);\n}\n\n// Export default instance\nexport default getCacheManager();\n"],"names":["CacheManager","deleteCached","getCacheManager","getCached","invalidateCache","resetCacheManager","setCached","config","l1Enabled","l2Enabled","l1TTL","l2TTL","enableMonitoring","writeThrough","warmOnMiss","l1Cache","getL1Cache","performance","l1HitRate","l2HitRate","averageLatency","totalRequests","l1Hits","l2Hits","l3Hits","get","tenant","resource","id","fetchFn","startTime","Date","now","cacheKey","generateCacheKey","l1Data","recordHit","wrapEntry","l2Data","getRedis","set","l3Data","error","console","data","setRedis","ttl","log","delete","deleteRedis","invalidate","pattern","count","keys","key","matchesPattern","redisCount","deletePattern","warm","items","item","length","getPerformance","updateHitRates","resetPerformance","healthCheck","l1Available","l2Available","isRedisAvailable","overall","getConfig","updateConfig","source","metadata","cachedAt","layer","latency","total","currentAvg","regex","RegExp","replace","test","globalCacheManager","manager","result"],"mappings":"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"}