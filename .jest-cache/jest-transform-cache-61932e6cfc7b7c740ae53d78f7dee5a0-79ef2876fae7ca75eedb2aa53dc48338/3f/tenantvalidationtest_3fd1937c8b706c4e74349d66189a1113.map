{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\integration\\tenant-validation.test.ts"],"sourcesContent":["/**\n * Integration Tests for Tenant Validation Middleware\n *\n * Tests the security controls that prevent cross-tenant data access\n */\n\nimport { describe, it, expect, jest, beforeEach } from '@jest/globals';\nimport { NextRequest, NextResponse } from 'next/server';\nimport {\n  validateTenantAccess,\n  getTenantContext,\n  isSuperAdmin,\n  validateResourceAccess\n} from '@/lib/middleware/tenant-validation';\n\n// Mock Supabase client\njest.mock('@/lib/supabase/server', () => ({\n  createClient: jest.fn()\n}));\n\n// Mock api-utils\njest.mock('@/lib/api-utils', () => ({\n  getUserOrganization: jest.fn()\n}));\n\n// Mock Sentry\njest.mock('@sentry/nextjs', () => ({\n  captureMessage: jest.fn(),\n  captureException: jest.fn()\n}));\n\ndescribe('Tenant Validation Middleware', () => {\n  let mockSupabase: any;\n  let mockGetUserOrganization: jest.Mock;\n\n  beforeEach(() => {\n    // Reset all mocks\n    jest.clearAllMocks();\n\n    // Setup mock Supabase client\n    mockSupabase = {\n      auth: {\n        getUser: jest.fn()\n      },\n      from: jest.fn(() => ({\n        select: jest.fn(() => ({\n          eq: jest.fn(() => ({\n            single: jest.fn()\n          }))\n        }))\n      }))\n    };\n\n    const { createClient } = require('@/lib/supabase/server');\n    (createClient as jest.Mock).mockResolvedValue(mockSupabase);\n\n    mockGetUserOrganization = require('@/lib/api-utils').getUserOrganization as jest.Mock;\n  });\n\n  describe('validateTenantAccess', () => {\n    it('should return 401 if user is not authenticated', async () => {\n      // Mock unauthenticated user\n      mockSupabase.auth.getUser.mockResolvedValue({\n        data: { user: null },\n        error: new Error('Not authenticated')\n      });\n\n      const request = new NextRequest('http://localhost/api/contacts');\n      const response = await validateTenantAccess(request);\n\n      expect(response).toBeInstanceOf(NextResponse);\n      expect(response?.status).toBe(401);\n\n      const json = await response?.json();\n      expect(json.error).toBe('Authentication required');\n      expect(json.code).toBe('UNAUTHORIZED');\n    });\n\n    it('should return 403 if user has no organization', async () => {\n      // Mock authenticated user without organization\n      mockSupabase.auth.getUser.mockResolvedValue({\n        data: {\n          user: {\n            id: 'user-123',\n            email: 'user@example.com'\n          }\n        },\n        error: null\n      });\n\n      mockGetUserOrganization.mockRejectedValue(\n        new Error('No organization found')\n      );\n\n      // Mock non-super-admin profile\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            single: jest.fn().mockResolvedValue({\n              data: { is_super_admin: false },\n              error: null\n            })\n          })\n        })\n      });\n\n      const request = new NextRequest('http://localhost/api/contacts');\n      const response = await validateTenantAccess(request);\n\n      expect(response).toBeInstanceOf(NextResponse);\n      expect(response?.status).toBe(403);\n\n      const json = await response?.json();\n      expect(json.error).toBe('User not associated with any organization');\n    });\n\n    it('should allow super admin without organization', async () => {\n      // Mock authenticated super admin\n      mockSupabase.auth.getUser.mockResolvedValue({\n        data: {\n          user: {\n            id: 'admin-123',\n            email: 'admin@adsapp.com'\n          }\n        },\n        error: null\n      });\n\n      mockGetUserOrganization.mockRejectedValue(\n        new Error('No organization found')\n      );\n\n      // Mock super admin profile\n      mockSupabase.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            single: jest.fn().mockResolvedValue({\n              data: {\n                is_super_admin: true,\n                role: 'super_admin'\n              },\n              error: null\n            })\n          })\n        })\n      });\n\n      const request = new NextRequest('http://localhost/api/admin/organizations');\n      const response = await validateTenantAccess(request);\n\n      // Super admin should be allowed to proceed (returns null)\n      expect(response).toBeNull();\n    });\n\n    it('should return 403 if cross-tenant access is attempted', async () => {\n      // Mock authenticated user with organization\n      mockSupabase.auth.getUser.mockResolvedValue({\n        data: {\n          user: {\n            id: 'user-123',\n            email: 'user@org1.com'\n          }\n        },\n        error: null\n      });\n\n      mockGetUserOrganization.mockResolvedValue({\n        organization_id: 'org-111',\n        organization: { role: 'admin' }\n      });\n\n      // Request with different organization ID\n      const request = new NextRequest(\n        'http://localhost/api/contacts?organization_id=org-222'\n      );\n\n      const response = await validateTenantAccess(request);\n\n      expect(response).toBeInstanceOf(NextResponse);\n      expect(response?.status).toBe(403);\n\n      const json = await response?.json();\n      expect(json.error).toBe('Forbidden: Access to this organization denied');\n      expect(json.code).toBe('FORBIDDEN');\n    });\n\n    it('should allow access for matching organization', async () => {\n      // Mock authenticated user with organization\n      mockSupabase.auth.getUser.mockResolvedValue({\n        data: {\n          user: {\n            id: 'user-123',\n            email: 'user@org1.com'\n          }\n        },\n        error: null\n      });\n\n      mockGetUserOrganization.mockResolvedValue({\n        organization_id: 'org-111',\n        organization: { role: 'admin' }\n      });\n\n      const request = new NextRequest('http://localhost/api/contacts');\n      const response = await validateTenantAccess(request);\n\n      // Should allow access (returns null to continue)\n      expect(response).toBeNull();\n    });\n\n    it('should attach tenant context headers to request', async () => {\n      // Mock authenticated user\n      mockSupabase.auth.getUser.mockResolvedValue({\n        data: {\n          user: {\n            id: 'user-123',\n            email: 'user@org1.com'\n          }\n        },\n        error: null\n      });\n\n      mockGetUserOrganization.mockResolvedValue({\n        organization_id: 'org-111',\n        organization: { role: 'agent' }\n      });\n\n      const request = new NextRequest('http://localhost/api/contacts');\n      const response = await validateTenantAccess(request);\n\n      expect(response).toBeNull();\n\n      // Check that headers were added (in real implementation)\n      // Note: In actual middleware, headers are added to the request\n    });\n  });\n\n  describe('getTenantContext', () => {\n    it('should extract tenant context from request headers', () => {\n      const request = new NextRequest('http://localhost/api/contacts', {\n        headers: {\n          'x-user-id': 'user-123',\n          'x-organization-id': 'org-111',\n          'x-user-role': 'admin',\n          'x-user-email': 'user@org1.com'\n        }\n      });\n\n      const context = getTenantContext(request);\n\n      expect(context.userId).toBe('user-123');\n      expect(context.organizationId).toBe('org-111');\n      expect(context.userRole).toBe('admin');\n      expect(context.userEmail).toBe('user@org1.com');\n    });\n\n    it('should return empty strings for missing headers', () => {\n      const request = new NextRequest('http://localhost/api/contacts');\n      const context = getTenantContext(request);\n\n      expect(context.userId).toBe('');\n      expect(context.organizationId).toBe('');\n      expect(context.userRole).toBe('agent'); // default role\n      expect(context.userEmail).toBe('');\n    });\n  });\n\n  describe('isSuperAdmin', () => {\n    it('should return true for super admin', () => {\n      const request = new NextRequest('http://localhost/api/admin', {\n        headers: {\n          'x-is-super-admin': 'true'\n        }\n      });\n\n      expect(isSuperAdmin(request)).toBe(true);\n    });\n\n    it('should return false for regular user', () => {\n      const request = new NextRequest('http://localhost/api/contacts', {\n        headers: {\n          'x-is-super-admin': 'false'\n        }\n      });\n\n      expect(isSuperAdmin(request)).toBe(false);\n    });\n\n    it('should return false when header is missing', () => {\n      const request = new NextRequest('http://localhost/api/contacts');\n      expect(isSuperAdmin(request)).toBe(false);\n    });\n  });\n\n  describe('validateResourceAccess', () => {\n    it('should allow super admin to access any resource', () => {\n      const context = {\n        userId: 'admin-123',\n        organizationId: '',\n        userRole: 'super_admin',\n        userEmail: 'admin@adsapp.com'\n      };\n\n      const result = validateResourceAccess('org-999', context);\n      expect(result).toBe(true);\n    });\n\n    it('should allow access to resources in same organization', () => {\n      const context = {\n        userId: 'user-123',\n        organizationId: 'org-111',\n        userRole: 'admin',\n        userEmail: 'user@org1.com'\n      };\n\n      const result = validateResourceAccess('org-111', context);\n      expect(result).toBe(true);\n    });\n\n    it('should deny access to resources in different organization', () => {\n      const context = {\n        userId: 'user-123',\n        organizationId: 'org-111',\n        userRole: 'admin',\n        userEmail: 'user@org1.com'\n      };\n\n      const result = validateResourceAccess('org-222', context);\n      expect(result).toBe(false);\n    });\n  });\n});\n\ndescribe('Rate Limiting Integration', () => {\n  it('should apply rate limits correctly', async () => {\n    const { createRateLimiter, rateLimitConfigs } = await import('@/lib/middleware/rate-limit');\n\n    const rateLimit = createRateLimiter({\n      windowMs: 60000,\n      maxRequests: 3\n    });\n\n    const request = new NextRequest('http://localhost/api/test');\n\n    // First 3 requests should succeed\n    for (let i = 0; i < 3; i++) {\n      const response = await rateLimit(request);\n      expect(response).toBeNull();\n    }\n\n    // 4th request should be rate limited\n    const rateLimitedResponse = await rateLimit(request);\n    expect(rateLimitedResponse).toBeInstanceOf(NextResponse);\n    expect(rateLimitedResponse?.status).toBe(429);\n\n    const json = await rateLimitedResponse?.json();\n    expect(json.code).toBe('RATE_LIMIT_EXCEEDED');\n  });\n});\n\ndescribe('Middleware Composition', () => {\n  it('should compose multiple middleware functions', async () => {\n    const { composeMiddleware } = await import('@/lib/middleware');\n\n    const middleware1 = jest.fn(async () => null);\n    const middleware2 = jest.fn(async () => null);\n    const middleware3 = jest.fn(async () => null);\n\n    const composed = composeMiddleware(middleware1, middleware2, middleware3);\n\n    const request = new NextRequest('http://localhost/api/test');\n    const response = await composed(request);\n\n    // All middleware should be called\n    expect(middleware1).toHaveBeenCalled();\n    expect(middleware2).toHaveBeenCalled();\n    expect(middleware3).toHaveBeenCalled();\n\n    // Should return null (continue request)\n    expect(response).toBeNull();\n  });\n\n  it('should short-circuit on first middleware error', async () => {\n    const { composeMiddleware } = await import('@/lib/middleware');\n\n    const middleware1 = jest.fn(async () => null);\n    const middleware2 = jest.fn(async () =>\n      NextResponse.json({ error: 'Blocked' }, { status: 403 })\n    );\n    const middleware3 = jest.fn(async () => null);\n\n    const composed = composeMiddleware(middleware1, middleware2, middleware3);\n\n    const request = new NextRequest('http://localhost/api/test');\n    const response = await composed(request);\n\n    // First two middleware called, third skipped\n    expect(middleware1).toHaveBeenCalled();\n    expect(middleware2).toHaveBeenCalled();\n    expect(middleware3).not.toHaveBeenCalled();\n\n    // Should return error response\n    expect(response).toBeInstanceOf(NextResponse);\n    expect(response?.status).toBe(403);\n  });\n});\n"],"names":["jest","mock","createClient","fn","getUserOrganization","captureMessage","captureException","describe","mockSupabase","mockGetUserOrganization","beforeEach","clearAllMocks","auth","getUser","from","select","eq","single","require","mockResolvedValue","it","data","user","error","Error","request","NextRequest","response","validateTenantAccess","expect","toBeInstanceOf","NextResponse","status","toBe","json","code","id","email","mockRejectedValue","mockReturnValue","is_super_admin","role","toBeNull","organization_id","organization","headers","context","getTenantContext","userId","organizationId","userRole","userEmail","isSuperAdmin","result","validateResourceAccess","createRateLimiter","rateLimitConfigs","rateLimit","windowMs","maxRequests","i","rateLimitedResponse","composeMiddleware","middleware1","middleware2","middleware3","composed","toHaveBeenCalled","not"],"mappings":"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"}