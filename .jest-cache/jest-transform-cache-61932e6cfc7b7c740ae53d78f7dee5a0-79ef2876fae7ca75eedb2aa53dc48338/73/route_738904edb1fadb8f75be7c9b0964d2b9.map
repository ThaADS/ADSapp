{"version":3,"names":["cov_2m4sc510y","actualCoverage","s","GET","request","f","middlewareResponse","_middleware","strictApiMiddleware","b","organizationId","getTenantContext","supabase","_server1","createClient","data","org","from","select","eq","single","_server","NextResponse","json","error","status","stripe_subscription_id","subscription","_server2","stripe","subscriptions","retrieve","subscriptionData","id","planId","subscription_tier","planName","price","items","unit_amount","currency","interval","recurring","currentPeriodStart","Date","current_period_start","toISOString","currentPeriodEnd","current_period_end","trialEnd","trial_end","undefined","cancelAt","cancel_at","canceledAt","canceled_at","createdAt","created","console"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\billing\\subscription\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@/lib/supabase/server'\nimport { stripe } from '@/lib/stripe/server'\nimport { strictApiMiddleware, getTenantContext } from '@/lib/middleware'\n\nexport async function GET(request: NextRequest) {\n  // Apply strict API middleware (tenant validation + strict rate limiting)\n  const middlewareResponse = await strictApiMiddleware(request);\n  if (middlewareResponse) return middlewareResponse;\n\n  try {\n    // Get tenant context from middleware (already validated)\n    const { organizationId } = getTenantContext(request);\n\n    const supabase = await createClient();\n\n    // Get organization subscription data\n    const { data: org } = await supabase\n      .from('organizations')\n      .select('*')\n      .eq('id', organizationId)\n      .single()\n\n    if (!org) {\n      return NextResponse.json(\n        { error: 'Organization not found' },\n        { status: 404 }\n      )\n    }\n\n    if (!org.stripe_subscription_id) {\n      return NextResponse.json({ subscription: null })\n    }\n\n    // Get subscription from Stripe\n    const subscription = await stripe.subscriptions.retrieve(org.stripe_subscription_id)\n\n    const subscriptionData = {\n      id: subscription.id,\n      status: subscription.status,\n      planId: org.subscription_tier,\n      planName: org.subscription_tier,\n      price: subscription.items.data[0]?.price?.unit_amount || 0,\n      currency: subscription.currency,\n      interval: subscription.items.data[0]?.price?.recurring?.interval || 'month',\n      currentPeriodStart: new Date(subscription.current_period_start * 1000).toISOString(),\n      currentPeriodEnd: new Date(subscription.current_period_end * 1000).toISOString(),\n      trialEnd: subscription.trial_end ? new Date(subscription.trial_end * 1000).toISOString() : undefined,\n      cancelAt: subscription.cancel_at ? new Date(subscription.cancel_at * 1000).toISOString() : undefined,\n      canceledAt: subscription.canceled_at ? new Date(subscription.canceled_at * 1000).toISOString() : undefined,\n      createdAt: new Date(subscription.created * 1000).toISOString(),\n    }\n\n    return NextResponse.json(subscriptionData)\n  } catch (error) {\n    console.error('Subscription API error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}"],"mappings":"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","ignoreList":[]}