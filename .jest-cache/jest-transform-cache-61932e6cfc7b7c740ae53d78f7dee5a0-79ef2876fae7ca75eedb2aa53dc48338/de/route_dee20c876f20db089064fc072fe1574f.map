{"version":3,"names":["cov_l7qy296di","actualCoverage","s","POST","request","f","_buildsafeinit","isBuildTime","b","_server","NextResponse","json","error","status","middlewareResponse","_middleware","strictApiMiddleware","organizationId","getTenantContext","immediate","reason","feedback","lifecycleManager","_subscriptionlifecycle","SubscriptionLifecycleManager","result","cancelSubscription","offerRetention","downgradeToFree","success","subscription","id","effectiveDate","toISOString","console","Error","message"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\billing\\cancel\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@/lib/supabase/server'\nimport { SubscriptionLifecycleManager } from '@/lib/billing/subscription-lifecycle'\nimport { isBuildTime } from '@/lib/build-safe-init'\nimport { strictApiMiddleware, getTenantContext } from '@/lib/middleware'\n\nexport async function POST(request: NextRequest) {\n  // Check if we're in build mode and return early\n  if (isBuildTime()) {\n    return NextResponse.json(\n      { error: 'Service temporarily unavailable during build' },\n      { status: 503 }\n    )\n  }\n\n  // Apply strict API middleware (tenant validation + strict rate limiting)\n  const middlewareResponse = await strictApiMiddleware(request);\n  if (middlewareResponse) return middlewareResponse;\n\n  try {\n    // Get tenant context from middleware (already validated)\n    const { organizationId } = getTenantContext(request);\n    const { immediate = false, reason, feedback } = await request.json();\n\n    if (!reason) {\n      return NextResponse.json(\n        { error: 'Cancellation reason is required' },\n        { status: 400 }\n      )\n    }\n\n    const lifecycleManager = new SubscriptionLifecycleManager()\n\n    const result = await lifecycleManager.cancelSubscription(organizationId, {\n      immediate,\n      reason,\n      feedback,\n      offerRetention: false,\n      downgradeToFree: true,\n    })\n\n    return NextResponse.json({\n      success: true,\n      subscription: {\n        id: result.subscription.id,\n        status: result.subscription.status,\n      },\n      effectiveDate: result.effectiveDate.toISOString(),\n      immediate,\n    })\n  } catch (error) {\n    console.error('Cancel API error:', error)\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}"],"mappings":"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","ignoreList":[]}