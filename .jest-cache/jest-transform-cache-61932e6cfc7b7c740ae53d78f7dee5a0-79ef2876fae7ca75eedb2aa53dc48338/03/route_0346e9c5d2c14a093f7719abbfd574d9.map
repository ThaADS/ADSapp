{"version":3,"names":["cov_15fpeu40je","actualCoverage","s","POST","request","f","middlewareResponse","_middleware","strictApiMiddleware","b","organizationId","userRole","getTenantContext","supabase","_server1","createClient","includes","_server","NextResponse","json","error","status","data","organization","from","select","eq","single","stripe_customer_id","session","_server2","StripeService","createPortalSession","url","console"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\billing\\portal\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { requireAuth } from '@/lib/auth'\nimport { createClient } from '@/lib/supabase/server'\nimport { StripeService } from '@/lib/stripe/server'\nimport { strictApiMiddleware, getTenantContext } from '@/lib/middleware'\n\nexport async function POST(request: NextRequest) {\n  // Apply strict API middleware (tenant validation + strict rate limiting)\n  const middlewareResponse = await strictApiMiddleware(request);\n  if (middlewareResponse) return middlewareResponse;\n\n  try {\n    // Get tenant context from middleware (already validated)\n    const { organizationId, userRole } = getTenantContext(request);\n    const supabase = await createClient();\n\n    // Check if user is owner or admin\n    if (!['owner', 'admin'].includes(userRole)) {\n      return NextResponse.json({ error: 'Unauthorized - Owner or Admin role required' }, { status: 403 })\n    }\n\n    // Get organization stripe customer ID\n    const { data: organization } = await supabase\n      .from('organizations')\n      .select('stripe_customer_id')\n      .eq('id', organizationId)\n      .single();\n\n    if (!organization?.stripe_customer_id) {\n      return NextResponse.json({ error: 'No billing account found' }, { status: 404 })\n    }\n\n    // Create portal session\n    const session = await StripeService.createPortalSession(\n      organization.stripe_customer_id\n    );\n\n    return NextResponse.json({ url: session.url })\n  } catch (error) {\n    console.error('Portal error:', error)\n    return NextResponse.json(\n      { error: 'Failed to create portal session' },\n      { status: 500 }\n    )\n  }\n}"],"mappings":"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","ignoreList":[]}