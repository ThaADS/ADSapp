{"version":3,"names":["DELETE","cov_2oyhg4b6dx","f","s","GET","request","params","id","supabase","_server1","createClient","data","user","error","authError","auth","getUser","b","_server","NextResponse","json","status","profile","from","select","eq","single","organization_id","queueManager","_queuemanager","getQueueManager","queueNames","Object","values","_bullconfig","QueueName","jobInfo","queueName","job","getJob","organizationId","success","console","details","Error","message","includes","role","cancelled","cancelJob"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\jobs\\[id]\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\nimport { getQueueManager } from '@/lib/queue/queue-manager';\nimport { QueueName } from '@/lib/queue/bull-config';\n\n/**\n * GET /api/jobs/[id]\n * Get job status and details\n */\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params;\n    const supabase = await createClient();\n\n    // Get authenticated user\n    const {\n      data: { user },\n      error: authError\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    // Get user's organization\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('organization_id')\n      .eq('id', user.id)\n      .single();\n\n    if (!profile?.organization_id) {\n      return NextResponse.json(\n        { error: 'No organization found' },\n        { status: 400 }\n      );\n    }\n\n    // Try to find job in all queues\n    const queueManager = getQueueManager();\n    const queueNames = Object.values(QueueName);\n\n    let jobInfo = null;\n\n    for (const queueName of queueNames) {\n      try {\n        const job = await queueManager.getJob(queueName, id);\n        if (job) {\n          // Verify job belongs to user's organization\n          if (job.data.organizationId === profile.organization_id) {\n            jobInfo = job;\n            break;\n          }\n        }\n      } catch (error) {\n        // Continue checking other queues\n        continue;\n      }\n    }\n\n    if (!jobInfo) {\n      return NextResponse.json({ error: 'Job not found' }, { status: 404 });\n    }\n\n    return NextResponse.json({\n      success: true,\n      job: jobInfo\n    });\n  } catch (error) {\n    console.error('Error getting job status:', error);\n    return NextResponse.json(\n      {\n        error: 'Failed to get job status',\n        details: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * DELETE /api/jobs/[id]\n * Cancel a job\n */\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params;\n    const supabase = await createClient();\n\n    // Get authenticated user\n    const {\n      data: { user },\n      error: authError\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    // Get user's organization\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('organization_id, role')\n      .eq('id', user.id)\n      .single();\n\n    if (!profile?.organization_id) {\n      return NextResponse.json(\n        { error: 'No organization found' },\n        { status: 400 }\n      );\n    }\n\n    // Check permissions (only agents and above can cancel jobs)\n    if (!['owner', 'admin', 'agent'].includes(profile.role)) {\n      return NextResponse.json(\n        { error: 'Insufficient permissions' },\n        { status: 403 }\n      );\n    }\n\n    // Try to cancel job in all queues\n    const queueManager = getQueueManager();\n    const queueNames = Object.values(QueueName);\n\n    let cancelled = false;\n\n    for (const queueName of queueNames) {\n      try {\n        // First verify job belongs to user's organization\n        const job = await queueManager.getJob(queueName, id);\n        if (job && job.data.organizationId === profile.organization_id) {\n          cancelled = await queueManager.cancelJob(queueName, id);\n          if (cancelled) {\n            break;\n          }\n        }\n      } catch (error) {\n        // Continue checking other queues\n        continue;\n      }\n    }\n\n    if (!cancelled) {\n      return NextResponse.json(\n        { error: 'Job not found or already completed' },\n        { status: 404 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: 'Job cancelled successfully'\n    });\n  } catch (error) {\n    console.error('Error cancelling job:', error);\n    return NextResponse.json(\n      {\n        error: 'Failed to cancel job',\n        details: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}