{"version":3,"names":["cov_nnig1ctfy","actualCoverage","s","processTemplate","getTemplate","templateId","organizationId","f","supabase","_server","createClient","data","error","from","select","eq","single","b","Error","message","extractTemplateVariables","content","regex","variables","match","exec","push","trim","Set","validateVariables","templateVariables","providedVariables","missing","filter","varName","valid","length","substituteTemplateVariables","template","result","key","value","Object","entries","RegExp","replace","sanitizeVariableValue","type","URL","date","Date","isNaN","getTime","createBulkMessageJob","userId","messages","scheduleAt","jobId","now","Math","random","toString","substr","console","log","job","startTime","recipients","metadata","id","results","processedCount","queuedCount","failedCount","errors","join","processedMessages","i","recipient","validation","sanitizedVariables","personalizedContent","contactId","phone","progress","round","updateProgress","bulkMessageJobId","endTime","duration","insert","job_id","job_type","organization_id","user_id","status","template_id","total","processed","queued","failed","bulk_job_id","error_details","started_at","toISOString","completed_at","totalRecipients","startedAt","completedAt"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\queue\\processors\\template-processor.ts"],"sourcesContent":["import { Job } from 'bullmq';\nimport { createClient } from '@/lib/supabase/server';\n\n/**\n * Template Processor\n *\n * Handles message template compilation, variable substitution, and batch processing.\n * Used for scheduled campaigns and automated messaging.\n *\n * Features:\n * - Template compilation and caching\n * - Variable substitution with validation\n * - Batch message personalization\n * - Template preview generation\n * - Multi-tenant isolation\n *\n * @module template-processor\n */\n\n/**\n * Template variable definition\n */\nexport interface TemplateVariable {\n  name: string;\n  type: 'text' | 'number' | 'date' | 'url';\n  required: boolean;\n  defaultValue?: string;\n}\n\n/**\n * Template processing job data\n */\nexport interface TemplateProcessingJobData {\n  organizationId: string;\n  userId: string;\n  templateId: string;\n  recipients: Array<{\n    contactId: string;\n    phone: string;\n    variables: Record<string, string>;\n  }>;\n  scheduleAt?: string; // ISO 8601 timestamp\n  metadata?: Record<string, any>;\n}\n\n/**\n * Template processing job result\n */\nexport interface TemplateProcessingJobResult {\n  jobId: string;\n  organizationId: string;\n  templateId: string;\n  totalRecipients: number;\n  processedCount: number;\n  queuedCount: number;\n  failedCount: number;\n  errors: Array<{\n    contactId: string;\n    error: string;\n  }>;\n  bulkMessageJobId?: string; // ID of created bulk message job\n  startedAt: string;\n  completedAt: string;\n  duration: number;\n}\n\n/**\n * Get template from database\n */\nasync function getTemplate(templateId: string, organizationId: string) {\n  const supabase = await createClient();\n\n  const { data, error } = await supabase\n    .from('message_templates')\n    .select('*')\n    .eq('id', templateId)\n    .eq('organization_id', organizationId)\n    .single();\n\n  if (error) {\n    throw new Error(`Failed to get template: ${error.message}`);\n  }\n\n  return data;\n}\n\n/**\n * Extract variables from template content\n */\nfunction extractTemplateVariables(content: string): string[] {\n  const regex = /{{([^}]+)}}/g;\n  const variables: string[] = [];\n  let match;\n\n  while ((match = regex.exec(content)) !== null) {\n    variables.push(match[1].trim());\n  }\n\n  return [...new Set(variables)]; // Remove duplicates\n}\n\n/**\n * Validate required variables are provided\n */\nfunction validateVariables(\n  templateVariables: string[],\n  providedVariables: Record<string, string>\n): { valid: boolean; missing: string[] } {\n  const missing = templateVariables.filter(\n    (varName) => !(varName in providedVariables) || !providedVariables[varName]\n  );\n\n  return {\n    valid: missing.length === 0,\n    missing\n  };\n}\n\n/**\n * Substitute variables in template\n */\nfunction substituteTemplateVariables(\n  template: string,\n  variables: Record<string, string>\n): string {\n  let result = template;\n\n  for (const [key, value] of Object.entries(variables)) {\n    const regex = new RegExp(`{{\\\\s*${key}\\\\s*}}`, 'g');\n    result = result.replace(regex, value);\n  }\n\n  return result;\n}\n\n/**\n * Sanitize variable value\n */\nfunction sanitizeVariableValue(\n  value: string,\n  type: string = 'text'\n): string {\n  switch (type) {\n    case 'url':\n      // Basic URL validation\n      try {\n        new URL(value);\n        return value;\n      } catch {\n        return '';\n      }\n    case 'number':\n      // Remove non-numeric characters\n      return value.replace(/[^0-9.-]/g, '');\n    case 'date':\n      // Validate date format\n      const date = new Date(value);\n      return isNaN(date.getTime()) ? '' : value;\n    case 'text':\n    default:\n      // Remove special characters that might break WhatsApp formatting\n      return value.replace(/[^\\w\\s.,!?@#$%&()-]/g, '');\n  }\n}\n\n/**\n * Create bulk message job from processed templates\n */\nasync function createBulkMessageJob(\n  organizationId: string,\n  userId: string,\n  messages: Array<{\n    contactId: string;\n    phone: string;\n    content: string;\n  }>,\n  scheduleAt?: string\n): Promise<string> {\n  // This would integrate with the bulk message queue\n  // For now, we'll simulate job creation\n  const jobId = `bulk_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n  // TODO: Queue bulk message job\n  console.log(`Created bulk message job: ${jobId} for ${messages.length} messages`);\n\n  return jobId;\n}\n\n/**\n * Template processor function\n */\nexport async function processTemplate(\n  job: Job<TemplateProcessingJobData>\n): Promise<TemplateProcessingJobResult> {\n  const startTime = Date.now();\n  const {\n    organizationId,\n    userId,\n    templateId,\n    recipients,\n    scheduleAt,\n    metadata\n  } = job.data;\n\n  console.log(\n    `[TemplateProcessing] Starting job ${job.id} for template ${templateId} with ${recipients.length} recipients`\n  );\n\n  const results = {\n    processedCount: 0,\n    queuedCount: 0,\n    failedCount: 0,\n    errors: [] as Array<{\n      contactId: string;\n      error: string;\n    }>\n  };\n\n  try {\n    // Step 1: Get template\n    console.log(`[TemplateProcessing] Fetching template ${templateId}`);\n    const template = await getTemplate(templateId, organizationId);\n\n    if (!template) {\n      throw new Error('Template not found');\n    }\n\n    // Step 2: Extract required variables\n    const templateVariables = extractTemplateVariables(template.content);\n    console.log(\n      `[TemplateProcessing] Template requires variables: ${templateVariables.join(', ')}`\n    );\n\n    // Step 3: Process each recipient\n    const processedMessages: Array<{\n      contactId: string;\n      phone: string;\n      content: string;\n    }> = [];\n\n    for (let i = 0; i < recipients.length; i++) {\n      const recipient = recipients[i];\n\n      try {\n        // Validate required variables\n        const validation = validateVariables(\n          templateVariables,\n          recipient.variables\n        );\n\n        if (!validation.valid) {\n          throw new Error(\n            `Missing required variables: ${validation.missing.join(', ')}`\n          );\n        }\n\n        // Sanitize variable values\n        const sanitizedVariables: Record<string, string> = {};\n        for (const [key, value] of Object.entries(recipient.variables)) {\n          sanitizedVariables[key] = sanitizeVariableValue(value, 'text');\n        }\n\n        // Substitute variables\n        const personalizedContent = substituteTemplateVariables(\n          template.content,\n          sanitizedVariables\n        );\n\n        // Add to processed messages\n        processedMessages.push({\n          contactId: recipient.contactId,\n          phone: recipient.phone,\n          content: personalizedContent\n        });\n\n        results.processedCount++;\n\n        // Update progress\n        if (i % 10 === 0 || i === recipients.length - 1) {\n          const progress = Math.round(((i + 1) / recipients.length) * 100);\n          await job.updateProgress(progress);\n        }\n      } catch (error) {\n        results.failedCount++;\n        results.errors.push({\n          contactId: recipient.contactId,\n          error: error instanceof Error ? error.message : 'Processing error'\n        });\n\n        console.error(\n          `[TemplateProcessing] Error processing recipient ${recipient.contactId}:`,\n          error\n        );\n      }\n    }\n\n    // Step 4: Create bulk message job with processed messages\n    let bulkMessageJobId: string | undefined;\n    if (processedMessages.length > 0) {\n      console.log(\n        `[TemplateProcessing] Creating bulk message job for ${processedMessages.length} messages`\n      );\n\n      bulkMessageJobId = await createBulkMessageJob(\n        organizationId,\n        userId,\n        processedMessages,\n        scheduleAt\n      );\n\n      results.queuedCount = processedMessages.length;\n    }\n\n    const endTime = Date.now();\n    const duration = endTime - startTime;\n\n    // Log job completion to database\n    const supabase = await createClient();\n    await supabase.from('job_logs').insert({\n      job_id: job.id?.toString(),\n      job_type: 'template_processing',\n      organization_id: organizationId,\n      user_id: userId,\n      status: results.failedCount === 0 ? 'completed' : 'partial_success',\n      result: {\n        template_id: templateId,\n        total: recipients.length,\n        processed: results.processedCount,\n        queued: results.queuedCount,\n        failed: results.failedCount,\n        bulk_job_id: bulkMessageJobId,\n        duration: duration\n      },\n      error_details:\n        results.errors.length > 0 ? { errors: results.errors } : null,\n      started_at: new Date(startTime).toISOString(),\n      completed_at: new Date(endTime).toISOString()\n    });\n\n    console.log(\n      `[TemplateProcessing] Job ${job.id} completed: ${results.processedCount} processed, ${results.queuedCount} queued, ${results.failedCount} failed, ${duration}ms`\n    );\n\n    return {\n      jobId: job.id?.toString() || '',\n      organizationId,\n      templateId,\n      totalRecipients: recipients.length,\n      processedCount: results.processedCount,\n      queuedCount: results.queuedCount,\n      failedCount: results.failedCount,\n      errors: results.errors,\n      bulkMessageJobId,\n      startedAt: new Date(startTime).toISOString(),\n      completedAt: new Date(endTime).toISOString(),\n      duration\n    };\n  } catch (error) {\n    const endTime = Date.now();\n    const duration = endTime - startTime;\n\n    // Log failure\n    const supabase = await createClient();\n    await supabase.from('job_logs').insert({\n      job_id: job.id?.toString(),\n      job_type: 'template_processing',\n      organization_id: organizationId,\n      user_id: userId,\n      status: 'failed',\n      result: {\n        template_id: templateId,\n        total: recipients.length,\n        processed: 0,\n        failed: recipients.length,\n        duration: duration\n      },\n      error_details: {\n        error: error instanceof Error ? error.message : 'Unknown error'\n      },\n      started_at: new Date(startTime).toISOString(),\n      completed_at: new Date(endTime).toISOString()\n    });\n\n    throw error;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}