{"version":3,"names":["cov_15ukjt3d3q","actualCoverage","s","GET","request","f","searchParams","URL","url","period","b","get","organizationId","headers","_server","NextResponse","json","error","status","supabase","_server1","createClient","data","org","from","select","eq","single","endDate","Date","startDate","setDate","getDate","setFullYear","getFullYear","invoices","subscriptionHistory","usageData","paidInvoices","filter","inv","failedInvoices","attempt_count","totalRevenue","reduce","sum","amount","averageInvoiceAmount","length","paymentSuccessRate","currentPlan","getPlanDetails","subscription_tier","monthlyRecurringRevenue","price","annualRecurringRevenue","previousStartDate","previousEndDate","periodDays","Math","floor","getTime","previousInvoices","previousRevenue","revenueGrowth","revenueHistory","generateRevenueHistory","planDistribution","calculatePlanDistribution","totalUsage","acc","usage","messages","messages_sent","users","users_active","contacts","contacts_managed","automations","automation_runs","apiCalls","api_calls","storage","storage_used","overageCharges","overage_charges","customerLifetime","customerLifetimeValue","analyticsData","totalSubscriptions","activeSubscriptions","newSubscriptions","reason","churnedSubscriptions","churnRate","successfulPayments","failedPayments","customerLifecycle","averageLifetime","averageLifetimeValue","cohortData","console","planId","plans","starter","professional","enterprise","history","periodLength","currentDate","periodEnd","periodInvoices","invDate","created_at","revenue","subscriptions","mrr","churn","push","toISOString","split","count","percentage"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\billing\\analytics\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@/lib/supabase/server'\nimport { stripe } from '@/lib/stripe/server'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const period = searchParams.get('period') || '30d'\n    const organizationId = request.headers.get('X-Organization-ID')\n\n    if (!organizationId) {\n      return NextResponse.json(\n        { error: 'Organization ID is required' },\n        { status: 400 }\n      )\n    }\n\n    const supabase = await createClient()\n\n    // Get organization data\n    const { data: org } = await supabase\n      .from('organizations')\n      .select('stripe_customer_id, subscription_tier')\n      .eq('id', organizationId)\n      .single()\n\n    if (!org) {\n      return NextResponse.json(\n        { error: 'Organization not found' },\n        { status: 404 }\n      )\n    }\n\n    // Calculate date range\n    const endDate = new Date()\n    const startDate = new Date()\n\n    switch (period) {\n      case '7d':\n        startDate.setDate(endDate.getDate() - 7)\n        break\n      case '30d':\n        startDate.setDate(endDate.getDate() - 30)\n        break\n      case '90d':\n        startDate.setDate(endDate.getDate() - 90)\n        break\n      case '1y':\n        startDate.setFullYear(endDate.getFullYear() - 1)\n        break\n      default:\n        startDate.setDate(endDate.getDate() - 30)\n    }\n\n    // TODO WEEK 5+: Create invoices, subscription_changes, usage_tracking tables\n    // For now, return placeholder data until advanced billing tables are created\n    const invoices: any[] = []\n    const subscriptionHistory: any[] = []\n    const usageData: any[] = []\n\n    // Get invoice data - COMMENTED OUT until invoices table is created\n    // const { data: invoices } = await supabase\n    //   .from('invoices')\n    //   .select('*')\n    //   .eq('organization_id', organizationId)\n    //   .gte('created_at', startDate.toISOString())\n    //   .lte('created_at', endDate.toISOString())\n\n    // Get subscription data - COMMENTED OUT until subscription_changes table is created\n    // const { data: subscriptionHistory } = await supabase\n    //   .from('subscription_changes')\n    //   .select('*')\n    //   .eq('organization_id', organizationId)\n    //   .gte('effective_date', startDate.toISOString())\n    //   .lte('effective_date', endDate.toISOString())\n    //   .order('effective_date', { ascending: true })\n\n    // Get usage data - COMMENTED OUT until usage_tracking table is created\n    // const { data: usageData } = await supabase\n    //   .from('usage_tracking')\n    //   .select('*')\n    //   .eq('organization_id', organizationId)\n    //   .gte('period_start', startDate.toISOString())\n    //   .order('period_start', { ascending: true })\n\n    // Calculate revenue metrics\n    const paidInvoices = invoices?.filter(inv => inv.status === 'paid') || []\n    const failedInvoices = invoices?.filter(inv =>\n      inv.status === 'uncollectible' ||\n      (inv.status === 'open' && inv.attempt_count >= 3)\n    ) || []\n\n    const totalRevenue = paidInvoices.reduce((sum, inv) => sum + inv.amount, 0)\n    const averageInvoiceAmount = invoices?.length ?\n      invoices.reduce((sum, inv) => sum + inv.amount, 0) / invoices.length : 0\n\n    const paymentSuccessRate = invoices?.length ?\n      (paidInvoices.length / invoices.length) * 100 : 100\n\n    // Calculate MRR/ARR (simplified - assumes subscription is active)\n    const currentPlan = await getPlanDetails(org.subscription_tier)\n    const monthlyRecurringRevenue = currentPlan?.price || 0\n    const annualRecurringRevenue = monthlyRecurringRevenue * 12\n\n    // Calculate revenue growth (compare with previous period)\n    const previousStartDate = new Date(startDate)\n    const previousEndDate = new Date(startDate)\n    const periodDays = Math.floor((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24))\n    previousStartDate.setDate(previousStartDate.getDate() - periodDays)\n\n    // COMMENTED OUT until invoices table is created\n    // const { data: previousInvoices } = await supabase\n    //   .from('invoices')\n    //   .select('amount, status')\n    //   .eq('organization_id', organizationId)\n    //   .gte('created_at', previousStartDate.toISOString())\n    //   .lte('created_at', previousEndDate.toISOString())\n\n    const previousInvoices: any[] = []\n    const previousRevenue = previousInvoices?.filter(inv => inv.status === 'paid')\n      .reduce((sum, inv) => sum + inv.amount, 0) || 0\n\n    const revenueGrowth = previousRevenue > 0 ?\n      ((totalRevenue - previousRevenue) / previousRevenue) * 100 : 0\n\n    // Generate historical data\n    const revenueHistory = generateRevenueHistory(invoices || [], period, startDate, endDate)\n\n    // Calculate plan distribution\n    const planDistribution = calculatePlanDistribution(subscriptionHistory || [], currentPlan)\n\n    // Calculate usage totals\n    const totalUsage = usageData?.reduce((acc, usage) => ({\n      messages: acc.messages + (usage.messages_sent || 0),\n      users: acc.users + (usage.users_active || 0),\n      contacts: acc.contacts + (usage.contacts_managed || 0),\n      automations: acc.automations + (usage.automation_runs || 0),\n      apiCalls: acc.apiCalls + (usage.api_calls || 0),\n      storage: acc.storage + (usage.storage_used || 0),\n    }), {\n      messages: 0,\n      users: 0,\n      contacts: 0,\n      automations: 0,\n      apiCalls: 0,\n      storage: 0,\n    }) || {\n      messages: 0,\n      users: 0,\n      contacts: 0,\n      automations: 0,\n      apiCalls: 0,\n      storage: 0,\n    }\n\n    const overageCharges = usageData?.reduce((sum, usage) =>\n      sum + (usage.overage_charges || 0), 0) || 0\n\n    // Calculate customer lifecycle (simplified)\n    const customerLifetime = 365 // Default to 1 year\n    const customerLifetimeValue = monthlyRecurringRevenue * 12\n\n    const analyticsData = {\n      totalRevenue,\n      monthlyRecurringRevenue,\n      annualRecurringRevenue,\n      revenueGrowth,\n      totalSubscriptions: 1, // Single organization\n      activeSubscriptions: org.subscription_tier === 'cancelled' ? 0 : 1,\n      newSubscriptions: subscriptionHistory?.filter(s => s.reason === 'upgrade').length || 0,\n      churnedSubscriptions: subscriptionHistory?.filter(s => s.reason === 'cancellation').length || 0,\n      churnRate: 0, // Would need more historical data to calculate properly\n      successfulPayments: paidInvoices.length,\n      failedPayments: failedInvoices.length,\n      paymentSuccessRate,\n      averageInvoiceAmount,\n      totalUsage,\n      overageCharges,\n      revenueHistory,\n      planDistribution,\n      customerLifecycle: {\n        averageLifetime: customerLifetime,\n        averageLifetimeValue: customerLifetimeValue,\n        cohortData: [], // Would need more complex calculations\n      },\n    }\n\n    return NextResponse.json(analyticsData)\n  } catch (error) {\n    console.error('Analytics API error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n// Helper functions\nasync function getPlanDetails(planId: string) {\n  const plans = {\n    starter: { price: 0 },\n    professional: { price: 2900 }, // $29/month in cents\n    enterprise: { price: 9900 }, // $99/month in cents\n  }\n  return plans[planId as keyof typeof plans] || plans.starter\n}\n\ninterface Invoice {\n  created_at: string;\n  status: string;\n  amount: number;\n}\n\nfunction generateRevenueHistory(\n  invoices: Invoice[],\n  period: string,\n  startDate: Date,\n  endDate: Date\n) {\n  const history = []\n  const periodLength = period === '7d' ? 1 : period === '30d' ? 7 : period === '90d' ? 7 : 30\n\n  let currentDate = new Date(startDate)\n  while (currentDate <= endDate) {\n    const periodEnd = new Date(currentDate)\n    periodEnd.setDate(periodEnd.getDate() + periodLength)\n\n    const periodInvoices = invoices.filter(inv => {\n      const invDate = new Date(inv.created_at)\n      return invDate >= currentDate && invDate < periodEnd\n    })\n\n    const revenue = periodInvoices\n      .filter(inv => inv.status === 'paid')\n      .reduce((sum, inv) => sum + inv.amount, 0)\n\n    const subscriptions = 1 // Simplified for single organization\n    const mrr = revenue // Simplified\n    const churn = 0 // Simplified\n\n    history.push({\n      period: currentDate.toISOString().split('T')[0],\n      revenue,\n      subscriptions,\n      mrr,\n      churn,\n    })\n\n    currentDate = new Date(periodEnd)\n  }\n\n  return history\n}\n\ninterface SubscriptionHistory {\n  plan_id: string;\n  effective_date: string;\n}\n\ninterface CurrentPlan {\n  price: number;\n}\n\nfunction calculatePlanDistribution(subscriptionHistory: SubscriptionHistory[], currentPlan: CurrentPlan | undefined) {\n  // Simplified for single organization\n  return [\n    {\n      planId: 'professional', // Current plan\n      count: 1,\n      revenue: currentPlan?.price || 0,\n      percentage: 100,\n    },\n  ]\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}