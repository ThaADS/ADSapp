{"version":3,"names":["DELETE","cov_1ewegs8acw","f","s","GET","PUT","request","params","middlewareResponse","_middleware","standardApiMiddleware","b","organizationId","getTenantContext","id","supabase","_server1","createClient","data","contact","error","from","select","eq","single","_server","NextResponse","json","status","conversations","allMessages","flatMap","c","messages","stats","totalConversations","length","activeConversations","filter","totalMessages","inboundMessages","m","sender_type","outboundMessages","firstContactDate","sort","a","Date","created_at","getTime","lastContactDate","last_message_at","averageResponseTime","calculateAverageResponseTime","messageFrequency","calculateMessageFrequency","contactWithStats","map","conv","messageCount","assignedAgent","profiles","full_name","_apiutils","createSuccessResponse","console","createErrorResponse","userId","body","name","email","tags","notes","metadata","is_blocked","existingContact","emailRegex","test","updateData","updated_at","toISOString","undefined","current","updated_by","updatedContact","update","in","delete","message","responseTimes","conversation","sortedMessages","i","currentMessage","nextMessage","responseTime","push","averageMs","reduce","sum","time","Math","round","daily","weekly","monthly","now","oneDayAgo","oneWeekAgo","oneMonthAgo","dailyMessages","weeklyMessages","monthlyMessages"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\contacts\\[id]\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { requireAuthenticatedUser, getUserOrganization, createErrorResponse, createSuccessResponse } from '@/lib/api-utils'\nimport { createClient } from '@/lib/supabase/server'\nimport { standardApiMiddleware, getTenantContext } from '@/lib/middleware'\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  // Apply standard API middleware (tenant validation + standard rate limiting)\n  const middlewareResponse = await standardApiMiddleware(request);\n  if (middlewareResponse) return middlewareResponse;\n\n  try {\n    // Get tenant context from middleware (already validated)\n    const { organizationId } = getTenantContext(request);\n    const { id } = await params;\n\n    const supabase = await createClient()\n\n    const { data: contact, error } = await supabase\n      .from('contacts')\n      .select(`\n        *,\n        conversations (\n          id,\n          status,\n          priority,\n          subject,\n          created_at,\n          last_message_at,\n          assigned_to,\n          profiles (\n            full_name\n          ),\n          messages (\n            id,\n            content,\n            sender_type,\n            message_type,\n            created_at\n          )\n        )\n      `)\n      .eq('id', id)\n      .eq('organization_id', organizationId)\n      .single()\n\n    if (error || !contact) {\n      return NextResponse.json(\n        { error: 'Contact not found' },\n        { status: 404 }\n      )\n    }\n\n    // Calculate contact statistics\n    const conversations = contact.conversations || []\n    const allMessages = conversations.flatMap(c => c.messages || [])\n\n    const stats = {\n      totalConversations: conversations.length,\n      activeConversations: conversations.filter(c => c.status === 'open' || c.status === 'pending').length,\n      totalMessages: allMessages.length,\n      inboundMessages: allMessages.filter(m => m.sender_type === 'contact').length,\n      outboundMessages: allMessages.filter(m => m.sender_type === 'agent').length,\n      firstContactDate: conversations.length > 0\n        ? conversations.sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())[0].created_at\n        : contact.created_at,\n      lastContactDate: contact.last_message_at,\n      averageResponseTime: calculateAverageResponseTime(conversations),\n      messageFrequency: calculateMessageFrequency(allMessages)\n    }\n\n    const contactWithStats = {\n      ...contact,\n      stats,\n      conversations: conversations.map(conv => ({\n        ...conv,\n        messageCount: conv.messages?.length || 0,\n        assignedAgent: conv.profiles?.full_name || null\n      }))\n    }\n\n    return createSuccessResponse(contactWithStats)\n\n  } catch (error) {\n    console.error('Error fetching contact:', error)\n    return createErrorResponse(error)\n  }\n}\n\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  // Apply standard API middleware (tenant validation + standard rate limiting)\n  const middlewareResponse = await standardApiMiddleware(request);\n  if (middlewareResponse) return middlewareResponse;\n\n  try {\n    // Get tenant context from middleware (already validated)\n    const { organizationId, userId } = getTenantContext(request);\n    const { id } = await params;\n\n    const body = await request.json()\n    const { name, email, tags, notes, metadata, is_blocked } = body\n\n    const supabase = await createClient()\n\n    // Check if contact exists\n    const { data: existingContact } = await supabase\n      .from('contacts')\n      .select('id')\n      .eq('id', id)\n      .eq('organization_id', organizationId)\n      .single()\n\n    if (!existingContact) {\n      return NextResponse.json(\n        { error: 'Contact not found' },\n        { status: 404 }\n      )\n    }\n\n    // Validate email if provided\n    if (email) {\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\n      if (!emailRegex.test(email)) {\n        return NextResponse.json(\n          { error: 'Invalid email format' },\n          { status: 400 }\n        )\n      }\n    }\n\n    // Update contact\n    const updateData: Record<string, unknown> = {\n      updated_at: new Date().toISOString()\n    }\n\n    if (name !== undefined) updateData.name = name\n    if (email !== undefined) updateData.email = email\n    if (tags !== undefined) updateData.tags = tags\n    if (notes !== undefined) updateData.notes = notes\n    if (is_blocked !== undefined) updateData.is_blocked = is_blocked\n\n    if (metadata !== undefined) {\n      // Merge with existing metadata\n      const { data: current } = await supabase\n        .from('contacts')\n        .select('metadata')\n        .eq('id', id)\n        .single()\n\n      updateData.metadata = {\n        ...(current?.metadata || {}),\n        ...metadata,\n        updated_by: userId,\n        updated_at: new Date().toISOString()\n      }\n    }\n\n    const { data: updatedContact, error } = await supabase\n      .from('contacts')\n      .update(updateData)\n      .eq('id', id)\n      .eq('organization_id', organizationId)\n      .select()\n      .single()\n\n    if (error) {\n      throw error\n    }\n\n    return createSuccessResponse(updatedContact)\n\n  } catch (error) {\n    console.error('Error updating contact:', error)\n    return createErrorResponse(error)\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  // Apply standard API middleware (tenant validation + standard rate limiting)\n  const middlewareResponse = await standardApiMiddleware(request);\n  if (middlewareResponse) return middlewareResponse;\n\n  try {\n    // Get tenant context from middleware (already validated)\n    const { organizationId } = getTenantContext(request);\n    const { id } = await params;\n\n    const supabase = await createClient()\n\n    // Check if contact exists\n    const { data: contact } = await supabase\n      .from('contacts')\n      .select('id, phone_number')\n      .eq('id', id)\n      .eq('organization_id', organizationId)\n      .single()\n\n    if (!contact) {\n      return NextResponse.json(\n        { error: 'Contact not found' },\n        { status: 404 }\n      )\n    }\n\n    // Check if contact has active conversations\n    const { data: activeConversations } = await supabase\n      .from('conversations')\n      .select('id')\n      .eq('contact_id', id)\n      .in('status', ['open', 'pending'])\n\n    if (activeConversations && activeConversations.length > 0) {\n      return NextResponse.json(\n        { error: 'Cannot delete contact with active conversations. Please close all conversations first.' },\n        { status: 400 }\n      )\n    }\n\n    // Delete the contact (this will cascade to related records)\n    const { error } = await supabase\n      .from('contacts')\n      .delete()\n      .eq('id', id)\n      .eq('organization_id', organizationId)\n\n    if (error) {\n      throw error\n    }\n\n    return createSuccessResponse({\n      id: id,\n      message: 'Contact deleted successfully'\n    })\n\n  } catch (error) {\n    console.error('Error deleting contact:', error)\n    return createErrorResponse(error)\n  }\n}\n\ninterface ConversationMessage {\n  created_at: string;\n  sender_type: string;\n}\n\ninterface ConversationWithMessages {\n  messages?: ConversationMessage[];\n}\n\nfunction calculateAverageResponseTime(conversations: ConversationWithMessages[]): number {\n  const responseTimes = []\n\n  for (const conversation of conversations) {\n    const messages = conversation.messages || []\n    const sortedMessages = messages.sort((a, b) =>\n      new Date(a.created_at).getTime() - new Date(b.created_at).getTime()\n    )\n\n    for (let i = 0; i < sortedMessages.length - 1; i++) {\n      const currentMessage = sortedMessages[i]\n      const nextMessage = sortedMessages[i + 1]\n\n      // Calculate response time from contact message to agent message\n      if (currentMessage.sender_type === 'contact' && nextMessage.sender_type === 'agent') {\n        const responseTime = new Date(nextMessage.created_at).getTime() - new Date(currentMessage.created_at).getTime()\n        responseTimes.push(responseTime)\n      }\n    }\n  }\n\n  if (responseTimes.length === 0) return 0\n\n  const averageMs = responseTimes.reduce((sum, time) => sum + time, 0) / responseTimes.length\n  return Math.round(averageMs / (1000 * 60)) // Convert to minutes\n}\n\ninterface Message {\n  created_at: string;\n}\n\nfunction calculateMessageFrequency(messages: Message[]): { daily: number; weekly: number; monthly: number } {\n  if (messages.length === 0) {\n    return { daily: 0, weekly: 0, monthly: 0 }\n  }\n\n  const now = new Date()\n  const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000)\n  const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)\n  const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)\n\n  const dailyMessages = messages.filter(m => new Date(m.created_at) >= oneDayAgo).length\n  const weeklyMessages = messages.filter(m => new Date(m.created_at) >= oneWeekAgo).length\n  const monthlyMessages = messages.filter(m => new Date(m.created_at) >= oneMonthAgo).length\n\n  return {\n    daily: dailyMessages,\n    weekly: weeklyMessages,\n    monthly: monthlyMessages\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}