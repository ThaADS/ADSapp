{"version":3,"names":["cov_9hnoejvr5","actualCoverage","s","POST","request","f","middlewareResponse","_middleware","strictApiMiddleware","b","organizationId","getTenantContext","newPlanId","prorate","json","_server1","SUBSCRIPTION_PLANS","_server","NextResponse","error","status","lifecycleManager","_subscriptionlifecycle","SubscriptionLifecycleManager","result","downgradeSubscription","success","subscription","id","planId","prorationAmount","console","Error","message"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\billing\\downgrade\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@/lib/supabase/server'\nimport { SubscriptionLifecycleManager } from '@/lib/billing/subscription-lifecycle'\nimport { SUBSCRIPTION_PLANS } from '@/lib/stripe/server'\nimport { strictApiMiddleware, getTenantContext } from '@/lib/middleware'\n\nexport async function POST(request: NextRequest) {\n  // Apply strict API middleware (tenant validation + strict rate limiting)\n  const middlewareResponse = await strictApiMiddleware(request);\n  if (middlewareResponse) return middlewareResponse;\n\n  try {\n    // Get tenant context from middleware (already validated)\n    const { organizationId } = getTenantContext(request);\n    const { newPlanId, prorate = true } = await request.json();\n\n    if (!newPlanId || !SUBSCRIPTION_PLANS[newPlanId as keyof typeof SUBSCRIPTION_PLANS]) {\n      return NextResponse.json(\n        { error: 'Invalid plan ID' },\n        { status: 400 }\n      )\n    }\n\n    const lifecycleManager = new SubscriptionLifecycleManager()\n\n    const result = await lifecycleManager.downgradeSubscription(\n      organizationId,\n      newPlanId,\n      { prorate }\n    )\n\n    return NextResponse.json({\n      success: true,\n      subscription: {\n        id: result.subscription.id,\n        status: result.subscription.status,\n        planId: newPlanId,\n      },\n      prorationAmount: result.prorationAmount,\n    })\n  } catch (error) {\n    console.error('Downgrade API error:', error)\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}"],"mappings":"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","ignoreList":[]}