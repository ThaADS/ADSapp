{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\cache\\l1-cache.ts"],"sourcesContent":["/**\n * L1 In-Memory Cache Implementation\n *\n * Fast, local cache layer with automatic TTL management\n * Features:\n * - LRU eviction policy\n * - Automatic TTL cleanup\n * - Memory size management\n * - Hot data optimization\n * - Thread-safe operations\n */\n\nexport interface L1CacheEntry<T> {\n  value: T;\n  expires: number;\n  size: number; // Approximate size in bytes\n  lastAccessed: number;\n}\n\nexport interface L1CacheConfig {\n  maxSize: number; // Maximum cache size in bytes\n  maxEntries: number; // Maximum number of entries\n  defaultTTL: number; // Default TTL in seconds\n  cleanupInterval: number; // Cleanup interval in milliseconds\n  enableStats: boolean; // Enable statistics tracking\n}\n\nexport interface L1CacheStats {\n  hits: number;\n  misses: number;\n  evictions: number;\n  size: number;\n  entries: number;\n  hitRate: number;\n}\n\n/**\n * L1 Cache Implementation with LRU eviction\n */\nexport class L1Cache {\n  private cache: Map<string, L1CacheEntry<any>>;\n  private config: L1CacheConfig;\n  private stats: L1CacheStats;\n  private cleanupTimer: NodeJS.Timeout | null = null;\n  private currentSize: number = 0;\n\n  constructor(config?: Partial<L1CacheConfig>) {\n    this.config = {\n      maxSize: config?.maxSize || 10 * 1024 * 1024, // 10 MB default\n      maxEntries: config?.maxEntries || 1000,\n      defaultTTL: config?.defaultTTL || 60, // 1 minute default\n      cleanupInterval: config?.cleanupInterval || 30000, // 30 seconds\n      enableStats: config?.enableStats ?? true,\n    };\n\n    this.cache = new Map();\n    this.stats = {\n      hits: 0,\n      misses: 0,\n      evictions: 0,\n      size: 0,\n      entries: 0,\n      hitRate: 0,\n    };\n\n    // Start automatic cleanup\n    this.startCleanup();\n  }\n\n  /**\n   * Get value from cache\n   */\n  get<T>(key: string): T | null {\n    const entry = this.cache.get(key);\n\n    // Cache miss\n    if (!entry) {\n      if (this.config.enableStats) {\n        this.stats.misses++;\n        this.updateHitRate();\n      }\n      return null;\n    }\n\n    // Check if expired\n    if (entry.expires < Date.now()) {\n      this.delete(key);\n      if (this.config.enableStats) {\n        this.stats.misses++;\n        this.updateHitRate();\n      }\n      return null;\n    }\n\n    // Cache hit - update last accessed time (LRU)\n    entry.lastAccessed = Date.now();\n    if (this.config.enableStats) {\n      this.stats.hits++;\n      this.updateHitRate();\n    }\n\n    return entry.value as T;\n  }\n\n  /**\n   * Set value in cache\n   */\n  set<T>(key: string, value: T, ttlSeconds?: number): void {\n    const ttl = ttlSeconds || this.config.defaultTTL;\n    const size = this.estimateSize(value);\n\n    // Check if we need to evict entries\n    this.ensureCapacity(size);\n\n    // Delete old entry if exists to update size\n    if (this.cache.has(key)) {\n      const oldEntry = this.cache.get(key)!;\n      this.currentSize -= oldEntry.size;\n    }\n\n    // Create new entry\n    const entry: L1CacheEntry<T> = {\n      value,\n      expires: Date.now() + ttl * 1000,\n      size,\n      lastAccessed: Date.now(),\n    };\n\n    this.cache.set(key, entry);\n    this.currentSize += size;\n\n    // Update stats\n    if (this.config.enableStats) {\n      this.stats.size = this.currentSize;\n      this.stats.entries = this.cache.size;\n    }\n  }\n\n  /**\n   * Delete value from cache\n   */\n  delete(key: string): boolean {\n    const entry = this.cache.get(key);\n    if (entry) {\n      this.currentSize -= entry.size;\n      this.cache.delete(key);\n\n      if (this.config.enableStats) {\n        this.stats.size = this.currentSize;\n        this.stats.entries = this.cache.size;\n      }\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Check if key exists and is not expired\n   */\n  has(key: string): boolean {\n    const entry = this.cache.get(key);\n    if (!entry) return false;\n\n    if (entry.expires < Date.now()) {\n      this.delete(key);\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Clear all cache entries\n   */\n  clear(): void {\n    this.cache.clear();\n    this.currentSize = 0;\n\n    if (this.config.enableStats) {\n      this.stats.size = 0;\n      this.stats.entries = 0;\n    }\n  }\n\n  /**\n   * Get all keys in cache\n   */\n  keys(): string[] {\n    // Filter out expired keys\n    const now = Date.now();\n    const validKeys: string[] = [];\n\n    for (const [key, entry] of this.cache.entries()) {\n      if (entry.expires >= now) {\n        validKeys.push(key);\n      }\n    }\n\n    return validKeys;\n  }\n\n  /**\n   * Get cache statistics\n   */\n  getStats(): L1CacheStats {\n    return { ...this.stats };\n  }\n\n  /**\n   * Reset cache statistics\n   */\n  resetStats(): void {\n    this.stats = {\n      hits: 0,\n      misses: 0,\n      evictions: 0,\n      size: this.currentSize,\n      entries: this.cache.size,\n      hitRate: 0,\n    };\n  }\n\n  /**\n   * Get cache configuration\n   */\n  getConfig(): L1CacheConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Update cache configuration\n   */\n  updateConfig(config: Partial<L1CacheConfig>): void {\n    this.config = { ...this.config, ...config };\n  }\n\n  /**\n   * Cleanup expired entries\n   */\n  private cleanup(): void {\n    const now = Date.now();\n    const keysToDelete: string[] = [];\n\n    for (const [key, entry] of this.cache.entries()) {\n      if (entry.expires < now) {\n        keysToDelete.push(key);\n      }\n    }\n\n    for (const key of keysToDelete) {\n      this.delete(key);\n    }\n\n    if (keysToDelete.length > 0 && this.config.enableStats) {\n      console.log(`[L1 Cache] Cleaned up ${keysToDelete.length} expired entries`);\n    }\n  }\n\n  /**\n   * Start automatic cleanup timer\n   */\n  private startCleanup(): void {\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n    }\n\n    this.cleanupTimer = setInterval(() => {\n      this.cleanup();\n    }, this.config.cleanupInterval);\n  }\n\n  /**\n   * Stop automatic cleanup timer\n   */\n  stopCleanup(): void {\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n      this.cleanupTimer = null;\n    }\n  }\n\n  /**\n   * Ensure cache has capacity for new entry\n   * Evict LRU entries if necessary\n   */\n  private ensureCapacity(newEntrySize: number): void {\n    // Check entry count limit\n    while (this.cache.size >= this.config.maxEntries) {\n      this.evictLRU();\n    }\n\n    // Check size limit\n    while (this.currentSize + newEntrySize > this.config.maxSize) {\n      this.evictLRU();\n    }\n  }\n\n  /**\n   * Evict least recently used entry\n   */\n  private evictLRU(): void {\n    let oldestKey: string | null = null;\n    let oldestTime = Infinity;\n\n    // Find least recently used entry\n    for (const [key, entry] of this.cache.entries()) {\n      if (entry.lastAccessed < oldestTime) {\n        oldestTime = entry.lastAccessed;\n        oldestKey = key;\n      }\n    }\n\n    if (oldestKey) {\n      this.delete(oldestKey);\n      if (this.config.enableStats) {\n        this.stats.evictions++;\n      }\n    }\n  }\n\n  /**\n   * Estimate size of value in bytes\n   */\n  private estimateSize(value: any): number {\n    try {\n      // Rough estimation using JSON serialization\n      const json = JSON.stringify(value);\n      return json.length * 2; // UTF-16 encoding\n    } catch {\n      // Fallback for non-serializable values\n      return 1024; // 1 KB default\n    }\n  }\n\n  /**\n   * Update hit rate calculation\n   */\n  private updateHitRate(): void {\n    const total = this.stats.hits + this.stats.misses;\n    if (total > 0) {\n      this.stats.hitRate = (this.stats.hits / total) * 100;\n    }\n  }\n\n  /**\n   * Destroy cache instance\n   */\n  destroy(): void {\n    this.stopCleanup();\n    this.clear();\n  }\n}\n\n// Global L1 cache instance\nlet globalL1Cache: L1Cache | null = null;\n\n/**\n * Get global L1 cache instance\n */\nexport function getL1Cache(config?: Partial<L1CacheConfig>): L1Cache {\n  if (!globalL1Cache) {\n    globalL1Cache = new L1Cache(config);\n  }\n  return globalL1Cache;\n}\n\n/**\n * Reset global L1 cache instance\n */\nexport function resetL1Cache(): void {\n  if (globalL1Cache) {\n    globalL1Cache.destroy();\n    globalL1Cache = null;\n  }\n}\n\n// Export default instance\nexport default getL1Cache();\n"],"names":["L1Cache","getL1Cache","resetL1Cache","config","cleanupTimer","currentSize","maxSize","maxEntries","defaultTTL","cleanupInterval","enableStats","cache","Map","stats","hits","misses","evictions","size","entries","hitRate","startCleanup","get","key","entry","updateHitRate","expires","Date","now","delete","lastAccessed","value","set","ttlSeconds","ttl","estimateSize","ensureCapacity","has","oldEntry","clear","keys","validKeys","push","getStats","resetStats","getConfig","updateConfig","cleanup","keysToDelete","length","console","log","clearInterval","setInterval","stopCleanup","newEntrySize","evictLRU","oldestKey","oldestTime","Infinity","json","JSON","stringify","total","destroy","globalL1Cache"],"mappings":"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"}