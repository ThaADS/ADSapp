{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\api-utils.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@/lib/supabase/server'\nimport { getUser } from '@/lib/auth'\n\nexport interface ApiError {\n  message: string\n  code: string\n  statusCode: number\n}\n\nexport class ApiException extends Error {\n  public statusCode: number\n  public code: string\n\n  constructor(message: string, statusCode: number = 500, code: string = 'INTERNAL_ERROR') {\n    super(message)\n    this.statusCode = statusCode\n    this.code = code\n    this.name = 'ApiException'\n  }\n}\n\nexport function createErrorResponse(error: unknown): NextResponse {\n  if (error instanceof ApiException) {\n    return NextResponse.json(\n      {\n        error: error.message,\n        code: error.code\n      },\n      { status: error.statusCode }\n    )\n  }\n\n  if (error instanceof Error) {\n    console.error('API Error:', error)\n    return NextResponse.json(\n      {\n        error: 'Internal server error',\n        code: 'INTERNAL_ERROR'\n      },\n      { status: 500 }\n    )\n  }\n\n  return NextResponse.json(\n    {\n      error: 'Unknown error occurred',\n      code: 'UNKNOWN_ERROR'\n    },\n    { status: 500 }\n  )\n}\n\nexport function createSuccessResponse(data: any, statusCode: number = 200): NextResponse {\n  return NextResponse.json({\n    success: true,\n    data\n  }, { status: statusCode })\n}\n\nexport async function validateRequest(request: NextRequest, schema?: any): Promise<any> {\n  const contentType = request.headers.get('content-type')\n\n  if (contentType?.includes('application/json')) {\n    try {\n      const body = await request.json()\n\n      if (schema) {\n        // Add validation logic here if needed\n        // Could integrate with Zod or similar validation library\n      }\n\n      return body\n    } catch (error) {\n      throw new ApiException('Invalid JSON in request body', 400, 'INVALID_JSON')\n    }\n  }\n\n  return null\n}\n\nexport async function requireAuthenticatedUser() {\n  const user = await getUser()\n\n  if (!user) {\n    throw new ApiException('Authentication required', 401, 'UNAUTHORIZED')\n  }\n\n  return user\n}\n\nexport async function getUserOrganization(userId: string) {\n  const supabase = await createClient()\n\n  const { data: profile, error } = await supabase\n    .from('profiles')\n    .select('organization_id, organization:organizations(*)')\n    .eq('id', userId)\n    .single()\n\n  if (error || !profile?.organization_id) {\n    throw new ApiException('No organization found', 404, 'NO_ORGANIZATION')\n  }\n\n  return profile\n}\n\nexport interface RateLimitOptions {\n  windowMs: number // Time window in milliseconds\n  max: number // Maximum requests per window\n  keyGenerator?: (request: NextRequest) => string\n}\n\n// Simple in-memory rate limiter (for production, use Redis)\nconst rateLimitStore = new Map<string, { count: number; resetTime: number }>()\n\nexport function rateLimit(options: RateLimitOptions) {\n  return async (request: NextRequest) => {\n    const key = options.keyGenerator\n      ? options.keyGenerator(request)\n      : request.ip || 'anonymous'\n\n    const now = Date.now()\n    const windowStart = now - options.windowMs\n\n    // Clean up old entries\n    for (const [k, v] of rateLimitStore.entries()) {\n      if (v.resetTime < now) {\n        rateLimitStore.delete(k)\n      }\n    }\n\n    const current = rateLimitStore.get(key)\n\n    if (!current || current.resetTime < now) {\n      rateLimitStore.set(key, {\n        count: 1,\n        resetTime: now + options.windowMs\n      })\n      return true\n    }\n\n    if (current.count >= options.max) {\n      throw new ApiException(\n        'Too many requests',\n        429,\n        'RATE_LIMIT_EXCEEDED'\n      )\n    }\n\n    current.count++\n    return true\n  }\n}\n\nexport function validatePagination(request: NextRequest) {\n  const { searchParams } = new URL(request.url)\n\n  const page = Math.max(1, parseInt(searchParams.get('page') || '1'))\n  const limit = Math.min(100, Math.max(1, parseInt(searchParams.get('limit') || '20')))\n  const offset = (page - 1) * limit\n\n  return { page, limit, offset }\n}\n\nexport function validateSortOrder(request: NextRequest, allowedFields: string[]) {\n  const { searchParams } = new URL(request.url)\n\n  const sortBy = searchParams.get('sortBy') || 'created_at'\n  const sortOrder = searchParams.get('sortOrder') || 'desc'\n\n  if (!allowedFields.includes(sortBy)) {\n    throw new ApiException(\n      `Invalid sort field. Allowed: ${allowedFields.join(', ')}`,\n      400,\n      'INVALID_SORT_FIELD'\n    )\n  }\n\n  if (!['asc', 'desc'].includes(sortOrder)) {\n    throw new ApiException(\n      'Invalid sort order. Must be \"asc\" or \"desc\"',\n      400,\n      'INVALID_SORT_ORDER'\n    )\n  }\n\n  return { sortBy, sortOrder, ascending: sortOrder === 'asc' }\n}\n\n/**\n * Get tenant context from request headers (set by tenant validation middleware)\n *\n * @param request - NextRequest object with tenant context headers\n * @returns Object containing user and organization information\n *\n * @example\n * ```typescript\n * import { getTenantContextFromHeaders } from '@/lib/api-utils';\n *\n * export async function GET(request: NextRequest) {\n *   const { userId, organizationId } = getTenantContextFromHeaders(request);\n *\n *   // Use in database queries\n *   const { data } = await supabase\n *     .from('contacts')\n *     .select('*')\n *     .eq('organization_id', organizationId);\n * }\n * ```\n */\nexport function getTenantContextFromHeaders(request: NextRequest): {\n  userId: string;\n  organizationId: string;\n  userRole: string;\n  userEmail: string;\n  isSuperAdmin: boolean;\n} {\n  return {\n    userId: request.headers.get('x-user-id') || '',\n    organizationId: request.headers.get('x-organization-id') || '',\n    userRole: request.headers.get('x-user-role') || 'agent',\n    userEmail: request.headers.get('x-user-email') || '',\n    isSuperAdmin: request.headers.get('x-is-super-admin') === 'true'\n  };\n}\n\n/**\n * Validate that a requested organization ID matches the user's organization\n * Provides double-check validation after middleware\n *\n * @param requestOrgId - Organization ID from request (query param, body, etc.)\n * @param userOrgId - User's organization ID from tenant context\n * @returns boolean indicating if access is allowed\n *\n * @example\n * ```typescript\n * import { validateOrganizationAccess, getTenantContextFromHeaders } from '@/lib/api-utils';\n *\n * export async function POST(request: NextRequest) {\n *   const { organizationId: userOrgId } = getTenantContextFromHeaders(request);\n *   const body = await request.json();\n *\n *   if (!validateOrganizationAccess(body.organization_id, userOrgId)) {\n *     return NextResponse.json({ error: 'Access denied' }, { status: 403 });\n *   }\n * }\n * ```\n */\nexport async function validateOrganizationAccess(\n  requestOrgId: string | null | undefined,\n  userOrgId: string\n): Promise<boolean> {\n  // If no specific organization requested, allow (will use user's org)\n  if (!requestOrgId) return true;\n\n  // Check if requested organization matches user's organization\n  return requestOrgId === userOrgId;\n}\n\n/**\n * Create a Supabase query builder that automatically scopes to user's organization\n *\n * @param supabase - Supabase client instance\n * @param tableName - Name of the table to query\n * @param organizationId - Organization ID to scope the query to\n * @returns Supabase query builder with organization filter applied\n *\n * @example\n * ```typescript\n * import { createTenantScopedQuery, getTenantContextFromHeaders } from '@/lib/api-utils';\n *\n * export async function GET(request: NextRequest) {\n *   const supabase = await createClient();\n *   const { organizationId } = getTenantContextFromHeaders(request);\n *\n *   // Automatically filters by organization_id\n *   const { data } = await createTenantScopedQuery(supabase, 'contacts', organizationId)\n *     .select('*')\n *     .eq('is_blocked', false);\n * }\n * ```\n */\nexport function createTenantScopedQuery(\n  supabase: any,\n  tableName: string,\n  organizationId: string\n) {\n  return supabase.from(tableName).select('*').eq('organization_id', organizationId);\n}\n\n/**\n * Validate that a resource belongs to the user's organization\n * Use for additional security checks after fetching a resource\n *\n * @param resourceOrgId - Organization ID of the fetched resource\n * @param userOrgId - User's organization ID from tenant context\n * @param isSuperAdmin - Whether the user is a super admin (bypasses check)\n * @returns boolean indicating if access is allowed\n * @throws ApiException if access is denied\n *\n * @example\n * ```typescript\n * import { validateResourceOwnership, getTenantContextFromHeaders } from '@/lib/api-utils';\n *\n * export async function DELETE(request: NextRequest, { params }: { params: { id: string } }) {\n *   const { organizationId, isSuperAdmin } = getTenantContextFromHeaders(request);\n *   const contact = await getContact(params.id);\n *\n *   validateResourceOwnership(contact.organization_id, organizationId, isSuperAdmin);\n *\n *   // Proceed with deletion\n * }\n * ```\n */\nexport function validateResourceOwnership(\n  resourceOrgId: string,\n  userOrgId: string,\n  isSuperAdmin: boolean = false\n): void {\n  // Super admins can access all resources\n  if (isSuperAdmin) return;\n\n  // Check if resource belongs to user's organization\n  if (resourceOrgId !== userOrgId) {\n    throw new ApiException(\n      'Access denied: Resource does not belong to your organization',\n      403,\n      'FORBIDDEN'\n    );\n  }\n}"],"names":["ApiException","createErrorResponse","createSuccessResponse","createTenantScopedQuery","getTenantContextFromHeaders","getUserOrganization","rateLimit","requireAuthenticatedUser","validateOrganizationAccess","validatePagination","validateRequest","validateResourceOwnership","validateSortOrder","Error","message","statusCode","code","name","error","NextResponse","json","status","console","data","success","request","schema","contentType","headers","get","includes","body","user","getUser","userId","supabase","createClient","profile","from","select","eq","single","organization_id","rateLimitStore","Map","options","key","keyGenerator","ip","now","Date","windowStart","windowMs","k","v","entries","resetTime","delete","current","set","count","max","searchParams","URL","url","page","Math","parseInt","limit","min","offset","allowedFields","sortBy","sortOrder","join","ascending","organizationId","userRole","userEmail","isSuperAdmin","requestOrgId","userOrgId","tableName","resourceOrgId"],"mappings":"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"}