{"version":3,"names":["MediaStorageService","constructor","cov_21dhq4bt12","f","s","supabase","_server","createClient","bucketName","uploadFile","file","originalName","mimeType","options","b","maxSize","length","Error","allowedTypes","includes","fileId","_uuid","v4","fileExtension","getFileExtension","fileName","organizationId","data","uploadData","error","uploadError","storage","from","upload","contentType","cacheControl","message","urlData","getPublicUrl","thumbnailUrl","metadata","generateThumbnail","isImageType","getImageMetadata","mediaFile","id","size","url","publicUrl","uploadedBy","dbError","insert","original_name","mime_type","file_size","storage_path","thumbnail_url","organization_id","uploaded_by","remove","console","getFile","select","eq","single","deleteFile","storagePath","storageError","thumbnailPath","delete","listFiles","query","count","ilike","limit","offset","range","order","ascending","files","map","item","total","imageBuffer","originalFileName","thumbnailBuffer","_sharp","default","resize","fit","withoutEnlargement","jpeg","quality","toBuffer","split","width","height","format","hasAlpha","channels","startsWith","extensionFromName","pop","toLowerCase","mimeTypeExtensions","cleanupOrphanedFiles","thirtyDaysAgo","Date","now","toISOString","orphanedFiles","lt","not"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\media\\storage.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/server'\nimport { v4 as uuidv4 } from 'uuid'\nimport sharp from 'sharp'\n\nexport interface MediaFile {\n  id: string\n  originalName: string\n  mimeType: string\n  size: number\n  url: string\n  thumbnailUrl?: string\n  organizationId: string\n  uploadedBy: string\n  metadata?: {\n    width?: number\n    height?: number\n    duration?: number\n    [key: string]: any\n  }\n}\n\nexport interface UploadOptions {\n  organizationId: string\n  uploadedBy: string\n  generateThumbnail?: boolean\n  maxSize?: number // in bytes\n  allowedTypes?: string[]\n}\n\nexport class MediaStorageService {\n  private supabase = createClient()\n  private bucketName = 'media'\n\n  constructor() {\n    this.supabase = createClient()\n  }\n\n  async uploadFile(\n    file: Buffer,\n    originalName: string,\n    mimeType: string,\n    options: UploadOptions\n  ): Promise<MediaFile> {\n    // Validate file size\n    if (options.maxSize && file.length > options.maxSize) {\n      throw new Error(`File size exceeds maximum allowed size of ${options.maxSize} bytes`)\n    }\n\n    // Validate file type\n    if (options.allowedTypes && !options.allowedTypes.includes(mimeType)) {\n      throw new Error(`File type ${mimeType} is not allowed`)\n    }\n\n    const fileId = uuidv4()\n    const fileExtension = this.getFileExtension(originalName, mimeType)\n    const fileName = `${options.organizationId}/${fileId}${fileExtension}`\n\n    try {\n      // Upload original file\n      const { data: uploadData, error: uploadError } = await (await this.supabase).storage\n        .from(this.bucketName)\n        .upload(fileName, file, {\n          contentType: mimeType,\n          cacheControl: '3600'\n        })\n\n      if (uploadError) {\n        throw new Error(`Failed to upload file: ${uploadError.message}`)\n      }\n\n      // Get public URL\n      const { data: urlData } = await (await this.supabase).storage\n        .from(this.bucketName)\n        .getPublicUrl(fileName)\n\n      let thumbnailUrl: string | undefined\n      let metadata: any = {}\n\n      // Generate thumbnail for images\n      if (options.generateThumbnail && this.isImageType(mimeType)) {\n        thumbnailUrl = await this.generateThumbnail(file, fileName, options.organizationId)\n        metadata = await this.getImageMetadata(file)\n      }\n\n      // Store file record in database\n      const mediaFile: MediaFile = {\n        id: fileId,\n        originalName,\n        mimeType,\n        size: file.length,\n        url: urlData.publicUrl,\n        thumbnailUrl,\n        organizationId: options.organizationId,\n        uploadedBy: options.uploadedBy,\n        metadata\n      }\n\n      const { error: dbError } = await (await this.supabase)\n        .from('media_files')\n        .insert({\n          id: fileId,\n          original_name: originalName,\n          mime_type: mimeType,\n          file_size: file.length,\n          storage_path: fileName,\n          url: urlData.publicUrl,\n          thumbnail_url: thumbnailUrl,\n          organization_id: options.organizationId,\n          uploaded_by: options.uploadedBy,\n          metadata\n        })\n\n      if (dbError) {\n        // Clean up uploaded file if database insert fails\n        await (await this.supabase).storage.from(this.bucketName).remove([fileName])\n        throw new Error(`Failed to store file record: ${dbError.message}`)\n      }\n\n      return mediaFile\n    } catch (error) {\n      console.error('Error uploading file:', error)\n      throw error\n    }\n  }\n\n  async getFile(fileId: string, organizationId: string): Promise<MediaFile | null> {\n    const { data, error } = await (await this.supabase)\n      .from('media_files')\n      .select('*')\n      .eq('id', fileId)\n      .eq('organization_id', organizationId)\n      .single()\n\n    if (error || !data) {\n      return null\n    }\n\n    return {\n      id: data.id,\n      originalName: data.original_name,\n      mimeType: data.mime_type,\n      size: data.file_size,\n      url: data.url,\n      thumbnailUrl: data.thumbnail_url,\n      organizationId: data.organization_id,\n      uploadedBy: data.uploaded_by,\n      metadata: data.metadata\n    }\n  }\n\n  async deleteFile(fileId: string, organizationId: string): Promise<void> {\n    const file = await this.getFile(fileId, organizationId)\n    if (!file) {\n      throw new Error('File not found')\n    }\n\n    try {\n      // Extract storage path from URL or construct it\n      const storagePath = `${organizationId}/${fileId}${this.getFileExtension(file.originalName, file.mimeType)}`\n\n      // Delete from storage\n      const { error: storageError } = await (await this.supabase).storage\n        .from(this.bucketName)\n        .remove([storagePath])\n\n      if (storageError) {\n        console.error('Error deleting file from storage:', storageError)\n      }\n\n      // Delete thumbnail if exists\n      if (file.thumbnailUrl) {\n        const thumbnailPath = `${organizationId}/thumbnails/${fileId}.jpg`\n        await (await this.supabase).storage\n          .from(this.bucketName)\n          .remove([thumbnailPath])\n      }\n\n      // Delete from database\n      const { error: dbError } = await (await this.supabase)\n        .from('media_files')\n        .delete()\n        .eq('id', fileId)\n        .eq('organization_id', organizationId)\n\n      if (dbError) {\n        throw new Error(`Failed to delete file record: ${dbError.message}`)\n      }\n    } catch (error) {\n      console.error('Error deleting file:', error)\n      throw error\n    }\n  }\n\n  async listFiles(\n    organizationId: string,\n    options?: {\n      limit?: number\n      offset?: number\n      mimeType?: string\n      uploadedBy?: string\n    }\n  ): Promise<{ files: MediaFile[]; total: number }> {\n    let query = (await this.supabase)\n      .from('media_files')\n      .select('*', { count: 'exact' })\n      .eq('organization_id', organizationId)\n\n    if (options?.mimeType) {\n      query = query.ilike('mime_type', `${options.mimeType}%`)\n    }\n\n    if (options?.uploadedBy) {\n      query = query.eq('uploaded_by', options.uploadedBy)\n    }\n\n    if (options?.limit) {\n      query = query.limit(options.limit)\n    }\n\n    if (options?.offset) {\n      query = query.range(options.offset, (options.offset + (options.limit || 20)) - 1)\n    }\n\n    const { data, error, count } = await query.order('created_at', { ascending: false })\n\n    if (error) {\n      throw new Error(`Failed to list files: ${error.message}`)\n    }\n\n    const files = (data || []).map(item => ({\n      id: item.id,\n      originalName: item.original_name,\n      mimeType: item.mime_type,\n      size: item.file_size,\n      url: item.url,\n      thumbnailUrl: item.thumbnail_url,\n      organizationId: item.organization_id,\n      uploadedBy: item.uploaded_by,\n      metadata: item.metadata\n    }))\n\n    return {\n      files,\n      total: count || 0\n    }\n  }\n\n  private async generateThumbnail(\n    imageBuffer: Buffer,\n    originalFileName: string,\n    organizationId: string\n  ): Promise<string> {\n    try {\n      const thumbnailBuffer = await sharp(imageBuffer)\n        .resize(300, 300, {\n          fit: 'inside',\n          withoutEnlargement: true\n        })\n        .jpeg({ quality: 80 })\n        .toBuffer()\n\n      const fileId = originalFileName.split('/')[1].split('.')[0]\n      const thumbnailPath = `${organizationId}/thumbnails/${fileId}.jpg`\n\n      const { error } = await (await this.supabase).storage\n        .from(this.bucketName)\n        .upload(thumbnailPath, thumbnailBuffer, {\n          contentType: 'image/jpeg',\n          cacheControl: '3600'\n        })\n\n      if (error) {\n        console.error('Error uploading thumbnail:', error)\n        return ''\n      }\n\n      const { data: urlData } = await (await this.supabase).storage\n        .from(this.bucketName)\n        .getPublicUrl(thumbnailPath)\n\n      return urlData.publicUrl\n    } catch (error) {\n      console.error('Error generating thumbnail:', error)\n      return ''\n    }\n  }\n\n  private async getImageMetadata(imageBuffer: Buffer): Promise<any> {\n    try {\n      const metadata = await sharp(imageBuffer).metadata()\n      return {\n        width: metadata.width,\n        height: metadata.height,\n        format: metadata.format,\n        hasAlpha: metadata.hasAlpha,\n        channels: metadata.channels\n      }\n    } catch (error) {\n      console.error('Error getting image metadata:', error)\n      return {}\n    }\n  }\n\n  private isImageType(mimeType: string): boolean {\n    return mimeType.startsWith('image/')\n  }\n\n  private getFileExtension(fileName: string, mimeType: string): string {\n    // Try to get extension from filename\n    const extensionFromName = fileName.split('.').pop()?.toLowerCase()\n    if (extensionFromName && extensionFromName.length <= 4) {\n      return `.${extensionFromName}`\n    }\n\n    // Fallback to mime type mapping\n    const mimeTypeExtensions: { [key: string]: string } = {\n      'image/jpeg': '.jpg',\n      'image/png': '.png',\n      'image/gif': '.gif',\n      'image/webp': '.webp',\n      'video/mp4': '.mp4',\n      'video/quicktime': '.mov',\n      'audio/mpeg': '.mp3',\n      'audio/ogg': '.ogg',\n      'audio/wav': '.wav',\n      'application/pdf': '.pdf',\n      'text/plain': '.txt',\n      'application/json': '.json'\n    }\n\n    return mimeTypeExtensions[mimeType] || ''\n  }\n\n  async cleanupOrphanedFiles(organizationId: string): Promise<void> {\n    // This method can be called periodically to clean up files that are no longer referenced\n    try {\n      // Find files that haven't been accessed in 30 days and aren't referenced in messages\n      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()\n\n      const { data: orphanedFiles } = await (await this.supabase)\n        .from('media_files')\n        .select('id')\n        .eq('organization_id', organizationId)\n        .lt('created_at', thirtyDaysAgo)\n        .not('id', 'in', `(SELECT DISTINCT media_file_id FROM messages WHERE media_file_id IS NOT NULL)`)\n\n      if (orphanedFiles) {\n        for (const file of orphanedFiles) {\n          await this.deleteFile(file.id, organizationId)\n        }\n      }\n    } catch (error) {\n      console.error('Error cleaning up orphaned files:', error)\n    }\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}