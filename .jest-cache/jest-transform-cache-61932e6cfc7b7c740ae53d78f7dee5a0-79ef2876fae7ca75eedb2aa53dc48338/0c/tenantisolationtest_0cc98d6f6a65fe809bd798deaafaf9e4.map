{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\unit\\security\\tenant-isolation.test.ts"],"sourcesContent":["/**\n * Tenant Isolation Security Tests\n *\n * Comprehensive tests for multi-tenant security ensuring complete tenant isolation.\n * Tests cover tenant validation, cross-tenant access prevention, JWT token handling,\n * super admin bypass logic, and tenant context propagation.\n *\n * @module tests/unit/security/tenant-isolation\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport {\n  validateTenantAccess,\n  getTenantContext,\n  isSuperAdmin,\n  validateResourceAccess,\n  TenantContext,\n} from '@/lib/middleware/tenant-validation';\nimport { createClient } from '@/lib/supabase/server';\n\n// Mock Supabase client\njest.mock('@/lib/supabase/server');\njest.mock('@/lib/api-utils');\n\ndescribe('Tenant Isolation Security', () => {\n  const mockCreateClient = createClient as jest.MockedFunction<typeof createClient>;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    // Reset environment\n    process.env.NODE_ENV = 'test';\n  });\n\n  describe('Test 1: Tenant ID Validation in API Middleware', () => {\n    it('should validate tenant ID from authenticated user', async () => {\n      // Arrange\n      const mockUser = {\n        id: 'user-123',\n        email: 'test@example.com',\n        user_metadata: { full_name: 'Test User' },\n      };\n\n      const mockOrganization = {\n        id: 'org-123',\n        organization_id: 'org-123',\n        organization: { role: 'admin' },\n      };\n\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: mockUser },\n            error: null,\n          }),\n        },\n        from: jest.fn(() => ({\n          select: jest.fn().mockReturnThis(),\n          eq: jest.fn().mockReturnThis(),\n          single: jest.fn().mockResolvedValue({\n            data: mockOrganization,\n            error: null,\n          }),\n        })),\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      // Mock getUserOrganization\n      const { getUserOrganization } = await import('@/lib/api-utils');\n      (getUserOrganization as jest.Mock).mockResolvedValue(mockOrganization);\n\n      const request = new NextRequest('http://localhost:3000/api/test');\n\n      // Act\n      const response = await validateTenantAccess(request);\n\n      // Assert\n      expect(response).not.toBeNull();\n      // In Next.js middleware, successful validation modifies headers\n      // Check that auth.getUser was called\n      expect(mockSupabaseClient.auth.getUser).toHaveBeenCalled();\n    });\n\n    it('should return 401 error when user is not authenticated', async () => {\n      // Arrange\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: null },\n            error: { message: 'Not authenticated' },\n          }),\n        },\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      const request = new NextRequest('http://localhost:3000/api/test');\n\n      // Act\n      const response = await validateTenantAccess(request);\n\n      // Assert\n      expect(response).not.toBeNull();\n      if (response instanceof NextResponse) {\n        expect(response.status).toBe(401);\n        const body = await response.json();\n        expect(body.error).toBe('Authentication required');\n        expect(body.code).toBe('UNAUTHORIZED');\n      }\n    });\n\n    it('should return 403 error when user has no organization', async () => {\n      // Arrange\n      const mockUser = {\n        id: 'user-456',\n        email: 'no-org@example.com',\n      };\n\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: mockUser },\n            error: null,\n          }),\n        },\n        from: jest.fn(() => ({\n          select: jest.fn().mockReturnThis(),\n          eq: jest.fn().mockReturnThis(),\n          single: jest.fn().mockResolvedValue({\n            data: null,\n            error: null,\n          }),\n        })),\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      // Mock getUserOrganization to return null\n      const { getUserOrganization } = await import('@/lib/api-utils');\n      (getUserOrganization as jest.Mock).mockResolvedValue(null);\n\n      const request = new NextRequest('http://localhost:3000/api/test');\n\n      // Act\n      const response = await validateTenantAccess(request);\n\n      // Assert\n      expect(response).not.toBeNull();\n      if (response instanceof NextResponse) {\n        expect(response.status).toBe(403);\n        const body = await response.json();\n        expect(body.error).toContain('not associated with any organization');\n        expect(body.code).toBe('NO_ORGANIZATION');\n      }\n    });\n  });\n\n  describe('Test 2: Cross-Tenant Data Access Prevention', () => {\n    it('should block access when user tenant does not match resource tenant', async () => {\n      // Arrange\n      const mockUser = {\n        id: 'user-789',\n        email: 'user@tenant-a.com',\n      };\n\n      const mockOrganization = {\n        id: 'org-a',\n        organization_id: 'org-a',\n        organization: { role: 'agent' },\n      };\n\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: mockUser },\n            error: null,\n          }),\n        },\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      // Mock getUserOrganization\n      const { getUserOrganization } = await import('@/lib/api-utils');\n      (getUserOrganization as jest.Mock).mockResolvedValue(mockOrganization);\n\n      // Create request with different organization ID in header\n      const request = new NextRequest('http://localhost:3000/api/test');\n      request.headers.set('x-organization-id', 'org-b');\n\n      // Act\n      const response = await validateTenantAccess(request);\n\n      // Assert\n      expect(response).not.toBeNull();\n      if (response instanceof NextResponse) {\n        expect(response.status).toBe(403);\n        const body = await response.json();\n        expect(body.error).toContain('Forbidden');\n        expect(body.error).toContain('denied');\n        expect(body.code).toBe('FORBIDDEN');\n      }\n    });\n\n    it('should log security event for cross-tenant access attempts', async () => {\n      // Arrange\n      const consoleSpy = jest.spyOn(console, 'warn').mockImplementation();\n\n      const mockUser = {\n        id: 'user-security-test',\n        email: 'attacker@tenant-x.com',\n      };\n\n      const mockOrganization = {\n        id: 'org-x',\n        organization_id: 'org-x',\n        organization: { role: 'agent' },\n      };\n\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: mockUser },\n            error: null,\n          }),\n        },\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      const { getUserOrganization } = await import('@/lib/api-utils');\n      (getUserOrganization as jest.Mock).mockResolvedValue(mockOrganization);\n\n      const request = new NextRequest('http://localhost:3000/api/sensitive-data');\n      request.headers.set('x-organization-id', 'org-y');\n      request.headers.set('user-agent', 'Test Agent');\n\n      // Act\n      await validateTenantAccess(request);\n\n      // Assert\n      expect(consoleSpy).toHaveBeenCalledWith(\n        '[SECURITY] Cross-tenant access attempt:',\n        expect.objectContaining({\n          userId: 'user-security-test',\n          userOrg: 'org-x',\n          requestedOrg: 'org-y',\n          path: '/api/sensitive-data',\n        })\n      );\n\n      consoleSpy.mockRestore();\n    });\n\n    it('should allow access when tenant IDs match', async () => {\n      // Arrange\n      const mockUser = {\n        id: 'user-valid',\n        email: 'valid@tenant-c.com',\n      };\n\n      const mockOrganization = {\n        id: 'org-c',\n        organization_id: 'org-c',\n        organization: { role: 'admin' },\n      };\n\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: mockUser },\n            error: null,\n          }),\n        },\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      const { getUserOrganization } = await import('@/lib/api-utils');\n      (getUserOrganization as jest.Mock).mockResolvedValue(mockOrganization);\n\n      const request = new NextRequest('http://localhost:3000/api/test');\n      request.headers.set('x-organization-id', 'org-c');\n\n      // Act\n      const response = await validateTenantAccess(request);\n\n      // Assert\n      expect(response).not.toBeNull();\n      expect(mockSupabaseClient.auth.getUser).toHaveBeenCalled();\n    });\n  });\n\n  describe('Test 3: JWT Token Organization ID Extraction', () => {\n    it('should extract organization ID from authenticated user context', async () => {\n      // Arrange\n      const request = new NextRequest('http://localhost:3000/api/test');\n      request.headers.set('x-user-id', 'user-123');\n      request.headers.set('x-organization-id', 'org-123');\n      request.headers.set('x-user-role', 'admin');\n      request.headers.set('x-user-email', 'test@example.com');\n\n      // Act\n      const context = getTenantContext(request);\n\n      // Assert\n      expect(context).toBeDefined();\n      expect(context.userId).toBe('user-123');\n      expect(context.organizationId).toBe('org-123');\n      expect(context.userRole).toBe('admin');\n      expect(context.userEmail).toBe('test@example.com');\n    });\n\n    it('should return empty strings for missing headers', async () => {\n      // Arrange\n      const request = new NextRequest('http://localhost:3000/api/test');\n\n      // Act\n      const context = getTenantContext(request);\n\n      // Assert\n      expect(context.userId).toBe('');\n      expect(context.organizationId).toBe('');\n      expect(context.userRole).toBe('agent'); // Default role\n      expect(context.userEmail).toBe('');\n    });\n\n    it('should handle malformed tenant context headers', async () => {\n      // Arrange\n      const request = new NextRequest('http://localhost:3000/api/test');\n      request.headers.set('x-user-id', '');\n      request.headers.set('x-organization-id', '');\n\n      // Act\n      const context = getTenantContext(request);\n\n      // Assert\n      expect(context.userId).toBe('');\n      expect(context.organizationId).toBe('');\n    });\n  });\n\n  describe('Test 4: Super Admin Bypass Logic', () => {\n    it('should allow super admin to bypass organization requirements', async () => {\n      // Arrange\n      const mockUser = {\n        id: 'super-admin-123',\n        email: 'admin@adsapp.com',\n      };\n\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: mockUser },\n            error: null,\n          }),\n        },\n        from: jest.fn(() => ({\n          select: jest.fn().mockReturnThis(),\n          eq: jest.fn().mockReturnThis(),\n          single: jest.fn().mockResolvedValue({\n            data: { is_super_admin: true, role: 'super_admin' },\n            error: null,\n          }),\n        })),\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      const { getUserOrganization } = await import('@/lib/api-utils');\n      (getUserOrganization as jest.Mock).mockResolvedValue(null);\n\n      const request = new NextRequest('http://localhost:3000/api/admin/test');\n\n      // Act\n      const response = await validateTenantAccess(request);\n\n      // Assert\n      expect(response).not.toBeNull();\n      // Super admin should pass validation\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('profiles');\n    });\n\n    it('should identify super admin from request headers', () => {\n      // Arrange\n      const request = new NextRequest('http://localhost:3000/api/test');\n      request.headers.set('x-is-super-admin', 'true');\n\n      // Act\n      const isSuperAdminUser = isSuperAdmin(request);\n\n      // Assert\n      expect(isSuperAdminUser).toBe(true);\n    });\n\n    it('should return false for non-super-admin users', () => {\n      // Arrange\n      const request = new NextRequest('http://localhost:3000/api/test');\n      request.headers.set('x-is-super-admin', 'false');\n\n      // Act\n      const isSuperAdminUser = isSuperAdmin(request);\n\n      // Assert\n      expect(isSuperAdminUser).toBe(false);\n    });\n\n    it('should allow super admin to access any organization resource', () => {\n      // Arrange\n      const tenantContext: TenantContext = {\n        userId: 'super-admin-456',\n        organizationId: '', // Super admin has no org\n        userRole: 'super_admin',\n        userEmail: 'super@adsapp.com',\n      };\n\n      // Act\n      const hasAccess = validateResourceAccess('any-org-id', tenantContext);\n\n      // Assert\n      expect(hasAccess).toBe(true);\n    });\n  });\n\n  describe('Test 5: Tenant Context Propagation', () => {\n    it('should attach tenant context headers to request', async () => {\n      // Arrange\n      const mockUser = {\n        id: 'user-context-test',\n        email: 'context@tenant-d.com',\n      };\n\n      const mockOrganization = {\n        id: 'org-d',\n        organization_id: 'org-d',\n        organization: { role: 'manager' },\n      };\n\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: mockUser },\n            error: null,\n          }),\n        },\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      const { getUserOrganization } = await import('@/lib/api-utils');\n      (getUserOrganization as jest.Mock).mockResolvedValue(mockOrganization);\n\n      const request = new NextRequest('http://localhost:3000/api/test');\n\n      // Act\n      const response = await validateTenantAccess(request);\n\n      // Assert\n      expect(response).not.toBeNull();\n      expect(mockSupabaseClient.auth.getUser).toHaveBeenCalled();\n    });\n\n    it('should validate resource access with matching organization', () => {\n      // Arrange\n      const tenantContext: TenantContext = {\n        userId: 'user-789',\n        organizationId: 'org-match',\n        userRole: 'agent',\n        userEmail: 'agent@tenant.com',\n      };\n\n      // Act\n      const hasAccess = validateResourceAccess('org-match', tenantContext);\n\n      // Assert\n      expect(hasAccess).toBe(true);\n    });\n\n    it('should deny resource access with non-matching organization', () => {\n      // Arrange\n      const tenantContext: TenantContext = {\n        userId: 'user-999',\n        organizationId: 'org-different',\n        userRole: 'agent',\n        userEmail: 'agent@tenant.com',\n      };\n\n      // Act\n      const hasAccess = validateResourceAccess('org-other', tenantContext);\n\n      // Assert\n      expect(hasAccess).toBe(false);\n    });\n\n    it('should propagate tenant context through middleware chain', async () => {\n      // Arrange\n      const mockUser = {\n        id: 'user-propagation',\n        email: 'propagation@tenant-e.com',\n      };\n\n      const mockOrganization = {\n        id: 'org-e',\n        organization_id: 'org-e',\n        organization: { role: 'agent' },\n      };\n\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockResolvedValue({\n            data: { user: mockUser },\n            error: null,\n          }),\n        },\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      const { getUserOrganization } = await import('@/lib/api-utils');\n      (getUserOrganization as jest.Mock).mockResolvedValue(mockOrganization);\n\n      const request = new NextRequest('http://localhost:3000/api/downstream');\n\n      // Act\n      await validateTenantAccess(request);\n\n      // Assert\n      expect(mockSupabaseClient.auth.getUser).toHaveBeenCalled();\n    });\n\n    it('should handle errors gracefully and return 500', async () => {\n      // Arrange\n      const mockSupabaseClient = {\n        auth: {\n          getUser: jest.fn().mockRejectedValue(new Error('Database connection failed')),\n        },\n      };\n\n      mockCreateClient.mockResolvedValue(mockSupabaseClient as any);\n\n      const consoleSpy = jest.spyOn(console, 'error').mockImplementation();\n\n      const request = new NextRequest('http://localhost:3000/api/test');\n\n      // Act\n      const response = await validateTenantAccess(request);\n\n      // Assert\n      expect(response).not.toBeNull();\n      if (response instanceof NextResponse) {\n        expect(response.status).toBe(500);\n        const body = await response.json();\n        expect(body.error).toContain('Internal server error');\n        expect(body.code).toBe('INTERNAL_ERROR');\n      }\n\n      expect(consoleSpy).toHaveBeenCalledWith(\n        '[TENANT_VALIDATION] Error:',\n        expect.any(Error)\n      );\n\n      consoleSpy.mockRestore();\n    });\n  });\n});\n"],"names":["jest","mock","describe","mockCreateClient","createClient","beforeEach","clearAllMocks","process","env","NODE_ENV","it","mockUser","id","email","user_metadata","full_name","mockOrganization","organization_id","organization","role","mockSupabaseClient","auth","getUser","fn","mockResolvedValue","data","user","error","from","select","mockReturnThis","eq","single","getUserOrganization","request","NextRequest","response","validateTenantAccess","expect","not","toBeNull","toHaveBeenCalled","message","NextResponse","status","toBe","body","json","code","toContain","headers","set","consoleSpy","spyOn","console","mockImplementation","toHaveBeenCalledWith","objectContaining","userId","userOrg","requestedOrg","path","mockRestore","context","getTenantContext","toBeDefined","organizationId","userRole","userEmail","is_super_admin","isSuperAdminUser","isSuperAdmin","tenantContext","hasAccess","validateResourceAccess","mockRejectedValue","Error","any"],"mappings":"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"}