{"version":3,"names":["cov_16wlsq8v2i","actualCoverage","s","POST","request","f","body","json","console","log","whatsappBusinessAccountId","b","organizationName","subdomain","whatsappPhoneNumber","fullName","role","_server","NextResponse","error","status","includes","supabase","_server1","createClient","data","user","authError","auth","getUser","id","email","existingProfile","profileCheckError","from","select","eq","single","code","organization_id","existingOrg","orgCheckError","newOrganization","orgError","insert","name","slug","whatsapp_phone_number_id","whatsapp_business_account_id","subscription_status","subscription_tier","message","updatedProfile","profileError","update","full_name","updated_at","Date","toISOString","delete","success","organization","profile"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\onboarding\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@/lib/supabase/server'\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    console.log('Onboarding request received:', { ...body, whatsappBusinessAccountId: body.whatsappBusinessAccountId ? '[REDACTED]' : null })\n\n    const {\n      organizationName,\n      subdomain,\n      whatsappPhoneNumber,\n      whatsappBusinessAccountId,\n      fullName,\n      role,\n    } = body\n\n    // Validate required fields\n    if (!organizationName || !subdomain || !fullName || !role) {\n      return NextResponse.json(\n        { error: 'Missing required fields: organizationName, subdomain, fullName, and role are required' },\n        { status: 400 }\n      )\n    }\n\n    // Validate role\n    if (!['owner', 'admin', 'agent'].includes(role)) {\n      return NextResponse.json(\n        { error: 'Invalid role. Must be owner, admin, or agent' },\n        { status: 400 }\n      )\n    }\n\n    // Create Supabase client\n    const supabase = await createClient()\n\n    // Get current authenticated user\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n\n    if (authError || !user) {\n      console.error('Auth error:', authError)\n      return NextResponse.json(\n        { error: 'You must be authenticated to complete onboarding' },\n        { status: 401 }\n      )\n    }\n\n    console.log('Authenticated user:', user.id, user.email)\n\n    // Check if user already has an organization\n    const { data: existingProfile, error: profileCheckError } = await supabase\n      .from('profiles')\n      .select('organization_id')\n      .eq('id', user.id)\n      .single()\n\n    if (profileCheckError && profileCheckError.code !== 'PGRST116') {\n      console.error('Profile check error:', profileCheckError)\n      return NextResponse.json(\n        { error: 'Failed to check existing profile' },\n        { status: 500 }\n      )\n    }\n\n    if (existingProfile?.organization_id) {\n      return NextResponse.json(\n        { error: 'You are already part of an organization' },\n        { status: 400 }\n      )\n    }\n\n    // Check if subdomain is already taken\n    const { data: existingOrg, error: orgCheckError } = await supabase\n      .from('organizations')\n      .select('id')\n      .eq('slug', subdomain)\n      .single()\n\n    if (orgCheckError && orgCheckError.code !== 'PGRST116') {\n      console.error('Organization check error:', orgCheckError)\n      return NextResponse.json(\n        { error: 'Failed to validate subdomain' },\n        { status: 500 }\n      )\n    }\n\n    if (existingOrg) {\n      return NextResponse.json(\n        { error: 'This subdomain is already taken. Please choose another one.' },\n        { status: 400 }\n      )\n    }\n\n    // Start transaction: Create organization and update profile\n    console.log('Creating organization...')\n\n    // Step 1: Create organization\n    const { data: newOrganization, error: orgError } = await supabase\n      .from('organizations')\n      .insert({\n        name: organizationName,\n        slug: subdomain,\n        whatsapp_phone_number_id: whatsappPhoneNumber || null,\n        whatsapp_business_account_id: whatsappBusinessAccountId || null,\n        subscription_status: 'trial',\n        subscription_tier: 'starter',\n      })\n      .select()\n      .single()\n\n    if (orgError || !newOrganization) {\n      console.error('Organization creation error:', orgError)\n      return NextResponse.json(\n        { error: `Failed to create organization: ${orgError?.message || 'Unknown error'}` },\n        { status: 500 }\n      )\n    }\n\n    console.log('Organization created:', newOrganization.id)\n\n    // Step 2: Update user profile\n    const { data: updatedProfile, error: profileError } = await supabase\n      .from('profiles')\n      .update({\n        organization_id: newOrganization.id,\n        full_name: fullName,\n        role: role,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', user.id)\n      .select()\n      .single()\n\n    if (profileError) {\n      console.error('Profile update error:', profileError)\n\n      // Rollback: Delete the created organization\n      await supabase\n        .from('organizations')\n        .delete()\n        .eq('id', newOrganization.id)\n\n      return NextResponse.json(\n        { error: `Failed to update profile: ${profileError.message}` },\n        { status: 500 }\n      )\n    }\n\n    console.log('Profile updated successfully')\n\n    // Success response\n    return NextResponse.json({\n      success: true,\n      message: 'Onboarding completed successfully',\n      data: {\n        organization: {\n          id: newOrganization.id,\n          name: newOrganization.name,\n          slug: newOrganization.slug,\n        },\n        profile: {\n          id: updatedProfile.id,\n          full_name: updatedProfile.full_name,\n          role: updatedProfile.role,\n        },\n      },\n    })\n  } catch (error) {\n    console.error('Onboarding API error:', error)\n    return NextResponse.json(\n      { error: 'An unexpected error occurred during onboarding' },\n      { status: 500 }\n    )\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}