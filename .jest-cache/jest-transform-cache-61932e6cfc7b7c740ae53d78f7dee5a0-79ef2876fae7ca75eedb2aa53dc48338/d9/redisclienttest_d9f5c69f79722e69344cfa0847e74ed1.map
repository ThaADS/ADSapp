{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\unit\\cache\\redis-client.test.ts"],"sourcesContent":["/**\n * Redis Client Unit Tests\n *\n * Tests for the Redis client wrapper with Upstash integration.\n * Covers: get, set, delete, key generation, and tenant isolation.\n *\n * @group unit\n * @group cache\n */\n\nimport {\n  getCached,\n  setCached,\n  deleteCached,\n  generateCacheKey,\n  parseCacheKey,\n  initializeRedis,\n  getRedisClient,\n  getCacheStats,\n  resetCacheStats,\n} from '@/lib/cache/redis-client';\nimport { Redis } from '@upstash/redis';\n\n// Mock the Redis client\njest.mock('@upstash/redis');\n\ndescribe('Redis Client', () => {\n  let mockRedis: jest.Mocked<Redis>;\n\n  beforeEach(() => {\n    // Reset all mocks\n    jest.clearAllMocks();\n    resetCacheStats();\n\n    // Create mock Redis instance\n    mockRedis = {\n      get: jest.fn(),\n      set: jest.fn(),\n      del: jest.fn(),\n      exists: jest.fn(),\n      keys: jest.fn(),\n      ping: jest.fn(),\n      mget: jest.fn(),\n      mset: jest.fn(),\n      expire: jest.fn(),\n      ttl: jest.fn(),\n      incrby: jest.fn(),\n      decrby: jest.fn(),\n      flushall: jest.fn(),\n    } as any;\n\n    // Mock Redis constructor\n    (Redis as jest.MockedClass<typeof Redis>).mockImplementation(() => mockRedis);\n\n    // Set test environment variables\n    process.env.UPSTASH_REDIS_REST_URL = 'https://test-redis.upstash.io';\n    process.env.UPSTASH_REDIS_REST_TOKEN = 'test-token-123';\n\n    // Initialize Redis client\n    initializeRedis();\n  });\n\n  afterEach(() => {\n    // Clean up environment\n    delete process.env.UPSTASH_REDIS_REST_URL;\n    delete process.env.UPSTASH_REDIS_REST_TOKEN;\n  });\n\n  // =========================================================================\n  // TEST 1: Get operation with existing key returns cached value\n  // =========================================================================\n  describe('getCached', () => {\n    it('should return cached value when key exists', async () => {\n      // Arrange\n      const testKey = 'org1:users:123:v1';\n      const testValue = { id: '123', name: 'John Doe' };\n      mockRedis.get.mockResolvedValue(testValue);\n\n      // Act\n      const result = await getCached<typeof testValue>(testKey);\n\n      // Assert\n      expect(result).toEqual(testValue);\n      expect(mockRedis.get).toHaveBeenCalledWith(testKey);\n      expect(mockRedis.get).toHaveBeenCalledTimes(1);\n\n      // Verify cache stats\n      const stats = getCacheStats();\n      expect(stats.hits).toBe(1);\n      expect(stats.misses).toBe(0);\n    });\n\n    // =========================================================================\n    // TEST 2: Get operation with non-existent key returns null\n    // =========================================================================\n    it('should return null when key does not exist', async () => {\n      // Arrange\n      const testKey = 'org1:users:999:v1';\n      mockRedis.get.mockResolvedValue(null);\n\n      // Act\n      const result = await getCached(testKey);\n\n      // Assert\n      expect(result).toBeNull();\n      expect(mockRedis.get).toHaveBeenCalledWith(testKey);\n\n      // Verify cache stats\n      const stats = getCacheStats();\n      expect(stats.hits).toBe(0);\n      expect(stats.misses).toBe(1);\n    });\n  });\n\n  // =========================================================================\n  // TEST 3: Set operation with TTL stores data correctly\n  // =========================================================================\n  describe('setCached', () => {\n    it('should store value with TTL', async () => {\n      // Arrange\n      const testKey = 'org1:products:456:v1';\n      const testValue = { id: '456', name: 'Product A', price: 99.99 };\n      const ttl = 300; // 5 minutes\n      mockRedis.set.mockResolvedValue('OK');\n\n      // Act\n      const result = await setCached(testKey, testValue, { ttl });\n\n      // Assert\n      expect(result).toBe(true);\n      expect(mockRedis.set).toHaveBeenCalledWith(\n        testKey,\n        testValue,\n        expect.objectContaining({ ex: ttl })\n      );\n      expect(mockRedis.set).toHaveBeenCalledTimes(1);\n    });\n\n    it('should return false when Redis client is unavailable', async () => {\n      // Arrange\n      const testKey = 'org1:data:test';\n      const testValue = { test: 'data' };\n\n      // Simulate Redis client being null\n      delete process.env.UPSTASH_REDIS_REST_URL;\n      delete process.env.UPSTASH_REDIS_REST_TOKEN;\n\n      // Re-initialize to get null client\n      const client = initializeRedis();\n      expect(client).toBeNull();\n\n      // Act\n      const result = await setCached(testKey, testValue);\n\n      // Assert\n      expect(result).toBe(false);\n    });\n  });\n\n  // =========================================================================\n  // TEST 4: Generate cache key with tenant isolation\n  // =========================================================================\n  describe('generateCacheKey', () => {\n    it('should generate key with tenant, resource, id, and version', () => {\n      // Arrange\n      const tenant = 'org_abc_123';\n      const resource = 'users';\n      const id = 'user_456';\n      const version = 'v1';\n\n      // Act\n      const key = generateCacheKey(tenant, resource, id, version);\n\n      // Assert\n      expect(key).toBe('org_abc_123:users:user_456:v1');\n      expect(key.split(':').length).toBe(4);\n      expect(key.startsWith(tenant)).toBe(true);\n      expect(key.endsWith(version)).toBe(true);\n    });\n\n    it('should generate key without ID when not provided', () => {\n      // Arrange\n      const tenant = 'org_xyz_789';\n      const resource = 'settings';\n      const version = 'v2';\n\n      // Act\n      const key = generateCacheKey(tenant, resource, undefined, version);\n\n      // Assert\n      expect(key).toBe('org_xyz_789:settings:v2');\n      expect(key.split(':').length).toBe(3);\n    });\n\n    it('should ensure tenant isolation by including tenant in key prefix', () => {\n      // Arrange\n      const tenant1 = 'tenant_a';\n      const tenant2 = 'tenant_b';\n      const resource = 'data';\n\n      // Act\n      const key1 = generateCacheKey(tenant1, resource);\n      const key2 = generateCacheKey(tenant2, resource);\n\n      // Assert\n      expect(key1).not.toBe(key2);\n      expect(key1.startsWith('tenant_a:')).toBe(true);\n      expect(key2.startsWith('tenant_b:')).toBe(true);\n    });\n  });\n\n  // =========================================================================\n  // TEST 5: Delete operation removes key from cache\n  // =========================================================================\n  describe('deleteCached', () => {\n    it('should delete key from cache', async () => {\n      // Arrange\n      const testKey = 'org1:sessions:abc123:v1';\n      mockRedis.del.mockResolvedValue(1);\n\n      // Act\n      const result = await deleteCached(testKey);\n\n      // Assert\n      expect(result).toBe(true);\n      expect(mockRedis.del).toHaveBeenCalledWith(testKey);\n      expect(mockRedis.del).toHaveBeenCalledTimes(1);\n    });\n\n    it('should handle deletion of non-existent key gracefully', async () => {\n      // Arrange\n      const testKey = 'org1:nonexistent:999:v1';\n      mockRedis.del.mockResolvedValue(0);\n\n      // Act\n      const result = await deleteCached(testKey);\n\n      // Assert\n      expect(result).toBe(true); // Function still returns true even if key didn't exist\n      expect(mockRedis.del).toHaveBeenCalledWith(testKey);\n    });\n\n    it('should return false when Redis client is unavailable', async () => {\n      // Arrange\n      const testKey = 'org1:data:test';\n\n      // Simulate Redis client being null\n      delete process.env.UPSTASH_REDIS_REST_URL;\n      delete process.env.UPSTASH_REDIS_REST_TOKEN;\n\n      // Re-initialize to get null client\n      const client = initializeRedis();\n      expect(client).toBeNull();\n\n      // Act\n      const result = await deleteCached(testKey);\n\n      // Assert\n      expect(result).toBe(false);\n    });\n  });\n\n  // =========================================================================\n  // BONUS TEST: Parse cache key extracts components correctly\n  // =========================================================================\n  describe('parseCacheKey', () => {\n    it('should parse cache key with all components', () => {\n      // Arrange\n      const key = 'org_123:users:user_456:v1';\n\n      // Act\n      const parsed = parseCacheKey(key);\n\n      // Assert\n      expect(parsed).toEqual({\n        tenant: 'org_123',\n        resource: 'users',\n        id: 'user_456',\n        version: 'v1',\n      });\n    });\n\n    it('should parse cache key without ID', () => {\n      // Arrange\n      const key = 'org_789:settings:v2';\n\n      // Act\n      const parsed = parseCacheKey(key);\n\n      // Assert\n      expect(parsed).toEqual({\n        tenant: 'org_789',\n        resource: 'settings',\n        id: undefined,\n        version: 'v2',\n      });\n    });\n  });\n});\n"],"names":["jest","mock","describe","mockRedis","beforeEach","clearAllMocks","resetCacheStats","get","fn","set","del","exists","keys","ping","mget","mset","expire","ttl","incrby","decrby","flushall","Redis","mockImplementation","process","env","UPSTASH_REDIS_REST_URL","UPSTASH_REDIS_REST_TOKEN","initializeRedis","afterEach","it","testKey","testValue","id","name","mockResolvedValue","result","getCached","expect","toEqual","toHaveBeenCalledWith","toHaveBeenCalledTimes","stats","getCacheStats","hits","toBe","misses","toBeNull","price","setCached","objectContaining","ex","test","client","tenant","resource","version","key","generateCacheKey","split","length","startsWith","endsWith","undefined","tenant1","tenant2","key1","key2","not","deleteCached","parsed","parseCacheKey"],"mappings":"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"}