{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\integration\\api\\auth.test.ts"],"sourcesContent":["/**\n * Authentication API Integration Tests\n *\n * Tests for /api/auth/* endpoints including signin, signup,\n * password reset, and multi-factor authentication.\n */\n\nimport { describe, it, expect, beforeEach, jest } from '@jest/globals'\nimport { NextRequest } from 'next/server'\nimport {\n  mockApiRequest,\n  createAuthenticatedRequest,\n  extractResponseData,\n  expectErrorResponse as expectErrorResponseHelper,\n  expectSuccessResponse as expectSuccessResponseHelper,\n} from '../../utils/api-test-helpers'\nimport {\n  createMockUser,\n  createMockOrganization,\n  createMockSupabaseClient,\n} from '../../utils/test-helpers'\n\n// Mock Next.js and Supabase\njest.mock('@/lib/supabase/server')\njest.mock('next/server')\n\n// Helper to parse Response\nasync function parseResponse(response: any) {\n  const text = await response.text()\n  let data: any\n  try {\n    data = JSON.parse(text)\n  } catch {\n    data = text\n  }\n  return { status: response.status, data, headers: response.headers }\n}\n\n// Helper to expect error response\nfunction expectErrorResponse(data: any, status?: number, message?: string) {\n  expect(data).toHaveProperty('error')\n  if (status) expect(data.statusCode || data.status || status).toBe(status)\n  if (message) expect(data.message || data.error).toContain(message)\n}\n\n// Helper to create mock request\nfunction createMockRequest(method: string, url: string, body?: any, headers?: Record<string, string>) {\n  // Ensure URL is absolute\n  const fullUrl = url.startsWith('http') ? url : `http://localhost:3000${url}`\n  return mockApiRequest({\n    method,\n    url: fullUrl,\n    body,\n    headers,\n  })\n}\n\ndescribe('POST /api/auth/signin', () => {\n  let mockSupabase: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    jest.clearAllMocks()\n  })\n\n  it('should authenticate valid user and return session', async () => {\n    const mockUser = createMockUser()\n    const mockOrg = createMockOrganization({ id: mockUser.organization_id })\n\n    mockSupabase.auth.signInWithPassword = jest.fn().mockResolvedValue({\n      data: {\n        user: { id: mockUser.id, email: mockUser.email },\n        session: { access_token: 'mock-token', refresh_token: 'mock-refresh' },\n      },\n      error: null,\n    })\n\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({\n        data: { ...mockUser, organization: mockOrg },\n        error: null,\n      }),\n    })\n\n    const request = createMockRequest('POST', '/api/auth/signin', {\n      email: mockUser.email,\n      password: 'validpassword123',\n    })\n\n    // Simulate API route handler\n    const response = await simulateSignIn(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data).toHaveProperty('user')\n    expect(data).toHaveProperty('session')\n    expect(data.user.email).toBe(mockUser.email)\n    expect(data.session.access_token).toBe('mock-token')\n  })\n\n  it('should reject invalid credentials', async () => {\n    mockSupabase.auth.signInWithPassword = jest.fn().mockResolvedValue({\n      data: { user: null, session: null },\n      error: { message: 'Invalid login credentials' },\n    })\n\n    const request = createMockRequest('POST', '/api/auth/signin', {\n      email: 'wrong@example.com',\n      password: 'wrongpassword',\n    })\n\n    const response = await simulateSignIn(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(401)\n    expectErrorResponse(data, 401, 'Invalid login credentials')\n  })\n\n  it('should validate email format', async () => {\n    const request = createMockRequest('POST', '/api/auth/signin', {\n      email: 'invalid-email',\n      password: 'password123',\n    })\n\n    const response = await simulateSignIn(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(400)\n    expectErrorResponse(data, 400, 'Invalid email format')\n  })\n\n  it('should require password field', async () => {\n    const request = createMockRequest('POST', '/api/auth/signin', {\n      email: 'test@example.com',\n    })\n\n    const response = await simulateSignIn(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(400)\n    expectErrorResponse(data, 400, 'password')\n  })\n})\n\ndescribe('POST /api/auth/signup', () => {\n  let mockSupabase: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    jest.clearAllMocks()\n  })\n\n  it('should create new user with organization', async () => {\n    const newUser = {\n      email: 'newuser@example.com',\n      password: 'SecurePass123!',\n      full_name: 'New User',\n      organization_name: 'New Organization',\n    }\n\n    mockSupabase.auth.signUp = jest.fn().mockResolvedValue({\n      data: {\n        user: { id: 'new-user-id', email: newUser.email },\n        session: { access_token: 'new-token' },\n      },\n      error: null,\n    })\n\n    mockSupabase.from = jest.fn().mockReturnValue({\n      insert: jest.fn().mockReturnThis(),\n      select: jest.fn().mockReturnThis(),\n      single: jest.fn().mockResolvedValue({\n        data: { id: 'new-org-id', name: newUser.organization_name },\n        error: null,\n      }),\n    })\n\n    const request = createMockRequest('POST', '/api/auth/signup', newUser)\n\n    const response = await simulateSignUp(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(201)\n    expect(data).toHaveProperty('user')\n    expect(data).toHaveProperty('organization')\n    expect(data.user.email).toBe(newUser.email)\n    expect(data.organization.name).toBe(newUser.organization_name)\n  })\n\n  it('should reject duplicate email', async () => {\n    mockSupabase.auth.signUp = jest.fn().mockResolvedValue({\n      data: { user: null, session: null },\n      error: { message: 'User already registered' },\n    })\n\n    const request = createMockRequest('POST', '/api/auth/signup', {\n      email: 'existing@example.com',\n      password: 'password123',\n      full_name: 'Duplicate User',\n      organization_name: 'Test Org',\n    })\n\n    const response = await simulateSignUp(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(409)\n    expectErrorResponse(data, 409, 'already registered')\n  })\n\n  it('should validate password strength', async () => {\n    const request = createMockRequest('POST', '/api/auth/signup', {\n      email: 'test@example.com',\n      password: 'weak',\n      full_name: 'Test User',\n      organization_name: 'Test Org',\n    })\n\n    const response = await simulateSignUp(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(400)\n    expectErrorResponse(data, 400, 'Password must be at least 8 characters')\n  })\n\n  it('should require organization name', async () => {\n    const request = createMockRequest('POST', '/api/auth/signup', {\n      email: 'test@example.com',\n      password: 'SecurePass123!',\n      full_name: 'Test User',\n    })\n\n    const response = await simulateSignUp(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(400)\n    expectErrorResponse(data, 400, 'Organization name is required')\n  })\n})\n\ndescribe('POST /api/auth/forgot-password', () => {\n  let mockSupabase: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    jest.clearAllMocks()\n  })\n\n  it('should send password reset email for valid email', async () => {\n    mockSupabase.auth.resetPasswordForEmail = jest.fn().mockResolvedValue({\n      data: {},\n      error: null,\n    })\n\n    const request = createMockRequest('POST', '/api/auth/forgot-password', {\n      email: 'user@example.com',\n    })\n\n    const response = await simulateForgotPassword(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.message).toContain('Password reset email sent')\n    expect(mockSupabase.auth.resetPasswordForEmail).toHaveBeenCalledWith('user@example.com', expect.any(Object))\n  })\n\n  it('should return success even for non-existent email (security)', async () => {\n    mockSupabase.auth.resetPasswordForEmail = jest.fn().mockResolvedValue({\n      data: {},\n      error: null,\n    })\n\n    const request = createMockRequest('POST', '/api/auth/forgot-password', {\n      email: 'nonexistent@example.com',\n    })\n\n    const response = await simulateForgotPassword(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    // Should return success to prevent email enumeration\n    expect(status).toBe(200)\n    expect(data.message).toContain('Password reset email sent')\n  })\n})\n\ndescribe('POST /api/auth/reset-password', () => {\n  let mockSupabase: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    jest.clearAllMocks()\n  })\n\n  it('should reset password with valid token', async () => {\n    mockSupabase.auth.updateUser = jest.fn().mockResolvedValue({\n      data: { user: { id: 'user-id' } },\n      error: null,\n    })\n\n    const request = createMockRequest('POST', '/api/auth/reset-password', {\n      token: 'valid-reset-token',\n      password: 'NewSecurePass123!',\n    })\n\n    const response = await simulateResetPassword(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.message).toContain('Password updated successfully')\n  })\n\n  it('should reject expired or invalid token', async () => {\n    mockSupabase.auth.updateUser = jest.fn().mockResolvedValue({\n      data: { user: null },\n      error: { message: 'Invalid or expired token' },\n    })\n\n    const request = createMockRequest('POST', '/api/auth/reset-password', {\n      token: 'expired-token',\n      password: 'NewSecurePass123!',\n    })\n\n    const response = await simulateResetPassword(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(400)\n    expectErrorResponse(data, 400, 'Invalid or expired token')\n  })\n})\n\n// =============================================================================\n// Helper Functions to Simulate API Route Handlers\n// =============================================================================\n\nasync function simulateSignIn(request: NextRequest, supabase: any): Promise<any> {\n  try {\n    const body = await request.json()\n    const { email, password } = body\n\n    // Validation\n    if (!email || !password) {\n      return new Response(JSON.stringify({ error: 'Email and password are required' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\n    if (!emailRegex.test(email)) {\n      return new Response(JSON.stringify({ error: 'Invalid email format' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    if (!password) {\n      return new Response(JSON.stringify({ error: 'Password is required' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    // Attempt sign in\n    const { data, error } = await supabase.auth.signInWithPassword({ email, password })\n\n    if (error || !data.session) {\n      return new Response(JSON.stringify({ error: 'Invalid login credentials' }), {\n        status: 401,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    // Get user profile\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('*, organization:organizations(*)')\n      .eq('id', data.user.id)\n      .single()\n\n    return new Response(\n      JSON.stringify({\n        user: { ...data.user, ...profile },\n        session: data.session,\n      }),\n      {\n        status: 200,\n        headers: { 'Content-Type': 'application/json' },\n      }\n    )\n  } catch (error: any) {\n    return new Response(JSON.stringify({ error: error.message }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' },\n    })\n  }\n}\n\nasync function simulateSignUp(request: NextRequest, supabase: any): Promise<any> {\n  try {\n    const body = await request.json()\n    const { email, password, full_name, organization_name } = body\n\n    // Validation\n    if (!email || !password || !full_name || !organization_name) {\n      let errorMsg = 'Missing required fields: '\n      if (!email) errorMsg += 'email '\n      if (!password) errorMsg += 'password '\n      if (!full_name) errorMsg += 'full_name '\n      if (!organization_name) errorMsg += 'Organization name is required'\n\n      return new Response(JSON.stringify({ error: errorMsg }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    if (password.length < 8) {\n      return new Response(JSON.stringify({ error: 'Password must be at least 8 characters' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    // Attempt sign up\n    const { data, error } = await supabase.auth.signUp({ email, password })\n\n    if (error) {\n      const status = error.message.includes('already registered') ? 409 : 400\n      return new Response(JSON.stringify({ error: error.message }), {\n        status,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    // Create organization\n    const { data: org } = await supabase\n      .from('organizations')\n      .insert({ name: organization_name })\n      .select()\n      .single()\n\n    return new Response(\n      JSON.stringify({\n        user: data.user,\n        organization: org,\n        session: data.session,\n      }),\n      {\n        status: 201,\n        headers: { 'Content-Type': 'application/json' },\n      }\n    )\n  } catch (error: any) {\n    return new Response(JSON.stringify({ error: error.message }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' },\n    })\n  }\n}\n\nasync function simulateForgotPassword(request: NextRequest, supabase: any): Promise<any> {\n  try {\n    const body = await request.json()\n    const { email } = body\n\n    if (!email) {\n      return new Response(JSON.stringify({ error: 'Email is required' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    await supabase.auth.resetPasswordForEmail(email, {\n      redirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/auth/reset-password`,\n    })\n\n    // Always return success (security best practice)\n    return new Response(\n      JSON.stringify({ message: 'Password reset email sent if account exists' }),\n      {\n        status: 200,\n        headers: { 'Content-Type': 'application/json' },\n      }\n    )\n  } catch (error: any) {\n    return new Response(JSON.stringify({ error: error.message }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' },\n    })\n  }\n}\n\nasync function simulateResetPassword(request: NextRequest, supabase: any): Promise<any> {\n  try {\n    const body = await request.json()\n    const { token, password } = body\n\n    if (!token || !password) {\n      return new Response(JSON.stringify({ error: 'Token and password are required' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    const { data, error } = await supabase.auth.updateUser({ password })\n\n    if (error) {\n      return new Response(JSON.stringify({ error: error.message }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      })\n    }\n\n    return new Response(\n      JSON.stringify({ message: 'Password updated successfully' }),\n      {\n        status: 200,\n        headers: { 'Content-Type': 'application/json' },\n      }\n    )\n  } catch (error: any) {\n    return new Response(JSON.stringify({ error: error.message }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' },\n    })\n  }\n}\n"],"names":["jest","mock","parseResponse","response","text","data","JSON","parse","status","headers","expectErrorResponse","message","expect","toHaveProperty","statusCode","toBe","error","toContain","createMockRequest","method","url","body","fullUrl","startsWith","mockApiRequest","describe","mockSupabase","beforeEach","createMockSupabaseClient","clearAllMocks","it","mockUser","createMockUser","mockOrg","createMockOrganization","id","organization_id","auth","signInWithPassword","fn","mockResolvedValue","user","email","session","access_token","refresh_token","from","mockReturnValue","select","mockReturnThis","eq","single","organization","request","password","simulateSignIn","newUser","full_name","organization_name","signUp","insert","name","simulateSignUp","resetPasswordForEmail","simulateForgotPassword","toHaveBeenCalledWith","any","Object","updateUser","token","simulateResetPassword","supabase","json","Response","stringify","emailRegex","test","profile","errorMsg","length","includes","org","redirectTo","process","env","NEXT_PUBLIC_APP_URL"],"mappings":"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"}