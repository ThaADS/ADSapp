{"version":3,"names":["cov_2aml7mj6mf","actualCoverage","s","PaymentMethodManager","attachPaymentMethod","organizationId","paymentMethodId","options","b","f","supabase","data","org","from","select","eq","single","stripe_customer_id","Error","paymentMethod","_server1","stripe","paymentMethods","attach","customer","setAsDefault","customers","update","invoice_settings","default_payment_method","is_default","paymentMethodData","formatPaymentMethodData","upsert","createSetupIntent","setupIntent","setupIntents","create","usage","confirm","confirmationMethod","metadata","toString","clientSecret","client_secret","setupIntentId","id","handleSetupIntentSucceeded","payment_method","handlePaymentMethodAttached","getOrganizationFromCustomer","handlePaymentMethodDetached","is_active","updated_at","Date","toISOString","detachPaymentMethod","paymentMethodRecord","otherMethods","neq","limit","length","setDefaultPaymentMethod","stripe_payment_method_id","detach","getPaymentMethods","order","ascending","updatePaymentMethod","updates","updateData","expiryMonth","expiryYear","card","exp_month","exp_year","Object","keys","expiry_month","expiry_year","recordPaymentFailure","failure","failure_count","then","last_failure","code","message","timestamp","setupPaymentRetryStrategy","strategy","organization_id","enabled","max_retries","maxRetries","retry_intervals","retryIntervals","fallback_methods","fallbackMethods","notify_customer","notifyCustomer","getPaymentRetryStrategy","processFailedPaymentRetry","invoiceId","attemptNumber","activeMethods","filter","pm","isActive","failureCount","methodsToTry","isDefault","method","result","attemptInvoicePayment","stripePaymentMethodId","error","console","validatePaymentMethod","retrieve","issues","now","currentYear","getFullYear","currentMonth","getMonth","push","expiryDate","twoMonthsFromNow","setMonth","valid","getPaymentMethodAnalytics","methods","totalMethods","defaultMethod","failureRate","methodTypes","recentFailures","m","find","totalFailures","reduce","sum","acc","type","thirtyDaysAgo","setDate","getDate","stripePaymentMethod","baseData","customer_id","created_at","created","brand","last4","country","us_bank_account","bank_name","customerId","invoice","invoices","pay","status","_server","createClient"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\billing\\payment-methods.ts"],"sourcesContent":["import Stripe from 'stripe'\nimport { createClient } from '@/lib/supabase/server'\nimport { stripe } from '@/lib/stripe/server'\n\nexport interface PaymentMethodData {\n  id: string\n  organizationId: string\n  stripePaymentMethodId: string\n  customerId: string\n  type: 'card' | 'bank_account' | 'sepa_debit' | 'us_bank_account'\n  brand?: string\n  last4: string\n  expiryMonth?: number\n  expiryYear?: number\n  country?: string\n  isDefault: boolean\n  isActive: boolean\n  failureCount: number\n  lastFailure?: {\n    code: string\n    message: string\n    timestamp: string\n  }\n  createdAt: string\n  updatedAt: string\n}\n\nexport interface PaymentMethodSetupOptions {\n  setAsDefault?: boolean\n  confirmationMethod?: 'automatic' | 'manual'\n  usage?: 'off_session' | 'on_session'\n  metadata?: Record<string, string>\n}\n\nexport interface PaymentRetryStrategy {\n  enabled: boolean\n  maxRetries: number\n  retryIntervals: number[] // in hours\n  fallbackMethods: string[] // payment method IDs to try\n  notifyCustomer: boolean\n}\n\nexport class PaymentMethodManager {\n  private supabase = createClient()\n\n  async attachPaymentMethod(\n    organizationId: string,\n    paymentMethodId: string,\n    options: PaymentMethodSetupOptions = {}\n  ): Promise<PaymentMethodData> {\n    const supabase = await this.supabase\n\n    // Get organization's customer ID\n    const { data: org } = await supabase\n      .from('organizations')\n      .select('stripe_customer_id')\n      .eq('id', organizationId)\n      .single()\n\n    if (!org?.stripe_customer_id) {\n      throw new Error('Organization does not have a Stripe customer')\n    }\n\n    // Attach payment method to customer\n    const paymentMethod = await stripe.paymentMethods.attach(paymentMethodId, {\n      customer: org.stripe_customer_id,\n    })\n\n    // Set as default if requested\n    if (options.setAsDefault) {\n      await stripe.customers.update(org.stripe_customer_id, {\n        invoice_settings: {\n          default_payment_method: paymentMethodId,\n        },\n      })\n\n      // Update existing default payment methods\n      await supabase\n        .from('payment_methods')\n        .update({ is_default: false })\n        .eq('organization_id', organizationId)\n        .eq('is_default', true)\n    }\n\n    // Create local record\n    const paymentMethodData = this.formatPaymentMethodData(\n      paymentMethod,\n      organizationId,\n      options.setAsDefault || false\n    )\n\n    await supabase\n      .from('payment_methods')\n      .upsert(paymentMethodData)\n\n    return paymentMethodData\n  }\n\n  async createSetupIntent(\n    organizationId: string,\n    options: PaymentMethodSetupOptions = {}\n  ): Promise<{ clientSecret: string; setupIntentId: string }> {\n    const supabase = await this.supabase\n\n    // Get organization's customer ID\n    const { data: org } = await supabase\n      .from('organizations')\n      .select('stripe_customer_id')\n      .eq('id', organizationId)\n      .single()\n\n    if (!org?.stripe_customer_id) {\n      throw new Error('Organization does not have a Stripe customer')\n    }\n\n    const setupIntent = await stripe.setupIntents.create({\n      customer: org.stripe_customer_id,\n      usage: options.usage || 'off_session',\n      confirm: options.confirmationMethod === 'automatic',\n      metadata: {\n        organizationId,\n        setAsDefault: options.setAsDefault?.toString() || 'false',\n        ...options.metadata,\n      },\n    })\n\n    return {\n      clientSecret: setupIntent.client_secret!,\n      setupIntentId: setupIntent.id,\n    }\n  }\n\n  async handleSetupIntentSucceeded(setupIntent: Stripe.SetupIntent): Promise<void> {\n    const organizationId = setupIntent.metadata.organizationId\n    const setAsDefault = setupIntent.metadata.setAsDefault === 'true'\n\n    if (!organizationId || !setupIntent.payment_method) {\n      return\n    }\n\n    await this.attachPaymentMethod(\n      organizationId,\n      setupIntent.payment_method as string,\n      { setAsDefault }\n    )\n  }\n\n  async handlePaymentMethodAttached(paymentMethod: Stripe.PaymentMethod): Promise<void> {\n    const supabase = await this.supabase\n\n    // Get organization from customer\n    const organizationId = await this.getOrganizationFromCustomer(paymentMethod.customer as string)\n    if (!organizationId) return\n\n    const paymentMethodData = this.formatPaymentMethodData(paymentMethod, organizationId, false)\n\n    await supabase\n      .from('payment_methods')\n      .upsert(paymentMethodData)\n  }\n\n  async handlePaymentMethodDetached(paymentMethod: Stripe.PaymentMethod): Promise<void> {\n    const supabase = await this.supabase\n\n    await supabase\n      .from('payment_methods')\n      .update({\n        is_active: false,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('stripe_payment_method_id', paymentMethod.id)\n  }\n\n  async detachPaymentMethod(organizationId: string, paymentMethodId: string): Promise<void> {\n    const supabase = await this.supabase\n\n    // Get payment method\n    const { data: paymentMethodRecord } = await supabase\n      .from('payment_methods')\n      .select('stripe_payment_method_id, is_default')\n      .eq('id', paymentMethodId)\n      .eq('organization_id', organizationId)\n      .single()\n\n    if (!paymentMethodRecord) {\n      throw new Error('Payment method not found')\n    }\n\n    // Check if this is the default method\n    if (paymentMethodRecord.is_default) {\n      // Check if there are other payment methods to set as default\n      const { data: otherMethods } = await supabase\n        .from('payment_methods')\n        .select('stripe_payment_method_id')\n        .eq('organization_id', organizationId)\n        .eq('is_active', true)\n        .neq('id', paymentMethodId)\n        .limit(1)\n\n      if (otherMethods?.length) {\n        // Set another method as default\n        await this.setDefaultPaymentMethod(organizationId, otherMethods[0].stripe_payment_method_id)\n      }\n    }\n\n    // Detach from Stripe\n    await stripe.paymentMethods.detach(paymentMethodRecord.stripe_payment_method_id)\n\n    // Update local record\n    await supabase\n      .from('payment_methods')\n      .update({\n        is_active: false,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', paymentMethodId)\n  }\n\n  async setDefaultPaymentMethod(organizationId: string, paymentMethodId: string): Promise<void> {\n    const supabase = await this.supabase\n\n    // Get organization and payment method\n    const { data: org } = await supabase\n      .from('organizations')\n      .select('stripe_customer_id')\n      .eq('id', organizationId)\n      .single()\n\n    if (!org?.stripe_customer_id) {\n      throw new Error('Organization does not have a Stripe customer')\n    }\n\n    // Update Stripe customer default payment method\n    await stripe.customers.update(org.stripe_customer_id, {\n      invoice_settings: {\n        default_payment_method: paymentMethodId,\n      },\n    })\n\n    // Update local records\n    await supabase\n      .from('payment_methods')\n      .update({ is_default: false })\n      .eq('organization_id', organizationId)\n\n    await supabase\n      .from('payment_methods')\n      .update({ is_default: true })\n      .eq('organization_id', organizationId)\n      .eq('stripe_payment_method_id', paymentMethodId)\n  }\n\n  async getPaymentMethods(organizationId: string): Promise<PaymentMethodData[]> {\n    const supabase = await this.supabase\n\n    const { data: paymentMethods } = await supabase\n      .from('payment_methods')\n      .select('*')\n      .eq('organization_id', organizationId)\n      .eq('is_active', true)\n      .order('is_default', { ascending: false })\n      .order('created_at', { ascending: false })\n\n    return paymentMethods || []\n  }\n\n  async updatePaymentMethod(\n    organizationId: string,\n    paymentMethodId: string,\n    updates: {\n      expiryMonth?: number\n      expiryYear?: number\n      metadata?: Record<string, string>\n    }\n  ): Promise<void> {\n    const supabase = await this.supabase\n\n    // Get payment method\n    const { data: paymentMethodRecord } = await supabase\n      .from('payment_methods')\n      .select('stripe_payment_method_id')\n      .eq('id', paymentMethodId)\n      .eq('organization_id', organizationId)\n      .single()\n\n    if (!paymentMethodRecord) {\n      throw new Error('Payment method not found')\n    }\n\n    // Update in Stripe\n    const updateData: any = {}\n    if (updates.expiryMonth || updates.expiryYear) {\n      updateData.card = {\n        exp_month: updates.expiryMonth,\n        exp_year: updates.expiryYear,\n      }\n    }\n    if (updates.metadata) {\n      updateData.metadata = updates.metadata\n    }\n\n    if (Object.keys(updateData).length > 0) {\n      await stripe.paymentMethods.update(paymentMethodRecord.stripe_payment_method_id, updateData)\n    }\n\n    // Update local record\n    await supabase\n      .from('payment_methods')\n      .update({\n        expiry_month: updates.expiryMonth,\n        expiry_year: updates.expiryYear,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', paymentMethodId)\n  }\n\n  async recordPaymentFailure(\n    paymentMethodId: string,\n    failure: { code: string; message: string }\n  ): Promise<void> {\n    const supabase = await this.supabase\n\n    await supabase\n      .from('payment_methods')\n      .update({\n        failure_count: supabase.from('payment_methods').select('failure_count').then(data => (data || 0) + 1),\n        last_failure: {\n          code: failure.code,\n          message: failure.message,\n          timestamp: new Date().toISOString(),\n        },\n        updated_at: new Date().toISOString(),\n      })\n      .eq('stripe_payment_method_id', paymentMethodId)\n  }\n\n  async setupPaymentRetryStrategy(\n    organizationId: string,\n    strategy: PaymentRetryStrategy\n  ): Promise<void> {\n    const supabase = await this.supabase\n\n    await supabase\n      .from('payment_retry_strategies')\n      .upsert({\n        organization_id: organizationId,\n        enabled: strategy.enabled,\n        max_retries: strategy.maxRetries,\n        retry_intervals: strategy.retryIntervals,\n        fallback_methods: strategy.fallbackMethods,\n        notify_customer: strategy.notifyCustomer,\n        updated_at: new Date().toISOString(),\n      })\n  }\n\n  async getPaymentRetryStrategy(organizationId: string): Promise<PaymentRetryStrategy | null> {\n    const supabase = await this.supabase\n\n    const { data: strategy } = await supabase\n      .from('payment_retry_strategies')\n      .select('*')\n      .eq('organization_id', organizationId)\n      .single()\n\n    if (!strategy) return null\n\n    return {\n      enabled: strategy.enabled,\n      maxRetries: strategy.max_retries,\n      retryIntervals: strategy.retry_intervals,\n      fallbackMethods: strategy.fallback_methods,\n      notifyCustomer: strategy.notify_customer,\n    }\n  }\n\n  async processFailedPaymentRetry(\n    organizationId: string,\n    invoiceId: string,\n    attemptNumber: number\n  ): Promise<boolean> {\n    const strategy = await this.getPaymentRetryStrategy(organizationId)\n\n    if (!strategy?.enabled || attemptNumber > strategy.maxRetries) {\n      return false\n    }\n\n    const paymentMethods = await this.getPaymentMethods(organizationId)\n    const activeMethods = paymentMethods.filter(pm => pm.isActive && pm.failureCount < 3)\n\n    if (activeMethods.length === 0) {\n      return false\n    }\n\n    // Try primary method first, then fallback methods\n    const methodsToTry = [\n      ...activeMethods.filter(pm => pm.isDefault),\n      ...activeMethods.filter(pm => !pm.isDefault),\n    ]\n\n    for (const method of methodsToTry) {\n      try {\n        // Attempt payment with this method\n        const result = await this.attemptInvoicePayment(invoiceId, method.stripePaymentMethodId)\n        if (result) {\n          return true\n        }\n      } catch (error) {\n        console.error(`Payment attempt failed with method ${method.id}:`, error)\n        await this.recordPaymentFailure(method.stripePaymentMethodId, {\n          code: 'payment_failed',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        })\n      }\n    }\n\n    return false\n  }\n\n  async validatePaymentMethod(paymentMethodId: string): Promise<{\n    valid: boolean\n    issues: string[]\n  }> {\n    try {\n      const paymentMethod = await stripe.paymentMethods.retrieve(paymentMethodId)\n      const issues: string[] = []\n\n      if (paymentMethod.card) {\n        // Check expiry\n        const now = new Date()\n        const currentYear = now.getFullYear()\n        const currentMonth = now.getMonth() + 1\n\n        if (paymentMethod.card.exp_year < currentYear ||\n            (paymentMethod.card.exp_year === currentYear && paymentMethod.card.exp_month < currentMonth)) {\n          issues.push('Card has expired')\n        }\n\n        // Check for upcoming expiry (next 2 months)\n        const expiryDate = new Date(paymentMethod.card.exp_year, paymentMethod.card.exp_month - 1)\n        const twoMonthsFromNow = new Date()\n        twoMonthsFromNow.setMonth(twoMonthsFromNow.getMonth() + 2)\n\n        if (expiryDate <= twoMonthsFromNow) {\n          issues.push('Card expires soon')\n        }\n      }\n\n      return {\n        valid: issues.length === 0,\n        issues,\n      }\n    } catch (error) {\n      return {\n        valid: false,\n        issues: ['Payment method not found or invalid'],\n      }\n    }\n  }\n\n  async getPaymentMethodAnalytics(organizationId: string): Promise<{\n    totalMethods: number\n    activeMethods: number\n    defaultMethod: PaymentMethodData | null\n    failureRate: number\n    methodTypes: Record<string, number>\n    recentFailures: number\n  }> {\n    const supabase = await this.supabase\n\n    const { data: methods } = await supabase\n      .from('payment_methods')\n      .select('*')\n      .eq('organization_id', organizationId)\n\n    if (!methods?.length) {\n      return {\n        totalMethods: 0,\n        activeMethods: 0,\n        defaultMethod: null,\n        failureRate: 0,\n        methodTypes: {},\n        recentFailures: 0,\n      }\n    }\n\n    const activeMethods = methods.filter(m => m.is_active)\n    const defaultMethod = methods.find(m => m.is_default) || null\n    const totalFailures = methods.reduce((sum, m) => sum + m.failure_count, 0)\n    const failureRate = totalFailures / methods.length\n\n    const methodTypes = methods.reduce((acc, method) => {\n      acc[method.type] = (acc[method.type] || 0) + 1\n      return acc\n    }, {} as Record<string, number>)\n\n    // Count recent failures (last 30 days)\n    const thirtyDaysAgo = new Date()\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)\n\n    const recentFailures = methods.filter(m =>\n      m.last_failure && new Date(m.last_failure.timestamp) >= thirtyDaysAgo\n    ).length\n\n    return {\n      totalMethods: methods.length,\n      activeMethods: activeMethods.length,\n      defaultMethod,\n      failureRate,\n      methodTypes,\n      recentFailures,\n    }\n  }\n\n  // Private helper methods\n  private formatPaymentMethodData(\n    stripePaymentMethod: Stripe.PaymentMethod,\n    organizationId: string,\n    isDefault: boolean\n  ): Partial<PaymentMethodData> {\n    const baseData = {\n      organization_id: organizationId,\n      stripe_payment_method_id: stripePaymentMethod.id,\n      customer_id: stripePaymentMethod.customer as string,\n      type: stripePaymentMethod.type as PaymentMethodData['type'],\n      is_default: isDefault,\n      is_active: true,\n      failure_count: 0,\n      created_at: new Date(stripePaymentMethod.created * 1000).toISOString(),\n      updated_at: new Date().toISOString(),\n    }\n\n    if (stripePaymentMethod.card) {\n      return {\n        ...baseData,\n        brand: stripePaymentMethod.card.brand,\n        last4: stripePaymentMethod.card.last4,\n        expiry_month: stripePaymentMethod.card.exp_month,\n        expiry_year: stripePaymentMethod.card.exp_year,\n        country: stripePaymentMethod.card.country,\n      }\n    }\n\n    if (stripePaymentMethod.us_bank_account) {\n      return {\n        ...baseData,\n        last4: stripePaymentMethod.us_bank_account.last4,\n        brand: stripePaymentMethod.us_bank_account.bank_name,\n      }\n    }\n\n    return baseData\n  }\n\n  private async getOrganizationFromCustomer(customerId: string): Promise<string | null> {\n    const supabase = await this.supabase\n    const { data } = await supabase\n      .from('organizations')\n      .select('id')\n      .eq('stripe_customer_id', customerId)\n      .single()\n\n    return data?.id || null\n  }\n\n  private async attemptInvoicePayment(invoiceId: string, paymentMethodId: string): Promise<boolean> {\n    try {\n      const invoice = await stripe.invoices.pay(invoiceId, {\n        payment_method: paymentMethodId,\n      })\n\n      return invoice.status === 'paid'\n    } catch (error) {\n      console.error('Invoice payment attempt failed:', error)\n      return false\n    }\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}