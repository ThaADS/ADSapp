{"version":3,"names":["cov_1lpk6vqs2f","actualCoverage","s","processEmailNotification","getResendClient","f","apiKey","process","env","RESEND_API_KEY","b","Error","_resend","Resend","getSenderEmail","organizationId","supabase","_server","createClient","data","org","from","select","eq","single","settings","orgSenderEmail","sender_email","defaultSender","RESEND_FROM_EMAIL","sendEmail","resend","recipient","subject","htmlContent","textContent","replyTo","attachments","emailData","to","email","html","text","reply_to","map","att","filename","content","Buffer","content_type","contentType","Object","keys","forEach","key","undefined","response","emails","send","error","message","success","emailId","id","errorMessage","console","batchSendEmails","recipients","onProgress","results","sentCount","failedCount","failedEmails","batchSize","delayBetweenBatches","i","length","batch","slice","sendPromises","batchResults","Promise","all","result","index","push","Math","min","resolve","setTimeout","job","startTime","Date","now","userId","emailType","metadata","log","senderEmail","current","total","progress","round","updateProgress","endTime","duration","insert","job_id","toString","job_type","organization_id","user_id","status","email_type","sent","failed","error_details","failed_emails","started_at","toISOString","completed_at","jobId","totalRecipients","startedAt","completedAt"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\queue\\processors\\email-notification-processor.ts"],"sourcesContent":["import { Job } from 'bullmq';\nimport { Resend } from 'resend';\nimport { createClient } from '@/lib/supabase/server';\n\n/**\n * Email Notification Processor\n *\n * Handles email notifications via Resend API.\n * Supports batch sending, delivery tracking, and retry logic.\n *\n * Features:\n * - Resend email integration\n * - Batch email sending with rate limiting\n * - Delivery status tracking\n * - HTML and text email support\n * - Retry on failures\n * - Multi-tenant email isolation\n *\n * @module email-notification-processor\n */\n\n/**\n * Email recipient\n */\nexport interface EmailRecipient {\n  email: string;\n  name?: string;\n}\n\n/**\n * Email notification job data\n */\nexport interface EmailNotificationJobData {\n  organizationId: string;\n  userId: string;\n  emailType:\n    | 'welcome'\n    | 'password_reset'\n    | 'notification'\n    | 'campaign'\n    | 'system';\n  recipients: EmailRecipient[];\n  subject: string;\n  htmlContent?: string;\n  textContent?: string;\n  replyTo?: string;\n  attachments?: Array<{\n    filename: string;\n    content: string; // Base64 encoded\n    contentType: string;\n  }>;\n  metadata?: Record<string, any>;\n}\n\n/**\n * Email notification job result\n */\nexport interface EmailNotificationJobResult {\n  jobId: string;\n  organizationId: string;\n  emailType: string;\n  totalRecipients: number;\n  sentCount: number;\n  failedCount: number;\n  failedEmails: Array<{\n    email: string;\n    error: string;\n  }>;\n  startedAt: string;\n  completedAt: string;\n  duration: number;\n}\n\n/**\n * Initialize Resend client\n */\nfunction getResendClient(): Resend {\n  const apiKey = process.env.RESEND_API_KEY;\n\n  if (!apiKey) {\n    throw new Error('RESEND_API_KEY environment variable is not set');\n  }\n\n  return new Resend(apiKey);\n}\n\n/**\n * Get sender email from environment or organization config\n */\nasync function getSenderEmail(organizationId: string): Promise<string> {\n  // Try to get organization-specific sender\n  const supabase = await createClient();\n\n  const { data: org } = await supabase\n    .from('organizations')\n    .select('settings')\n    .eq('id', organizationId)\n    .single();\n\n  const settings = org?.settings as { sender_email?: string } | null;\n  const orgSenderEmail = settings?.sender_email;\n\n  if (orgSenderEmail) {\n    return orgSenderEmail;\n  }\n\n  // Fall back to default sender\n  const defaultSender =\n    process.env.RESEND_FROM_EMAIL || 'notifications@adsapp.com';\n  return defaultSender;\n}\n\n/**\n * Send a single email via Resend\n */\nasync function sendEmail(\n  resend: Resend,\n  from: string,\n  recipient: EmailRecipient,\n  subject: string,\n  htmlContent?: string,\n  textContent?: string,\n  replyTo?: string,\n  attachments?: Array<{\n    filename: string;\n    content: string;\n    contentType: string;\n  }>\n): Promise<{ success: boolean; error?: string; emailId?: string }> {\n  try {\n    const emailData: any = {\n      from,\n      to: recipient.email,\n      subject,\n      html: htmlContent,\n      text: textContent,\n      reply_to: replyTo,\n      attachments: attachments?.map((att) => ({\n        filename: att.filename,\n        content: Buffer.from(att.content, 'base64'),\n        content_type: att.contentType\n      }))\n    };\n\n    // Remove undefined fields\n    Object.keys(emailData).forEach(\n      (key) => emailData[key] === undefined && delete emailData[key]\n    );\n\n    const response = await resend.emails.send(emailData);\n\n    if (response.error) {\n      throw new Error(response.error.message);\n    }\n\n    return {\n      success: true,\n      emailId: response.data?.id\n    };\n  } catch (error) {\n    const errorMessage =\n      error instanceof Error ? error.message : 'Unknown error';\n    console.error(`Failed to send email to ${recipient.email}:`, errorMessage);\n    return { success: false, error: errorMessage };\n  }\n}\n\n/**\n * Batch send emails with rate limiting\n */\nasync function batchSendEmails(\n  resend: Resend,\n  from: string,\n  recipients: EmailRecipient[],\n  subject: string,\n  htmlContent?: string,\n  textContent?: string,\n  replyTo?: string,\n  attachments?: Array<{\n    filename: string;\n    content: string;\n    contentType: string;\n  }>,\n  onProgress?: (current: number, total: number) => void\n): Promise<{\n  sentCount: number;\n  failedCount: number;\n  failedEmails: Array<{ email: string; error: string }>;\n}> {\n  const results = {\n    sentCount: 0,\n    failedCount: 0,\n    failedEmails: [] as Array<{ email: string; error: string }>\n  };\n\n  // Resend rate limit: 10 emails/second\n  const batchSize = 10;\n  const delayBetweenBatches = 1000; // 1 second\n\n  for (let i = 0; i < recipients.length; i += batchSize) {\n    const batch = recipients.slice(i, i + batchSize);\n\n    // Send batch in parallel\n    const sendPromises = batch.map((recipient) =>\n      sendEmail(\n        resend,\n        from,\n        recipient,\n        subject,\n        htmlContent,\n        textContent,\n        replyTo,\n        attachments\n      )\n    );\n\n    const batchResults = await Promise.all(sendPromises);\n\n    // Process results\n    batchResults.forEach((result, index) => {\n      const recipient = batch[index];\n\n      if (result.success) {\n        results.sentCount++;\n      } else {\n        results.failedCount++;\n        results.failedEmails.push({\n          email: recipient.email,\n          error: result.error || 'Unknown error'\n        });\n      }\n    });\n\n    // Update progress\n    if (onProgress) {\n      onProgress(Math.min(i + batchSize, recipients.length), recipients.length);\n    }\n\n    // Rate limiting delay (except for last batch)\n    if (i + batchSize < recipients.length) {\n      await new Promise((resolve) => setTimeout(resolve, delayBetweenBatches));\n    }\n  }\n\n  return results;\n}\n\n/**\n * Email notification processor function\n */\nexport async function processEmailNotification(\n  job: Job<EmailNotificationJobData>\n): Promise<EmailNotificationJobResult> {\n  const startTime = Date.now();\n  const {\n    organizationId,\n    userId,\n    emailType,\n    recipients,\n    subject,\n    htmlContent,\n    textContent,\n    replyTo,\n    attachments,\n    metadata\n  } = job.data;\n\n  console.log(\n    `[EmailNotification] Starting job ${job.id} for ${recipients.length} recipients`\n  );\n\n  try {\n    // Initialize Resend client\n    const resend = getResendClient();\n\n    // Get sender email\n    const senderEmail = await getSenderEmail(organizationId);\n\n    // Send emails in batches with progress tracking\n    const results = await batchSendEmails(\n      resend,\n      senderEmail,\n      recipients,\n      subject,\n      htmlContent,\n      textContent,\n      replyTo,\n      attachments,\n      async (current, total) => {\n        const progress = Math.round((current / total) * 100);\n        await job.updateProgress(progress);\n        console.log(\n          `[EmailNotification] Job ${job.id}: ${current}/${total} sent`\n        );\n      }\n    );\n\n    const endTime = Date.now();\n    const duration = endTime - startTime;\n\n    // Log job completion to database\n    const supabase = await createClient();\n    await supabase.from('job_logs').insert({\n      job_id: job.id?.toString(),\n      job_type: 'email_notification',\n      organization_id: organizationId,\n      user_id: userId,\n      status: results.failedCount === 0 ? 'completed' : 'partial_success',\n      result: {\n        email_type: emailType,\n        total: recipients.length,\n        sent: results.sentCount,\n        failed: results.failedCount,\n        duration: duration\n      },\n      error_details:\n        results.failedEmails.length > 0\n          ? { failed_emails: results.failedEmails }\n          : null,\n      started_at: new Date(startTime).toISOString(),\n      completed_at: new Date(endTime).toISOString()\n    });\n\n    console.log(\n      `[EmailNotification] Job ${job.id} completed: ${results.sentCount} sent, ${results.failedCount} failed, ${duration}ms`\n    );\n\n    return {\n      jobId: job.id?.toString() || '',\n      organizationId,\n      emailType,\n      totalRecipients: recipients.length,\n      sentCount: results.sentCount,\n      failedCount: results.failedCount,\n      failedEmails: results.failedEmails,\n      startedAt: new Date(startTime).toISOString(),\n      completedAt: new Date(endTime).toISOString(),\n      duration\n    };\n  } catch (error) {\n    const endTime = Date.now();\n    const duration = endTime - startTime;\n\n    // Log failure\n    const supabase = await createClient();\n    await supabase.from('job_logs').insert({\n      job_id: job.id?.toString(),\n      job_type: 'email_notification',\n      organization_id: organizationId,\n      user_id: userId,\n      status: 'failed',\n      result: {\n        email_type: emailType,\n        total: recipients.length,\n        sent: 0,\n        failed: recipients.length,\n        duration: duration\n      },\n      error_details: {\n        error: error instanceof Error ? error.message : 'Unknown error'\n      },\n      started_at: new Date(startTime).toISOString(),\n      completed_at: new Date(endTime).toISOString()\n    });\n\n    throw error;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}