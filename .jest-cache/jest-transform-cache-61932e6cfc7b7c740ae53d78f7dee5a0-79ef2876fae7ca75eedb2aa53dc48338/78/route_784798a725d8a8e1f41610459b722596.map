{"version":3,"names":["POST","request","cov_d0lc204p9","f","s","user","_apiutils","requireAuthenticatedUser","profile","getUserOrganization","id","body","json","fileId","operations","b","_server","NextResponse","error","status","mediaStorage","_storage","MediaStorageService","file","getFile","organization_id","mimeType","startsWith","response","fetch","url","originalBuffer","Buffer","from","arrayBuffer","processedBuffer","processor","_sharp","default","operation","type","resize","width","height","fit","withoutEnlargement","extract","left","top","rotate","angle","blur","sigma","sharpen","grayscale","format","jpeg","quality","png","webp","text","svgText","fontFamily","fontSize","color","opacity","textBuffer","composite","input","gravity","position","toBuffer","processedFile","uploadFile","originalName","organizationId","uploadedBy","generateThumbnail","createSuccessResponse","originalFile","console","createErrorResponse"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\media\\process\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { requireAuthenticatedUser, getUserOrganization, createErrorResponse, createSuccessResponse } from '@/lib/api-utils'\nimport { MediaStorageService } from '@/lib/media/storage'\nimport sharp from 'sharp'\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Authenticate user\n    const user = await requireAuthenticatedUser()\n    const profile = await getUserOrganization(user.id)\n\n    const body = await request.json()\n    const { fileId, operations } = body\n\n    if (!fileId || !operations) {\n      return NextResponse.json(\n        { error: 'File ID and operations are required' },\n        { status: 400 }\n      )\n    }\n\n    const mediaStorage = new MediaStorageService()\n    const file = await mediaStorage.getFile(fileId, profile.organization_id)\n\n    if (!file) {\n      return NextResponse.json(\n        { error: 'File not found' },\n        { status: 404 }\n      )\n    }\n\n    // Only process image files\n    if (!file.mimeType.startsWith('image/')) {\n      return NextResponse.json(\n        { error: 'File must be an image' },\n        { status: 400 }\n      )\n    }\n\n    // Download original file\n    const response = await fetch(file.url)\n    const originalBuffer = Buffer.from(await response.arrayBuffer())\n\n    let processedBuffer = originalBuffer\n    let processor = sharp(originalBuffer)\n\n    // Apply operations\n    for (const operation of operations) {\n      switch (operation.type) {\n        case 'resize':\n          processor = processor.resize(operation.width, operation.height, {\n            fit: operation.fit || 'cover',\n            withoutEnlargement: operation.withoutEnlargement || false\n          })\n          break\n\n        case 'crop':\n          processor = processor.extract({\n            left: operation.left,\n            top: operation.top,\n            width: operation.width,\n            height: operation.height\n          })\n          break\n\n        case 'rotate':\n          processor = processor.rotate(operation.angle)\n          break\n\n        case 'blur':\n          processor = processor.blur(operation.sigma || 1)\n          break\n\n        case 'sharpen':\n          processor = processor.sharpen()\n          break\n\n        case 'grayscale':\n          processor = processor.grayscale()\n          break\n\n        case 'format':\n          switch (operation.format) {\n            case 'jpeg':\n              processor = processor.jpeg({ quality: operation.quality || 80 })\n              break\n            case 'png':\n              processor = processor.png({ quality: operation.quality || 80 })\n              break\n            case 'webp':\n              processor = processor.webp({ quality: operation.quality || 80 })\n              break\n          }\n          break\n\n        case 'watermark':\n          if (operation.text) {\n            // Text watermark\n            const svgText = `\n              <svg width=\"${operation.width || 200}\" height=\"${operation.height || 50}\">\n                <text x=\"50%\" y=\"50%\" text-anchor=\"middle\" dominant-baseline=\"middle\"\n                      font-family=\"${operation.fontFamily || 'Arial'}\"\n                      font-size=\"${operation.fontSize || 16}\"\n                      fill=\"${operation.color || 'white'}\"\n                      opacity=\"${operation.opacity || 0.5}\">\n                  ${operation.text}\n                </text>\n              </svg>\n            `\n            const textBuffer = Buffer.from(svgText)\n            processor = processor.composite([{\n              input: textBuffer,\n              gravity: operation.position || 'southeast'\n            }])\n          }\n          break\n      }\n    }\n\n    // Process the image\n    processedBuffer = await processor.toBuffer()\n\n    // Upload processed file\n    const processedFile = await mediaStorage.uploadFile(\n      processedBuffer,\n      `processed_${file.originalName}`,\n      file.mimeType,\n      {\n        organizationId: profile.organization_id,\n        uploadedBy: user.id,\n        generateThumbnail: true\n      }\n    )\n\n    return createSuccessResponse({\n      originalFile: file,\n      processedFile,\n      operations\n    })\n\n  } catch (error) {\n    console.error('Media processing error:', error)\n    return createErrorResponse(error)\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}