{"version":3,"names":["createTenantScope","cov_wre5m29gw","f","s","getTenantContext","isSuperAdmin","validateResourceAccess","validateTenantAccess","request","supabase","_server1","createClient","data","user","error","authError","auth","getUser","b","_server","NextResponse","json","code","status","userOrg","_apiutils","getUserOrganization","id","organization_id","profile","from","select","eq","single","is_super_admin","requestHeaders","Headers","headers","set","email","next","requestedOrgId","get","nextUrl","searchParams","securityEvent","userId","requestedOrg","path","pathname","method","timestamp","Date","toISOString","ip","getClientIp","userAgent","console","warn","process","env","NODE_ENV","Sentry","Promise","resolve","then","_interop_require_wildcard","require","captureMessage","level","extra","orgRole","organization","String","role","captureException","tags","middleware","sentryError","organizationId","userRole","userEmail","resourceOrgId","tenantContext","forwarded","realIp","cfConnectingIp","vercelIp","split","trim","query"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\middleware\\tenant-validation.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\nimport { getUserOrganization } from '@/lib/api-utils';\n\n/**\n * Tenant Context Type for API routes\n * Contains authenticated user and organization information\n */\nexport interface TenantContext {\n  userId: string;\n  organizationId: string;\n  userRole: string;\n  userEmail: string;\n}\n\n/**\n * Security Event Log for cross-tenant access attempts\n */\ninterface SecurityEvent {\n  userId: string;\n  userOrg: string;\n  requestedOrg: string | null;\n  path: string;\n  method: string;\n  timestamp: string;\n  ip: string;\n  userAgent: string;\n}\n\n/**\n * Tenant Validation Middleware\n * Ensures all API requests are scoped to the authenticated user's organization\n *\n * Security Features:\n * - Validates user authentication via Supabase JWT\n * - Verifies user-organization relationship\n * - Prevents cross-tenant data access\n * - Logs security events for monitoring\n * - Attaches tenant context to request headers\n *\n * Usage in API routes:\n * ```typescript\n * import { validateTenantAccess, getTenantContext } from '@/lib/middleware/tenant-validation';\n *\n * export async function GET(request: NextRequest) {\n *   const validation = await validateTenantAccess(request);\n *   if (validation) return validation; // Return error response if validation fails\n *\n *   const { organizationId, userId } = getTenantContext(request);\n *   // Use organizationId to scope database queries\n * }\n * ```\n */\nexport async function validateTenantAccess(request: NextRequest): Promise<NextResponse | null> {\n  try {\n    const supabase = await createClient();\n\n    // 1. Verify user authentication\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json(\n        {\n          error: 'Authentication required',\n          code: 'UNAUTHORIZED'\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Get user's organization and profile\n    const userOrg = await getUserOrganization(user.id);\n\n    if (!userOrg || !userOrg.organization_id) {\n      // Check if user is super admin - they don't need organization\n      const { data: profile } = await supabase\n        .from('profiles')\n        .select('is_super_admin, role')\n        .eq('id', user.id)\n        .single();\n\n      if (profile?.is_super_admin) {\n        // Super admins bypass organization requirements\n        const requestHeaders = new Headers(request.headers);\n        requestHeaders.set('x-user-id', user.id);\n        requestHeaders.set('x-user-role', 'super_admin');\n        requestHeaders.set('x-is-super-admin', 'true');\n        requestHeaders.set('x-user-email', user.email || '');\n\n        return NextResponse.next({\n          request: { headers: requestHeaders }\n        });\n      }\n\n      return NextResponse.json(\n        {\n          error: 'User not associated with any organization',\n          code: 'NO_ORGANIZATION'\n        },\n        { status: 403 }\n      );\n    }\n\n    // 3. Validate tenant context from request\n    // Check for organization ID in headers or query parameters\n    const requestedOrgId = request.headers.get('x-organization-id') ||\n                          request.nextUrl.searchParams.get('organization_id');\n\n    // 4. Cross-tenant access prevention\n    if (requestedOrgId && requestedOrgId !== userOrg.organization_id) {\n      // Log cross-tenant access attempt for security monitoring\n      const securityEvent: SecurityEvent = {\n        userId: user.id,\n        userOrg: userOrg.organization_id,\n        requestedOrg: requestedOrgId,\n        path: request.nextUrl.pathname,\n        method: request.method,\n        timestamp: new Date().toISOString(),\n        ip: getClientIp(request),\n        userAgent: request.headers.get('user-agent') || 'unknown'\n      };\n\n      // Log to console (in production, send to security monitoring service)\n      console.warn('[SECURITY] Cross-tenant access attempt:', securityEvent);\n\n      // Send to Sentry for alerting\n      if (process.env.NODE_ENV === 'production') {\n        try {\n          const Sentry = await import('@sentry/nextjs');\n          Sentry.captureMessage('Cross-tenant access attempt', {\n            level: 'warning',\n            extra: {\n              userId: securityEvent.userId,\n              userOrg: securityEvent.userOrg,\n              requestedOrg: securityEvent.requestedOrg,\n              path: securityEvent.path,\n              method: securityEvent.method,\n              timestamp: securityEvent.timestamp,\n              ip: securityEvent.ip,\n              userAgent: securityEvent.userAgent\n            }\n          });\n        } catch (error) {\n          console.error('Failed to log security event to Sentry:', error);\n        }\n      }\n\n      return NextResponse.json(\n        {\n          error: 'Forbidden: Access to this organization denied',\n          code: 'FORBIDDEN'\n        },\n        { status: 403 }\n      );\n    }\n\n    // 5. Attach tenant context to request headers for downstream use\n    const requestHeaders = new Headers(request.headers);\n    requestHeaders.set('x-user-id', user.id);\n    requestHeaders.set('x-organization-id', userOrg.organization_id);\n\n    // Type guard for organization role\n    const orgRole = userOrg.organization &&\n                    typeof userOrg.organization === 'object' &&\n                    'role' in userOrg.organization\n      ? String(userOrg.organization.role)\n      : 'agent';\n\n    requestHeaders.set('x-user-role', orgRole);\n    requestHeaders.set('x-user-email', user.email || '');\n    requestHeaders.set('x-is-super-admin', 'false');\n\n    // Return modified request with tenant context\n    return NextResponse.next({\n      request: { headers: requestHeaders }\n    });\n\n  } catch (error) {\n    console.error('[TENANT_VALIDATION] Error:', error);\n\n    // Log error to monitoring service\n    if (process.env.NODE_ENV === 'production') {\n      try {\n        const Sentry = await import('@sentry/nextjs');\n        Sentry.captureException(error, {\n          tags: {\n            middleware: 'tenant-validation'\n          }\n        });\n      } catch (sentryError) {\n        console.error('Failed to log error to Sentry:', sentryError);\n      }\n    }\n\n    // Return 500 error for unexpected failures\n    return NextResponse.json(\n      {\n        error: 'Internal server error during tenant validation',\n        code: 'INTERNAL_ERROR'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Extract tenant context from request headers\n * Use this in API routes after validateTenantAccess middleware\n *\n * @param request - NextRequest object with tenant context headers\n * @returns TenantContext object with user and organization information\n *\n * @example\n * ```typescript\n * const { organizationId, userId, userRole } = getTenantContext(request);\n *\n * // Use organizationId to scope database queries\n * const { data } = await supabase\n *   .from('contacts')\n *   .select('*')\n *   .eq('organization_id', organizationId);\n * ```\n */\nexport function getTenantContext(request: NextRequest): TenantContext {\n  return {\n    userId: request.headers.get('x-user-id') || '',\n    organizationId: request.headers.get('x-organization-id') || '',\n    userRole: request.headers.get('x-user-role') || 'agent',\n    userEmail: request.headers.get('x-user-email') || ''\n  };\n}\n\n/**\n * Check if the current user is a super admin\n * Super admins bypass organization requirements\n *\n * @param request - NextRequest object with tenant context headers\n * @returns boolean indicating if user is super admin\n */\nexport function isSuperAdmin(request: NextRequest): boolean {\n  return request.headers.get('x-is-super-admin') === 'true';\n}\n\n/**\n * Validate that a resource belongs to the user's organization\n * Use this for additional validation in API routes\n *\n * @param resourceOrgId - Organization ID of the resource being accessed\n * @param tenantContext - Tenant context from request\n * @returns boolean indicating if access is allowed\n *\n * @example\n * ```typescript\n * const contact = await getContact(contactId);\n * const context = getTenantContext(request);\n *\n * if (!validateResourceAccess(contact.organization_id, context)) {\n *   return NextResponse.json({ error: 'Access denied' }, { status: 403 });\n * }\n * ```\n */\nexport function validateResourceAccess(\n  resourceOrgId: string,\n  tenantContext: TenantContext\n): boolean {\n  // Super admins can access all resources\n  if (!tenantContext.organizationId && tenantContext.userRole === 'super_admin') {\n    return true;\n  }\n\n  // Regular users can only access resources in their organization\n  return resourceOrgId === tenantContext.organizationId;\n}\n\n/**\n * Helper function to get client IP address\n * Handles various proxy headers (Vercel, Cloudflare, etc.)\n *\n * @param request - NextRequest object\n * @returns Client IP address or 'unknown'\n */\nfunction getClientIp(request: NextRequest): string {\n  const forwarded = request.headers.get('x-forwarded-for');\n  const realIp = request.headers.get('x-real-ip');\n  const cfConnectingIp = request.headers.get('cf-connecting-ip');\n  const vercelIp = request.headers.get('x-vercel-forwarded-for');\n\n  return (\n    cfConnectingIp ||\n    vercelIp ||\n    forwarded?.split(',')[0].trim() ||\n    realIp ||\n    'unknown'\n  );\n}\n\n/**\n * Supabase Query Builder Interface\n * Minimal interface for tenant scoping\n */\ninterface SupabaseQueryBuilder {\n  eq(column: string, value: string): SupabaseQueryBuilder;\n}\n\n/**\n * Create a tenant-aware database query modifier\n * Automatically adds organization_id filter to queries\n *\n * @param organizationId - Organization ID to filter by\n * @returns Function that modifies Supabase query builder\n *\n * @example\n * ```typescript\n * const context = getTenantContext(request);\n * const scopeToOrg = createTenantScope(context.organizationId);\n *\n * const { data } = await supabase\n *   .from('contacts')\n *   .select('*')\n *   .modify(scopeToOrg); // Automatically adds .eq('organization_id', organizationId)\n * ```\n */\nexport function createTenantScope(organizationId: string) {\n  return (query: SupabaseQueryBuilder) => query.eq('organization_id', organizationId);\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}