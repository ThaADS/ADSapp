{"version":3,"names":["cov_16s8ksit8j","actualCoverage","s","POST","request","f","middlewareResponse","_middleware","strictApiMiddleware","b","organizationId","userId","userRole","getTenantContext","supabase","_server1","createClient","body","json","planId","_server2","SUBSCRIPTION_PLANS","_server","NextResponse","error","status","includes","data","organization","from","select","eq","single","user","auth","getUser","email","customerId","StripeService","createCustomer","name","session","createCheckoutSession","url","console"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\billing\\checkout\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { requireAuth } from '@/lib/auth'\nimport { createClient } from '@/lib/supabase/server'\nimport { StripeService, SUBSCRIPTION_PLANS } from '@/lib/stripe/server'\nimport { strictApiMiddleware, getTenantContext } from '@/lib/middleware'\n\nexport async function POST(request: NextRequest) {\n  // Apply strict API middleware (tenant validation + strict rate limiting)\n  const middlewareResponse = await strictApiMiddleware(request);\n  if (middlewareResponse) return middlewareResponse;\n\n  try {\n    // Get tenant context from middleware (already validated)\n    const { organizationId, userId, userRole } = getTenantContext(request);\n    const supabase = await createClient();\n\n    const body = await request.json();\n    const { planId } = body;\n\n    // Validate plan\n    if (!planId || !SUBSCRIPTION_PLANS[planId as keyof typeof SUBSCRIPTION_PLANS]) {\n      return NextResponse.json({ error: 'Invalid plan' }, { status: 400 })\n    }\n\n    // Check if user is owner or admin\n    if (!['owner', 'admin'].includes(userRole)) {\n      return NextResponse.json({ error: 'Unauthorized - Owner or Admin role required' }, { status: 403 })\n    }\n\n    // Get organization details\n    const { data: organization } = await supabase\n      .from('organizations')\n      .select('name, billing_email')\n      .eq('id', organizationId)\n      .single();\n\n    if (!organization) {\n      return NextResponse.json({ error: 'Organization not found' }, { status: 404 })\n    }\n\n    // Get user email for Stripe\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user?.email) {\n      return NextResponse.json({ error: 'User email not found' }, { status: 400 })\n    }\n\n    // Create or get Stripe customer\n    const customerId = await StripeService.createCustomer(\n      organizationId,\n      user.email,\n      organization.name\n    );\n\n    // Create checkout session\n    const session = await StripeService.createCheckoutSession(\n      organizationId,\n      planId,\n      customerId\n    );\n\n    return NextResponse.json({ url: session.url })\n  } catch (error) {\n    console.error('Checkout error:', error)\n    return NextResponse.json(\n      { error: 'Failed to create checkout session' },\n      { status: 500 }\n    )\n  }\n}"],"mappings":"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","ignoreList":[]}