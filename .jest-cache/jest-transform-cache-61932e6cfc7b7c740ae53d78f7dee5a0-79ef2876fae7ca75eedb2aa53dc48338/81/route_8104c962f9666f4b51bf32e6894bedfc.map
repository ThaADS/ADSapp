{"version":3,"names":["cov_1kpinula8z","actualCoverage","s","GET","request","f","supabase","_server1","createClient","data","user","error","authError","auth","getUser","b","_server","NextResponse","json","status","profile","from","select","eq","id","single","organization_id","includes","role","queueManager","_queuemanager","getQueueManager","stats","getAllQueueStatistics","jobLogs","logsError","order","ascending","limit","console","aggregatedStats","total","completed","failed","running","byType","forEach","log","job_type","success","queueStats","historicalStats","recentJobs","slice","details","Error","message"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\jobs\\stats\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\nimport { getQueueManager } from '@/lib/queue/queue-manager';\n\n/**\n * GET /api/jobs/stats\n * Get queue statistics\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const supabase = await createClient();\n\n    // Get authenticated user\n    const {\n      data: { user },\n      error: authError\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    // Get user's organization\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('organization_id, role')\n      .eq('id', user.id)\n      .single();\n\n    if (!profile?.organization_id) {\n      return NextResponse.json(\n        { error: 'No organization found' },\n        { status: 400 }\n      );\n    }\n\n    // Check permissions (only admins and owners can view stats)\n    if (!['owner', 'admin'].includes(profile.role)) {\n      return NextResponse.json(\n        { error: 'Insufficient permissions' },\n        { status: 403 }\n      );\n    }\n\n    // Get queue statistics\n    const queueManager = getQueueManager();\n    const stats = await queueManager.getAllQueueStatistics();\n\n    // Get job history from database\n    const { data: jobLogs, error: logsError } = await supabase\n      .from('job_logs')\n      .select('job_type, status, result, created_at')\n      .eq('organization_id', profile.organization_id)\n      .order('created_at', { ascending: false })\n      .limit(100);\n\n    if (logsError) {\n      console.error('Error fetching job logs:', logsError);\n    }\n\n    // Calculate aggregated statistics\n    const aggregatedStats = {\n      total: 0,\n      completed: 0,\n      failed: 0,\n      running: 0,\n      byType: {} as Record<string, any>\n    };\n\n    if (jobLogs) {\n      jobLogs.forEach((log) => {\n        aggregatedStats.total++;\n\n        if (log.status === 'completed') {\n          aggregatedStats.completed++;\n        } else if (log.status === 'failed') {\n          aggregatedStats.failed++;\n        } else {\n          aggregatedStats.running++;\n        }\n\n        if (!aggregatedStats.byType[log.job_type]) {\n          aggregatedStats.byType[log.job_type] = {\n            total: 0,\n            completed: 0,\n            failed: 0\n          };\n        }\n\n        aggregatedStats.byType[log.job_type].total++;\n\n        if (log.status === 'completed') {\n          aggregatedStats.byType[log.job_type].completed++;\n        } else if (log.status === 'failed') {\n          aggregatedStats.byType[log.job_type].failed++;\n        }\n      });\n    }\n\n    return NextResponse.json({\n      success: true,\n      queueStats: stats,\n      historicalStats: aggregatedStats,\n      recentJobs: jobLogs?.slice(0, 10) || []\n    });\n  } catch (error) {\n    console.error('Error getting queue stats:', error);\n    return NextResponse.json(\n      {\n        error: 'Failed to get queue statistics',\n        details: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}