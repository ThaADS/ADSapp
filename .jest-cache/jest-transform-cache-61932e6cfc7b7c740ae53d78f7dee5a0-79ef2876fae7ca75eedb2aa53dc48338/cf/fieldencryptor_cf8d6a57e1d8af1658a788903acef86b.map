{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\crypto\\field-encryptor.ts"],"sourcesContent":["/**\n * Field-Level Encryptor\n *\n * High-level API for encrypting and decrypting database fields.\n * Provides type-safe operations with comprehensive error handling,\n * batch processing support, and audit logging capabilities.\n *\n * Features:\n * - Type-safe field encryption/decryption\n * - Null/undefined handling\n * - Batch operations for migrations\n * - Audit logging for compliance\n * - Transparent error handling\n * - Support for all PII fields\n *\n * @module crypto/field-encryptor\n */\n\nimport {\n  encrypt as encryptCore,\n  decrypt as decryptCore,\n  encryptBatch as encryptBatchCore,\n  decryptBatch as decryptBatchCore,\n  validateEncryptedData,\n  getEncryptionStatus,\n} from './encryption';\nimport {\n  EncryptionError,\n  DecryptionError,\n  EncryptionAuditLog,\n  BatchEncryptRequest,\n  BatchEncryptResult,\n  BatchDecryptRequest,\n  BatchDecryptResult,\n  ENCRYPTION_CONSTANTS,\n  ENCRYPTED_FIELDS,\n  EncryptedFieldsMap,\n  needsEncryption,\n} from './types';\n\n/**\n * Field encryptor class for managing encrypted fields\n */\nexport class FieldEncryptor {\n  private auditLogs: EncryptionAuditLog[] = [];\n  private enableAuditLogging: boolean;\n\n  constructor(options?: { enableAuditLogging?: boolean }) {\n    this.enableAuditLogging = options?.enableAuditLogging ?? true;\n  }\n\n  /**\n   * Encrypt a single field value\n   *\n   * @param value - Plaintext value to encrypt\n   * @param fieldName - Name of the field (for audit logging)\n   * @param metadata - Additional metadata for audit log\n   * @returns Encrypted value as base64 string, or null if input is null/empty\n   *\n   * @example\n   * ```typescript\n   * const encryptor = new FieldEncryptor();\n   * const encrypted = encryptor.encryptField('+1234567890', 'phone_number');\n   * ```\n   */\n  encryptField(\n    value: string | null | undefined,\n    fieldName?: string,\n    metadata?: {\n      table?: string;\n      recordId?: string;\n      userId?: string;\n      organizationId?: string;\n    }\n  ): string | null {\n    const startTime = Date.now();\n\n    try {\n      // Handle null/undefined/empty values\n      if (!value || value.trim() === '') {\n        this.logAudit({\n          operation: 'encrypt',\n          field: fieldName,\n          success: true,\n          timestamp: new Date(),\n          ...metadata,\n        });\n        return null;\n      }\n\n      // Perform encryption\n      const result = encryptCore(value);\n\n      // Log successful encryption\n      this.logAudit({\n        operation: 'encrypt',\n        field: fieldName,\n        success: true,\n        timestamp: new Date(),\n        ...metadata,\n      });\n\n      return result.encrypted;\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n\n      // Log failed encryption\n      this.logAudit({\n        operation: 'encrypt',\n        field: fieldName,\n        success: false,\n        error: errorMessage,\n        timestamp: new Date(),\n        ...metadata,\n      });\n\n      // Re-throw with context\n      throw new EncryptionError(\n        `Failed to encrypt field '${fieldName || 'unknown'}': ${errorMessage}`,\n        'FIELD_ENCRYPTION_FAILED',\n        {\n          field: fieldName,\n          originalError: errorMessage,\n          duration: Date.now() - startTime,\n          ...metadata,\n        }\n      );\n    }\n  }\n\n  /**\n   * Decrypt a single field value\n   *\n   * @param encryptedValue - Encrypted value (base64 string)\n   * @param fieldName - Name of the field (for audit logging)\n   * @param metadata - Additional metadata for audit log\n   * @returns Decrypted plaintext value, or null if input is null/empty\n   *\n   * @example\n   * ```typescript\n   * const encryptor = new FieldEncryptor();\n   * const decrypted = encryptor.decryptField(encryptedValue, 'phone_number');\n   * ```\n   */\n  decryptField(\n    encryptedValue: string | null | undefined,\n    fieldName?: string,\n    metadata?: {\n      table?: string;\n      recordId?: string;\n      userId?: string;\n      organizationId?: string;\n    }\n  ): string | null {\n    const startTime = Date.now();\n\n    try {\n      // Handle null/undefined/empty values\n      if (!encryptedValue || encryptedValue.trim() === '') {\n        this.logAudit({\n          operation: 'decrypt',\n          field: fieldName,\n          success: true,\n          timestamp: new Date(),\n          ...metadata,\n        });\n        return null;\n      }\n\n      // Validate encrypted data format\n      const validation = validateEncryptedData(\n        encryptedValue,\n        ENCRYPTION_CONSTANTS.CURRENT_VERSION\n      );\n\n      if (!validation.valid) {\n        throw new DecryptionError(\n          `Invalid encrypted data format: ${validation.error}`,\n          'INVALID_ENCRYPTED_FORMAT',\n          validation.details\n        );\n      }\n\n      // Perform decryption\n      const result = decryptCore(\n        encryptedValue,\n        ENCRYPTION_CONSTANTS.CURRENT_VERSION\n      );\n\n      // Log successful decryption\n      this.logAudit({\n        operation: 'decrypt',\n        field: fieldName,\n        success: true,\n        timestamp: new Date(),\n        ...metadata,\n      });\n\n      return result.plaintext;\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error ? error.message : String(error);\n\n      // Log failed decryption\n      this.logAudit({\n        operation: 'decrypt',\n        field: fieldName,\n        success: false,\n        error: errorMessage,\n        timestamp: new Date(),\n        ...metadata,\n      });\n\n      // Re-throw with context\n      throw new DecryptionError(\n        `Failed to decrypt field '${fieldName || 'unknown'}': ${errorMessage}`,\n        'FIELD_DECRYPTION_FAILED',\n        {\n          field: fieldName,\n          originalError: errorMessage,\n          duration: Date.now() - startTime,\n          ...metadata,\n        }\n      );\n    }\n  }\n\n  /**\n   * Encrypt multiple fields in a record\n   *\n   * @param record - Record object with fields to encrypt\n   * @param fields - Array of field names to encrypt\n   * @param metadata - Metadata for audit logging\n   * @returns New record object with encrypted fields\n   *\n   * @example\n   * ```typescript\n   * const encryptor = new FieldEncryptor();\n   * const encrypted = encryptor.encryptRecord(\n   *   { name: 'John', phone: '+1234567890', email: 'john@example.com' },\n   *   ['phone', 'email']\n   * );\n   * ```\n   */\n  encryptRecord<T extends Record<string, unknown>>(\n    record: T,\n    fields: (keyof T)[],\n    metadata?: {\n      table?: string;\n      recordId?: string;\n      userId?: string;\n      organizationId?: string;\n    }\n  ): T {\n    const encryptedRecord = { ...record };\n\n    for (const field of fields) {\n      const value = record[field];\n\n      if (typeof value === 'string') {\n        encryptedRecord[field] = this.encryptField(value, String(field), {\n          ...metadata,\n          recordId: metadata?.recordId || (record.id as string),\n        }) as T[keyof T];\n      }\n    }\n\n    return encryptedRecord;\n  }\n\n  /**\n   * Decrypt multiple fields in a record\n   *\n   * @param record - Record object with encrypted fields\n   * @param fields - Array of field names to decrypt\n   * @param metadata - Metadata for audit logging\n   * @returns New record object with decrypted fields\n   *\n   * @example\n   * ```typescript\n   * const encryptor = new FieldEncryptor();\n   * const decrypted = encryptor.decryptRecord(\n   *   encryptedRecord,\n   *   ['phone', 'email']\n   * );\n   * ```\n   */\n  decryptRecord<T extends Record<string, unknown>>(\n    record: T,\n    fields: (keyof T)[],\n    metadata?: {\n      table?: string;\n      recordId?: string;\n      userId?: string;\n      organizationId?: string;\n    }\n  ): T {\n    const decryptedRecord = { ...record };\n\n    for (const field of fields) {\n      const value = record[field];\n\n      if (typeof value === 'string') {\n        decryptedRecord[field] = this.decryptField(value, String(field), {\n          ...metadata,\n          recordId: metadata?.recordId || (record.id as string),\n        }) as T[keyof T];\n      }\n    }\n\n    return decryptedRecord;\n  }\n\n  /**\n   * Batch encrypt multiple values\n   *\n   * @param requests - Array of encryption requests\n   * @returns Array of encryption results\n   *\n   * @example\n   * ```typescript\n   * const encryptor = new FieldEncryptor();\n   * const results = encryptor.batchEncrypt([\n   *   { id: '1', field: 'phone', value: '+1234567890' },\n   *   { id: '2', field: 'phone', value: '+9876543210' },\n   * ]);\n   * ```\n   */\n  batchEncrypt(requests: BatchEncryptRequest[]): BatchEncryptResult[] {\n    const startTime = Date.now();\n    const results: BatchEncryptResult[] = [];\n\n    for (const request of requests) {\n      try {\n        const encrypted = this.encryptField(request.value, request.field, {\n          recordId: request.id,\n        });\n\n        results.push({\n          id: request.id,\n          field: request.field,\n          encrypted,\n          success: true,\n        });\n      } catch (error) {\n        const errorMessage =\n          error instanceof Error ? error.message : String(error);\n\n        results.push({\n          id: request.id,\n          field: request.field,\n          encrypted: null,\n          success: false,\n          error: errorMessage,\n        });\n      }\n    }\n\n    // Log batch operation\n    const successCount = results.filter((r) => r.success).length;\n    const failureCount = results.length - successCount;\n\n    this.logAudit({\n      operation: 'batch_encrypt',\n      recordCount: requests.length,\n      success: failureCount === 0,\n      error: failureCount > 0 ? `${failureCount} records failed` : undefined,\n      timestamp: new Date(),\n    });\n\n    return results;\n  }\n\n  /**\n   * Batch decrypt multiple values\n   *\n   * @param requests - Array of decryption requests\n   * @returns Array of decryption results\n   *\n   * @example\n   * ```typescript\n   * const encryptor = new FieldEncryptor();\n   * const results = encryptor.batchDecrypt([\n   *   { id: '1', field: 'phone', encrypted: 'base64...' },\n   *   { id: '2', field: 'phone', encrypted: 'base64...' },\n   * ]);\n   * ```\n   */\n  batchDecrypt(requests: BatchDecryptRequest[]): BatchDecryptResult[] {\n    const startTime = Date.now();\n    const results: BatchDecryptResult[] = [];\n\n    for (const request of requests) {\n      try {\n        const decrypted = this.decryptField(request.encrypted, request.field, {\n          recordId: request.id,\n        });\n\n        results.push({\n          id: request.id,\n          field: request.field,\n          decrypted,\n          success: true,\n        });\n      } catch (error) {\n        const errorMessage =\n          error instanceof Error ? error.message : String(error);\n\n        results.push({\n          id: request.id,\n          field: request.field,\n          decrypted: null,\n          success: false,\n          error: errorMessage,\n        });\n      }\n    }\n\n    // Log batch operation\n    const successCount = results.filter((r) => r.success).length;\n    const failureCount = results.length - successCount;\n\n    this.logAudit({\n      operation: 'batch_decrypt',\n      recordCount: requests.length,\n      success: failureCount === 0,\n      error: failureCount > 0 ? `${failureCount} records failed` : undefined,\n      timestamp: new Date(),\n    });\n\n    return results;\n  }\n\n  /**\n   * Get fields that should be encrypted for a given table\n   *\n   * @param tableName - Name of the database table\n   * @returns Array of field names to encrypt\n   */\n  getEncryptedFieldsForTable(tableName: keyof EncryptedFieldsMap): string[] {\n    return ENCRYPTED_FIELDS[tableName] || [];\n  }\n\n  /**\n   * Check if a field should be encrypted\n   *\n   * @param tableName - Name of the database table\n   * @param fieldName - Name of the field\n   * @returns True if field should be encrypted\n   */\n  shouldEncryptField(\n    tableName: keyof EncryptedFieldsMap,\n    fieldName: string\n  ): boolean {\n    const fields = this.getEncryptedFieldsForTable(tableName);\n    return fields.includes(fieldName);\n  }\n\n  /**\n   * Encrypt all PII fields in a contacts record\n   *\n   * @param contact - Contact record\n   * @returns Contact record with encrypted PII fields\n   */\n  encryptContact<T extends { phone_number?: string | null; whatsapp_id?: string | null }>(\n    contact: T,\n    metadata?: { organizationId?: string; userId?: string }\n  ): T {\n    return this.encryptRecord(contact, ['phone_number', 'whatsapp_id'], {\n      table: 'contacts',\n      recordId: (contact as { id?: string }).id,\n      ...metadata,\n    });\n  }\n\n  /**\n   * Decrypt all PII fields in a contacts record\n   *\n   * @param contact - Contact record with encrypted fields\n   * @returns Contact record with decrypted PII fields\n   */\n  decryptContact<T extends { phone_number?: string | null; whatsapp_id?: string | null }>(\n    contact: T,\n    metadata?: { organizationId?: string; userId?: string }\n  ): T {\n    return this.decryptRecord(contact, ['phone_number', 'whatsapp_id'], {\n      table: 'contacts',\n      recordId: (contact as { id?: string }).id,\n      ...metadata,\n    });\n  }\n\n  /**\n   * Encrypt all PII fields in a profile record\n   *\n   * @param profile - Profile record\n   * @returns Profile record with encrypted PII fields\n   */\n  encryptProfile<T extends { email?: string | null }>(\n    profile: T,\n    metadata?: { organizationId?: string; userId?: string }\n  ): T {\n    return this.encryptRecord(profile, ['email'], {\n      table: 'profiles',\n      recordId: (profile as { id?: string }).id,\n      ...metadata,\n    });\n  }\n\n  /**\n   * Decrypt all PII fields in a profile record\n   *\n   * @param profile - Profile record with encrypted fields\n   * @returns Profile record with decrypted PII fields\n   */\n  decryptProfile<T extends { email?: string | null }>(\n    profile: T,\n    metadata?: { organizationId?: string; userId?: string }\n  ): T {\n    return this.decryptRecord(profile, ['email'], {\n      table: 'profiles',\n      recordId: (profile as { id?: string }).id,\n      ...metadata,\n    });\n  }\n\n  /**\n   * Get all audit logs\n   *\n   * @returns Array of audit log entries\n   */\n  getAuditLogs(): EncryptionAuditLog[] {\n    return [...this.auditLogs];\n  }\n\n  /**\n   * Clear audit logs\n   */\n  clearAuditLogs(): void {\n    this.auditLogs = [];\n  }\n\n  /**\n   * Get audit logs filtered by criteria\n   *\n   * @param filter - Filter criteria\n   * @returns Filtered audit log entries\n   */\n  getFilteredAuditLogs(filter: {\n    operation?: EncryptionAuditLog['operation'];\n    table?: string;\n    field?: string;\n    success?: boolean;\n    startDate?: Date;\n    endDate?: Date;\n  }): EncryptionAuditLog[] {\n    return this.auditLogs.filter((log) => {\n      if (filter.operation && log.operation !== filter.operation) return false;\n      if (filter.table && log.table !== filter.table) return false;\n      if (filter.field && log.field !== filter.field) return false;\n      if (\n        filter.success !== undefined &&\n        log.success !== filter.success\n      )\n        return false;\n      if (filter.startDate && log.timestamp < filter.startDate) return false;\n      if (filter.endDate && log.timestamp > filter.endDate) return false;\n      return true;\n    });\n  }\n\n  /**\n   * Export audit logs to JSON\n   *\n   * @param filter - Optional filter criteria\n   * @returns JSON string of audit logs\n   */\n  exportAuditLogs(filter?: Parameters<typeof this.getFilteredAuditLogs>[0]): string {\n    const logs = filter ? this.getFilteredAuditLogs(filter) : this.auditLogs;\n    return JSON.stringify(logs, null, 2);\n  }\n\n  /**\n   * Get encryption statistics\n   *\n   * @returns Statistics about encryption operations\n   */\n  getStatistics(): {\n    totalOperations: number;\n    successfulOperations: number;\n    failedOperations: number;\n    successRate: number;\n    operationsByType: Record<string, number>;\n    operationsByTable: Record<string, number>;\n  } {\n    const stats = {\n      totalOperations: this.auditLogs.length,\n      successfulOperations: this.auditLogs.filter((log) => log.success).length,\n      failedOperations: this.auditLogs.filter((log) => !log.success).length,\n      successRate: 0,\n      operationsByType: {} as Record<string, number>,\n      operationsByTable: {} as Record<string, number>,\n    };\n\n    stats.successRate =\n      stats.totalOperations > 0\n        ? (stats.successfulOperations / stats.totalOperations) * 100\n        : 0;\n\n    // Count by operation type\n    for (const log of this.auditLogs) {\n      stats.operationsByType[log.operation] =\n        (stats.operationsByType[log.operation] || 0) + 1;\n\n      if (log.table) {\n        stats.operationsByTable[log.table] =\n          (stats.operationsByTable[log.table] || 0) + 1;\n      }\n    }\n\n    return stats;\n  }\n\n  /**\n   * Log an audit entry\n   *\n   * @param log - Audit log entry\n   */\n  private logAudit(log: EncryptionAuditLog): void {\n    if (this.enableAuditLogging) {\n      this.auditLogs.push(log);\n    }\n  }\n\n  /**\n   * Verify encryption is working correctly\n   *\n   * @returns Status object with encryption health information\n   */\n  static verifyEncryption(): {\n    healthy: boolean;\n    status: ReturnType<typeof getEncryptionStatus>;\n    message: string;\n  } {\n    try {\n      const status = getEncryptionStatus();\n\n      if (!status.keyLoaded) {\n        return {\n          healthy: false,\n          status,\n          message: 'Encryption key not loaded',\n        };\n      }\n\n      if (!status.testPassed) {\n        return {\n          healthy: false,\n          status,\n          message: 'Encryption test failed',\n        };\n      }\n\n      return {\n        healthy: true,\n        status,\n        message: 'Encryption system operational',\n      };\n    } catch (error) {\n      return {\n        healthy: false,\n        status: {\n          keyLoaded: false,\n          version: 'unknown',\n          algorithm: 'unknown',\n          testPassed: false,\n        },\n        message: error instanceof Error ? error.message : String(error),\n      };\n    }\n  }\n}\n\n/**\n * Singleton instance of FieldEncryptor for convenience\n */\nexport const fieldEncryptor = new FieldEncryptor({ enableAuditLogging: true });\n\n/**\n * Convenience functions using singleton instance\n */\nexport const encryptField = (\n  value: string | null | undefined,\n  fieldName?: string,\n  metadata?: Parameters<typeof fieldEncryptor.encryptField>[2]\n): string | null => fieldEncryptor.encryptField(value, fieldName, metadata);\n\nexport const decryptField = (\n  value: string | null | undefined,\n  fieldName?: string,\n  metadata?: Parameters<typeof fieldEncryptor.decryptField>[2]\n): string | null => fieldEncryptor.decryptField(value, fieldName, metadata);\n\nexport const encryptContact = <T extends { phone_number?: string | null; whatsapp_id?: string | null }>(\n  contact: T,\n  metadata?: { organizationId?: string; userId?: string }\n): T => fieldEncryptor.encryptContact(contact, metadata);\n\nexport const decryptContact = <T extends { phone_number?: string | null; whatsapp_id?: string | null }>(\n  contact: T,\n  metadata?: { organizationId?: string; userId?: string }\n): T => fieldEncryptor.decryptContact(contact, metadata);\n\nexport const encryptProfile = <T extends { email?: string | null }>(\n  profile: T,\n  metadata?: { organizationId?: string; userId?: string }\n): T => fieldEncryptor.encryptProfile(profile, metadata);\n\nexport const decryptProfile = <T extends { email?: string | null }>(\n  profile: T,\n  metadata?: { organizationId?: string; userId?: string }\n): T => fieldEncryptor.decryptProfile(profile, metadata);\n"],"names":["FieldEncryptor","decryptContact","decryptField","decryptProfile","encryptContact","encryptField","encryptProfile","fieldEncryptor","options","auditLogs","enableAuditLogging","value","fieldName","metadata","startTime","Date","now","trim","logAudit","operation","field","success","timestamp","result","encryptCore","encrypted","error","errorMessage","Error","message","String","EncryptionError","originalError","duration","encryptedValue","validation","validateEncryptedData","ENCRYPTION_CONSTANTS","CURRENT_VERSION","valid","DecryptionError","details","decryptCore","plaintext","encryptRecord","record","fields","encryptedRecord","recordId","id","decryptRecord","decryptedRecord","batchEncrypt","requests","results","request","push","successCount","filter","r","length","failureCount","recordCount","undefined","batchDecrypt","decrypted","getEncryptedFieldsForTable","tableName","ENCRYPTED_FIELDS","shouldEncryptField","includes","contact","table","profile","getAuditLogs","clearAuditLogs","getFilteredAuditLogs","log","startDate","endDate","exportAuditLogs","logs","JSON","stringify","getStatistics","stats","totalOperations","successfulOperations","failedOperations","successRate","operationsByType","operationsByTable","verifyEncryption","status","getEncryptionStatus","keyLoaded","healthy","testPassed","version","algorithm"],"mappings":"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"}