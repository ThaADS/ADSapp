{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\middleware\\tenant-validation.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\nimport { getUserOrganization } from '@/lib/api-utils';\n\n/**\n * Tenant Context Type for API routes\n * Contains authenticated user and organization information\n */\nexport interface TenantContext {\n  userId: string;\n  organizationId: string;\n  userRole: string;\n  userEmail: string;\n}\n\n/**\n * Security Event Log for cross-tenant access attempts\n */\ninterface SecurityEvent {\n  userId: string;\n  userOrg: string;\n  requestedOrg: string | null;\n  path: string;\n  method: string;\n  timestamp: string;\n  ip: string;\n  userAgent: string;\n}\n\n/**\n * Tenant Validation Middleware\n * Ensures all API requests are scoped to the authenticated user's organization\n *\n * Security Features:\n * - Validates user authentication via Supabase JWT\n * - Verifies user-organization relationship\n * - Prevents cross-tenant data access\n * - Logs security events for monitoring\n * - Attaches tenant context to request headers\n *\n * Usage in API routes:\n * ```typescript\n * import { validateTenantAccess, getTenantContext } from '@/lib/middleware/tenant-validation';\n *\n * export async function GET(request: NextRequest) {\n *   const validation = await validateTenantAccess(request);\n *   if (validation) return validation; // Return error response if validation fails\n *\n *   const { organizationId, userId } = getTenantContext(request);\n *   // Use organizationId to scope database queries\n * }\n * ```\n */\nexport async function validateTenantAccess(request: NextRequest): Promise<NextResponse | null> {\n  try {\n    const supabase = await createClient();\n\n    // 1. Verify user authentication\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json(\n        {\n          error: 'Authentication required',\n          code: 'UNAUTHORIZED'\n        },\n        { status: 401 }\n      );\n    }\n\n    // 2. Get user's organization and profile\n    const userOrg = await getUserOrganization(user.id);\n\n    if (!userOrg || !userOrg.organization_id) {\n      // Check if user is super admin - they don't need organization\n      const { data: profile } = await supabase\n        .from('profiles')\n        .select('is_super_admin, role')\n        .eq('id', user.id)\n        .single();\n\n      if (profile?.is_super_admin) {\n        // Super admins bypass organization requirements\n        const requestHeaders = new Headers(request.headers);\n        requestHeaders.set('x-user-id', user.id);\n        requestHeaders.set('x-user-role', 'super_admin');\n        requestHeaders.set('x-is-super-admin', 'true');\n        requestHeaders.set('x-user-email', user.email || '');\n\n        return NextResponse.next({\n          request: { headers: requestHeaders }\n        });\n      }\n\n      return NextResponse.json(\n        {\n          error: 'User not associated with any organization',\n          code: 'NO_ORGANIZATION'\n        },\n        { status: 403 }\n      );\n    }\n\n    // 3. Validate tenant context from request\n    // Check for organization ID in headers or query parameters\n    const requestedOrgId = request.headers.get('x-organization-id') ||\n                          request.nextUrl.searchParams.get('organization_id');\n\n    // 4. Cross-tenant access prevention\n    if (requestedOrgId && requestedOrgId !== userOrg.organization_id) {\n      // Log cross-tenant access attempt for security monitoring\n      const securityEvent: SecurityEvent = {\n        userId: user.id,\n        userOrg: userOrg.organization_id,\n        requestedOrg: requestedOrgId,\n        path: request.nextUrl.pathname,\n        method: request.method,\n        timestamp: new Date().toISOString(),\n        ip: getClientIp(request),\n        userAgent: request.headers.get('user-agent') || 'unknown'\n      };\n\n      // Log to console (in production, send to security monitoring service)\n      console.warn('[SECURITY] Cross-tenant access attempt:', securityEvent);\n\n      // Send to Sentry for alerting\n      if (process.env.NODE_ENV === 'production') {\n        try {\n          const Sentry = await import('@sentry/nextjs');\n          Sentry.captureMessage('Cross-tenant access attempt', {\n            level: 'warning',\n            extra: {\n              userId: securityEvent.userId,\n              userOrg: securityEvent.userOrg,\n              requestedOrg: securityEvent.requestedOrg,\n              path: securityEvent.path,\n              method: securityEvent.method,\n              timestamp: securityEvent.timestamp,\n              ip: securityEvent.ip,\n              userAgent: securityEvent.userAgent\n            }\n          });\n        } catch (error) {\n          console.error('Failed to log security event to Sentry:', error);\n        }\n      }\n\n      return NextResponse.json(\n        {\n          error: 'Forbidden: Access to this organization denied',\n          code: 'FORBIDDEN'\n        },\n        { status: 403 }\n      );\n    }\n\n    // 5. Attach tenant context to request headers for downstream use\n    const requestHeaders = new Headers(request.headers);\n    requestHeaders.set('x-user-id', user.id);\n    requestHeaders.set('x-organization-id', userOrg.organization_id);\n\n    // Type guard for organization role\n    const orgRole = userOrg.organization &&\n                    typeof userOrg.organization === 'object' &&\n                    'role' in userOrg.organization\n      ? String(userOrg.organization.role)\n      : 'agent';\n\n    requestHeaders.set('x-user-role', orgRole);\n    requestHeaders.set('x-user-email', user.email || '');\n    requestHeaders.set('x-is-super-admin', 'false');\n\n    // Return modified request with tenant context\n    return NextResponse.next({\n      request: { headers: requestHeaders }\n    });\n\n  } catch (error) {\n    console.error('[TENANT_VALIDATION] Error:', error);\n\n    // Log error to monitoring service\n    if (process.env.NODE_ENV === 'production') {\n      try {\n        const Sentry = await import('@sentry/nextjs');\n        Sentry.captureException(error, {\n          tags: {\n            middleware: 'tenant-validation'\n          }\n        });\n      } catch (sentryError) {\n        console.error('Failed to log error to Sentry:', sentryError);\n      }\n    }\n\n    // Return 500 error for unexpected failures\n    return NextResponse.json(\n      {\n        error: 'Internal server error during tenant validation',\n        code: 'INTERNAL_ERROR'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Extract tenant context from request headers\n * Use this in API routes after validateTenantAccess middleware\n *\n * @param request - NextRequest object with tenant context headers\n * @returns TenantContext object with user and organization information\n *\n * @example\n * ```typescript\n * const { organizationId, userId, userRole } = getTenantContext(request);\n *\n * // Use organizationId to scope database queries\n * const { data } = await supabase\n *   .from('contacts')\n *   .select('*')\n *   .eq('organization_id', organizationId);\n * ```\n */\nexport function getTenantContext(request: NextRequest): TenantContext {\n  return {\n    userId: request.headers.get('x-user-id') || '',\n    organizationId: request.headers.get('x-organization-id') || '',\n    userRole: request.headers.get('x-user-role') || 'agent',\n    userEmail: request.headers.get('x-user-email') || ''\n  };\n}\n\n/**\n * Check if the current user is a super admin\n * Super admins bypass organization requirements\n *\n * @param request - NextRequest object with tenant context headers\n * @returns boolean indicating if user is super admin\n */\nexport function isSuperAdmin(request: NextRequest): boolean {\n  return request.headers.get('x-is-super-admin') === 'true';\n}\n\n/**\n * Validate that a resource belongs to the user's organization\n * Use this for additional validation in API routes\n *\n * @param resourceOrgId - Organization ID of the resource being accessed\n * @param tenantContext - Tenant context from request\n * @returns boolean indicating if access is allowed\n *\n * @example\n * ```typescript\n * const contact = await getContact(contactId);\n * const context = getTenantContext(request);\n *\n * if (!validateResourceAccess(contact.organization_id, context)) {\n *   return NextResponse.json({ error: 'Access denied' }, { status: 403 });\n * }\n * ```\n */\nexport function validateResourceAccess(\n  resourceOrgId: string,\n  tenantContext: TenantContext\n): boolean {\n  // Super admins can access all resources\n  if (!tenantContext.organizationId && tenantContext.userRole === 'super_admin') {\n    return true;\n  }\n\n  // Regular users can only access resources in their organization\n  return resourceOrgId === tenantContext.organizationId;\n}\n\n/**\n * Helper function to get client IP address\n * Handles various proxy headers (Vercel, Cloudflare, etc.)\n *\n * @param request - NextRequest object\n * @returns Client IP address or 'unknown'\n */\nfunction getClientIp(request: NextRequest): string {\n  const forwarded = request.headers.get('x-forwarded-for');\n  const realIp = request.headers.get('x-real-ip');\n  const cfConnectingIp = request.headers.get('cf-connecting-ip');\n  const vercelIp = request.headers.get('x-vercel-forwarded-for');\n\n  return (\n    cfConnectingIp ||\n    vercelIp ||\n    forwarded?.split(',')[0].trim() ||\n    realIp ||\n    'unknown'\n  );\n}\n\n/**\n * Supabase Query Builder Interface\n * Minimal interface for tenant scoping\n */\ninterface SupabaseQueryBuilder {\n  eq(column: string, value: string): SupabaseQueryBuilder;\n}\n\n/**\n * Create a tenant-aware database query modifier\n * Automatically adds organization_id filter to queries\n *\n * @param organizationId - Organization ID to filter by\n * @returns Function that modifies Supabase query builder\n *\n * @example\n * ```typescript\n * const context = getTenantContext(request);\n * const scopeToOrg = createTenantScope(context.organizationId);\n *\n * const { data } = await supabase\n *   .from('contacts')\n *   .select('*')\n *   .modify(scopeToOrg); // Automatically adds .eq('organization_id', organizationId)\n * ```\n */\nexport function createTenantScope(organizationId: string) {\n  return (query: SupabaseQueryBuilder) => query.eq('organization_id', organizationId);\n}\n"],"names":["createTenantScope","getTenantContext","isSuperAdmin","validateResourceAccess","validateTenantAccess","request","supabase","createClient","data","user","error","authError","auth","getUser","NextResponse","json","code","status","userOrg","getUserOrganization","id","organization_id","profile","from","select","eq","single","is_super_admin","requestHeaders","Headers","headers","set","email","next","requestedOrgId","get","nextUrl","searchParams","securityEvent","userId","requestedOrg","path","pathname","method","timestamp","Date","toISOString","ip","getClientIp","userAgent","console","warn","process","env","NODE_ENV","Sentry","captureMessage","level","extra","orgRole","organization","String","role","captureException","tags","middleware","sentryError","organizationId","userRole","userEmail","resourceOrgId","tenantContext","forwarded","realIp","cfConnectingIp","vercelIp","split","trim","query"],"mappings":"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"}