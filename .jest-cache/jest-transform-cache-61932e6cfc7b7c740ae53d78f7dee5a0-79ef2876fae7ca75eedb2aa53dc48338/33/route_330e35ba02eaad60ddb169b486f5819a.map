{"version":3,"names":["cov_2hkem5d4cm","actualCoverage","s","POST","request","f","supabase","_server1","createClient","data","user","error","authError","auth","getUser","b","_server","NextResponse","json","status","profile","from","select","eq","id","single","organization_id","includes","role","body","contacts","importOptions","Array","isArray","length","invalidContacts","filter","contact","phone","invalidCount","options","updateExisting","skipDuplicates","validatePhone","jobData","organizationId","userId","map","name","email","tags","customFields","metadata","requestedBy","requestedAt","Date","toISOString","source","queueManager","_queuemanager","getQueueManager","jobId","addJob","_bullconfig","QueueName","CONTACT_IMPORT","priority","JobPriority","NORMAL","success","message","console","details","Error"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\jobs\\import-contacts\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\nimport { getQueueManager } from '@/lib/queue/queue-manager';\nimport { QueueName, JobPriority } from '@/lib/queue/bull-config';\nimport { ContactImportJobData } from '@/lib/queue/processors/contact-import-processor';\n\n/**\n * POST /api/jobs/import-contacts\n * Queue a contact import job\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const supabase = await createClient();\n\n    // Get authenticated user\n    const {\n      data: { user },\n      error: authError\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    // Get user's organization\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('organization_id, role')\n      .eq('id', user.id)\n      .single();\n\n    if (!profile?.organization_id) {\n      return NextResponse.json(\n        { error: 'No organization found' },\n        { status: 400 }\n      );\n    }\n\n    // Check permissions (only admins and owners can import contacts)\n    if (!['owner', 'admin'].includes(profile.role)) {\n      return NextResponse.json(\n        { error: 'Insufficient permissions' },\n        { status: 403 }\n      );\n    }\n\n    // Parse request body\n    const body = await request.json();\n    const { contacts, importOptions } = body;\n\n    // Validate required fields\n    if (!contacts || !Array.isArray(contacts) || contacts.length === 0) {\n      return NextResponse.json(\n        { error: 'contacts is required and must be a non-empty array' },\n        { status: 400 }\n      );\n    }\n\n    // Validate contact structure\n    const invalidContacts = contacts.filter(\n      (contact) => !contact.phone || typeof contact.phone !== 'string'\n    );\n\n    if (invalidContacts.length > 0) {\n      return NextResponse.json(\n        {\n          error: 'All contacts must have a valid phone number',\n          invalidCount: invalidContacts.length\n        },\n        { status: 400 }\n      );\n    }\n\n    // Set default import options\n    const options = {\n      updateExisting: importOptions?.updateExisting ?? false,\n      skipDuplicates: importOptions?.skipDuplicates ?? true,\n      validatePhone: importOptions?.validatePhone ?? true\n    };\n\n    // Prepare job data\n    const jobData: ContactImportJobData = {\n      organizationId: profile.organization_id,\n      userId: user.id,\n      contacts: contacts.map((contact) => ({\n        phone: contact.phone,\n        name: contact.name,\n        email: contact.email,\n        tags: contact.tags || [],\n        customFields: contact.customFields || {}\n      })),\n      importOptions: options,\n      metadata: {\n        requestedBy: user.email,\n        requestedAt: new Date().toISOString(),\n        source: 'api'\n      }\n    };\n\n    // Get queue manager and add job\n    const queueManager = getQueueManager();\n    const jobId = await queueManager.addJob(\n      QueueName.CONTACT_IMPORT,\n      'import-contacts',\n      jobData,\n      {\n        priority: JobPriority.NORMAL\n      }\n    );\n\n    return NextResponse.json(\n      {\n        success: true,\n        jobId,\n        message: `Contact import job queued for ${contacts.length} contacts`\n      },\n      { status: 202 }\n    );\n  } catch (error) {\n    console.error('Error queuing contact import job:', error);\n    return NextResponse.json(\n      {\n        error: 'Failed to queue contact import job',\n        details: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAWM;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AAAAA,cAAA,GAAAE,CAAA;;;;;;+BADgB;;;;;;WAAAC,IAAA;;;;;kCAVoB;;;kCACb;;;kCACG;;;kCACO;AAOhC,eAAeA,KAAKC,OAAoB;EAAA;EAAAJ,cAAA,GAAAK,CAAA;EAAAL,cAAA,GAAAE,CAAA;EAC7C,IAAI;IACF,MAAMI,QAAA;IAAA;IAAA,CAAAN,cAAA,GAAAE,CAAA,OAAW,MAAM,IAAAK,QAAA,CAAAC,YAAY;IAEnC;IACA,MAAM;MACJC,IAAA,EAAM;QAAEC;MAAI,CAAE;MACdC,KAAA,EAAOC;IAAS,CACjB;IAAA;IAAA,CAAAZ,cAAA,GAAAE,CAAA,OAAG,MAAMI,QAAA,CAASO,IAAI,CAACC,OAAO;IAAA;IAAAd,cAAA,GAAAE,CAAA;IAE/B;IAAI;IAAA,CAAAF,cAAA,GAAAe,CAAA,UAAAH,SAAA;IAAA;IAAA,CAAAZ,cAAA,GAAAe,CAAA,UAAa,CAACL,IAAA,GAAM;MAAA;MAAAV,cAAA,GAAAe,CAAA;MAAAf,cAAA,GAAAE,CAAA;MACtB,OAAOc,OAAA,CAAAC,YAAY,CAACC,IAAI,CAAC;QAAEP,KAAA,EAAO;MAAe,GAAG;QAAEQ,MAAA,EAAQ;MAAI;IACpE;IAAA;IAAA;MAAAnB,cAAA,GAAAe,CAAA;IAAA;IAEA;IACA,MAAM;MAAEN,IAAA,EAAMW;IAAO,CAAE;IAAA;IAAA,CAAApB,cAAA,GAAAE,CAAA,QAAG,MAAMI,QAAA,CAC7Be,IAAI,CAAC,YACLC,MAAM,CAAC,yBACPC,EAAE,CAAC,MAAMb,IAAA,CAAKc,EAAE,EAChBC,MAAM;IAAA;IAAAzB,cAAA,GAAAE,CAAA;IAET,IAAI,CAACkB,OAAA,EAASM,eAAA,EAAiB;MAAA;MAAA1B,cAAA,GAAAe,CAAA;MAAAf,cAAA,GAAAE,CAAA;MAC7B,OAAOc,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;QAAEP,KAAA,EAAO;MAAwB,GACjC;QAAEQ,MAAA,EAAQ;MAAI;IAElB;IAAA;IAAA;MAAAnB,cAAA,GAAAe,CAAA;IAAA;IAEA;IAAAf,cAAA,GAAAE,CAAA;IACA,IAAI,CAAC,CAAC,SAAS,QAAQ,CAACyB,QAAQ,CAACP,OAAA,CAAQQ,IAAI,GAAG;MAAA;MAAA5B,cAAA,GAAAe,CAAA;MAAAf,cAAA,GAAAE,CAAA;MAC9C,OAAOc,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;QAAEP,KAAA,EAAO;MAA2B,GACpC;QAAEQ,MAAA,EAAQ;MAAI;IAElB;IAAA;IAAA;MAAAnB,cAAA,GAAAe,CAAA;IAAA;IAEA;IACA,MAAMc,IAAA;IAAA;IAAA,CAAA7B,cAAA,GAAAE,CAAA,QAAO,MAAME,OAAA,CAAQc,IAAI;IAC/B,MAAM;MAAEY,QAAQ;MAAEC;IAAa,CAAE;IAAA;IAAA,CAAA/B,cAAA,GAAAE,CAAA,QAAG2B,IAAA;IAEpC;IAAA;IAAA7B,cAAA,GAAAE,CAAA;IACA;IAAI;IAAA,CAAAF,cAAA,GAAAe,CAAA,WAACe,QAAA;IAAA;IAAA,CAAA9B,cAAA,GAAAe,CAAA,UAAY,CAACiB,KAAA,CAAMC,OAAO,CAACH,QAAA;IAAA;IAAA,CAAA9B,cAAA,GAAAe,CAAA,UAAae,QAAA,CAASI,MAAM,KAAK,IAAG;MAAA;MAAAlC,cAAA,GAAAe,CAAA;MAAAf,cAAA,GAAAE,CAAA;MAClE,OAAOc,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;QAAEP,KAAA,EAAO;MAAqD,GAC9D;QAAEQ,MAAA,EAAQ;MAAI;IAElB;IAAA;IAAA;MAAAnB,cAAA,GAAAe,CAAA;IAAA;IAEA;IACA,MAAMoB,eAAA;IAAA;IAAA,CAAAnC,cAAA,GAAAE,CAAA,QAAkB4B,QAAA,CAASM,MAAM,CACpCC,OAAA,IAAY;MAAA;MAAArC,cAAA,GAAAK,CAAA;MAAAL,cAAA,GAAAE,CAAA;MAAA,kCAAAF,cAAA,GAAAe,CAAA,WAACsB,OAAA,CAAQC,KAAK;MAAA;MAAA,CAAAtC,cAAA,GAAAe,CAAA,UAAI,OAAOsB,OAAA,CAAQC,KAAK,KAAK;IAAA;IAAA;IAAAtC,cAAA,GAAAE,CAAA;IAG1D,IAAIiC,eAAA,CAAgBD,MAAM,GAAG,GAAG;MAAA;MAAAlC,cAAA,GAAAe,CAAA;MAAAf,cAAA,GAAAE,CAAA;MAC9B,OAAOc,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;QACEP,KAAA,EAAO;QACP4B,YAAA,EAAcJ,eAAA,CAAgBD;MAChC,GACA;QAAEf,MAAA,EAAQ;MAAI;IAElB;IAAA;IAAA;MAAAnB,cAAA,GAAAe,CAAA;IAAA;IAEA;IACA,MAAMyB,OAAA;IAAA;IAAA,CAAAxC,cAAA,GAAAE,CAAA,QAAU;MACduC,cAAA;MAAgB;MAAA,CAAAzC,cAAA,GAAAe,CAAA,UAAAgB,aAAA,EAAeU,cAAA;MAAA;MAAA,CAAAzC,cAAA,GAAAe,CAAA,UAAkB;MACjD2B,cAAA;MAAgB;MAAA,CAAA1C,cAAA,GAAAe,CAAA,UAAAgB,aAAA,EAAeW,cAAA;MAAA;MAAA,CAAA1C,cAAA,GAAAe,CAAA,UAAkB;MACjD4B,aAAA;MAAe;MAAA,CAAA3C,cAAA,GAAAe,CAAA,WAAAgB,aAAA,EAAeY,aAAA;MAAA;MAAA,CAAA3C,cAAA,GAAAe,CAAA,WAAiB;IACjD;IAEA;IACA,MAAM6B,OAAA;IAAA;IAAA,CAAA5C,cAAA,GAAAE,CAAA,QAAgC;MACpC2C,cAAA,EAAgBzB,OAAA,CAAQM,eAAe;MACvCoB,MAAA,EAAQpC,IAAA,CAAKc,EAAE;MACfM,QAAA,EAAUA,QAAA,CAASiB,GAAG,CAAEV,OAAA,IAAa;QAAA;QAAArC,cAAA,GAAAK,CAAA;QAAAL,cAAA,GAAAE,CAAA;QAAA;UACnCoC,KAAA,EAAOD,OAAA,CAAQC,KAAK;UACpBU,IAAA,EAAMX,OAAA,CAAQW,IAAI;UAClBC,KAAA,EAAOZ,OAAA,CAAQY,KAAK;UACpBC,IAAA;UAAM;UAAA,CAAAlD,cAAA,GAAAe,CAAA,WAAAsB,OAAA,CAAQa,IAAI;UAAA;UAAA,CAAAlD,cAAA,GAAAe,CAAA,WAAI,EAAE;UACxBoC,YAAA;UAAc;UAAA,CAAAnD,cAAA,GAAAe,CAAA,WAAAsB,OAAA,CAAQc,YAAY;UAAA;UAAA,CAAAnD,cAAA,GAAAe,CAAA,WAAI,CAAC;QACzC;MAAA;MACAgB,aAAA,EAAeS,OAAA;MACfY,QAAA,EAAU;QACRC,WAAA,EAAa3C,IAAA,CAAKuC,KAAK;QACvBK,WAAA,EAAa,IAAIC,IAAA,GAAOC,WAAW;QACnCC,MAAA,EAAQ;MACV;IACF;IAEA;IACA,MAAMC,YAAA;IAAA;IAAA,CAAA1D,cAAA,GAAAE,CAAA,QAAe,IAAAyD,aAAA,CAAAC,eAAe;IACpC,MAAMC,KAAA;IAAA;IAAA,CAAA7D,cAAA,GAAAE,CAAA,QAAQ,MAAMwD,YAAA,CAAaI,MAAM,CACrCC,WAAA,CAAAC,SAAS,CAACC,cAAc,EACxB,mBACArB,OAAA,EACA;MACEsB,QAAA,EAAUH,WAAA,CAAAI,WAAW,CAACC;IACxB;IAAA;IAAApE,cAAA,GAAAE,CAAA;IAGF,OAAOc,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;MACEmD,OAAA,EAAS;MACTR,KAAA;MACAS,OAAA,EAAS,iCAAiCxC,QAAA,CAASI,MAAM;IAC3D,GACA;MAAEf,MAAA,EAAQ;IAAI;EAElB,EAAE,OAAOR,KAAA,EAAO;IAAA;IAAAX,cAAA,GAAAE,CAAA;IACdqE,OAAA,CAAQ5D,KAAK,CAAC,qCAAqCA,KAAA;IAAA;IAAAX,cAAA,GAAAE,CAAA;IACnD,OAAOc,OAAA,CAAAC,YAAY,CAACC,IAAI,CACtB;MACEP,KAAA,EAAO;MACP6D,OAAA,EAAS7D,KAAA,YAAiB8D,KAAA;MAAA;MAAA,CAAAzE,cAAA,GAAAe,CAAA,WAAQJ,KAAA,CAAM2D,OAAO;MAAA;MAAA,CAAAtE,cAAA,GAAAe,CAAA,WAAG;IACpD,GACA;MAAEI,MAAA,EAAQ;IAAI;EAElB;AACF","ignoreList":[]}