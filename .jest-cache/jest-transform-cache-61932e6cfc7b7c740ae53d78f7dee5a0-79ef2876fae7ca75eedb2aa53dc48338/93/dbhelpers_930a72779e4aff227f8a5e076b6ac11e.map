{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\crypto\\db-helpers.ts"],"sourcesContent":["/**\n * Database Encryption Helpers\n *\n * Helper functions for transparent encryption/decryption integration\n * with Supabase database operations.\n *\n * Features:\n * - Transparent encryption before insert/update\n * - Transparent decryption after select\n * - Query transformation for encrypted fields\n * - Supabase client integration\n * - Type-safe operations\n *\n * @module crypto/db-helpers\n */\n\nimport { SupabaseClient } from '@supabase/supabase-js';\nimport type { Database } from '@/types/database';\nimport { FieldEncryptor, fieldEncryptor } from './field-encryptor';\nimport { ENCRYPTED_FIELDS } from './types';\n\n/**\n * Encrypted database client that transparently handles encryption/decryption\n */\nexport class EncryptedSupabaseClient {\n  constructor(\n    private client: SupabaseClient<Database>,\n    private encryptor: FieldEncryptor = fieldEncryptor\n  ) {}\n\n  /**\n   * Insert a contact with automatic field encryption\n   *\n   * @param contact - Contact data to insert\n   * @returns Insert result with encrypted fields\n   */\n  async insertContact(\n    contact: Database['public']['Tables']['contacts']['Insert']\n  ): Promise<{\n    data: Database['public']['Tables']['contacts']['Row'] | null;\n    error: Error | null;\n  }> {\n    try {\n      // Encrypt PII fields\n      const encryptedContact = this.encryptor.encryptContact(contact);\n\n      // Perform insert\n      const { data, error } = await this.client\n        .from('contacts')\n        .insert(encryptedContact)\n        .select()\n        .single();\n\n      if (error) {\n        return { data: null, error };\n      }\n\n      // Decrypt the returned data for consistency\n      if (data) {\n        const decryptedData = this.encryptor.decryptContact(data);\n        return { data: decryptedData, error: null };\n      }\n\n      return { data, error: null };\n    } catch (error) {\n      return {\n        data: null,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Update a contact with automatic field encryption\n   *\n   * @param id - Contact ID\n   * @param updates - Contact fields to update\n   * @returns Update result with decrypted fields\n   */\n  async updateContact(\n    id: string,\n    updates: Database['public']['Tables']['contacts']['Update']\n  ): Promise<{\n    data: Database['public']['Tables']['contacts']['Row'] | null;\n    error: Error | null;\n  }> {\n    try {\n      // Encrypt PII fields in updates\n      const encryptedUpdates = this.encryptor.encryptContact(updates);\n\n      // Perform update\n      const { data, error } = await this.client\n        .from('contacts')\n        .update(encryptedUpdates)\n        .eq('id', id)\n        .select()\n        .single();\n\n      if (error) {\n        return { data: null, error };\n      }\n\n      // Decrypt the returned data\n      if (data) {\n        const decryptedData = this.encryptor.decryptContact(data);\n        return { data: decryptedData, error: null };\n      }\n\n      return { data, error: null };\n    } catch (error) {\n      return {\n        data: null,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Select contacts with automatic field decryption\n   *\n   * @param organizationId - Organization ID to filter by\n   * @returns Array of contacts with decrypted fields\n   */\n  async selectContacts(organizationId: string): Promise<{\n    data: Database['public']['Tables']['contacts']['Row'][] | null;\n    error: Error | null;\n  }> {\n    try {\n      const { data, error } = await this.client\n        .from('contacts')\n        .select('*')\n        .eq('organization_id', organizationId);\n\n      if (error) {\n        return { data: null, error };\n      }\n\n      // Decrypt all contacts\n      if (data) {\n        const decryptedData = data.map((contact) =>\n          this.encryptor.decryptContact(contact)\n        );\n        return { data: decryptedData, error: null };\n      }\n\n      return { data, error: null };\n    } catch (error) {\n      return {\n        data: null,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Select a single contact by ID with automatic decryption\n   *\n   * @param id - Contact ID\n   * @returns Contact with decrypted fields\n   */\n  async selectContactById(id: string): Promise<{\n    data: Database['public']['Tables']['contacts']['Row'] | null;\n    error: Error | null;\n  }> {\n    try {\n      const { data, error } = await this.client\n        .from('contacts')\n        .select('*')\n        .eq('id', id)\n        .single();\n\n      if (error) {\n        return { data: null, error };\n      }\n\n      // Decrypt the contact\n      if (data) {\n        const decryptedData = this.encryptor.decryptContact(data);\n        return { data: decryptedData, error: null };\n      }\n\n      return { data, error: null };\n    } catch (error) {\n      return {\n        data: null,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Insert a profile with automatic field encryption\n   *\n   * @param profile - Profile data to insert\n   * @returns Insert result with encrypted fields\n   */\n  async insertProfile(\n    profile: Database['public']['Tables']['profiles']['Insert']\n  ): Promise<{\n    data: Database['public']['Tables']['profiles']['Row'] | null;\n    error: Error | null;\n  }> {\n    try {\n      // Encrypt PII fields\n      const encryptedProfile = this.encryptor.encryptProfile(profile);\n\n      // Perform insert\n      const { data, error } = await this.client\n        .from('profiles')\n        .insert(encryptedProfile)\n        .select()\n        .single();\n\n      if (error) {\n        return { data: null, error };\n      }\n\n      // Decrypt the returned data\n      if (data) {\n        const decryptedData = this.encryptor.decryptProfile(data);\n        return { data: decryptedData, error: null };\n      }\n\n      return { data, error: null };\n    } catch (error) {\n      return {\n        data: null,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Update a profile with automatic field encryption\n   *\n   * @param id - Profile ID\n   * @param updates - Profile fields to update\n   * @returns Update result with decrypted fields\n   */\n  async updateProfile(\n    id: string,\n    updates: Database['public']['Tables']['profiles']['Update']\n  ): Promise<{\n    data: Database['public']['Tables']['profiles']['Row'] | null;\n    error: Error | null;\n  }> {\n    try {\n      // Encrypt PII fields in updates\n      const encryptedUpdates = this.encryptor.encryptProfile(updates);\n\n      // Perform update\n      const { data, error } = await this.client\n        .from('profiles')\n        .update(encryptedUpdates)\n        .eq('id', id)\n        .select()\n        .single();\n\n      if (error) {\n        return { data: null, error };\n      }\n\n      // Decrypt the returned data\n      if (data) {\n        const decryptedData = this.encryptor.decryptProfile(data);\n        return { data: decryptedData, error: null };\n      }\n\n      return { data, error: null };\n    } catch (error) {\n      return {\n        data: null,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Select profiles with automatic field decryption\n   *\n   * @param organizationId - Organization ID to filter by\n   * @returns Array of profiles with decrypted fields\n   */\n  async selectProfiles(organizationId: string): Promise<{\n    data: Database['public']['Tables']['profiles']['Row'][] | null;\n    error: Error | null;\n  }> {\n    try {\n      const { data, error } = await this.client\n        .from('profiles')\n        .select('*')\n        .eq('organization_id', organizationId);\n\n      if (error) {\n        return { data: null, error };\n      }\n\n      // Decrypt all profiles\n      if (data) {\n        const decryptedData = data.map((profile) =>\n          this.encryptor.decryptProfile(profile)\n        );\n        return { data: decryptedData, error: null };\n      }\n\n      return { data, error: null };\n    } catch (error) {\n      return {\n        data: null,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Select a single profile by ID with automatic decryption\n   *\n   * @param id - Profile ID\n   * @returns Profile with decrypted fields\n   */\n  async selectProfileById(id: string): Promise<{\n    data: Database['public']['Tables']['profiles']['Row'] | null;\n    error: Error | null;\n  }> {\n    try {\n      const { data, error } = await this.client\n        .from('profiles')\n        .select('*')\n        .eq('id', id)\n        .single();\n\n      if (error) {\n        return { data: null, error };\n      }\n\n      // Decrypt the profile\n      if (data) {\n        const decryptedData = this.encryptor.decryptProfile(data);\n        return { data: decryptedData, error: null };\n      }\n\n      return { data, error: null };\n    } catch (error) {\n      return {\n        data: null,\n        error: error instanceof Error ? error : new Error(String(error)),\n      };\n    }\n  }\n\n  /**\n   * Get the raw Supabase client for non-encrypted operations\n   *\n   * @returns Supabase client\n   */\n  getClient(): SupabaseClient<Database> {\n    return this.client;\n  }\n}\n\n/**\n * Create an encrypted Supabase client\n *\n * @param client - Supabase client instance\n * @param encryptor - Optional custom field encryptor\n * @returns Encrypted Supabase client\n */\nexport function createEncryptedClient(\n  client: SupabaseClient<Database>,\n  encryptor?: FieldEncryptor\n): EncryptedSupabaseClient {\n  return new EncryptedSupabaseClient(client, encryptor);\n}\n\n/**\n * Encrypt data before insert/update\n *\n * @param tableName - Name of the table\n * @param data - Data to encrypt\n * @returns Data with encrypted fields\n */\nexport function encryptBeforeWrite<T extends Record<string, unknown>>(\n  tableName: keyof typeof ENCRYPTED_FIELDS,\n  data: T\n): T {\n  const encryptor = fieldEncryptor;\n  const fieldsToEncrypt = ENCRYPTED_FIELDS[tableName];\n\n  if (!fieldsToEncrypt || fieldsToEncrypt.length === 0) {\n    return data;\n  }\n\n  return encryptor.encryptRecord(data, fieldsToEncrypt as (keyof T)[]);\n}\n\n/**\n * Decrypt data after select\n *\n * @param tableName - Name of the table\n * @param data - Data to decrypt\n * @returns Data with decrypted fields\n */\nexport function decryptAfterRead<T extends Record<string, unknown>>(\n  tableName: keyof typeof ENCRYPTED_FIELDS,\n  data: T\n): T {\n  const encryptor = fieldEncryptor;\n  const fieldsToDecrypt = ENCRYPTED_FIELDS[tableName];\n\n  if (!fieldsToDecrypt || fieldsToDecrypt.length === 0) {\n    return data;\n  }\n\n  return encryptor.decryptRecord(data, fieldsToDecrypt as (keyof T)[]);\n}\n\n/**\n * Encrypt an array of records\n *\n * @param tableName - Name of the table\n * @param records - Array of records to encrypt\n * @returns Array of records with encrypted fields\n */\nexport function encryptRecords<T extends Record<string, unknown>>(\n  tableName: keyof typeof ENCRYPTED_FIELDS,\n  records: T[]\n): T[] {\n  return records.map((record) => encryptBeforeWrite(tableName, record));\n}\n\n/**\n * Decrypt an array of records\n *\n * @param tableName - Name of the table\n * @param records - Array of records to decrypt\n * @returns Array of records with decrypted fields\n */\nexport function decryptRecords<T extends Record<string, unknown>>(\n  tableName: keyof typeof ENCRYPTED_FIELDS,\n  records: T[]\n): T[] {\n  return records.map((record) => decryptAfterRead(tableName, record));\n}\n\n/**\n * Middleware for automatically encrypting fields in API routes\n *\n * @example\n * ```typescript\n * // In API route\n * const contactData = await req.json();\n * const encrypted = await encryptionMiddleware('contacts', contactData);\n * await supabase.from('contacts').insert(encrypted);\n * ```\n */\nexport async function encryptionMiddleware<T extends Record<string, unknown>>(\n  tableName: keyof typeof ENCRYPTED_FIELDS,\n  data: T\n): Promise<T> {\n  return encryptBeforeWrite(tableName, data);\n}\n\n/**\n * Middleware for automatically decrypting fields in API routes\n *\n * @example\n * ```typescript\n * // In API route\n * const { data } = await supabase.from('contacts').select('*');\n * const decrypted = await decryptionMiddleware('contacts', data);\n * return Response.json(decrypted);\n * ```\n */\nexport async function decryptionMiddleware<T extends Record<string, unknown>>(\n  tableName: keyof typeof ENCRYPTED_FIELDS,\n  data: T | T[]\n): Promise<T | T[]> {\n  if (Array.isArray(data)) {\n    return decryptRecords(tableName, data);\n  }\n  return decryptAfterRead(tableName, data);\n}\n\n/**\n * Create encryption hooks for Supabase queries\n *\n * @param client - Supabase client\n * @returns Object with encryption-aware query methods\n */\nexport function createEncryptionHooks(client: SupabaseClient<Database>) {\n  return {\n    /**\n     * Insert with automatic encryption\n     */\n    async insertWithEncryption<\n      TableName extends keyof typeof ENCRYPTED_FIELDS & keyof Database['public']['Tables']\n    >(\n      tableName: TableName,\n      data: Database['public']['Tables'][TableName]['Insert']\n    ) {\n      const encrypted = encryptBeforeWrite(tableName, data);\n      const result = await client.from(tableName).insert(encrypted).select();\n\n      if (result.data) {\n        return {\n          ...result,\n          data: decryptRecords(\n            tableName,\n            result.data as Record<string, unknown>[]\n          ) as typeof result.data,\n        };\n      }\n\n      return result;\n    },\n\n    /**\n     * Update with automatic encryption\n     */\n    async updateWithEncryption<\n      TableName extends keyof typeof ENCRYPTED_FIELDS & keyof Database['public']['Tables']\n    >(\n      tableName: TableName,\n      id: string,\n      updates: Database['public']['Tables'][TableName]['Update']\n    ) {\n      const encrypted = encryptBeforeWrite(tableName, updates);\n      const result = await client\n        .from(tableName)\n        .update(encrypted)\n        .eq('id', id)\n        .select();\n\n      if (result.data) {\n        return {\n          ...result,\n          data: decryptRecords(\n            tableName,\n            result.data as Record<string, unknown>[]\n          ) as typeof result.data,\n        };\n      }\n\n      return result;\n    },\n\n    /**\n     * Select with automatic decryption\n     */\n    async selectWithDecryption<\n      TableName extends keyof typeof ENCRYPTED_FIELDS & keyof Database['public']['Tables']\n    >(tableName: TableName, query?: string) {\n      const result = await client.from(tableName).select(query || '*');\n\n      if (result.data) {\n        return {\n          ...result,\n          data: decryptRecords(\n            tableName,\n            result.data as Record<string, unknown>[]\n          ) as typeof result.data,\n        };\n      }\n\n      return result;\n    },\n  };\n}\n\n/**\n * Verify that encryption is properly configured for database operations\n *\n * @returns Verification result\n */\nexport function verifyDatabaseEncryption(): {\n  configured: boolean;\n  tablesConfigured: string[];\n  fieldsConfigured: Record<string, string[]>;\n  warnings: string[];\n} {\n  const warnings: string[] = [];\n  const tablesConfigured = Object.keys(ENCRYPTED_FIELDS);\n  const fieldsConfigured: Record<string, string[]> = {};\n\n  // Check each table configuration\n  for (const [table, fields] of Object.entries(ENCRYPTED_FIELDS)) {\n    fieldsConfigured[table] = fields;\n\n    if (fields.length === 0) {\n      warnings.push(`Table '${table}' has no encrypted fields configured`);\n    }\n  }\n\n  // Check if encryption key is available\n  try {\n    const { healthy } = FieldEncryptor.verifyEncryption();\n    if (!healthy) {\n      warnings.push('Encryption system is not healthy');\n    }\n  } catch (error) {\n    warnings.push(\n      `Encryption verification failed: ${error instanceof Error ? error.message : String(error)}`\n    );\n  }\n\n  return {\n    configured: warnings.length === 0,\n    tablesConfigured,\n    fieldsConfigured,\n    warnings,\n  };\n}\n"],"names":["EncryptedSupabaseClient","createEncryptedClient","createEncryptionHooks","decryptAfterRead","decryptRecords","decryptionMiddleware","encryptBeforeWrite","encryptRecords","encryptionMiddleware","verifyDatabaseEncryption","client","encryptor","fieldEncryptor","insertContact","contact","encryptedContact","encryptContact","data","error","from","insert","select","single","decryptedData","decryptContact","Error","String","updateContact","id","updates","encryptedUpdates","update","eq","selectContacts","organizationId","map","selectContactById","insertProfile","profile","encryptedProfile","encryptProfile","decryptProfile","updateProfile","selectProfiles","selectProfileById","getClient","tableName","fieldsToEncrypt","ENCRYPTED_FIELDS","length","encryptRecord","fieldsToDecrypt","decryptRecord","records","record","Array","isArray","insertWithEncryption","encrypted","result","updateWithEncryption","selectWithDecryption","query","warnings","tablesConfigured","Object","keys","fieldsConfigured","table","fields","entries","push","healthy","FieldEncryptor","verifyEncryption","message","configured"],"mappings":"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"}