{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\queue\\bull-config.ts"],"sourcesContent":["import { Queue, Worker, QueueEvents, ConnectionOptions } from 'bullmq';\nimport IORedis from 'ioredis';\n\n/**\n * BullMQ Job Queue Configuration\n *\n * Production-ready job queue system for asynchronous processing.\n * Handles bulk operations, contact imports, template processing, and email notifications.\n *\n * Features:\n * - Redis-backed reliable job storage\n * - Automatic retry with exponential backoff\n * - Job progress tracking\n * - Dead letter queue for failed jobs\n * - Queue monitoring and health checks\n * - Multi-tenant job isolation\n *\n * @module bull-config\n */\n\n/**\n * Job priorities for queue processing\n */\nexport enum JobPriority {\n  CRITICAL = 1, // User-initiated actions (immediate send)\n  HIGH = 2, // Scheduled campaigns\n  NORMAL = 3, // Background imports\n  LOW = 4 // Analytics processing\n}\n\n/**\n * Job status enum\n */\nexport enum JobStatus {\n  WAITING = 'waiting',\n  ACTIVE = 'active',\n  COMPLETED = 'completed',\n  FAILED = 'failed',\n  DELAYED = 'delayed',\n  PAUSED = 'paused'\n}\n\n/**\n * Queue names\n */\nexport enum QueueName {\n  BULK_MESSAGE = 'bulk-messages',\n  CONTACT_IMPORT = 'contact-import',\n  TEMPLATE_PROCESSING = 'template-processing',\n  EMAIL_NOTIFICATION = 'email-notification'\n}\n\n/**\n * Redis connection configuration\n */\nexport interface RedisConfig {\n  host: string;\n  port: number;\n  password?: string;\n  db?: number;\n  maxRetriesPerRequest?: number;\n  enableReadyCheck?: boolean;\n  enableOfflineQueue?: boolean;\n}\n\n/**\n * Job options configuration\n */\nexport interface JobConfig {\n  attempts: number;\n  backoff: {\n    type: 'exponential' | 'fixed';\n    delay: number;\n  };\n  removeOnComplete: number | boolean;\n  removeOnFail: number | boolean;\n  timeout?: number;\n}\n\n/**\n * Queue statistics\n */\nexport interface QueueStats {\n  waiting: number;\n  active: number;\n  completed: number;\n  failed: number;\n  delayed: number;\n  paused: number;\n}\n\n/**\n * Get Redis connection configuration from environment\n */\nexport function getRedisConfig(): RedisConfig {\n  const url = process.env.UPSTASH_REDIS_REST_URL;\n\n  if (!url) {\n    throw new Error('UPSTASH_REDIS_REST_URL environment variable is not set');\n  }\n\n  // Parse Upstash Redis URL\n  // Format: https://host:port or redis://host:port\n  const urlObj = new URL(url);\n  const host = urlObj.hostname;\n  const port = parseInt(urlObj.port || '6379', 10);\n\n  return {\n    host,\n    port,\n    password: process.env.UPSTASH_REDIS_REST_TOKEN,\n    db: 0,\n    maxRetriesPerRequest: 3,\n    enableReadyCheck: false,\n    enableOfflineQueue: true\n  };\n}\n\n/**\n * Get Redis IORedis connection for BullMQ\n */\nexport function getRedisConnection(): IORedis {\n  const config = getRedisConfig();\n\n  return new IORedis({\n    host: config.host,\n    port: config.port,\n    password: config.password,\n    db: config.db || 0,\n    maxRetriesPerRequest: config.maxRetriesPerRequest || 3,\n    enableReadyCheck: config.enableReadyCheck ?? false,\n    enableOfflineQueue: config.enableOfflineQueue ?? true,\n    retryStrategy(times: number) {\n      const delay = Math.min(times * 50, 2000);\n      return delay;\n    },\n    reconnectOnError(err: Error) {\n      const targetError = 'READONLY';\n      if (err.message.includes(targetError)) {\n        // Only reconnect when the error contains \"READONLY\"\n        return true;\n      }\n      return false;\n    }\n  });\n}\n\n/**\n * Default job configuration\n */\nexport const DEFAULT_JOB_CONFIG: JobConfig = {\n  attempts: 3,\n  backoff: {\n    type: 'exponential',\n    delay: 1000\n  },\n  removeOnComplete: 100, // Keep last 100 completed jobs\n  removeOnFail: 1000, // Keep last 1000 failed jobs for debugging\n  timeout: 300000 // 5 minutes default timeout\n};\n\n/**\n * Job configuration by queue type\n */\nexport const QUEUE_CONFIGS: Record<QueueName, Partial<JobConfig>> = {\n  [QueueName.BULK_MESSAGE]: {\n    attempts: 3,\n    backoff: {\n      type: 'exponential',\n      delay: 2000\n    },\n    timeout: 600000 // 10 minutes for bulk messages\n  },\n  [QueueName.CONTACT_IMPORT]: {\n    attempts: 2,\n    backoff: {\n      type: 'exponential',\n      delay: 5000\n    },\n    timeout: 1800000 // 30 minutes for large imports\n  },\n  [QueueName.TEMPLATE_PROCESSING]: {\n    attempts: 3,\n    backoff: {\n      type: 'exponential',\n      delay: 1000\n    },\n    timeout: 180000 // 3 minutes\n  },\n  [QueueName.EMAIL_NOTIFICATION]: {\n    attempts: 5,\n    backoff: {\n      type: 'exponential',\n      delay: 2000\n    },\n    timeout: 60000 // 1 minute\n  }\n};\n\n/**\n * Worker concurrency configuration\n */\nexport const WORKER_CONCURRENCY: Record<QueueName, number> = {\n  [QueueName.BULK_MESSAGE]: 5, // 5 concurrent workers for messages\n  [QueueName.CONTACT_IMPORT]: 2, // 2 concurrent workers for imports\n  [QueueName.TEMPLATE_PROCESSING]: 10, // 10 concurrent workers for templates\n  [QueueName.EMAIL_NOTIFICATION]: 10 // 10 concurrent workers for emails\n};\n\n/**\n * Create a BullMQ queue\n */\nexport function createQueue(queueName: QueueName): Queue {\n  const connection = getRedisConnection();\n  const config = {\n    ...DEFAULT_JOB_CONFIG,\n    ...QUEUE_CONFIGS[queueName]\n  };\n\n  const queue = new Queue(queueName, {\n    connection,\n    defaultJobOptions: {\n      attempts: config.attempts,\n      backoff: config.backoff,\n      removeOnComplete: config.removeOnComplete,\n      removeOnFail: config.removeOnFail,\n      timeout: config.timeout\n    }\n  });\n\n  return queue;\n}\n\n/**\n * Create a BullMQ worker\n */\nexport function createWorker(\n  queueName: QueueName,\n  processor: (job: any) => Promise<any>\n): Worker {\n  const connection = getRedisConnection();\n  const concurrency = WORKER_CONCURRENCY[queueName];\n\n  const worker = new Worker(queueName, processor, {\n    connection,\n    concurrency,\n    autorun: true,\n    removeOnComplete: { count: 100 },\n    removeOnFail: { count: 1000 }\n  });\n\n  // Worker event handlers\n  worker.on('completed', (job) => {\n    console.log(`[${queueName}] Job ${job.id} completed successfully`);\n  });\n\n  worker.on('failed', (job, err) => {\n    console.error(\n      `[${queueName}] Job ${job?.id} failed with error:`,\n      err.message\n    );\n  });\n\n  worker.on('error', (err) => {\n    console.error(`[${queueName}] Worker error:`, err);\n  });\n\n  return worker;\n}\n\n/**\n * Create queue events listener\n */\nexport function createQueueEvents(queueName: QueueName): QueueEvents {\n  const connection = getRedisConnection();\n\n  const queueEvents = new QueueEvents(queueName, {\n    connection\n  });\n\n  return queueEvents;\n}\n\n/**\n * Get queue statistics\n */\nexport async function getQueueStats(queue: Queue): Promise<QueueStats> {\n  const [waiting, active, completed, failed, delayed, paused] =\n    await Promise.all([\n      queue.getWaitingCount(),\n      queue.getActiveCount(),\n      queue.getCompletedCount(),\n      queue.getFailedCount(),\n      queue.getDelayedCount(),\n      queue.getPausedCount()\n    ]);\n\n  return {\n    waiting,\n    active,\n    completed,\n    failed,\n    delayed,\n    paused\n  };\n}\n\n/**\n * Health check for queue system\n */\nexport async function checkQueueHealth(queue: Queue): Promise<{\n  healthy: boolean;\n  queueName: string;\n  stats: QueueStats;\n  latency: number;\n  error?: string;\n}> {\n  try {\n    const start = Date.now();\n    const stats = await getQueueStats(queue);\n    const latency = Date.now() - start;\n\n    return {\n      healthy: true,\n      queueName: queue.name,\n      stats,\n      latency\n    };\n  } catch (error) {\n    const message = error instanceof Error ? error.message : 'Unknown error';\n    return {\n      healthy: false,\n      queueName: queue.name,\n      stats: {\n        waiting: 0,\n        active: 0,\n        completed: 0,\n        failed: 0,\n        delayed: 0,\n        paused: 0\n      },\n      latency: -1,\n      error: message\n    };\n  }\n}\n\n/**\n * Graceful shutdown for queue and worker\n */\nexport async function gracefulShutdown(\n  queue: Queue,\n  worker: Worker,\n  queueEvents: QueueEvents\n): Promise<void> {\n  console.log(`Gracefully shutting down ${queue.name}...`);\n\n  try {\n    // Close queue events first\n    await queueEvents.close();\n\n    // Close worker (wait for active jobs to complete)\n    await worker.close();\n\n    // Close queue\n    await queue.close();\n\n    console.log(`${queue.name} shutdown complete`);\n  } catch (error) {\n    console.error(`Error during shutdown of ${queue.name}:`, error);\n    throw error;\n  }\n}\n\n/**\n * Pause a queue\n */\nexport async function pauseQueue(queue: Queue): Promise<void> {\n  await queue.pause();\n  console.log(`Queue ${queue.name} paused`);\n}\n\n/**\n * Resume a queue\n */\nexport async function resumeQueue(queue: Queue): Promise<void> {\n  await queue.resume();\n  console.log(`Queue ${queue.name} resumed`);\n}\n\n/**\n * Clear all jobs from a queue\n */\nexport async function clearQueue(queue: Queue): Promise<void> {\n  await queue.drain();\n  await queue.clean(0, 0, 'completed');\n  await queue.clean(0, 0, 'failed');\n  console.log(`Queue ${queue.name} cleared`);\n}\n"],"names":["DEFAULT_JOB_CONFIG","JobPriority","JobStatus","QUEUE_CONFIGS","QueueName","WORKER_CONCURRENCY","checkQueueHealth","clearQueue","createQueue","createQueueEvents","createWorker","getQueueStats","getRedisConfig","getRedisConnection","gracefulShutdown","pauseQueue","resumeQueue","url","process","env","UPSTASH_REDIS_REST_URL","Error","urlObj","URL","host","hostname","port","parseInt","password","UPSTASH_REDIS_REST_TOKEN","db","maxRetriesPerRequest","enableReadyCheck","enableOfflineQueue","config","IORedis","retryStrategy","times","delay","Math","min","reconnectOnError","err","targetError","message","includes","attempts","backoff","type","removeOnComplete","removeOnFail","timeout","queueName","connection","queue","Queue","defaultJobOptions","processor","concurrency","worker","Worker","autorun","count","on","job","console","log","id","error","queueEvents","QueueEvents","waiting","active","completed","failed","delayed","paused","Promise","all","getWaitingCount","getActiveCount","getCompletedCount","getFailedCount","getDelayedCount","getPausedCount","start","Date","now","stats","latency","healthy","name","close","pause","resume","drain","clean"],"mappings":"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"}