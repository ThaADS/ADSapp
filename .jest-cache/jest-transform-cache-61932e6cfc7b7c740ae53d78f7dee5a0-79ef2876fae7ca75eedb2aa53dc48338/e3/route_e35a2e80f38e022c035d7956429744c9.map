{"version":3,"names":["GET","cov_zywa989km","f","s","POST","request","user","_apiutils","requireAuthenticatedUser","profile","getUserOrganization","id","supabase","_server1","createClient","data","org","from","select","eq","organization_id","single","b","whatsapp_business_account_id","whatsapp_access_token","_server","NextResponse","json","error","status","whatsappClient","_enhancedclient","getWhatsAppClient","whatsappTemplates","getTemplates","existingTemplates","not","existingTemplateMap","Map","map","t","whatsapp_template_id","results","synced","created","updated","errors","whatsappTemplate","existingTemplate","get","templateData","name","content","extractTemplateContent","category","variables","extractTemplateVariables","whatsapp_template_name","whatsapp_status","whatsapp_template_data","is_active","updatedTemplate","update","updated_at","Date","toISOString","push","newTemplate","insert","created_by","console","templateId","templateName","message","whatsappTemplateIds","Set","deletedTemplates","filter","has","deletedTemplate","createSuccessResponse","summary","totalWhatsAppTemplates","length","deleted","details","whatsappTemplateId","createErrorResponse","dbTemplates","syncStatus","databaseTemplates","needsSync","syncDetails","newInWhatsApp","updatedInWhatsApp","deletedFromWhatsApp","outOfSync","dbTemplateMap","dbTemplate","oldStatus","newStatus","lastSyncAt","getLastSyncTime","components","bodyComponent","find","c","type","text","component","example","body_text","bodyText","matches","match","forEach","index","organizationId","order","ascending","limit"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\app\\api\\templates\\sync\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { requireAuthenticatedUser, getUserOrganization, createErrorResponse, createSuccessResponse } from '@/lib/api-utils'\nimport { getWhatsAppClient } from '@/lib/whatsapp/enhanced-client'\nimport { createClient } from '@/lib/supabase/server'\n\nexport async function POST(request: NextRequest) {\n  try {\n    const user = await requireAuthenticatedUser()\n    const profile = await getUserOrganization(user.id)\n\n    const supabase = await createClient()\n\n    // Get organization's WhatsApp configuration\n    const { data: org } = await supabase\n      .from('organizations')\n      .select('whatsapp_business_account_id, whatsapp_access_token')\n      .eq('id', profile.organization_id)\n      .single()\n\n    if (!org?.whatsapp_business_account_id || !org?.whatsapp_access_token) {\n      return NextResponse.json(\n        { error: 'WhatsApp Business Account not configured' },\n        { status: 400 }\n      )\n    }\n\n    const whatsappClient = await getWhatsAppClient(profile.organization_id)\n\n    // Get templates from WhatsApp\n    const whatsappTemplates = await whatsappClient.getTemplates(org.whatsapp_business_account_id)\n\n    // Get existing templates from database\n    const { data: existingTemplates } = await supabase\n      .from('message_templates')\n      .select('*')\n      .eq('organization_id', profile.organization_id)\n      .not('whatsapp_template_id', 'is', null)\n\n    const existingTemplateMap = new Map(\n      (existingTemplates || []).map(t => [t.whatsapp_template_id, t])\n    )\n\n    const results = {\n      synced: [],\n      created: [],\n      updated: [],\n      errors: []\n    }\n\n    // Process each WhatsApp template\n    for (const whatsappTemplate of whatsappTemplates) {\n      try {\n        const existingTemplate = existingTemplateMap.get(whatsappTemplate.id)\n\n        const templateData = {\n          name: whatsappTemplate.name,\n          content: extractTemplateContent(whatsappTemplate),\n          category: whatsappTemplate.category || 'general',\n          variables: extractTemplateVariables(whatsappTemplate),\n          whatsapp_template_id: whatsappTemplate.id,\n          whatsapp_template_name: whatsappTemplate.name,\n          whatsapp_status: whatsappTemplate.status,\n          whatsapp_template_data: whatsappTemplate,\n          is_active: whatsappTemplate.status === 'APPROVED'\n        }\n\n        if (existingTemplate) {\n          // Update existing template\n          const { data: updatedTemplate, error } = await supabase\n            .from('message_templates')\n            .update({\n              ...templateData,\n              updated_at: new Date().toISOString()\n            })\n            .eq('id', existingTemplate.id)\n            .select()\n            .single()\n\n          if (error) {\n            throw error\n          }\n\n          results.updated.push(updatedTemplate)\n        } else {\n          // Create new template\n          const { data: newTemplate, error } = await supabase\n            .from('message_templates')\n            .insert({\n              organization_id: profile.organization_id,\n              created_by: user.id,\n              ...templateData\n            })\n            .select()\n            .single()\n\n          if (error) {\n            throw error\n          }\n\n          results.created.push(newTemplate)\n        }\n\n        results.synced.push({\n          id: whatsappTemplate.id,\n          name: whatsappTemplate.name,\n          status: whatsappTemplate.status\n        })\n\n      } catch (error) {\n        console.error(`Error syncing template ${whatsappTemplate.id}:`, error)\n        results.errors.push({\n          templateId: whatsappTemplate.id,\n          templateName: whatsappTemplate.name,\n          error: error.message\n        })\n      }\n    }\n\n    // Check for templates that were deleted from WhatsApp\n    const whatsappTemplateIds = new Set(whatsappTemplates.map(t => t.id))\n    const deletedTemplates = (existingTemplates || []).filter(\n      t => t.whatsapp_template_id && !whatsappTemplateIds.has(t.whatsapp_template_id)\n    )\n\n    // Mark deleted templates as inactive\n    for (const deletedTemplate of deletedTemplates) {\n      await supabase\n        .from('message_templates')\n        .update({\n          is_active: false,\n          whatsapp_status: 'deleted',\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', deletedTemplate.id)\n    }\n\n    return createSuccessResponse({\n      summary: {\n        totalWhatsAppTemplates: whatsappTemplates.length,\n        synced: results.synced.length,\n        created: results.created.length,\n        updated: results.updated.length,\n        deleted: deletedTemplates.length,\n        errors: results.errors.length\n      },\n      details: results,\n      deletedTemplates: deletedTemplates.map(t => ({\n        id: t.id,\n        name: t.name,\n        whatsappTemplateId: t.whatsapp_template_id\n      }))\n    })\n\n  } catch (error) {\n    console.error('Template sync error:', error)\n    return createErrorResponse(error)\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const user = await requireAuthenticatedUser()\n    const profile = await getUserOrganization(user.id)\n\n    const supabase = await createClient()\n\n    // Get organization's WhatsApp configuration\n    const { data: org } = await supabase\n      .from('organizations')\n      .select('whatsapp_business_account_id')\n      .eq('id', profile.organization_id)\n      .single()\n\n    if (!org?.whatsapp_business_account_id) {\n      return NextResponse.json(\n        { error: 'WhatsApp Business Account not configured' },\n        { status: 400 }\n      )\n    }\n\n    const whatsappClient = await getWhatsAppClient(profile.organization_id)\n\n    // Get templates from WhatsApp (for comparison)\n    const whatsappTemplates = await whatsappClient.getTemplates(org.whatsapp_business_account_id)\n\n    // Get existing templates from database\n    const { data: dbTemplates } = await supabase\n      .from('message_templates')\n      .select('*')\n      .eq('organization_id', profile.organization_id)\n      .not('whatsapp_template_id', 'is', null)\n\n    const syncStatus = {\n      whatsappTemplates: whatsappTemplates.length,\n      databaseTemplates: dbTemplates?.length || 0,\n      needsSync: false,\n      syncDetails: {\n        newInWhatsApp: [],\n        updatedInWhatsApp: [],\n        deletedFromWhatsApp: [],\n        outOfSync: []\n      }\n    }\n\n    const dbTemplateMap = new Map(\n      (dbTemplates || []).map(t => [t.whatsapp_template_id, t])\n    )\n\n    // Check for new templates in WhatsApp\n    for (const whatsappTemplate of whatsappTemplates) {\n      const dbTemplate = dbTemplateMap.get(whatsappTemplate.id)\n\n      if (!dbTemplate) {\n        syncStatus.syncDetails.newInWhatsApp.push({\n          id: whatsappTemplate.id,\n          name: whatsappTemplate.name,\n          status: whatsappTemplate.status\n        })\n        syncStatus.needsSync = true\n      } else if (dbTemplate.whatsapp_status !== whatsappTemplate.status) {\n        syncStatus.syncDetails.updatedInWhatsApp.push({\n          id: whatsappTemplate.id,\n          name: whatsappTemplate.name,\n          oldStatus: dbTemplate.whatsapp_status,\n          newStatus: whatsappTemplate.status\n        })\n        syncStatus.needsSync = true\n      }\n    }\n\n    // Check for deleted templates\n    const whatsappTemplateIds = new Set(whatsappTemplates.map(t => t.id))\n    for (const dbTemplate of dbTemplates || []) {\n      if (dbTemplate.whatsapp_template_id && !whatsappTemplateIds.has(dbTemplate.whatsapp_template_id)) {\n        syncStatus.syncDetails.deletedFromWhatsApp.push({\n          id: dbTemplate.id,\n          name: dbTemplate.name,\n          whatsappTemplateId: dbTemplate.whatsapp_template_id\n        })\n        syncStatus.needsSync = true\n      }\n    }\n\n    return createSuccessResponse({\n      lastSyncAt: await getLastSyncTime(supabase, profile.organization_id),\n      syncStatus\n    })\n\n  } catch (error) {\n    console.error('Template sync status error:', error)\n    return createErrorResponse(error)\n  }\n}\n\nfunction extractTemplateContent(whatsappTemplate: any): string {\n  try {\n    // Extract content from WhatsApp template structure\n    const components = whatsappTemplate.components || []\n    const bodyComponent = components.find(c => c.type === 'BODY')\n\n    if (bodyComponent && bodyComponent.text) {\n      return bodyComponent.text\n    }\n\n    return whatsappTemplate.name || 'WhatsApp Template'\n  } catch (error) {\n    console.error('Error extracting template content:', error)\n    return 'WhatsApp Template'\n  }\n}\n\nfunction extractTemplateVariables(whatsappTemplate: any): Array<{ name: string; type: string; example?: string }> {\n  try {\n    const variables = []\n    const components = whatsappTemplate.components || []\n\n    for (const component of components) {\n      if (component.example && component.example.body_text) {\n        // Extract variables from body text examples\n        const bodyText = component.text || ''\n        const matches = bodyText.match(/\\{\\{(\\d+)\\}\\}/g) || []\n\n        matches.forEach((match, index) => {\n          variables.push({\n            name: `var${index + 1}`,\n            type: 'text',\n            example: component.example.body_text[0]?.[index] || ''\n          })\n        })\n      }\n    }\n\n    return variables\n  } catch (error) {\n    console.error('Error extracting template variables:', error)\n    return []\n  }\n}\n\nasync function getLastSyncTime(supabase: any, organizationId: string): Promise<string | null> {\n  const { data } = await supabase\n    .from('message_templates')\n    .select('updated_at')\n    .eq('organization_id', organizationId)\n    .not('whatsapp_template_id', 'is', null)\n    .order('updated_at', { ascending: false })\n    .limit(1)\n    .single()\n\n  return data?.updated_at || null\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}