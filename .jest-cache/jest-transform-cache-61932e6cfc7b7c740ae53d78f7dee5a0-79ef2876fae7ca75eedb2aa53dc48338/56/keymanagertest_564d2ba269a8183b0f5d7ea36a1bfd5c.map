{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\unit\\lib\\security\\key-manager.test.ts"],"sourcesContent":["/**\n * Key Manager Unit Tests\n *\n * Tests key rotation (90-day expiration), key versioning,\n * backward compatibility, and multi-tenant key isolation.\n */\n\nimport {\n  KeyManager,\n  getKeyManager,\n  resetKeyManager,\n  __testing__,\n} from '@/lib/security/key-manager';\nimport { KMSClient } from '@/lib/security/kms-client';\nimport * as crypto from 'crypto';\n\n// Mock dependencies\njest.mock('@/lib/supabase/server');\njest.mock('@/lib/security/kms-client');\n\nimport { createClient } from '@/lib/supabase/server';\n\ndescribe('KeyManager - Key Rotation & Versioning', () => {\n  let keyManager: KeyManager;\n  let mockKMSClient: jest.Mocked<KMSClient>;\n  let mockSupabaseClient: any;\n\n  beforeEach(() => {\n    // Reset key manager singleton\n    resetKeyManager();\n\n    // Create mock KMS client\n    mockKMSClient = {\n      generateDataKey: jest.fn(),\n      decryptDataKey: jest.fn(),\n      encryptDataKey: jest.fn(),\n      rotateKey: jest.fn(),\n      listKeys: jest.fn(),\n      describeKey: jest.fn(),\n      scheduleKeyDeletion: jest.fn(),\n      cancelKeyDeletion: jest.fn(),\n      getKeyRotationStatus: jest.fn(),\n      enableKeyRotation: jest.fn(),\n      disableKeyRotation: jest.fn(),\n      createAlias: jest.fn(),\n      updateAlias: jest.fn(),\n      deleteAlias: jest.fn(),\n      listAliases: jest.fn(),\n    } as any;\n\n    // Create mock Supabase client\n    mockSupabaseClient = {\n      from: jest.fn().mockReturnThis(),\n      select: jest.fn().mockReturnThis(),\n      insert: jest.fn().mockReturnThis(),\n      update: jest.fn().mockReturnThis(),\n      delete: jest.fn().mockReturnThis(),\n      eq: jest.fn().mockReturnThis(),\n      lte: jest.fn().mockReturnThis(),\n      order: jest.fn().mockReturnThis(),\n      limit: jest.fn().mockReturnThis(),\n      single: jest.fn(),\n    };\n\n    // Mock createClient to return our mock\n    (createClient as jest.MockedFunction<typeof createClient>) = jest\n      .fn()\n      .mockResolvedValue(mockSupabaseClient);\n\n    // Create key manager with mocked KMS client\n    keyManager = new KeyManager(mockKMSClient);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n    resetKeyManager();\n  });\n\n  describe('Key Rotation (90-day Expiration)', () => {\n    it('should rotate key after 90-day expiration', async () => {\n      // Arrange\n      const tenantId = 'tenant-abc123';\n      const currentVersion = 1;\n      const now = new Date();\n      const expiredDate = new Date(now.getTime() - 91 * 24 * 60 * 60 * 1000); // 91 days ago\n\n      const expiredKey = {\n        id: 'key-old-123',\n        tenant_id: tenantId,\n        kms_key_id: 'arn:aws:kms:old',\n        encrypted_data_key: 'encrypted-old-key-base64',\n        version: currentVersion,\n        is_active: true,\n        created_at: expiredDate.toISOString(),\n        expires_at: expiredDate.toISOString(),\n        rotated_at: null,\n      };\n\n      const newKeyPlaintext = crypto.randomBytes(32);\n      const newKeyEncrypted = 'encrypted-new-key-base64';\n\n      // Mock database responses\n      mockSupabaseClient.single\n        .mockResolvedValueOnce({ data: expiredKey, error: null }) // Get active key\n        .mockResolvedValueOnce({ data: null, error: null }); // Get next version\n\n      mockSupabaseClient.update.mockResolvedValue({ data: null, error: null });\n      mockSupabaseClient.insert.mockResolvedValue({ data: null, error: null });\n\n      // Mock KMS responses\n      mockKMSClient.generateDataKey.mockResolvedValue({\n        keyId: 'arn:aws:kms:new',\n        plaintext: newKeyPlaintext,\n        ciphertext: newKeyEncrypted,\n      });\n\n      // Act\n      const newKey = await keyManager.rotateKey(tenantId);\n\n      // Assert\n      expect(newKey).toBeDefined();\n      expect(newKey).toBeInstanceOf(Buffer);\n      expect(mockSupabaseClient.update).toHaveBeenCalled();\n      expect(mockKMSClient.generateDataKey).toHaveBeenCalledWith(tenantId);\n    });\n\n    it('should detect keys approaching expiration', async () => {\n      // Arrange\n      const tenantId = 'tenant-warning';\n      const now = new Date();\n      const nearExpirationDate = new Date(now.getTime() + 5 * 24 * 60 * 60 * 1000); // 5 days from now\n\n      const key = {\n        id: 'key-warning-123',\n        tenant_id: tenantId,\n        kms_key_id: 'arn:aws:kms:key',\n        encrypted_data_key: 'encrypted-key-base64',\n        version: 1,\n        is_active: true,\n        created_at: now.toISOString(),\n        expires_at: nearExpirationDate.toISOString(),\n        rotated_at: null,\n      };\n\n      const keyPlaintext = crypto.randomBytes(32);\n\n      mockSupabaseClient.single.mockResolvedValue({ data: key, error: null });\n      mockKMSClient.decryptDataKey.mockResolvedValue({\n        keyId: key.kms_key_id,\n        plaintext: keyPlaintext,\n      });\n\n      // Spy on console to verify warning\n      const consoleInfoSpy = jest.spyOn(console, 'info').mockImplementation();\n\n      // Act\n      await keyManager.getEncryptionKey(tenantId);\n\n      // Assert\n      expect(consoleInfoSpy).toHaveBeenCalledWith(\n        expect.stringContaining('approaching expiration')\n      );\n\n      consoleInfoSpy.mockRestore();\n    });\n\n    it('should schedule automatic rotation for expired keys', async () => {\n      // Arrange\n      const now = new Date();\n      const expiredDate = new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000); // 1 day ago\n      const warningDate = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // 7 days from now\n\n      const keysNeedingRotation = [\n        { tenant_id: 'tenant-1' },\n        { tenant_id: 'tenant-2' },\n        { tenant_id: 'tenant-3' },\n      ];\n\n      // Mock database to return keys needing rotation\n      mockSupabaseClient.single.mockResolvedValue({ data: null, error: null });\n      mockSupabaseClient.select.mockImplementation(() => {\n        return Promise.resolve({ data: keysNeedingRotation, error: null });\n      });\n\n      // Mock KMS for key generation\n      const newKeyPlaintext = crypto.randomBytes(32);\n      mockKMSClient.generateDataKey.mockResolvedValue({\n        keyId: 'arn:aws:kms:new',\n        plaintext: newKeyPlaintext,\n        ciphertext: 'encrypted-new-key',\n      });\n\n      mockSupabaseClient.insert.mockResolvedValue({ data: null, error: null });\n      mockSupabaseClient.update.mockResolvedValue({ data: null, error: null });\n\n      // Spy on console\n      const consoleInfoSpy = jest.spyOn(console, 'info').mockImplementation();\n\n      // Act\n      await keyManager.scheduleRotation();\n\n      // Assert\n      expect(consoleInfoSpy).toHaveBeenCalledWith(\n        expect.stringContaining('Scheduling rotation for')\n      );\n      expect(mockKMSClient.generateDataKey).toHaveBeenCalledTimes(3);\n\n      consoleInfoSpy.mockRestore();\n    });\n  });\n\n  describe('Key Versioning & Backward Compatibility', () => {\n    it('should maintain key version history', async () => {\n      // Arrange\n      const tenantId = 'tenant-versioning';\n      const keyHistory = [\n        {\n          id: 'key-v3',\n          tenant_id: tenantId,\n          kms_key_id: 'arn:aws:kms:v3',\n          encrypted_data_key: 'encrypted-v3',\n          version: 3,\n          is_active: true,\n          created_at: new Date().toISOString(),\n          expires_at: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString(),\n          rotated_at: null,\n        },\n        {\n          id: 'key-v2',\n          tenant_id: tenantId,\n          kms_key_id: 'arn:aws:kms:v2',\n          encrypted_data_key: 'encrypted-v2',\n          version: 2,\n          is_active: false,\n          created_at: new Date(Date.now() - 100 * 24 * 60 * 60 * 1000).toISOString(),\n          expires_at: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),\n          rotated_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),\n        },\n        {\n          id: 'key-v1',\n          tenant_id: tenantId,\n          kms_key_id: 'arn:aws:kms:v1',\n          encrypted_data_key: 'encrypted-v1',\n          version: 1,\n          is_active: false,\n          created_at: new Date(Date.now() - 200 * 24 * 60 * 60 * 1000).toISOString(),\n          expires_at: new Date(Date.now() - 110 * 24 * 60 * 60 * 1000).toISOString(),\n          rotated_at: new Date(Date.now() - 105 * 24 * 60 * 60 * 1000).toISOString(),\n        },\n      ];\n\n      mockSupabaseClient.select.mockImplementation(() => {\n        return Promise.resolve({ data: keyHistory, error: null });\n      });\n\n      // Act\n      const history = await keyManager.getKeyHistory(tenantId);\n\n      // Assert\n      expect(history).toHaveLength(3);\n      expect(history[0].version).toBe(3);\n      expect(history[0].isActive).toBe(true);\n      expect(history[1].version).toBe(2);\n      expect(history[1].isActive).toBe(false);\n      expect(history[1].rotatedAt).toBeDefined();\n      expect(history[2].version).toBe(1);\n      expect(history[2].isActive).toBe(false);\n    });\n\n    it('should increment version number correctly', async () => {\n      // Arrange\n      const tenantId = 'tenant-increment';\n      const currentVersion = 5;\n\n      // Mock existing key with version 5\n      mockSupabaseClient.single\n        .mockResolvedValueOnce({\n          data: {\n            version: currentVersion,\n            tenant_id: tenantId,\n          },\n          error: null,\n        })\n        .mockResolvedValueOnce({ data: null, error: null }); // For next version query\n\n      mockSupabaseClient.limit.mockReturnThis();\n\n      const newKeyPlaintext = crypto.randomBytes(32);\n      mockKMSClient.generateDataKey.mockResolvedValue({\n        keyId: 'arn:aws:kms:new',\n        plaintext: newKeyPlaintext,\n        ciphertext: 'encrypted-new-key',\n      });\n\n      mockSupabaseClient.insert.mockImplementation((data) => {\n        // Verify version is incremented\n        expect(data.version).toBe(currentVersion + 1);\n        return Promise.resolve({ data: null, error: null });\n      });\n\n      // Act\n      await keyManager.createKey(tenantId);\n\n      // Assert\n      expect(mockSupabaseClient.insert).toHaveBeenCalled();\n    });\n  });\n\n  describe('Multi-Tenant Key Isolation', () => {\n    it('should maintain separate keys for different tenants', async () => {\n      // Arrange\n      const tenant1 = 'tenant-alice';\n      const tenant2 = 'tenant-bob';\n\n      const key1Plaintext = crypto.randomBytes(32);\n      const key2Plaintext = crypto.randomBytes(32);\n\n      // Mock database responses for different tenants\n      mockSupabaseClient.single\n        .mockResolvedValueOnce({\n          data: {\n            id: 'key-alice',\n            tenant_id: tenant1,\n            kms_key_id: 'arn:aws:kms:alice',\n            encrypted_data_key: 'encrypted-alice-key',\n            version: 1,\n            is_active: true,\n            created_at: new Date().toISOString(),\n            expires_at: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString(),\n          },\n          error: null,\n        })\n        .mockResolvedValueOnce({\n          data: {\n            id: 'key-bob',\n            tenant_id: tenant2,\n            kms_key_id: 'arn:aws:kms:bob',\n            encrypted_data_key: 'encrypted-bob-key',\n            version: 1,\n            is_active: true,\n            created_at: new Date().toISOString(),\n            expires_at: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString(),\n          },\n          error: null,\n        });\n\n      // Mock KMS decryption for different tenants\n      mockKMSClient.decryptDataKey\n        .mockResolvedValueOnce({\n          keyId: 'arn:aws:kms:alice',\n          plaintext: key1Plaintext,\n        })\n        .mockResolvedValueOnce({\n          keyId: 'arn:aws:kms:bob',\n          plaintext: key2Plaintext,\n        });\n\n      // Act\n      const aliceKey = await keyManager.getEncryptionKey(tenant1);\n      const bobKey = await keyManager.getEncryptionKey(tenant2);\n\n      // Assert\n      expect(aliceKey).not.toEqual(bobKey);\n      expect(aliceKey).toEqual(key1Plaintext);\n      expect(bobKey).toEqual(key2Plaintext);\n      expect(mockKMSClient.decryptDataKey).toHaveBeenCalledWith('encrypted-alice-key', tenant1);\n      expect(mockKMSClient.decryptDataKey).toHaveBeenCalledWith('encrypted-bob-key', tenant2);\n    });\n\n    it('should get key statistics per tenant', async () => {\n      // Arrange\n      const tenantId = 'tenant-stats';\n      const now = new Date();\n\n      const tenantKeys = [\n        {\n          is_active: true,\n          created_at: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString(),\n          expires_at: new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000).toISOString(),\n        },\n        {\n          is_active: false,\n          created_at: new Date(now.getTime() - 120 * 24 * 60 * 60 * 1000).toISOString(),\n          expires_at: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString(),\n        },\n      ];\n\n      mockSupabaseClient.select.mockImplementation(() => {\n        return Promise.resolve({ data: tenantKeys, error: null });\n      });\n\n      // Act\n      const stats = await keyManager.getKeyStats(tenantId);\n\n      // Assert\n      expect(stats).toBeDefined();\n      expect(stats.totalKeys).toBe(2);\n      expect(stats.activeKeys).toBe(1);\n      expect(stats.expiredKeys).toBe(1);\n      expect(stats.averageKeyAge).toBeGreaterThan(0);\n      expect(mockSupabaseClient.eq).toHaveBeenCalledWith('tenant_id', tenantId);\n    });\n  });\n});\n"],"names":["jest","mock","describe","keyManager","mockKMSClient","mockSupabaseClient","beforeEach","resetKeyManager","generateDataKey","fn","decryptDataKey","encryptDataKey","rotateKey","listKeys","describeKey","scheduleKeyDeletion","cancelKeyDeletion","getKeyRotationStatus","enableKeyRotation","disableKeyRotation","createAlias","updateAlias","deleteAlias","listAliases","from","mockReturnThis","select","insert","update","delete","eq","lte","order","limit","single","createClient","mockResolvedValue","KeyManager","afterEach","clearAllMocks","it","tenantId","currentVersion","now","Date","expiredDate","getTime","expiredKey","id","tenant_id","kms_key_id","encrypted_data_key","version","is_active","created_at","toISOString","expires_at","rotated_at","newKeyPlaintext","crypto","randomBytes","newKeyEncrypted","mockResolvedValueOnce","data","error","keyId","plaintext","ciphertext","newKey","expect","toBeDefined","toBeInstanceOf","Buffer","toHaveBeenCalled","toHaveBeenCalledWith","nearExpirationDate","key","keyPlaintext","consoleInfoSpy","spyOn","console","mockImplementation","getEncryptionKey","stringContaining","mockRestore","warningDate","keysNeedingRotation","Promise","resolve","scheduleRotation","toHaveBeenCalledTimes","keyHistory","history","getKeyHistory","toHaveLength","toBe","isActive","rotatedAt","createKey","tenant1","tenant2","key1Plaintext","key2Plaintext","aliceKey","bobKey","not","toEqual","tenantKeys","stats","getKeyStats","totalKeys","activeKeys","expiredKeys","averageKeyAge","toBeGreaterThan"],"mappings":"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"}