f463666f1b532bd7aac0e1ecb54c6dc9
"use strict";

/* istanbul ignore next */
function cov_2ajixmi8dk() {
  var path = "C:\\Ai Projecten\\ADSapp\\src\\lib\\queue\\processors\\bulk-message-processor.ts";
  var hash = "98a721172312604836763cd84a236b6a1015d160";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "C:\\Ai Projecten\\ADSapp\\src\\lib\\queue\\processors\\bulk-message-processor.ts",
    statementMap: {
      "0": {
        start: {
          line: 2,
          column: 0
        },
        end: {
          line: 4,
          column: 3
        }
      },
      "1": {
        start: {
          line: 5,
          column: 0
        },
        end: {
          line: 10,
          column: 3
        }
      },
      "2": {
        start: {
          line: 8,
          column: 8
        },
        end: {
          line: 8,
          column: 34
        }
      },
      "3": {
        start: {
          line: 11,
          column: 16
        },
        end: {
          line: 11,
          column: 48
        }
      },
      "4": {
        start: {
          line: 15,
          column: 4
        },
        end: {
          line: 75,
          column: 5
        }
      },
      "5": {
        start: {
          line: 17,
          column: 25
        },
        end: {
          line: 17,
          column: 58
        }
      },
      "6": {
        start: {
          line: 18,
          column: 56
        },
        end: {
          line: 18,
          column: 152
        }
      },
      "7": {
        start: {
          line: 19,
          column: 8
        },
        end: {
          line: 21,
          column: 9
        }
      },
      "8": {
        start: {
          line: 20,
          column: 12
        },
        end: {
          line: 20,
          column: 85
        }
      },
      "9": {
        start: {
          line: 22,
          column: 31
        },
        end: {
          line: 22,
          column: 56
        }
      },
      "10": {
        start: {
          line: 23,
          column: 8
        },
        end: {
          line: 25,
          column: 9
        }
      },
      "11": {
        start: {
          line: 24,
          column: 12
        },
        end: {
          line: 24,
          column: 72
        }
      },
      "12": {
        start: {
          line: 27,
          column: 31
        },
        end: {
          line: 27,
          column: 55
        }
      },
      "13": {
        start: {
          line: 29,
          column: 25
        },
        end: {
          line: 43,
          column: 10
        }
      },
      "14": {
        start: {
          line: 44,
          column: 8
        },
        end: {
          line: 47,
          column: 9
        }
      },
      "15": {
        start: {
          line: 45,
          column: 30
        },
        end: {
          line: 45,
          column: 51
        }
      },
      "16": {
        start: {
          line: 46,
          column: 12
        },
        end: {
          line: 46,
          column: 87
        }
      },
      "17": {
        start: {
          line: 48,
          column: 21
        },
        end: {
          line: 48,
          column: 42
        }
      },
      "18": {
        start: {
          line: 49,
          column: 26
        },
        end: {
          line: 49,
          column: 48
        }
      },
      "19": {
        start: {
          line: 51,
          column: 8
        },
        end: {
          line: 63,
          column: 11
        }
      },
      "20": {
        start: {
          line: 64,
          column: 8
        },
        end: {
          line: 67,
          column: 10
        }
      },
      "21": {
        start: {
          line: 69,
          column: 29
        },
        end: {
          line: 69,
          column: 85
        }
      },
      "22": {
        start: {
          line: 70,
          column: 8
        },
        end: {
          line: 70,
          column: 75
        }
      },
      "23": {
        start: {
          line: 71,
          column: 8
        },
        end: {
          line: 74,
          column: 10
        }
      },
      "24": {
        start: {
          line: 80,
          column: 17
        },
        end: {
          line: 80,
          column: 25
        }
      },
      "25": {
        start: {
          line: 81,
          column: 4
        },
        end: {
          line: 84,
          column: 5
        }
      },
      "26": {
        start: {
          line: 82,
          column: 22
        },
        end: {
          line: 82,
          column: 51
        }
      },
      "27": {
        start: {
          line: 83,
          column: 8
        },
        end: {
          line: 83,
          column: 46
        }
      },
      "28": {
        start: {
          line: 85,
          column: 4
        },
        end: {
          line: 85,
          column: 18
        }
      },
      "29": {
        start: {
          line: 88,
          column: 22
        },
        end: {
          line: 88,
          column: 32
        }
      },
      "30": {
        start: {
          line: 89,
          column: 100
        },
        end: {
          line: 89,
          column: 108
        }
      },
      "31": {
        start: {
          line: 90,
          column: 4
        },
        end: {
          line: 90,
          column: 88
        }
      },
      "32": {
        start: {
          line: 91,
          column: 20
        },
        end: {
          line: 95,
          column: 5
        }
      },
      "33": {
        start: {
          line: 97,
          column: 4
        },
        end: {
          line: 138,
          column: 5
        }
      },
      "34": {
        start: {
          line: 97,
          column: 16
        },
        end: {
          line: 97,
          column: 17
        }
      },
      "35": {
        start: {
          line: 98,
          column: 24
        },
        end: {
          line: 98,
          column: 35
        }
      },
      "36": {
        start: {
          line: 99,
          column: 8
        },
        end: {
          line: 137,
          column: 9
        }
      },
      "37": {
        start: {
          line: 101,
          column: 31
        },
        end: {
          line: 101,
          column: 45
        }
      },
      "38": {
        start: {
          line: 102,
          column: 12
        },
        end: {
          line: 104,
          column: 13
        }
      },
      "39": {
        start: {
          line: 103,
          column: 16
        },
        end: {
          line: 103,
          column: 86
        }
      },
      "40": {
        start: {
          line: 106,
          column: 27
        },
        end: {
          line: 106,
          column: 109
        }
      },
      "41": {
        start: {
          line: 107,
          column: 12
        },
        end: {
          line: 116,
          column: 13
        }
      },
      "42": {
        start: {
          line: 108,
          column: 16
        },
        end: {
          line: 108,
          column: 39
        }
      },
      "43": {
        start: {
          line: 110,
          column: 16
        },
        end: {
          line: 110,
          column: 39
        }
      },
      "44": {
        start: {
          line: 111,
          column: 16
        },
        end: {
          line: 115,
          column: 19
        }
      },
      "45": {
        start: {
          line: 118,
          column: 29
        },
        end: {
          line: 118,
          column: 72
        }
      },
      "46": {
        start: {
          line: 119,
          column: 12
        },
        end: {
          line: 119,
          column: 47
        }
      },
      "47": {
        start: {
          line: 121,
          column: 12
        },
        end: {
          line: 123,
          column: 13
        }
      },
      "48": {
        start: {
          line: 122,
          column: 16
        },
        end: {
          line: 122,
          column: 98
        }
      },
      "49": {
        start: {
          line: 126,
          column: 12
        },
        end: {
          line: 128,
          column: 13
        }
      },
      "50": {
        start: {
          line: 127,
          column: 16
        },
        end: {
          line: 127,
          column: 70
        }
      },
      "51": {
        start: {
          line: 127,
          column: 45
        },
        end: {
          line: 127,
          column: 68
        }
      },
      "52": {
        start: {
          line: 130,
          column: 12
        },
        end: {
          line: 130,
          column: 35
        }
      },
      "53": {
        start: {
          line: 131,
          column: 12
        },
        end: {
          line: 135,
          column: 15
        }
      },
      "54": {
        start: {
          line: 136,
          column: 12
        },
        end: {
          line: 136,
          column: 90
        }
      },
      "55": {
        start: {
          line: 139,
          column: 20
        },
        end: {
          line: 139,
          column: 30
        }
      },
      "56": {
        start: {
          line: 140,
          column: 21
        },
        end: {
          line: 140,
          column: 40
        }
      },
      "57": {
        start: {
          line: 142,
          column: 21
        },
        end: {
          line: 142,
          column: 54
        }
      },
      "58": {
        start: {
          line: 143,
          column: 4
        },
        end: {
          line: 160,
          column: 7
        }
      },
      "59": {
        start: {
          line: 161,
          column: 4
        },
        end: {
          line: 161,
          column: 137
        }
      },
      "60": {
        start: {
          line: 162,
          column: 4
        },
        end: {
          line: 172,
          column: 6
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 7,
            column: 9
          },
          end: {
            line: 7,
            column: 10
          }
        },
        loc: {
          start: {
            line: 7,
            column: 20
          },
          end: {
            line: 9,
            column: 5
          }
        },
        line: 7
      },
      "1": {
        name: "sendWhatsAppMessage",
        decl: {
          start: {
            line: 14,
            column: 19
          },
          end: {
            line: 14,
            column: 38
          }
        },
        loc: {
          start: {
            line: 14,
            column: 82
          },
          end: {
            line: 76,
            column: 1
          }
        },
        line: 14
      },
      "2": {
        name: "substituteVariables",
        decl: {
          start: {
            line: 79,
            column: 13
          },
          end: {
            line: 79,
            column: 32
          }
        },
        loc: {
          start: {
            line: 79,
            column: 54
          },
          end: {
            line: 86,
            column: 1
          }
        },
        line: 79
      },
      "3": {
        name: "processBulkMessage",
        decl: {
          start: {
            line: 87,
            column: 15
          },
          end: {
            line: 87,
            column: 33
          }
        },
        loc: {
          start: {
            line: 87,
            column: 39
          },
          end: {
            line: 173,
            column: 1
          }
        },
        line: 87
      },
      "4": {
        name: "(anonymous_4)",
        decl: {
          start: {
            line: 127,
            column: 34
          },
          end: {
            line: 127,
            column: 35
          }
        },
        loc: {
          start: {
            line: 127,
            column: 45
          },
          end: {
            line: 127,
            column: 68
          }
        },
        line: 127
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 19,
            column: 8
          },
          end: {
            line: 21,
            column: 9
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 19,
            column: 8
          },
          end: {
            line: 21,
            column: 9
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 19
      },
      "1": {
        loc: {
          start: {
            line: 23,
            column: 8
          },
          end: {
            line: 25,
            column: 9
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 23,
            column: 8
          },
          end: {
            line: 25,
            column: 9
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 23
      },
      "2": {
        loc: {
          start: {
            line: 23,
            column: 12
          },
          end: {
            line: 23,
            column: 77
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 23,
            column: 12
          },
          end: {
            line: 23,
            column: 41
          }
        }, {
          start: {
            line: 23,
            column: 45
          },
          end: {
            line: 23,
            column: 77
          }
        }],
        line: 23
      },
      "3": {
        loc: {
          start: {
            line: 44,
            column: 8
          },
          end: {
            line: 47,
            column: 9
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 44,
            column: 8
          },
          end: {
            line: 47,
            column: 9
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 44
      },
      "4": {
        loc: {
          start: {
            line: 46,
            column: 28
          },
          end: {
            line: 46,
            column: 85
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 46,
            column: 28
          },
          end: {
            line: 46,
            column: 52
          }
        }, {
          start: {
            line: 46,
            column: 56
          },
          end: {
            line: 46,
            column: 85
          }
        }],
        line: 46
      },
      "5": {
        loc: {
          start: {
            line: 69,
            column: 29
          },
          end: {
            line: 69,
            column: 85
          }
        },
        type: "cond-expr",
        locations: [{
          start: {
            line: 69,
            column: 54
          },
          end: {
            line: 69,
            column: 67
          }
        }, {
          start: {
            line: 69,
            column: 70
          },
          end: {
            line: 69,
            column: 85
          }
        }],
        line: 69
      },
      "6": {
        loc: {
          start: {
            line: 102,
            column: 12
          },
          end: {
            line: 104,
            column: 13
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 102,
            column: 12
          },
          end: {
            line: 104,
            column: 13
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 102
      },
      "7": {
        loc: {
          start: {
            line: 107,
            column: 12
          },
          end: {
            line: 116,
            column: 13
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 107,
            column: 12
          },
          end: {
            line: 116,
            column: 13
          }
        }, {
          start: {
            line: 109,
            column: 19
          },
          end: {
            line: 116,
            column: 13
          }
        }],
        line: 107
      },
      "8": {
        loc: {
          start: {
            line: 114,
            column: 27
          },
          end: {
            line: 114,
            column: 58
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 114,
            column: 27
          },
          end: {
            line: 114,
            column: 39
          }
        }, {
          start: {
            line: 114,
            column: 43
          },
          end: {
            line: 114,
            column: 58
          }
        }],
        line: 114
      },
      "9": {
        loc: {
          start: {
            line: 121,
            column: 12
          },
          end: {
            line: 123,
            column: 13
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 121,
            column: 12
          },
          end: {
            line: 123,
            column: 13
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 121
      },
      "10": {
        loc: {
          start: {
            line: 121,
            column: 16
          },
          end: {
            line: 121,
            column: 63
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 121,
            column: 16
          },
          end: {
            line: 121,
            column: 34
          }
        }, {
          start: {
            line: 121,
            column: 38
          },
          end: {
            line: 121,
            column: 63
          }
        }],
        line: 121
      },
      "11": {
        loc: {
          start: {
            line: 126,
            column: 12
          },
          end: {
            line: 128,
            column: 13
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 126,
            column: 12
          },
          end: {
            line: 128,
            column: 13
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 126
      },
      "12": {
        loc: {
          start: {
            line: 134,
            column: 23
          },
          end: {
            line: 134,
            column: 82
          }
        },
        type: "cond-expr",
        locations: [{
          start: {
            line: 134,
            column: 48
          },
          end: {
            line: 134,
            column: 61
          }
        }, {
          start: {
            line: 134,
            column: 64
          },
          end: {
            line: 134,
            column: 82
          }
        }],
        line: 134
      },
      "13": {
        loc: {
          start: {
            line: 148,
            column: 16
          },
          end: {
            line: 148,
            column: 76
          }
        },
        type: "cond-expr",
        locations: [{
          start: {
            line: 148,
            column: 45
          },
          end: {
            line: 148,
            column: 56
          }
        }, {
          start: {
            line: 148,
            column: 59
          },
          end: {
            line: 148,
            column: 76
          }
        }],
        line: 148
      },
      "14": {
        loc: {
          start: {
            line: 155,
            column: 23
          },
          end: {
            line: 157,
            column: 16
          }
        },
        type: "cond-expr",
        locations: [{
          start: {
            line: 155,
            column: 59
          },
          end: {
            line: 157,
            column: 9
          }
        }, {
          start: {
            line: 157,
            column: 12
          },
          end: {
            line: 157,
            column: 16
          }
        }],
        line: 155
      },
      "15": {
        loc: {
          start: {
            line: 163,
            column: 15
          },
          end: {
            line: 163,
            column: 39
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 163,
            column: 15
          },
          end: {
            line: 163,
            column: 33
          }
        }, {
          start: {
            line: 163,
            column: 37
          },
          end: {
            line: 163,
            column: 39
          }
        }],
        line: 163
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0,
      "16": 0,
      "17": 0,
      "18": 0,
      "19": 0,
      "20": 0,
      "21": 0,
      "22": 0,
      "23": 0,
      "24": 0,
      "25": 0,
      "26": 0,
      "27": 0,
      "28": 0,
      "29": 0,
      "30": 0,
      "31": 0,
      "32": 0,
      "33": 0,
      "34": 0,
      "35": 0,
      "36": 0,
      "37": 0,
      "38": 0,
      "39": 0,
      "40": 0,
      "41": 0,
      "42": 0,
      "43": 0,
      "44": 0,
      "45": 0,
      "46": 0,
      "47": 0,
      "48": 0,
      "49": 0,
      "50": 0,
      "51": 0,
      "52": 0,
      "53": 0,
      "54": 0,
      "55": 0,
      "56": 0,
      "57": 0,
      "58": 0,
      "59": 0,
      "60": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0
    },
    b: {
      "0": [0, 0],
      "1": [0, 0],
      "2": [0, 0],
      "3": [0, 0],
      "4": [0, 0],
      "5": [0, 0],
      "6": [0, 0],
      "7": [0, 0],
      "8": [0, 0],
      "9": [0, 0],
      "10": [0, 0],
      "11": [0, 0],
      "12": [0, 0],
      "13": [0, 0],
      "14": [0, 0],
      "15": [0, 0]
    },
    inputSourceMap: {
      version: 3,
      sources: ["C:\\Ai Projecten\\ADSapp\\src\\lib\\queue\\processors\\bulk-message-processor.ts"],
      sourcesContent: ["import { Job } from 'bullmq';\nimport { createClient } from '@/lib/supabase/server';\n\n/**\n * Bulk Message Processor\n *\n * Handles sending WhatsApp messages to multiple contacts in bulk.\n * Implements rate limiting, progress tracking, and per-message error handling.\n *\n * Features:\n * - WhatsApp Business API rate limiting\n * - Individual message failure tracking\n * - Progress updates for UI feedback\n * - Retry logic for failed messages\n * - Multi-tenant isolation\n *\n * @module bulk-message-processor\n */\n\n/**\n * Contact information for bulk messaging\n */\nexport interface BulkMessageContact {\n  id: string;\n  phone: string;\n  name?: string;\n  variables?: Record<string, string>; // For template variable substitution\n}\n\n/**\n * Bulk message job data\n */\nexport interface BulkMessageJobData {\n  organizationId: string;\n  userId: string;\n  contacts: BulkMessageContact[];\n  messageContent: string;\n  messageType: 'text' | 'template';\n  templateId?: string;\n  metadata?: Record<string, any>;\n}\n\n/**\n * Bulk message job result\n */\nexport interface BulkMessageJobResult {\n  jobId: string;\n  organizationId: string;\n  totalContacts: number;\n  successCount: number;\n  failureCount: number;\n  failedContacts: Array<{\n    contactId: string;\n    phone: string;\n    error: string;\n  }>;\n  startedAt: string;\n  completedAt: string;\n  duration: number;\n}\n\n/**\n * Send a single WhatsApp message\n */\nasync function sendWhatsAppMessage(\n  phone: string,\n  content: string,\n  organizationId: string,\n  contactId: string\n): Promise<{ success: boolean; error?: string; messageId?: string }> {\n  try {\n    // Get WhatsApp configuration for organization\n    const supabase = await createClient();\n\n    const { data: orgConfig, error: configError } = await supabase\n      .from('organizations')\n      .select('whatsapp_config')\n      .eq('id', organizationId)\n      .single();\n\n    if (configError) {\n      throw new Error(`Failed to get WhatsApp config: ${configError.message}`);\n    }\n\n    const whatsappConfig = orgConfig.whatsapp_config as {\n      access_token: string;\n      phone_number_id: string;\n    };\n\n    if (!whatsappConfig?.access_token || !whatsappConfig?.phone_number_id) {\n      throw new Error('WhatsApp not configured for organization');\n    }\n\n    // Format phone number (remove non-digits)\n    const formattedPhone = phone.replace(/\\D/g, '');\n\n    // Send message via WhatsApp Business API\n    const response = await fetch(\n      `https://graph.facebook.com/v18.0/${whatsappConfig.phone_number_id}/messages`,\n      {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${whatsappConfig.access_token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          messaging_product: 'whatsapp',\n          to: formattedPhone,\n          type: 'text',\n          text: {\n            body: content\n          }\n        })\n      }\n    );\n\n    if (!response.ok) {\n      const errorData = await response.json();\n      throw new Error(\n        errorData.error?.message || 'WhatsApp API request failed'\n      );\n    }\n\n    const data = await response.json();\n    const messageId = data.messages?.[0]?.id;\n\n    // Log message to database\n    await supabase.from('messages').insert({\n      conversation_id: null, // Will be linked later\n      contact_id: contactId,\n      organization_id: organizationId,\n      content: content,\n      message_type: 'text',\n      direction: 'outbound',\n      status: 'sent',\n      whatsapp_message_id: messageId,\n      metadata: { bulk_send: true }\n    });\n\n    return { success: true, messageId };\n  } catch (error) {\n    const errorMessage =\n      error instanceof Error ? error.message : 'Unknown error';\n    console.error(`Failed to send message to ${phone}:`, errorMessage);\n    return { success: false, error: errorMessage };\n  }\n}\n\n/**\n * Substitute variables in message template\n */\nfunction substituteVariables(\n  template: string,\n  variables: Record<string, string>\n): string {\n  let result = template;\n\n  for (const [key, value] of Object.entries(variables)) {\n    const regex = new RegExp(`{{${key}}}`, 'g');\n    result = result.replace(regex, value);\n  }\n\n  return result;\n}\n\n/**\n * Bulk message processor function\n */\nexport async function processBulkMessage(\n  job: Job<BulkMessageJobData>\n): Promise<BulkMessageJobResult> {\n  const startTime = Date.now();\n  const {\n    organizationId,\n    userId,\n    contacts,\n    messageContent,\n    messageType,\n    templateId,\n    metadata\n  } = job.data;\n\n  console.log(\n    `[BulkMessage] Starting job ${job.id} for ${contacts.length} contacts`\n  );\n\n  const results = {\n    successCount: 0,\n    failureCount: 0,\n    failedContacts: [] as Array<{\n      contactId: string;\n      phone: string;\n      error: string;\n    }>\n  };\n\n  // Process each contact\n  for (let i = 0; i < contacts.length; i++) {\n    const contact = contacts[i];\n\n    try {\n      // Substitute variables if provided\n      let finalMessage = messageContent;\n      if (contact.variables) {\n        finalMessage = substituteVariables(messageContent, contact.variables);\n      }\n\n      // Send message\n      const result = await sendWhatsAppMessage(\n        contact.phone,\n        finalMessage,\n        organizationId,\n        contact.id\n      );\n\n      if (result.success) {\n        results.successCount++;\n      } else {\n        results.failureCount++;\n        results.failedContacts.push({\n          contactId: contact.id,\n          phone: contact.phone,\n          error: result.error || 'Unknown error'\n        });\n      }\n\n      // Update progress\n      const progress = Math.round(((i + 1) / contacts.length) * 100);\n      await job.updateProgress(progress);\n\n      // Log progress every 10 contacts\n      if ((i + 1) % 10 === 0 || i + 1 === contacts.length) {\n        console.log(\n          `[BulkMessage] Job ${job.id}: ${i + 1}/${contacts.length} processed`\n        );\n      }\n\n      // Rate limiting: WhatsApp allows ~80 messages/second\n      // Add small delay to be safe (12-13 msg/sec)\n      if (i < contacts.length - 1) {\n        await new Promise((resolve) => setTimeout(resolve, 75));\n      }\n    } catch (error) {\n      results.failureCount++;\n      results.failedContacts.push({\n        contactId: contact.id,\n        phone: contact.phone,\n        error: error instanceof Error ? error.message : 'Processing error'\n      });\n\n      console.error(`[BulkMessage] Error processing contact ${contact.id}:`, error);\n    }\n  }\n\n  const endTime = Date.now();\n  const duration = endTime - startTime;\n\n  // Log job completion to database\n  const supabase = await createClient();\n  await supabase.from('job_logs').insert({\n    job_id: job.id?.toString(),\n    job_type: 'bulk_message',\n    organization_id: organizationId,\n    user_id: userId,\n    status: results.failureCount === 0 ? 'completed' : 'partial_failure',\n    result: {\n      total: contacts.length,\n      success: results.successCount,\n      failed: results.failureCount,\n      duration: duration\n    },\n    error_details:\n      results.failedContacts.length > 0\n        ? { failed_contacts: results.failedContacts }\n        : null,\n    started_at: new Date(startTime).toISOString(),\n    completed_at: new Date(endTime).toISOString()\n  });\n\n  console.log(\n    `[BulkMessage] Job ${job.id} completed: ${results.successCount} success, ${results.failureCount} failed, ${duration}ms`\n  );\n\n  return {\n    jobId: job.id?.toString() || '',\n    organizationId,\n    totalContacts: contacts.length,\n    successCount: results.successCount,\n    failureCount: results.failureCount,\n    failedContacts: results.failedContacts,\n    startedAt: new Date(startTime).toISOString(),\n    completedAt: new Date(endTime).toISOString(),\n    duration\n  };\n}\n"],
      names: ["processBulkMessage", "sendWhatsAppMessage", "phone", "content", "organizationId", "contactId", "supabase", "createClient", "data", "orgConfig", "error", "configError", "from", "select", "eq", "single", "Error", "message", "whatsappConfig", "whatsapp_config", "access_token", "phone_number_id", "formattedPhone", "replace", "response", "fetch", "method", "headers", "body", "JSON", "stringify", "messaging_product", "to", "type", "text", "ok", "errorData", "json", "messageId", "messages", "id", "insert", "conversation_id", "contact_id", "organization_id", "message_type", "direction", "status", "whatsapp_message_id", "metadata", "bulk_send", "success", "errorMessage", "console", "substituteVariables", "template", "variables", "result", "key", "value", "Object", "entries", "regex", "RegExp", "job", "startTime", "Date", "now", "userId", "contacts", "messageContent", "messageType", "templateId", "log", "length", "results", "successCount", "failureCount", "failedContacts", "i", "contact", "finalMessage", "push", "progress", "Math", "round", "updateProgress", "Promise", "resolve", "setTimeout", "endTime", "duration", "job_id", "toString", "job_type", "user_id", "total", "failed", "error_details", "failed_contacts", "started_at", "toISOString", "completed_at", "jobId", "totalContacts", "startedAt", "completedAt"],
      mappings: "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"
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "98a721172312604836763cd84a236b6a1015d160"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_2ajixmi8dk = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_2ajixmi8dk();
cov_2ajixmi8dk().s[0]++;
Object.defineProperty(exports, "__esModule", {
  value: true
});
/* istanbul ignore next */
cov_2ajixmi8dk().s[1]++;
Object.defineProperty(exports, "processBulkMessage", {
  enumerable: true,
  get: function () {
    /* istanbul ignore next */
    cov_2ajixmi8dk().f[0]++;
    cov_2ajixmi8dk().s[2]++;
    return processBulkMessage;
  }
});
const _server =
/* istanbul ignore next */
(cov_2ajixmi8dk().s[3]++, require("../../supabase/server"));
/**
 * Send a single WhatsApp message
 */
async function sendWhatsAppMessage(phone, content, organizationId, contactId) {
  /* istanbul ignore next */
  cov_2ajixmi8dk().f[1]++;
  cov_2ajixmi8dk().s[4]++;
  try {
    // Get WhatsApp configuration for organization
    const supabase =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[5]++, await (0, _server.createClient)());
    const {
      data: orgConfig,
      error: configError
    } =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[6]++, await supabase.from('organizations').select('whatsapp_config').eq('id', organizationId).single());
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[7]++;
    if (configError) {
      /* istanbul ignore next */
      cov_2ajixmi8dk().b[0][0]++;
      cov_2ajixmi8dk().s[8]++;
      throw new Error(`Failed to get WhatsApp config: ${configError.message}`);
    } else
    /* istanbul ignore next */
    {
      cov_2ajixmi8dk().b[0][1]++;
    }
    const whatsappConfig =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[9]++, orgConfig.whatsapp_config);
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[10]++;
    if (
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[2][0]++, !whatsappConfig?.access_token) ||
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[2][1]++, !whatsappConfig?.phone_number_id)) {
      /* istanbul ignore next */
      cov_2ajixmi8dk().b[1][0]++;
      cov_2ajixmi8dk().s[11]++;
      throw new Error('WhatsApp not configured for organization');
    } else
    /* istanbul ignore next */
    {
      cov_2ajixmi8dk().b[1][1]++;
    }
    // Format phone number (remove non-digits)
    const formattedPhone =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[12]++, phone.replace(/\D/g, ''));
    // Send message via WhatsApp Business API
    const response =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[13]++, await fetch(`https://graph.facebook.com/v18.0/${whatsappConfig.phone_number_id}/messages`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${whatsappConfig.access_token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        messaging_product: 'whatsapp',
        to: formattedPhone,
        type: 'text',
        text: {
          body: content
        }
      })
    }));
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[14]++;
    if (!response.ok) {
      /* istanbul ignore next */
      cov_2ajixmi8dk().b[3][0]++;
      const errorData =
      /* istanbul ignore next */
      (cov_2ajixmi8dk().s[15]++, await response.json());
      /* istanbul ignore next */
      cov_2ajixmi8dk().s[16]++;
      throw new Error(
      /* istanbul ignore next */
      (cov_2ajixmi8dk().b[4][0]++, errorData.error?.message) ||
      /* istanbul ignore next */
      (cov_2ajixmi8dk().b[4][1]++, 'WhatsApp API request failed'));
    } else
    /* istanbul ignore next */
    {
      cov_2ajixmi8dk().b[3][1]++;
    }
    const data =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[17]++, await response.json());
    const messageId =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[18]++, data.messages?.[0]?.id);
    // Log message to database
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[19]++;
    await supabase.from('messages').insert({
      conversation_id: null,
      contact_id: contactId,
      organization_id: organizationId,
      content: content,
      message_type: 'text',
      direction: 'outbound',
      status: 'sent',
      whatsapp_message_id: messageId,
      metadata: {
        bulk_send: true
      }
    });
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[20]++;
    return {
      success: true,
      messageId
    };
  } catch (error) {
    const errorMessage =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[21]++, error instanceof Error ?
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[5][0]++, error.message) :
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[5][1]++, 'Unknown error'));
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[22]++;
    console.error(`Failed to send message to ${phone}:`, errorMessage);
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[23]++;
    return {
      success: false,
      error: errorMessage
    };
  }
}
/**
 * Substitute variables in message template
 */
function substituteVariables(template, variables) {
  /* istanbul ignore next */
  cov_2ajixmi8dk().f[2]++;
  let result =
  /* istanbul ignore next */
  (cov_2ajixmi8dk().s[24]++, template);
  /* istanbul ignore next */
  cov_2ajixmi8dk().s[25]++;
  for (const [key, value] of Object.entries(variables)) {
    const regex =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[26]++, new RegExp(`{{${key}}}`, 'g'));
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[27]++;
    result = result.replace(regex, value);
  }
  /* istanbul ignore next */
  cov_2ajixmi8dk().s[28]++;
  return result;
}
async function processBulkMessage(job) {
  /* istanbul ignore next */
  cov_2ajixmi8dk().f[3]++;
  const startTime =
  /* istanbul ignore next */
  (cov_2ajixmi8dk().s[29]++, Date.now());
  const {
    organizationId,
    userId,
    contacts,
    messageContent,
    messageType,
    templateId,
    metadata
  } =
  /* istanbul ignore next */
  (cov_2ajixmi8dk().s[30]++, job.data);
  /* istanbul ignore next */
  cov_2ajixmi8dk().s[31]++;
  console.log(`[BulkMessage] Starting job ${job.id} for ${contacts.length} contacts`);
  const results =
  /* istanbul ignore next */
  (cov_2ajixmi8dk().s[32]++, {
    successCount: 0,
    failureCount: 0,
    failedContacts: []
  });
  // Process each contact
  /* istanbul ignore next */
  cov_2ajixmi8dk().s[33]++;
  for (let i =
  /* istanbul ignore next */
  (cov_2ajixmi8dk().s[34]++, 0); i < contacts.length; i++) {
    const contact =
    /* istanbul ignore next */
    (cov_2ajixmi8dk().s[35]++, contacts[i]);
    /* istanbul ignore next */
    cov_2ajixmi8dk().s[36]++;
    try {
      // Substitute variables if provided
      let finalMessage =
      /* istanbul ignore next */
      (cov_2ajixmi8dk().s[37]++, messageContent);
      /* istanbul ignore next */
      cov_2ajixmi8dk().s[38]++;
      if (contact.variables) {
        /* istanbul ignore next */
        cov_2ajixmi8dk().b[6][0]++;
        cov_2ajixmi8dk().s[39]++;
        finalMessage = substituteVariables(messageContent, contact.variables);
      } else
      /* istanbul ignore next */
      {
        cov_2ajixmi8dk().b[6][1]++;
      }
      // Send message
      const result =
      /* istanbul ignore next */
      (cov_2ajixmi8dk().s[40]++, await sendWhatsAppMessage(contact.phone, finalMessage, organizationId, contact.id));
      /* istanbul ignore next */
      cov_2ajixmi8dk().s[41]++;
      if (result.success) {
        /* istanbul ignore next */
        cov_2ajixmi8dk().b[7][0]++;
        cov_2ajixmi8dk().s[42]++;
        results.successCount++;
      } else {
        /* istanbul ignore next */
        cov_2ajixmi8dk().b[7][1]++;
        cov_2ajixmi8dk().s[43]++;
        results.failureCount++;
        /* istanbul ignore next */
        cov_2ajixmi8dk().s[44]++;
        results.failedContacts.push({
          contactId: contact.id,
          phone: contact.phone,
          error:
          /* istanbul ignore next */
          (cov_2ajixmi8dk().b[8][0]++, result.error) ||
          /* istanbul ignore next */
          (cov_2ajixmi8dk().b[8][1]++, 'Unknown error')
        });
      }
      // Update progress
      const progress =
      /* istanbul ignore next */
      (cov_2ajixmi8dk().s[45]++, Math.round((i + 1) / contacts.length * 100));
      /* istanbul ignore next */
      cov_2ajixmi8dk().s[46]++;
      await job.updateProgress(progress);
      // Log progress every 10 contacts
      /* istanbul ignore next */
      cov_2ajixmi8dk().s[47]++;
      if (
      /* istanbul ignore next */
      (cov_2ajixmi8dk().b[10][0]++, (i + 1) % 10 === 0) ||
      /* istanbul ignore next */
      (cov_2ajixmi8dk().b[10][1]++, i + 1 === contacts.length)) {
        /* istanbul ignore next */
        cov_2ajixmi8dk().b[9][0]++;
        cov_2ajixmi8dk().s[48]++;
        console.log(`[BulkMessage] Job ${job.id}: ${i + 1}/${contacts.length} processed`);
      } else
      /* istanbul ignore next */
      {
        cov_2ajixmi8dk().b[9][1]++;
      }
      // Rate limiting: WhatsApp allows ~80 messages/second
      // Add small delay to be safe (12-13 msg/sec)
      cov_2ajixmi8dk().s[49]++;
      if (i < contacts.length - 1) {
        /* istanbul ignore next */
        cov_2ajixmi8dk().b[11][0]++;
        cov_2ajixmi8dk().s[50]++;
        await new Promise(resolve => {
          /* istanbul ignore next */
          cov_2ajixmi8dk().f[4]++;
          cov_2ajixmi8dk().s[51]++;
          return setTimeout(resolve, 75);
        });
      } else
      /* istanbul ignore next */
      {
        cov_2ajixmi8dk().b[11][1]++;
      }
    } catch (error) {
      /* istanbul ignore next */
      cov_2ajixmi8dk().s[52]++;
      results.failureCount++;
      /* istanbul ignore next */
      cov_2ajixmi8dk().s[53]++;
      results.failedContacts.push({
        contactId: contact.id,
        phone: contact.phone,
        error: error instanceof Error ?
        /* istanbul ignore next */
        (cov_2ajixmi8dk().b[12][0]++, error.message) :
        /* istanbul ignore next */
        (cov_2ajixmi8dk().b[12][1]++, 'Processing error')
      });
      /* istanbul ignore next */
      cov_2ajixmi8dk().s[54]++;
      console.error(`[BulkMessage] Error processing contact ${contact.id}:`, error);
    }
  }
  const endTime =
  /* istanbul ignore next */
  (cov_2ajixmi8dk().s[55]++, Date.now());
  const duration =
  /* istanbul ignore next */
  (cov_2ajixmi8dk().s[56]++, endTime - startTime);
  // Log job completion to database
  const supabase =
  /* istanbul ignore next */
  (cov_2ajixmi8dk().s[57]++, await (0, _server.createClient)());
  /* istanbul ignore next */
  cov_2ajixmi8dk().s[58]++;
  await supabase.from('job_logs').insert({
    job_id: job.id?.toString(),
    job_type: 'bulk_message',
    organization_id: organizationId,
    user_id: userId,
    status: results.failureCount === 0 ?
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[13][0]++, 'completed') :
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[13][1]++, 'partial_failure'),
    result: {
      total: contacts.length,
      success: results.successCount,
      failed: results.failureCount,
      duration: duration
    },
    error_details: results.failedContacts.length > 0 ?
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[14][0]++, {
      failed_contacts: results.failedContacts
    }) :
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[14][1]++, null),
    started_at: new Date(startTime).toISOString(),
    completed_at: new Date(endTime).toISOString()
  });
  /* istanbul ignore next */
  cov_2ajixmi8dk().s[59]++;
  console.log(`[BulkMessage] Job ${job.id} completed: ${results.successCount} success, ${results.failureCount} failed, ${duration}ms`);
  /* istanbul ignore next */
  cov_2ajixmi8dk().s[60]++;
  return {
    jobId:
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[15][0]++, job.id?.toString()) ||
    /* istanbul ignore next */
    (cov_2ajixmi8dk().b[15][1]++, ''),
    organizationId,
    totalContacts: contacts.length,
    successCount: results.successCount,
    failureCount: results.failureCount,
    failedContacts: results.failedContacts,
    startedAt: new Date(startTime).toISOString(),
    completedAt: new Date(endTime).toISOString(),
    duration
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMmFqaXhtaThkayIsImFjdHVhbENvdmVyYWdlIiwicyIsInByb2Nlc3NCdWxrTWVzc2FnZSIsInNlbmRXaGF0c0FwcE1lc3NhZ2UiLCJwaG9uZSIsImNvbnRlbnQiLCJvcmdhbml6YXRpb25JZCIsImNvbnRhY3RJZCIsImYiLCJzdXBhYmFzZSIsIl9zZXJ2ZXIiLCJjcmVhdGVDbGllbnQiLCJkYXRhIiwib3JnQ29uZmlnIiwiZXJyb3IiLCJjb25maWdFcnJvciIsImZyb20iLCJzZWxlY3QiLCJlcSIsInNpbmdsZSIsImIiLCJFcnJvciIsIm1lc3NhZ2UiLCJ3aGF0c2FwcENvbmZpZyIsIndoYXRzYXBwX2NvbmZpZyIsImFjY2Vzc190b2tlbiIsInBob25lX251bWJlcl9pZCIsImZvcm1hdHRlZFBob25lIiwicmVwbGFjZSIsInJlc3BvbnNlIiwiZmV0Y2giLCJtZXRob2QiLCJoZWFkZXJzIiwiYm9keSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtZXNzYWdpbmdfcHJvZHVjdCIsInRvIiwidHlwZSIsInRleHQiLCJvayIsImVycm9yRGF0YSIsImpzb24iLCJtZXNzYWdlSWQiLCJtZXNzYWdlcyIsImlkIiwiaW5zZXJ0IiwiY29udmVyc2F0aW9uX2lkIiwiY29udGFjdF9pZCIsIm9yZ2FuaXphdGlvbl9pZCIsIm1lc3NhZ2VfdHlwZSIsImRpcmVjdGlvbiIsInN0YXR1cyIsIndoYXRzYXBwX21lc3NhZ2VfaWQiLCJtZXRhZGF0YSIsImJ1bGtfc2VuZCIsInN1Y2Nlc3MiLCJlcnJvck1lc3NhZ2UiLCJjb25zb2xlIiwic3Vic3RpdHV0ZVZhcmlhYmxlcyIsInRlbXBsYXRlIiwidmFyaWFibGVzIiwicmVzdWx0Iiwia2V5IiwidmFsdWUiLCJPYmplY3QiLCJlbnRyaWVzIiwicmVnZXgiLCJSZWdFeHAiLCJqb2IiLCJzdGFydFRpbWUiLCJEYXRlIiwibm93IiwidXNlcklkIiwiY29udGFjdHMiLCJtZXNzYWdlQ29udGVudCIsIm1lc3NhZ2VUeXBlIiwidGVtcGxhdGVJZCIsImxvZyIsImxlbmd0aCIsInJlc3VsdHMiLCJzdWNjZXNzQ291bnQiLCJmYWlsdXJlQ291bnQiLCJmYWlsZWRDb250YWN0cyIsImkiLCJjb250YWN0IiwiZmluYWxNZXNzYWdlIiwicHVzaCIsInByb2dyZXNzIiwiTWF0aCIsInJvdW5kIiwidXBkYXRlUHJvZ3Jlc3MiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNldFRpbWVvdXQiLCJlbmRUaW1lIiwiZHVyYXRpb24iLCJqb2JfaWQiLCJ0b1N0cmluZyIsImpvYl90eXBlIiwidXNlcl9pZCIsInRvdGFsIiwiZmFpbGVkIiwiZXJyb3JfZGV0YWlscyIsImZhaWxlZF9jb250YWN0cyIsInN0YXJ0ZWRfYXQiLCJ0b0lTT1N0cmluZyIsImNvbXBsZXRlZF9hdCIsImpvYklkIiwidG90YWxDb250YWN0cyIsInN0YXJ0ZWRBdCIsImNvbXBsZXRlZEF0Il0sInNvdXJjZXMiOlsiQzpcXEFpIFByb2plY3RlblxcQURTYXBwXFxzcmNcXGxpYlxccXVldWVcXHByb2Nlc3NvcnNcXGJ1bGstbWVzc2FnZS1wcm9jZXNzb3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSm9iIH0gZnJvbSAnYnVsbG1xJztcbmltcG9ydCB7IGNyZWF0ZUNsaWVudCB9IGZyb20gJ0AvbGliL3N1cGFiYXNlL3NlcnZlcic7XG5cbi8qKlxuICogQnVsayBNZXNzYWdlIFByb2Nlc3NvclxuICpcbiAqIEhhbmRsZXMgc2VuZGluZyBXaGF0c0FwcCBtZXNzYWdlcyB0byBtdWx0aXBsZSBjb250YWN0cyBpbiBidWxrLlxuICogSW1wbGVtZW50cyByYXRlIGxpbWl0aW5nLCBwcm9ncmVzcyB0cmFja2luZywgYW5kIHBlci1tZXNzYWdlIGVycm9yIGhhbmRsaW5nLlxuICpcbiAqIEZlYXR1cmVzOlxuICogLSBXaGF0c0FwcCBCdXNpbmVzcyBBUEkgcmF0ZSBsaW1pdGluZ1xuICogLSBJbmRpdmlkdWFsIG1lc3NhZ2UgZmFpbHVyZSB0cmFja2luZ1xuICogLSBQcm9ncmVzcyB1cGRhdGVzIGZvciBVSSBmZWVkYmFja1xuICogLSBSZXRyeSBsb2dpYyBmb3IgZmFpbGVkIG1lc3NhZ2VzXG4gKiAtIE11bHRpLXRlbmFudCBpc29sYXRpb25cbiAqXG4gKiBAbW9kdWxlIGJ1bGstbWVzc2FnZS1wcm9jZXNzb3JcbiAqL1xuXG4vKipcbiAqIENvbnRhY3QgaW5mb3JtYXRpb24gZm9yIGJ1bGsgbWVzc2FnaW5nXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQnVsa01lc3NhZ2VDb250YWN0IHtcbiAgaWQ6IHN0cmluZztcbiAgcGhvbmU6IHN0cmluZztcbiAgbmFtZT86IHN0cmluZztcbiAgdmFyaWFibGVzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjsgLy8gRm9yIHRlbXBsYXRlIHZhcmlhYmxlIHN1YnN0aXR1dGlvblxufVxuXG4vKipcbiAqIEJ1bGsgbWVzc2FnZSBqb2IgZGF0YVxuICovXG5leHBvcnQgaW50ZXJmYWNlIEJ1bGtNZXNzYWdlSm9iRGF0YSB7XG4gIG9yZ2FuaXphdGlvbklkOiBzdHJpbmc7XG4gIHVzZXJJZDogc3RyaW5nO1xuICBjb250YWN0czogQnVsa01lc3NhZ2VDb250YWN0W107XG4gIG1lc3NhZ2VDb250ZW50OiBzdHJpbmc7XG4gIG1lc3NhZ2VUeXBlOiAndGV4dCcgfCAndGVtcGxhdGUnO1xuICB0ZW1wbGF0ZUlkPzogc3RyaW5nO1xuICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT47XG59XG5cbi8qKlxuICogQnVsayBtZXNzYWdlIGpvYiByZXN1bHRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBCdWxrTWVzc2FnZUpvYlJlc3VsdCB7XG4gIGpvYklkOiBzdHJpbmc7XG4gIG9yZ2FuaXphdGlvbklkOiBzdHJpbmc7XG4gIHRvdGFsQ29udGFjdHM6IG51bWJlcjtcbiAgc3VjY2Vzc0NvdW50OiBudW1iZXI7XG4gIGZhaWx1cmVDb3VudDogbnVtYmVyO1xuICBmYWlsZWRDb250YWN0czogQXJyYXk8e1xuICAgIGNvbnRhY3RJZDogc3RyaW5nO1xuICAgIHBob25lOiBzdHJpbmc7XG4gICAgZXJyb3I6IHN0cmluZztcbiAgfT47XG4gIHN0YXJ0ZWRBdDogc3RyaW5nO1xuICBjb21wbGV0ZWRBdDogc3RyaW5nO1xuICBkdXJhdGlvbjogbnVtYmVyO1xufVxuXG4vKipcbiAqIFNlbmQgYSBzaW5nbGUgV2hhdHNBcHAgbWVzc2FnZVxuICovXG5hc3luYyBmdW5jdGlvbiBzZW5kV2hhdHNBcHBNZXNzYWdlKFxuICBwaG9uZTogc3RyaW5nLFxuICBjb250ZW50OiBzdHJpbmcsXG4gIG9yZ2FuaXphdGlvbklkOiBzdHJpbmcsXG4gIGNvbnRhY3RJZDogc3RyaW5nXG4pOiBQcm9taXNlPHsgc3VjY2VzczogYm9vbGVhbjsgZXJyb3I/OiBzdHJpbmc7IG1lc3NhZ2VJZD86IHN0cmluZyB9PiB7XG4gIHRyeSB7XG4gICAgLy8gR2V0IFdoYXRzQXBwIGNvbmZpZ3VyYXRpb24gZm9yIG9yZ2FuaXphdGlvblxuICAgIGNvbnN0IHN1cGFiYXNlID0gYXdhaXQgY3JlYXRlQ2xpZW50KCk7XG5cbiAgICBjb25zdCB7IGRhdGE6IG9yZ0NvbmZpZywgZXJyb3I6IGNvbmZpZ0Vycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oJ29yZ2FuaXphdGlvbnMnKVxuICAgICAgLnNlbGVjdCgnd2hhdHNhcHBfY29uZmlnJylcbiAgICAgIC5lcSgnaWQnLCBvcmdhbml6YXRpb25JZClcbiAgICAgIC5zaW5nbGUoKTtcblxuICAgIGlmIChjb25maWdFcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZ2V0IFdoYXRzQXBwIGNvbmZpZzogJHtjb25maWdFcnJvci5tZXNzYWdlfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHdoYXRzYXBwQ29uZmlnID0gb3JnQ29uZmlnLndoYXRzYXBwX2NvbmZpZyBhcyB7XG4gICAgICBhY2Nlc3NfdG9rZW46IHN0cmluZztcbiAgICAgIHBob25lX251bWJlcl9pZDogc3RyaW5nO1xuICAgIH07XG5cbiAgICBpZiAoIXdoYXRzYXBwQ29uZmlnPy5hY2Nlc3NfdG9rZW4gfHwgIXdoYXRzYXBwQ29uZmlnPy5waG9uZV9udW1iZXJfaWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignV2hhdHNBcHAgbm90IGNvbmZpZ3VyZWQgZm9yIG9yZ2FuaXphdGlvbicpO1xuICAgIH1cblxuICAgIC8vIEZvcm1hdCBwaG9uZSBudW1iZXIgKHJlbW92ZSBub24tZGlnaXRzKVxuICAgIGNvbnN0IGZvcm1hdHRlZFBob25lID0gcGhvbmUucmVwbGFjZSgvXFxEL2csICcnKTtcblxuICAgIC8vIFNlbmQgbWVzc2FnZSB2aWEgV2hhdHNBcHAgQnVzaW5lc3MgQVBJXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcbiAgICAgIGBodHRwczovL2dyYXBoLmZhY2Vib29rLmNvbS92MTguMC8ke3doYXRzYXBwQ29uZmlnLnBob25lX251bWJlcl9pZH0vbWVzc2FnZXNgLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3doYXRzYXBwQ29uZmlnLmFjY2Vzc190b2tlbn1gLFxuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIG1lc3NhZ2luZ19wcm9kdWN0OiAnd2hhdHNhcHAnLFxuICAgICAgICAgIHRvOiBmb3JtYXR0ZWRQaG9uZSxcbiAgICAgICAgICB0eXBlOiAndGV4dCcsXG4gICAgICAgICAgdGV4dDoge1xuICAgICAgICAgICAgYm9keTogY29udGVudFxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgY29uc3QgZXJyb3JEYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBlcnJvckRhdGEuZXJyb3I/Lm1lc3NhZ2UgfHwgJ1doYXRzQXBwIEFQSSByZXF1ZXN0IGZhaWxlZCdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICBjb25zdCBtZXNzYWdlSWQgPSBkYXRhLm1lc3NhZ2VzPy5bMF0/LmlkO1xuXG4gICAgLy8gTG9nIG1lc3NhZ2UgdG8gZGF0YWJhc2VcbiAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdtZXNzYWdlcycpLmluc2VydCh7XG4gICAgICBjb252ZXJzYXRpb25faWQ6IG51bGwsIC8vIFdpbGwgYmUgbGlua2VkIGxhdGVyXG4gICAgICBjb250YWN0X2lkOiBjb250YWN0SWQsXG4gICAgICBvcmdhbml6YXRpb25faWQ6IG9yZ2FuaXphdGlvbklkLFxuICAgICAgY29udGVudDogY29udGVudCxcbiAgICAgIG1lc3NhZ2VfdHlwZTogJ3RleHQnLFxuICAgICAgZGlyZWN0aW9uOiAnb3V0Ym91bmQnLFxuICAgICAgc3RhdHVzOiAnc2VudCcsXG4gICAgICB3aGF0c2FwcF9tZXNzYWdlX2lkOiBtZXNzYWdlSWQsXG4gICAgICBtZXRhZGF0YTogeyBidWxrX3NlbmQ6IHRydWUgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZUlkIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID1cbiAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InO1xuICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBzZW5kIG1lc3NhZ2UgdG8gJHtwaG9uZX06YCwgZXJyb3JNZXNzYWdlKTtcbiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IGVycm9yTWVzc2FnZSB9O1xuICB9XG59XG5cbi8qKlxuICogU3Vic3RpdHV0ZSB2YXJpYWJsZXMgaW4gbWVzc2FnZSB0ZW1wbGF0ZVxuICovXG5mdW5jdGlvbiBzdWJzdGl0dXRlVmFyaWFibGVzKFxuICB0ZW1wbGF0ZTogc3RyaW5nLFxuICB2YXJpYWJsZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IHN0cmluZyB7XG4gIGxldCByZXN1bHQgPSB0ZW1wbGF0ZTtcblxuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh2YXJpYWJsZXMpKSB7XG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGB7eyR7a2V5fX19YCwgJ2cnKTtcbiAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZShyZWdleCwgdmFsdWUpO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLyoqXG4gKiBCdWxrIG1lc3NhZ2UgcHJvY2Vzc29yIGZ1bmN0aW9uXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcm9jZXNzQnVsa01lc3NhZ2UoXG4gIGpvYjogSm9iPEJ1bGtNZXNzYWdlSm9iRGF0YT5cbik6IFByb21pc2U8QnVsa01lc3NhZ2VKb2JSZXN1bHQ+IHtcbiAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgY29uc3Qge1xuICAgIG9yZ2FuaXphdGlvbklkLFxuICAgIHVzZXJJZCxcbiAgICBjb250YWN0cyxcbiAgICBtZXNzYWdlQ29udGVudCxcbiAgICBtZXNzYWdlVHlwZSxcbiAgICB0ZW1wbGF0ZUlkLFxuICAgIG1ldGFkYXRhXG4gIH0gPSBqb2IuZGF0YTtcblxuICBjb25zb2xlLmxvZyhcbiAgICBgW0J1bGtNZXNzYWdlXSBTdGFydGluZyBqb2IgJHtqb2IuaWR9IGZvciAke2NvbnRhY3RzLmxlbmd0aH0gY29udGFjdHNgXG4gICk7XG5cbiAgY29uc3QgcmVzdWx0cyA9IHtcbiAgICBzdWNjZXNzQ291bnQ6IDAsXG4gICAgZmFpbHVyZUNvdW50OiAwLFxuICAgIGZhaWxlZENvbnRhY3RzOiBbXSBhcyBBcnJheTx7XG4gICAgICBjb250YWN0SWQ6IHN0cmluZztcbiAgICAgIHBob25lOiBzdHJpbmc7XG4gICAgICBlcnJvcjogc3RyaW5nO1xuICAgIH0+XG4gIH07XG5cbiAgLy8gUHJvY2VzcyBlYWNoIGNvbnRhY3RcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb250YWN0cy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGNvbnRhY3QgPSBjb250YWN0c1tpXTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBTdWJzdGl0dXRlIHZhcmlhYmxlcyBpZiBwcm92aWRlZFxuICAgICAgbGV0IGZpbmFsTWVzc2FnZSA9IG1lc3NhZ2VDb250ZW50O1xuICAgICAgaWYgKGNvbnRhY3QudmFyaWFibGVzKSB7XG4gICAgICAgIGZpbmFsTWVzc2FnZSA9IHN1YnN0aXR1dGVWYXJpYWJsZXMobWVzc2FnZUNvbnRlbnQsIGNvbnRhY3QudmFyaWFibGVzKTtcbiAgICAgIH1cblxuICAgICAgLy8gU2VuZCBtZXNzYWdlXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZW5kV2hhdHNBcHBNZXNzYWdlKFxuICAgICAgICBjb250YWN0LnBob25lLFxuICAgICAgICBmaW5hbE1lc3NhZ2UsXG4gICAgICAgIG9yZ2FuaXphdGlvbklkLFxuICAgICAgICBjb250YWN0LmlkXG4gICAgICApO1xuXG4gICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgcmVzdWx0cy5zdWNjZXNzQ291bnQrKztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdHMuZmFpbHVyZUNvdW50Kys7XG4gICAgICAgIHJlc3VsdHMuZmFpbGVkQ29udGFjdHMucHVzaCh7XG4gICAgICAgICAgY29udGFjdElkOiBjb250YWN0LmlkLFxuICAgICAgICAgIHBob25lOiBjb250YWN0LnBob25lLFxuICAgICAgICAgIGVycm9yOiByZXN1bHQuZXJyb3IgfHwgJ1Vua25vd24gZXJyb3InXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBVcGRhdGUgcHJvZ3Jlc3NcbiAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5yb3VuZCgoKGkgKyAxKSAvIGNvbnRhY3RzLmxlbmd0aCkgKiAxMDApO1xuICAgICAgYXdhaXQgam9iLnVwZGF0ZVByb2dyZXNzKHByb2dyZXNzKTtcblxuICAgICAgLy8gTG9nIHByb2dyZXNzIGV2ZXJ5IDEwIGNvbnRhY3RzXG4gICAgICBpZiAoKGkgKyAxKSAlIDEwID09PSAwIHx8IGkgKyAxID09PSBjb250YWN0cy5sZW5ndGgpIHtcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYFtCdWxrTWVzc2FnZV0gSm9iICR7am9iLmlkfTogJHtpICsgMX0vJHtjb250YWN0cy5sZW5ndGh9IHByb2Nlc3NlZGBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gUmF0ZSBsaW1pdGluZzogV2hhdHNBcHAgYWxsb3dzIH44MCBtZXNzYWdlcy9zZWNvbmRcbiAgICAgIC8vIEFkZCBzbWFsbCBkZWxheSB0byBiZSBzYWZlICgxMi0xMyBtc2cvc2VjKVxuICAgICAgaWYgKGkgPCBjb250YWN0cy5sZW5ndGggLSAxKSB7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDc1KSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJlc3VsdHMuZmFpbHVyZUNvdW50Kys7XG4gICAgICByZXN1bHRzLmZhaWxlZENvbnRhY3RzLnB1c2goe1xuICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3QuaWQsXG4gICAgICAgIHBob25lOiBjb250YWN0LnBob25lLFxuICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnUHJvY2Vzc2luZyBlcnJvcidcbiAgICAgIH0pO1xuXG4gICAgICBjb25zb2xlLmVycm9yKGBbQnVsa01lc3NhZ2VdIEVycm9yIHByb2Nlc3NpbmcgY29udGFjdCAke2NvbnRhY3QuaWR9OmAsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBlbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgY29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xuXG4gIC8vIExvZyBqb2IgY29tcGxldGlvbiB0byBkYXRhYmFzZVxuICBjb25zdCBzdXBhYmFzZSA9IGF3YWl0IGNyZWF0ZUNsaWVudCgpO1xuICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdqb2JfbG9ncycpLmluc2VydCh7XG4gICAgam9iX2lkOiBqb2IuaWQ/LnRvU3RyaW5nKCksXG4gICAgam9iX3R5cGU6ICdidWxrX21lc3NhZ2UnLFxuICAgIG9yZ2FuaXphdGlvbl9pZDogb3JnYW5pemF0aW9uSWQsXG4gICAgdXNlcl9pZDogdXNlcklkLFxuICAgIHN0YXR1czogcmVzdWx0cy5mYWlsdXJlQ291bnQgPT09IDAgPyAnY29tcGxldGVkJyA6ICdwYXJ0aWFsX2ZhaWx1cmUnLFxuICAgIHJlc3VsdDoge1xuICAgICAgdG90YWw6IGNvbnRhY3RzLmxlbmd0aCxcbiAgICAgIHN1Y2Nlc3M6IHJlc3VsdHMuc3VjY2Vzc0NvdW50LFxuICAgICAgZmFpbGVkOiByZXN1bHRzLmZhaWx1cmVDb3VudCxcbiAgICAgIGR1cmF0aW9uOiBkdXJhdGlvblxuICAgIH0sXG4gICAgZXJyb3JfZGV0YWlsczpcbiAgICAgIHJlc3VsdHMuZmFpbGVkQ29udGFjdHMubGVuZ3RoID4gMFxuICAgICAgICA/IHsgZmFpbGVkX2NvbnRhY3RzOiByZXN1bHRzLmZhaWxlZENvbnRhY3RzIH1cbiAgICAgICAgOiBudWxsLFxuICAgIHN0YXJ0ZWRfYXQ6IG5ldyBEYXRlKHN0YXJ0VGltZSkudG9JU09TdHJpbmcoKSxcbiAgICBjb21wbGV0ZWRfYXQ6IG5ldyBEYXRlKGVuZFRpbWUpLnRvSVNPU3RyaW5nKClcbiAgfSk7XG5cbiAgY29uc29sZS5sb2coXG4gICAgYFtCdWxrTWVzc2FnZV0gSm9iICR7am9iLmlkfSBjb21wbGV0ZWQ6ICR7cmVzdWx0cy5zdWNjZXNzQ291bnR9IHN1Y2Nlc3MsICR7cmVzdWx0cy5mYWlsdXJlQ291bnR9IGZhaWxlZCwgJHtkdXJhdGlvbn1tc2BcbiAgKTtcblxuICByZXR1cm4ge1xuICAgIGpvYklkOiBqb2IuaWQ/LnRvU3RyaW5nKCkgfHwgJycsXG4gICAgb3JnYW5pemF0aW9uSWQsXG4gICAgdG90YWxDb250YWN0czogY29udGFjdHMubGVuZ3RoLFxuICAgIHN1Y2Nlc3NDb3VudDogcmVzdWx0cy5zdWNjZXNzQ291bnQsXG4gICAgZmFpbHVyZUNvdW50OiByZXN1bHRzLmZhaWx1cmVDb3VudCxcbiAgICBmYWlsZWRDb250YWN0czogcmVzdWx0cy5mYWlsZWRDb250YWN0cyxcbiAgICBzdGFydGVkQXQ6IG5ldyBEYXRlKHN0YXJ0VGltZSkudG9JU09TdHJpbmcoKSxcbiAgICBjb21wbGV0ZWRBdDogbmV3IERhdGUoZW5kVGltZSkudG9JU09TdHJpbmcoKSxcbiAgICBkdXJhdGlvblxuICB9O1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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