{"version":3,"names":["cov_2ajixmi8dk","actualCoverage","s","processBulkMessage","sendWhatsAppMessage","phone","content","organizationId","contactId","f","supabase","_server","createClient","data","orgConfig","error","configError","from","select","eq","single","b","Error","message","whatsappConfig","whatsapp_config","access_token","phone_number_id","formattedPhone","replace","response","fetch","method","headers","body","JSON","stringify","messaging_product","to","type","text","ok","errorData","json","messageId","messages","id","insert","conversation_id","contact_id","organization_id","message_type","direction","status","whatsapp_message_id","metadata","bulk_send","success","errorMessage","console","substituteVariables","template","variables","result","key","value","Object","entries","regex","RegExp","job","startTime","Date","now","userId","contacts","messageContent","messageType","templateId","log","length","results","successCount","failureCount","failedContacts","i","contact","finalMessage","push","progress","Math","round","updateProgress","Promise","resolve","setTimeout","endTime","duration","job_id","toString","job_type","user_id","total","failed","error_details","failed_contacts","started_at","toISOString","completed_at","jobId","totalContacts","startedAt","completedAt"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\queue\\processors\\bulk-message-processor.ts"],"sourcesContent":["import { Job } from 'bullmq';\nimport { createClient } from '@/lib/supabase/server';\n\n/**\n * Bulk Message Processor\n *\n * Handles sending WhatsApp messages to multiple contacts in bulk.\n * Implements rate limiting, progress tracking, and per-message error handling.\n *\n * Features:\n * - WhatsApp Business API rate limiting\n * - Individual message failure tracking\n * - Progress updates for UI feedback\n * - Retry logic for failed messages\n * - Multi-tenant isolation\n *\n * @module bulk-message-processor\n */\n\n/**\n * Contact information for bulk messaging\n */\nexport interface BulkMessageContact {\n  id: string;\n  phone: string;\n  name?: string;\n  variables?: Record<string, string>; // For template variable substitution\n}\n\n/**\n * Bulk message job data\n */\nexport interface BulkMessageJobData {\n  organizationId: string;\n  userId: string;\n  contacts: BulkMessageContact[];\n  messageContent: string;\n  messageType: 'text' | 'template';\n  templateId?: string;\n  metadata?: Record<string, any>;\n}\n\n/**\n * Bulk message job result\n */\nexport interface BulkMessageJobResult {\n  jobId: string;\n  organizationId: string;\n  totalContacts: number;\n  successCount: number;\n  failureCount: number;\n  failedContacts: Array<{\n    contactId: string;\n    phone: string;\n    error: string;\n  }>;\n  startedAt: string;\n  completedAt: string;\n  duration: number;\n}\n\n/**\n * Send a single WhatsApp message\n */\nasync function sendWhatsAppMessage(\n  phone: string,\n  content: string,\n  organizationId: string,\n  contactId: string\n): Promise<{ success: boolean; error?: string; messageId?: string }> {\n  try {\n    // Get WhatsApp configuration for organization\n    const supabase = await createClient();\n\n    const { data: orgConfig, error: configError } = await supabase\n      .from('organizations')\n      .select('whatsapp_config')\n      .eq('id', organizationId)\n      .single();\n\n    if (configError) {\n      throw new Error(`Failed to get WhatsApp config: ${configError.message}`);\n    }\n\n    const whatsappConfig = orgConfig.whatsapp_config as {\n      access_token: string;\n      phone_number_id: string;\n    };\n\n    if (!whatsappConfig?.access_token || !whatsappConfig?.phone_number_id) {\n      throw new Error('WhatsApp not configured for organization');\n    }\n\n    // Format phone number (remove non-digits)\n    const formattedPhone = phone.replace(/\\D/g, '');\n\n    // Send message via WhatsApp Business API\n    const response = await fetch(\n      `https://graph.facebook.com/v18.0/${whatsappConfig.phone_number_id}/messages`,\n      {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${whatsappConfig.access_token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          messaging_product: 'whatsapp',\n          to: formattedPhone,\n          type: 'text',\n          text: {\n            body: content\n          }\n        })\n      }\n    );\n\n    if (!response.ok) {\n      const errorData = await response.json();\n      throw new Error(\n        errorData.error?.message || 'WhatsApp API request failed'\n      );\n    }\n\n    const data = await response.json();\n    const messageId = data.messages?.[0]?.id;\n\n    // Log message to database\n    await supabase.from('messages').insert({\n      conversation_id: null, // Will be linked later\n      contact_id: contactId,\n      organization_id: organizationId,\n      content: content,\n      message_type: 'text',\n      direction: 'outbound',\n      status: 'sent',\n      whatsapp_message_id: messageId,\n      metadata: { bulk_send: true }\n    });\n\n    return { success: true, messageId };\n  } catch (error) {\n    const errorMessage =\n      error instanceof Error ? error.message : 'Unknown error';\n    console.error(`Failed to send message to ${phone}:`, errorMessage);\n    return { success: false, error: errorMessage };\n  }\n}\n\n/**\n * Substitute variables in message template\n */\nfunction substituteVariables(\n  template: string,\n  variables: Record<string, string>\n): string {\n  let result = template;\n\n  for (const [key, value] of Object.entries(variables)) {\n    const regex = new RegExp(`{{${key}}}`, 'g');\n    result = result.replace(regex, value);\n  }\n\n  return result;\n}\n\n/**\n * Bulk message processor function\n */\nexport async function processBulkMessage(\n  job: Job<BulkMessageJobData>\n): Promise<BulkMessageJobResult> {\n  const startTime = Date.now();\n  const {\n    organizationId,\n    userId,\n    contacts,\n    messageContent,\n    messageType,\n    templateId,\n    metadata\n  } = job.data;\n\n  console.log(\n    `[BulkMessage] Starting job ${job.id} for ${contacts.length} contacts`\n  );\n\n  const results = {\n    successCount: 0,\n    failureCount: 0,\n    failedContacts: [] as Array<{\n      contactId: string;\n      phone: string;\n      error: string;\n    }>\n  };\n\n  // Process each contact\n  for (let i = 0; i < contacts.length; i++) {\n    const contact = contacts[i];\n\n    try {\n      // Substitute variables if provided\n      let finalMessage = messageContent;\n      if (contact.variables) {\n        finalMessage = substituteVariables(messageContent, contact.variables);\n      }\n\n      // Send message\n      const result = await sendWhatsAppMessage(\n        contact.phone,\n        finalMessage,\n        organizationId,\n        contact.id\n      );\n\n      if (result.success) {\n        results.successCount++;\n      } else {\n        results.failureCount++;\n        results.failedContacts.push({\n          contactId: contact.id,\n          phone: contact.phone,\n          error: result.error || 'Unknown error'\n        });\n      }\n\n      // Update progress\n      const progress = Math.round(((i + 1) / contacts.length) * 100);\n      await job.updateProgress(progress);\n\n      // Log progress every 10 contacts\n      if ((i + 1) % 10 === 0 || i + 1 === contacts.length) {\n        console.log(\n          `[BulkMessage] Job ${job.id}: ${i + 1}/${contacts.length} processed`\n        );\n      }\n\n      // Rate limiting: WhatsApp allows ~80 messages/second\n      // Add small delay to be safe (12-13 msg/sec)\n      if (i < contacts.length - 1) {\n        await new Promise((resolve) => setTimeout(resolve, 75));\n      }\n    } catch (error) {\n      results.failureCount++;\n      results.failedContacts.push({\n        contactId: contact.id,\n        phone: contact.phone,\n        error: error instanceof Error ? error.message : 'Processing error'\n      });\n\n      console.error(`[BulkMessage] Error processing contact ${contact.id}:`, error);\n    }\n  }\n\n  const endTime = Date.now();\n  const duration = endTime - startTime;\n\n  // Log job completion to database\n  const supabase = await createClient();\n  await supabase.from('job_logs').insert({\n    job_id: job.id?.toString(),\n    job_type: 'bulk_message',\n    organization_id: organizationId,\n    user_id: userId,\n    status: results.failureCount === 0 ? 'completed' : 'partial_failure',\n    result: {\n      total: contacts.length,\n      success: results.successCount,\n      failed: results.failureCount,\n      duration: duration\n    },\n    error_details:\n      results.failedContacts.length > 0\n        ? { failed_contacts: results.failedContacts }\n        : null,\n    started_at: new Date(startTime).toISOString(),\n    completed_at: new Date(endTime).toISOString()\n  });\n\n  console.log(\n    `[BulkMessage] Job ${job.id} completed: ${results.successCount} success, ${results.failureCount} failed, ${duration}ms`\n  );\n\n  return {\n    jobId: job.id?.toString() || '',\n    organizationId,\n    totalContacts: contacts.length,\n    successCount: results.successCount,\n    failureCount: results.failureCount,\n    failedContacts: results.failedContacts,\n    startedAt: new Date(startTime).toISOString(),\n    completedAt: new Date(endTime).toISOString(),\n    duration\n  };\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}