{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\integration\\api\\health.test.ts"],"sourcesContent":["/**\n * Health Check API Integration Tests\n *\n * Tests for /api/health/* endpoints including overall health,\n * database, Stripe, and WhatsApp API connectivity.\n */\n\nimport { describe, it, expect, beforeEach, jest } from '@jest/globals'\nimport { NextRequest } from 'next/server'\nimport { createMockRequest, parseResponse } from '../../utils/api-test-helpers'\nimport { createMockSupabaseClient } from '../../utils/test-helpers'\n\njest.mock('@/lib/supabase/server')\n\ndescribe('GET /api/health', () => {\n  it('should return overall application health status', async () => {\n    const request = createMockRequest('GET', '/api/health')\n    const response = await simulateHealthCheck(request)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data).toHaveProperty('status')\n    expect(data).toHaveProperty('timestamp')\n    expect(data).toHaveProperty('services')\n    expect(data.status).toBe('healthy')\n  })\n})\n\ndescribe('GET /api/health/db', () => {\n  let mockSupabase: any\n\n  beforeEach(() => {\n    mockSupabase = createMockSupabaseClient()\n    jest.clearAllMocks()\n  })\n\n  it('should return healthy when database is connected', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      limit: jest.fn().mockResolvedValue({ data: [], error: null }),\n    })\n\n    const request = createMockRequest('GET', '/api/health/db')\n    const response = await simulateDbHealthCheck(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.status).toBe('healthy')\n    expect(data.service).toBe('database')\n    expect(data).toHaveProperty('latency')\n  })\n\n  it('should return unhealthy when database connection fails', async () => {\n    mockSupabase.from = jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnThis(),\n      limit: jest.fn().mockResolvedValue({\n        data: null,\n        error: { message: 'Connection failed' },\n      }),\n    })\n\n    const request = createMockRequest('GET', '/api/health/db')\n    const response = await simulateDbHealthCheck(request, mockSupabase)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(503)\n    expect(data.status).toBe('unhealthy')\n    expect(data).toHaveProperty('error')\n  })\n})\n\ndescribe('GET /api/health/stripe', () => {\n  it('should return healthy when Stripe is configured', async () => {\n    const mockStripe = {\n      customers: {\n        list: jest.fn().mockResolvedValue({ data: [] }),\n      },\n    }\n\n    const request = createMockRequest('GET', '/api/health/stripe')\n    const response = await simulateStripeHealthCheck(request, mockStripe)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.status).toBe('healthy')\n    expect(data.service).toBe('stripe')\n  })\n\n  it('should return unhealthy when Stripe is not configured', async () => {\n    const mockStripe = null\n\n    const request = createMockRequest('GET', '/api/health/stripe')\n    const response = await simulateStripeHealthCheck(request, mockStripe)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(503)\n    expect(data.status).toBe('unhealthy')\n    expect(data.error).toContain('not configured')\n  })\n})\n\ndescribe('GET /api/health/whatsapp', () => {\n  it('should return healthy when WhatsApp API is accessible', async () => {\n    global.fetch = jest.fn().mockResolvedValue({\n      ok: true,\n      json: async () => ({ success: true }),\n    }) as jest.Mock\n\n    const request = createMockRequest('GET', '/api/health/whatsapp')\n    const response = await simulateWhatsAppHealthCheck(request)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(200)\n    expect(data.status).toBe('healthy')\n    expect(data.service).toBe('whatsapp')\n  })\n\n  it('should return unhealthy when WhatsApp API is not accessible', async () => {\n    global.fetch = jest.fn().mockRejectedValue(new Error('Network error')) as jest.Mock\n\n    const request = createMockRequest('GET', '/api/health/whatsapp')\n    const response = await simulateWhatsAppHealthCheck(request)\n    const { status, data } = await parseResponse(response)\n\n    expect(status).toBe(503)\n    expect(data.status).toBe('unhealthy')\n    expect(data).toHaveProperty('error')\n  })\n})\n\n// =============================================================================\n// Helper Functions to Simulate API Route Handlers\n// =============================================================================\n\nasync function simulateHealthCheck(request: NextRequest): Promise<any> {\n  try {\n    return new Response(\n      JSON.stringify({\n        status: 'healthy',\n        timestamp: new Date().toISOString(),\n        services: {\n          database: 'healthy',\n          stripe: 'healthy',\n          whatsapp: 'healthy',\n        },\n      }),\n      { status: 200, headers: { 'Content-Type': 'application/json' } }\n    )\n  } catch (error: any) {\n    return new Response(JSON.stringify({ status: 'unhealthy', error: error.message }), {\n      status: 503,\n      headers: { 'Content-Type': 'application/json' },\n    })\n  }\n}\n\nasync function simulateDbHealthCheck(request: NextRequest, supabase: any): Promise<any> {\n  try {\n    const startTime = Date.now()\n\n    const { data, error } = await supabase.from('organizations').select('id').limit(1)\n\n    if (error) {\n      return new Response(\n        JSON.stringify({\n          status: 'unhealthy',\n          service: 'database',\n          error: error.message,\n        }),\n        { status: 503, headers: { 'Content-Type': 'application/json' } }\n      )\n    }\n\n    const latency = Date.now() - startTime\n\n    return new Response(\n      JSON.stringify({\n        status: 'healthy',\n        service: 'database',\n        latency: `${latency}ms`,\n      }),\n      { status: 200, headers: { 'Content-Type': 'application/json' } }\n    )\n  } catch (error: any) {\n    return new Response(\n      JSON.stringify({\n        status: 'unhealthy',\n        service: 'database',\n        error: error.message,\n      }),\n      { status: 503, headers: { 'Content-Type': 'application/json' } }\n    )\n  }\n}\n\nasync function simulateStripeHealthCheck(request: NextRequest, stripe: any): Promise<any> {\n  try {\n    if (!stripe || !process.env.STRIPE_SECRET_KEY) {\n      return new Response(\n        JSON.stringify({\n          status: 'unhealthy',\n          service: 'stripe',\n          error: 'Stripe not configured',\n        }),\n        { status: 503, headers: { 'Content-Type': 'application/json' } }\n      )\n    }\n\n    await stripe.customers.list({ limit: 1 })\n\n    return new Response(\n      JSON.stringify({\n        status: 'healthy',\n        service: 'stripe',\n      }),\n      { status: 200, headers: { 'Content-Type': 'application/json' } }\n    )\n  } catch (error: any) {\n    return new Response(\n      JSON.stringify({\n        status: 'unhealthy',\n        service: 'stripe',\n        error: error.message,\n      }),\n      { status: 503, headers: { 'Content-Type': 'application/json' } }\n    )\n  }\n}\n\nasync function simulateWhatsAppHealthCheck(request: NextRequest): Promise<any> {\n  try {\n    if (!process.env.WHATSAPP_ACCESS_TOKEN) {\n      return new Response(\n        JSON.stringify({\n          status: 'unhealthy',\n          service: 'whatsapp',\n          error: 'WhatsApp not configured',\n        }),\n        { status: 503, headers: { 'Content-Type': 'application/json' } }\n      )\n    }\n\n    const response = await fetch(\n      `https://graph.facebook.com/v18.0/${process.env.WHATSAPP_PHONE_NUMBER_ID}`,\n      {\n        headers: {\n          Authorization: `Bearer ${process.env.WHATSAPP_ACCESS_TOKEN}`,\n        },\n      }\n    )\n\n    if (!response.ok) {\n      throw new Error('WhatsApp API not accessible')\n    }\n\n    return new Response(\n      JSON.stringify({\n        status: 'healthy',\n        service: 'whatsapp',\n      }),\n      { status: 200, headers: { 'Content-Type': 'application/json' } }\n    )\n  } catch (error: any) {\n    return new Response(\n      JSON.stringify({\n        status: 'unhealthy',\n        service: 'whatsapp',\n        error: error.message,\n      }),\n      { status: 503, headers: { 'Content-Type': 'application/json' } }\n    )\n  }\n}\n"],"names":["jest","mock","describe","it","request","createMockRequest","response","simulateHealthCheck","status","data","parseResponse","expect","toBe","toHaveProperty","mockSupabase","beforeEach","createMockSupabaseClient","clearAllMocks","from","fn","mockReturnValue","select","mockReturnThis","limit","mockResolvedValue","error","simulateDbHealthCheck","service","message","mockStripe","customers","list","simulateStripeHealthCheck","toContain","global","fetch","ok","json","success","simulateWhatsAppHealthCheck","mockRejectedValue","Error","Response","JSON","stringify","timestamp","Date","toISOString","services","database","stripe","whatsapp","headers","supabase","startTime","now","latency","process","env","STRIPE_SECRET_KEY","WHATSAPP_ACCESS_TOKEN","WHATSAPP_PHONE_NUMBER_ID","Authorization"],"mappings":"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"}