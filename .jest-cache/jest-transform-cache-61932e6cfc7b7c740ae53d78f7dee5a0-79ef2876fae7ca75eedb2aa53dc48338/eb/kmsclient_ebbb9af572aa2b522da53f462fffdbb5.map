{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\security\\kms-client.ts"],"sourcesContent":["/**\n * AWS KMS Client Library\n *\n * Provides secure encryption key management using AWS Key Management Service (KMS).\n * Supports multi-tenant key isolation, automatic key rotation, and comprehensive error handling.\n *\n * Features:\n * - Data key generation with AWS KMS\n * - Secure key decryption with caching\n * - Multi-tenant key isolation\n * - Comprehensive error handling and retry logic\n * - Audit logging for all operations\n * - Key rotation support\n *\n * @module security/kms-client\n */\n\nimport {\n  KMSClient as AWSKMSClient,\n  GenerateDataKeyCommand,\n  DecryptCommand,\n  EncryptCommand,\n  DescribeKeyCommand,\n  ScheduleKeyDeletionCommand,\n  CreateAliasCommand,\n  UpdateAliasCommand,\n  KMSServiceException,\n  GenerateDataKeyCommandInput,\n  DecryptCommandInput,\n  EncryptCommandInput,\n} from '@aws-sdk/client-kms';\nimport { fromEnv } from '@aws-sdk/credential-providers';\nimport { KeyManagementError } from '@/lib/crypto/types';\n\n/**\n * KMS Configuration\n */\nexport interface KMSConfig {\n  /** AWS Region */\n  region: string;\n  /** KMS Key ID or ARN */\n  keyId: string;\n  /** Access Key ID (optional, uses environment if not provided) */\n  accessKeyId?: string;\n  /** Secret Access Key (optional, uses environment if not provided) */\n  secretAccessKey?: string;\n  /** Maximum retry attempts */\n  maxRetries?: number;\n  /** Request timeout in milliseconds */\n  timeout?: number;\n}\n\n/**\n * Data key generation result\n */\nexport interface DataKeyResult {\n  /** Encrypted data key (for storage) */\n  ciphertext: string;\n  /** Plaintext data key (for immediate use) */\n  plaintext: Buffer;\n  /** Key ID used for generation */\n  keyId: string;\n}\n\n/**\n * Key metadata information\n */\nexport interface KeyMetadata {\n  /** Key ID */\n  keyId: string;\n  /** Key ARN */\n  arn: string;\n  /** Key state (Enabled, Disabled, etc.) */\n  state: string;\n  /** Creation date */\n  createdAt: Date;\n  /** Key description */\n  description?: string;\n  /** Whether key rotation is enabled */\n  rotationEnabled: boolean;\n}\n\n/**\n * Decryption result\n */\nexport interface DecryptionResult {\n  /** Decrypted plaintext key */\n  plaintext: Buffer;\n  /** Key ID used for decryption */\n  keyId: string;\n}\n\n/**\n * KMS operation statistics for monitoring\n */\nexport interface KMSStats {\n  /** Total operations performed */\n  totalOperations: number;\n  /** Successful operations */\n  successful: number;\n  /** Failed operations */\n  failed: number;\n  /** Cache hits */\n  cacheHits: number;\n  /** Cache misses */\n  cacheMisses: number;\n  /** Average response time in ms */\n  averageResponseTime: number;\n}\n\n/**\n * AWS KMS Client for encryption key management\n */\nexport class KMSClient {\n  private client: AWSKMSClient;\n  private config: Required<KMSConfig>;\n  private keyCache: Map<string, { key: Buffer; timestamp: number }>;\n  private readonly CACHE_TTL = 3600000; // 1 hour in milliseconds\n  private stats: KMSStats;\n\n  /**\n   * Create a new KMS client\n   *\n   * @param config - KMS configuration\n   * @throws {KeyManagementError} If configuration is invalid\n   */\n  constructor(config?: Partial<KMSConfig>) {\n    this.config = this.loadConfig(config);\n    this.validateConfig();\n\n    // Initialize AWS KMS client\n    this.client = new AWSKMSClient({\n      region: this.config.region,\n      credentials: this.config.accessKeyId && this.config.secretAccessKey\n        ? {\n            accessKeyId: this.config.accessKeyId,\n            secretAccessKey: this.config.secretAccessKey,\n          }\n        : fromEnv(),\n      maxAttempts: this.config.maxRetries,\n      requestHandler: {\n        requestTimeout: this.config.timeout,\n      } as any,\n    });\n\n    this.keyCache = new Map();\n    this.stats = {\n      totalOperations: 0,\n      successful: 0,\n      failed: 0,\n      cacheHits: 0,\n      cacheMisses: 0,\n      averageResponseTime: 0,\n    };\n  }\n\n  /**\n   * Load configuration from environment and override with provided config\n   */\n  private loadConfig(config?: Partial<KMSConfig>): Required<KMSConfig> {\n    return {\n      region: config?.region || process.env.AWS_REGION || 'us-east-1',\n      keyId: config?.keyId || process.env.AWS_KMS_KEY_ID || '',\n      accessKeyId: config?.accessKeyId || process.env.AWS_ACCESS_KEY_ID,\n      secretAccessKey: config?.secretAccessKey || process.env.AWS_SECRET_ACCESS_KEY,\n      maxRetries: config?.maxRetries || 3,\n      timeout: config?.timeout || 30000,\n    };\n  }\n\n  /**\n   * Validate KMS configuration\n   *\n   * @throws {KeyManagementError} If configuration is invalid\n   */\n  private validateConfig(): void {\n    if (!this.config.keyId) {\n      throw new KeyManagementError(\n        'AWS_KMS_KEY_ID is required',\n        'MISSING_KMS_KEY_ID',\n        {\n          hint: 'Set AWS_KMS_KEY_ID environment variable or provide keyId in config',\n        }\n      );\n    }\n\n    if (!this.config.region) {\n      throw new KeyManagementError(\n        'AWS_REGION is required',\n        'MISSING_AWS_REGION',\n        {\n          hint: 'Set AWS_REGION environment variable or provide region in config',\n        }\n      );\n    }\n\n    // Validate key ID format (should be UUID or ARN)\n    const isValidKeyId =\n      /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(this.config.keyId) ||\n      /^arn:aws:kms:[a-z0-9-]+:\\d{12}:key\\/[a-f0-9-]+$/i.test(this.config.keyId) ||\n      /^alias\\/[a-zA-Z0-9/_-]+$/.test(this.config.keyId);\n\n    if (!isValidKeyId) {\n      throw new KeyManagementError(\n        'Invalid KMS Key ID format',\n        'INVALID_KEY_ID_FORMAT',\n        {\n          keyId: this.config.keyId,\n          hint: 'Key ID should be UUID, ARN, or alias format',\n        }\n      );\n    }\n  }\n\n  /**\n   * Generate a new data key for tenant-specific encryption\n   *\n   * @param tenantId - Tenant identifier for key isolation\n   * @param keySpec - Key specification (default: AES_256)\n   * @returns Data key result with ciphertext and plaintext\n   * @throws {KeyManagementError} If key generation fails\n   */\n  async generateDataKey(\n    tenantId: string,\n    keySpec: 'AES_256' | 'AES_128' = 'AES_256'\n  ): Promise<DataKeyResult> {\n    const startTime = Date.now();\n    this.stats.totalOperations++;\n\n    try {\n      // Create encryption context for tenant isolation\n      const encryptionContext = {\n        TenantId: tenantId,\n        Purpose: 'DataEncryption',\n        Timestamp: new Date().toISOString(),\n      };\n\n      const input: GenerateDataKeyCommandInput = {\n        KeyId: this.config.keyId,\n        KeySpec: keySpec,\n        EncryptionContext: encryptionContext,\n      };\n\n      const command = new GenerateDataKeyCommand(input);\n      const response = await this.client.send(command);\n\n      if (!response.CiphertextBlob || !response.Plaintext) {\n        throw new KeyManagementError(\n          'KMS returned incomplete data key',\n          'INCOMPLETE_DATA_KEY',\n          { response }\n        );\n      }\n\n      const result: DataKeyResult = {\n        ciphertext: Buffer.from(response.CiphertextBlob).toString('base64'),\n        plaintext: Buffer.from(response.Plaintext),\n        keyId: response.KeyId || this.config.keyId,\n      };\n\n      // Cache the plaintext key\n      this.cacheKey(tenantId, result.plaintext);\n\n      this.stats.successful++;\n      this.updateAverageResponseTime(Date.now() - startTime);\n\n      // Audit log\n      this.logOperation('generateDataKey', tenantId, true);\n\n      return result;\n    } catch (error) {\n      this.stats.failed++;\n      this.logOperation('generateDataKey', tenantId, false, error);\n\n      if (error instanceof KMSServiceException) {\n        throw this.handleKMSError(error, 'generateDataKey');\n      }\n\n      throw new KeyManagementError(\n        'Failed to generate data key',\n        'GENERATE_KEY_FAILED',\n        {\n          tenantId,\n          originalError: error instanceof Error ? error.message : String(error),\n        }\n      );\n    }\n  }\n\n  /**\n   * Decrypt a ciphertext data key\n   *\n   * @param ciphertext - Base64 encoded encrypted data key\n   * @param tenantId - Tenant identifier for context validation\n   * @returns Decrypted plaintext key\n   * @throws {KeyManagementError} If decryption fails\n   */\n  async decryptDataKey(\n    ciphertext: string,\n    tenantId: string\n  ): Promise<DecryptionResult> {\n    const startTime = Date.now();\n    this.stats.totalOperations++;\n\n    try {\n      // Check cache first\n      const cached = this.getCachedKey(tenantId);\n      if (cached) {\n        this.stats.cacheHits++;\n        return {\n          plaintext: cached,\n          keyId: this.config.keyId,\n        };\n      }\n\n      this.stats.cacheMisses++;\n\n      // Create encryption context for tenant validation\n      const encryptionContext = {\n        TenantId: tenantId,\n        Purpose: 'DataEncryption',\n      };\n\n      const input: DecryptCommandInput = {\n        CiphertextBlob: Buffer.from(ciphertext, 'base64'),\n        EncryptionContext: encryptionContext,\n      };\n\n      const command = new DecryptCommand(input);\n      const response = await this.client.send(command);\n\n      if (!response.Plaintext) {\n        throw new KeyManagementError(\n          'KMS returned no plaintext',\n          'NO_PLAINTEXT',\n          { response }\n        );\n      }\n\n      const plaintext = Buffer.from(response.Plaintext);\n\n      // Cache the decrypted key\n      this.cacheKey(tenantId, plaintext);\n\n      this.stats.successful++;\n      this.updateAverageResponseTime(Date.now() - startTime);\n\n      // Audit log\n      this.logOperation('decryptDataKey', tenantId, true);\n\n      return {\n        plaintext,\n        keyId: response.KeyId || this.config.keyId,\n      };\n    } catch (error) {\n      this.stats.failed++;\n      this.logOperation('decryptDataKey', tenantId, false, error);\n\n      if (error instanceof KMSServiceException) {\n        throw this.handleKMSError(error, 'decryptDataKey');\n      }\n\n      throw new KeyManagementError(\n        'Failed to decrypt data key',\n        'DECRYPT_KEY_FAILED',\n        {\n          tenantId,\n          originalError: error instanceof Error ? error.message : String(error),\n        }\n      );\n    }\n  }\n\n  /**\n   * Encrypt data directly with KMS (for small payloads)\n   *\n   * @param plaintext - Data to encrypt\n   * @param tenantId - Tenant identifier\n   * @returns Encrypted ciphertext as base64\n   * @throws {KeyManagementError} If encryption fails\n   */\n  async encrypt(plaintext: string, tenantId: string): Promise<string> {\n    const startTime = Date.now();\n    this.stats.totalOperations++;\n\n    try {\n      const encryptionContext = {\n        TenantId: tenantId,\n        Purpose: 'DirectEncryption',\n      };\n\n      const input: EncryptCommandInput = {\n        KeyId: this.config.keyId,\n        Plaintext: Buffer.from(plaintext),\n        EncryptionContext: encryptionContext,\n      };\n\n      const command = new EncryptCommand(input);\n      const response = await this.client.send(command);\n\n      if (!response.CiphertextBlob) {\n        throw new KeyManagementError(\n          'KMS returned no ciphertext',\n          'NO_CIPHERTEXT',\n          { response }\n        );\n      }\n\n      this.stats.successful++;\n      this.updateAverageResponseTime(Date.now() - startTime);\n\n      this.logOperation('encrypt', tenantId, true);\n\n      return Buffer.from(response.CiphertextBlob).toString('base64');\n    } catch (error) {\n      this.stats.failed++;\n      this.logOperation('encrypt', tenantId, false, error);\n\n      if (error instanceof KMSServiceException) {\n        throw this.handleKMSError(error, 'encrypt');\n      }\n\n      throw new KeyManagementError(\n        'Failed to encrypt with KMS',\n        'ENCRYPT_FAILED',\n        {\n          tenantId,\n          originalError: error instanceof Error ? error.message : String(error),\n        }\n      );\n    }\n  }\n\n  /**\n   * Get KMS key metadata\n   *\n   * @returns Key metadata information\n   * @throws {KeyManagementError} If operation fails\n   */\n  async getKeyMetadata(): Promise<KeyMetadata> {\n    try {\n      const command = new DescribeKeyCommand({ KeyId: this.config.keyId });\n      const response = await this.client.send(command);\n\n      if (!response.KeyMetadata) {\n        throw new KeyManagementError(\n          'No key metadata returned',\n          'NO_KEY_METADATA'\n        );\n      }\n\n      return {\n        keyId: response.KeyMetadata.KeyId || this.config.keyId,\n        arn: response.KeyMetadata.Arn || '',\n        state: response.KeyMetadata.KeyState || 'Unknown',\n        createdAt: response.KeyMetadata.CreationDate || new Date(),\n        description: response.KeyMetadata.Description,\n        rotationEnabled: response.KeyMetadata.KeyRotationEnabled || false,\n      };\n    } catch (error) {\n      if (error instanceof KMSServiceException) {\n        throw this.handleKMSError(error, 'getKeyMetadata');\n      }\n\n      throw new KeyManagementError(\n        'Failed to get key metadata',\n        'GET_METADATA_FAILED',\n        {\n          originalError: error instanceof Error ? error.message : String(error),\n        }\n      );\n    }\n  }\n\n  /**\n   * Clear cached keys for a tenant\n   *\n   * @param tenantId - Tenant identifier (optional, clears all if not provided)\n   */\n  clearCache(tenantId?: string): void {\n    if (tenantId) {\n      this.keyCache.delete(tenantId);\n    } else {\n      this.keyCache.clear();\n    }\n  }\n\n  /**\n   * Get KMS client statistics\n   *\n   * @returns Current statistics\n   */\n  getStats(): KMSStats {\n    return { ...this.stats };\n  }\n\n  /**\n   * Reset statistics\n   */\n  resetStats(): void {\n    this.stats = {\n      totalOperations: 0,\n      successful: 0,\n      failed: 0,\n      cacheHits: 0,\n      cacheMisses: 0,\n      averageResponseTime: 0,\n    };\n  }\n\n  /**\n   * Test KMS connectivity and permissions\n   *\n   * @returns True if connection successful\n   */\n  async testConnection(): Promise<boolean> {\n    try {\n      await this.getKeyMetadata();\n      return true;\n    } catch (error) {\n      console.error('KMS connection test failed:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Cache a decrypted key\n   */\n  private cacheKey(tenantId: string, key: Buffer): void {\n    this.keyCache.set(tenantId, {\n      key: Buffer.from(key), // Clone the buffer\n      timestamp: Date.now(),\n    });\n  }\n\n  /**\n   * Get cached key if valid\n   */\n  private getCachedKey(tenantId: string): Buffer | null {\n    const cached = this.keyCache.get(tenantId);\n\n    if (!cached) {\n      return null;\n    }\n\n    // Check if cache entry is still valid\n    if (Date.now() - cached.timestamp > this.CACHE_TTL) {\n      this.keyCache.delete(tenantId);\n      return null;\n    }\n\n    return Buffer.from(cached.key); // Return a copy\n  }\n\n  /**\n   * Update average response time\n   */\n  private updateAverageResponseTime(responseTime: number): void {\n    const total = this.stats.averageResponseTime * (this.stats.successful - 1) + responseTime;\n    this.stats.averageResponseTime = total / this.stats.successful;\n  }\n\n  /**\n   * Handle KMS-specific errors\n   */\n  private handleKMSError(error: KMSServiceException, operation: string): KeyManagementError {\n    const errorMap: Record<string, { code: string; message: string }> = {\n      NotFoundException: {\n        code: 'KEY_NOT_FOUND',\n        message: 'KMS key not found',\n      },\n      DisabledException: {\n        code: 'KEY_DISABLED',\n        message: 'KMS key is disabled',\n      },\n      InvalidCiphertextException: {\n        code: 'INVALID_CIPHERTEXT',\n        message: 'Invalid ciphertext or encryption context',\n      },\n      AccessDeniedException: {\n        code: 'ACCESS_DENIED',\n        message: 'Access denied to KMS key',\n      },\n      InvalidGrantTokenException: {\n        code: 'INVALID_GRANT_TOKEN',\n        message: 'Invalid grant token',\n      },\n      KMSInternalException: {\n        code: 'KMS_INTERNAL_ERROR',\n        message: 'AWS KMS internal error',\n      },\n      KMSInvalidStateException: {\n        code: 'INVALID_KEY_STATE',\n        message: 'KMS key is in invalid state',\n      },\n    };\n\n    const mapped = errorMap[error.name] || {\n      code: 'KMS_ERROR',\n      message: 'AWS KMS operation failed',\n    };\n\n    return new KeyManagementError(\n      `${mapped.message}: ${error.message}`,\n      mapped.code,\n      {\n        operation,\n        awsError: error.name,\n        requestId: error.$metadata?.requestId,\n      }\n    );\n  }\n\n  /**\n   * Log KMS operation for audit trail\n   */\n  private logOperation(\n    operation: string,\n    tenantId: string,\n    success: boolean,\n    error?: unknown\n  ): void {\n    const logEntry = {\n      timestamp: new Date().toISOString(),\n      operation,\n      tenantId,\n      success,\n      error: error instanceof Error ? error.message : undefined,\n    };\n\n    // In production, send to proper logging service\n    if (process.env.NODE_ENV === 'development') {\n      console.log('[KMS Audit]', JSON.stringify(logEntry));\n    }\n\n    // TODO: Integrate with centralized logging service\n    // await logService.log('kms_operation', logEntry);\n  }\n\n  /**\n   * Destroy the client and clean up resources\n   */\n  destroy(): void {\n    this.clearCache();\n    this.client.destroy();\n  }\n}\n\n/**\n * Singleton KMS client instance\n */\nlet kmsClientInstance: KMSClient | null = null;\n\n/**\n * Get or create KMS client singleton\n *\n * @param config - Optional configuration\n * @returns KMS client instance\n */\nexport function getKMSClient(config?: Partial<KMSConfig>): KMSClient {\n  if (!kmsClientInstance) {\n    kmsClientInstance = new KMSClient(config);\n  }\n  return kmsClientInstance;\n}\n\n/**\n * Reset KMS client singleton (useful for testing)\n */\nexport function resetKMSClient(): void {\n  if (kmsClientInstance) {\n    kmsClientInstance.destroy();\n    kmsClientInstance = null;\n  }\n}\n\n/**\n * Export for testing\n */\nexport const __testing__ = {\n  KMSClient,\n  resetKMSClient,\n};\n"],"names":["KMSClient","__testing__","getKMSClient","resetKMSClient","config","CACHE_TTL","loadConfig","validateConfig","client","AWSKMSClient","region","credentials","accessKeyId","secretAccessKey","fromEnv","maxAttempts","maxRetries","requestHandler","requestTimeout","timeout","keyCache","Map","stats","totalOperations","successful","failed","cacheHits","cacheMisses","averageResponseTime","process","env","AWS_REGION","keyId","AWS_KMS_KEY_ID","AWS_ACCESS_KEY_ID","AWS_SECRET_ACCESS_KEY","KeyManagementError","hint","isValidKeyId","test","generateDataKey","tenantId","keySpec","startTime","Date","now","encryptionContext","TenantId","Purpose","Timestamp","toISOString","input","KeyId","KeySpec","EncryptionContext","command","GenerateDataKeyCommand","response","send","CiphertextBlob","Plaintext","result","ciphertext","Buffer","from","toString","plaintext","cacheKey","updateAverageResponseTime","logOperation","error","KMSServiceException","handleKMSError","originalError","Error","message","String","decryptDataKey","cached","getCachedKey","DecryptCommand","encrypt","EncryptCommand","getKeyMetadata","DescribeKeyCommand","KeyMetadata","arn","Arn","state","KeyState","createdAt","CreationDate","description","Description","rotationEnabled","KeyRotationEnabled","clearCache","delete","clear","getStats","resetStats","testConnection","console","key","set","timestamp","get","responseTime","total","operation","errorMap","NotFoundException","code","DisabledException","InvalidCiphertextException","AccessDeniedException","InvalidGrantTokenException","KMSInternalException","KMSInvalidStateException","mapped","name","awsError","requestId","$metadata","success","logEntry","undefined","NODE_ENV","log","JSON","stringify","destroy","kmsClientInstance"],"mappings":"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"}