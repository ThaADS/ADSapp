{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\integration\\encryption-flow.test.ts"],"sourcesContent":["/**\n * Integration Tests for Encryption Flow\n *\n * End-to-end tests for field-level encryption integrated with\n * the database, API routes, and business logic.\n *\n * @module tests/integration/encryption-flow\n */\n\nimport * as crypto from 'crypto';\nimport {\n  FieldEncryptor,\n  encryptContact,\n  decryptContact,\n  encryptProfile,\n  decryptProfile,\n} from '../../src/lib/crypto/field-encryptor';\nimport {\n  encryptBeforeWrite,\n  decryptAfterRead,\n  encryptRecords,\n  decryptRecords,\n  verifyDatabaseEncryption,\n} from '../../src/lib/crypto/db-helpers';\nimport { ENCRYPTED_FIELDS } from '../../src/lib/crypto/types';\n\ndescribe('Encryption Integration Flow', () => {\n  let encryptor: FieldEncryptor;\n\n  beforeAll(() => {\n    // Set up test encryption key\n    const testKey = crypto.randomBytes(32).toString('base64');\n    process.env.ENCRYPTION_KEY = testKey;\n\n    encryptor = new FieldEncryptor({ enableAuditLogging: true });\n  });\n\n  afterAll(() => {\n    // Clean up\n    delete process.env.ENCRYPTION_KEY;\n  });\n\n  describe('Field Encryptor', () => {\n    test('should encrypt a single field value', () => {\n      const plaintext = '+1234567890';\n      const encrypted = encryptor.encryptField(plaintext, 'phone_number');\n\n      expect(encrypted).not.toBeNull();\n      expect(encrypted).not.toBe(plaintext);\n      expect(typeof encrypted).toBe('string');\n    });\n\n    test('should decrypt a field value', () => {\n      const plaintext = 'user@example.com';\n      const encrypted = encryptor.encryptField(plaintext, 'email');\n      const decrypted = encryptor.decryptField(encrypted!, 'email');\n\n      expect(decrypted).toBe(plaintext);\n    });\n\n    test('should handle null values gracefully', () => {\n      const encrypted = encryptor.encryptField(null, 'phone_number');\n      expect(encrypted).toBeNull();\n\n      const decrypted = encryptor.decryptField(null, 'phone_number');\n      expect(decrypted).toBeNull();\n    });\n\n    test('should handle undefined values gracefully', () => {\n      const encrypted = encryptor.encryptField(undefined, 'email');\n      expect(encrypted).toBeNull();\n\n      const decrypted = encryptor.decryptField(undefined, 'email');\n      expect(decrypted).toBeNull();\n    });\n\n    test('should handle empty strings', () => {\n      const encrypted = encryptor.encryptField('', 'field');\n      expect(encrypted).toBeNull();\n\n      const decrypted = encryptor.decryptField('', 'field');\n      expect(decrypted).toBeNull();\n    });\n\n    test('should maintain audit logs', () => {\n      encryptor.clearAuditLogs();\n\n      encryptor.encryptField('test1', 'field1');\n      encryptor.decryptField('encrypted', 'field2');\n      encryptor.encryptField('test2', 'field3');\n\n      const logs = encryptor.getAuditLogs();\n      expect(logs.length).toBeGreaterThanOrEqual(2); // At least 2 successful operations\n    });\n  });\n\n  describe('Record Encryption', () => {\n    test('should encrypt contact record', () => {\n      const contact = {\n        id: '123',\n        phone_number: '+1234567890',\n        whatsapp_id: 'whatsapp:+1234567890',\n        name: 'John Doe',\n      };\n\n      const encrypted = encryptor.encryptContact(contact);\n\n      expect(encrypted.phone_number).not.toBe(contact.phone_number);\n      expect(encrypted.whatsapp_id).not.toBe(contact.whatsapp_id);\n      expect(encrypted.name).toBe(contact.name); // Not encrypted\n      expect(encrypted.id).toBe(contact.id); // Not encrypted\n    });\n\n    test('should decrypt contact record', () => {\n      const original = {\n        id: '456',\n        phone_number: '+9876543210',\n        whatsapp_id: 'whatsapp:+9876543210',\n        name: 'Jane Smith',\n      };\n\n      const encrypted = encryptor.encryptContact(original);\n      const decrypted = encryptor.decryptContact(encrypted);\n\n      expect(decrypted.phone_number).toBe(original.phone_number);\n      expect(decrypted.whatsapp_id).toBe(original.whatsapp_id);\n      expect(decrypted.name).toBe(original.name);\n      expect(decrypted.id).toBe(original.id);\n    });\n\n    test('should encrypt profile record', () => {\n      const profile = {\n        id: '789',\n        email: 'user@example.com',\n        full_name: 'Test User',\n        role: 'admin' as const,\n      };\n\n      const encrypted = encryptor.encryptProfile(profile);\n\n      expect(encrypted.email).not.toBe(profile.email);\n      expect(encrypted.full_name).toBe(profile.full_name); // Not encrypted\n      expect(encrypted.role).toBe(profile.role); // Not encrypted\n    });\n\n    test('should decrypt profile record', () => {\n      const original = {\n        id: '101',\n        email: 'admin@example.com',\n        full_name: 'Admin User',\n      };\n\n      const encrypted = encryptor.encryptProfile(original);\n      const decrypted = encryptor.decryptProfile(encrypted);\n\n      expect(decrypted.email).toBe(original.email);\n      expect(decrypted.full_name).toBe(original.full_name);\n    });\n\n    test('should handle records with null PII fields', () => {\n      const contact = {\n        id: '111',\n        phone_number: null,\n        whatsapp_id: null,\n        name: 'No Phone',\n      };\n\n      const encrypted = encryptor.encryptContact(contact);\n      expect(encrypted.phone_number).toBeNull();\n      expect(encrypted.whatsapp_id).toBeNull();\n\n      const decrypted = encryptor.decryptContact(encrypted);\n      expect(decrypted.phone_number).toBeNull();\n      expect(decrypted.whatsapp_id).toBeNull();\n    });\n  });\n\n  describe('Batch Operations', () => {\n    test('should batch encrypt multiple records', () => {\n      const requests = [\n        { id: '1', field: 'phone', value: '+1111111111' },\n        { id: '2', field: 'phone', value: '+2222222222' },\n        { id: '3', field: 'phone', value: '+3333333333' },\n      ];\n\n      const results = encryptor.batchEncrypt(requests);\n\n      expect(results).toHaveLength(3);\n      results.forEach((result, index) => {\n        expect(result.success).toBe(true);\n        expect(result.encrypted).not.toBeNull();\n        expect(result.encrypted).not.toBe(requests[index].value);\n      });\n    });\n\n    test('should batch decrypt multiple records', () => {\n      const originalValues = ['+1111111111', '+2222222222', '+3333333333'];\n      const encrypted = originalValues.map((value, index) => ({\n        id: String(index + 1),\n        field: 'phone',\n        value,\n      }));\n\n      const encryptedResults = encryptor.batchEncrypt(encrypted);\n\n      const decryptRequests = encryptedResults.map(result => ({\n        id: result.id,\n        field: result.field,\n        encrypted: result.encrypted!,\n      }));\n\n      const decryptedResults = encryptor.batchDecrypt(decryptRequests);\n\n      expect(decryptedResults).toHaveLength(3);\n      decryptedResults.forEach((result, index) => {\n        expect(result.success).toBe(true);\n        expect(result.decrypted).toBe(originalValues[index]);\n      });\n    });\n\n    test('should handle batch operations with failures gracefully', () => {\n      const requests = [\n        { id: '1', field: 'phone', value: '+1111111111' },\n        { id: '2', field: 'phone', value: null }, // Will succeed with null\n        { id: '3', field: 'phone', value: '+3333333333' },\n      ];\n\n      const results = encryptor.batchEncrypt(requests);\n\n      expect(results).toHaveLength(3);\n      expect(results[0].success).toBe(true);\n      expect(results[1].success).toBe(true);\n      expect(results[1].encrypted).toBeNull();\n      expect(results[2].success).toBe(true);\n    });\n  });\n\n  describe('Database Helpers', () => {\n    test('should encrypt before write for contacts', () => {\n      const contact = {\n        phone_number: '+1234567890',\n        whatsapp_id: 'whatsapp:+1234567890',\n        name: 'Test Contact',\n      };\n\n      const encrypted = encryptBeforeWrite('contacts', contact);\n\n      expect(encrypted.phone_number).not.toBe(contact.phone_number);\n      expect(encrypted.whatsapp_id).not.toBe(contact.whatsapp_id);\n      expect(encrypted.name).toBe(contact.name);\n    });\n\n    test('should decrypt after read for contacts', () => {\n      const original = {\n        phone_number: '+9876543210',\n        whatsapp_id: 'whatsapp:+9876543210',\n        name: 'Test Contact',\n      };\n\n      const encrypted = encryptBeforeWrite('contacts', original);\n      const decrypted = decryptAfterRead('contacts', encrypted);\n\n      expect(decrypted.phone_number).toBe(original.phone_number);\n      expect(decrypted.whatsapp_id).toBe(original.whatsapp_id);\n    });\n\n    test('should encrypt multiple records', () => {\n      const contacts = [\n        { phone_number: '+1111111111', whatsapp_id: 'wa:1' },\n        { phone_number: '+2222222222', whatsapp_id: 'wa:2' },\n      ];\n\n      const encrypted = encryptRecords('contacts', contacts);\n\n      expect(encrypted).toHaveLength(2);\n      encrypted.forEach((record, index) => {\n        expect(record.phone_number).not.toBe(contacts[index].phone_number);\n        expect(record.whatsapp_id).not.toBe(contacts[index].whatsapp_id);\n      });\n    });\n\n    test('should decrypt multiple records', () => {\n      const contacts = [\n        { phone_number: '+1111111111', whatsapp_id: 'wa:1' },\n        { phone_number: '+2222222222', whatsapp_id: 'wa:2' },\n      ];\n\n      const encrypted = encryptRecords('contacts', contacts);\n      const decrypted = decryptRecords('contacts', encrypted);\n\n      expect(decrypted).toHaveLength(2);\n      decrypted.forEach((record, index) => {\n        expect(record.phone_number).toBe(contacts[index].phone_number);\n        expect(record.whatsapp_id).toBe(contacts[index].whatsapp_id);\n      });\n    });\n  });\n\n  describe('Convenience Functions', () => {\n    test('should use encryptContact convenience function', () => {\n      const contact = {\n        phone_number: '+1234567890',\n        whatsapp_id: 'wa:123',\n      };\n\n      const encrypted = encryptContact(contact);\n\n      expect(encrypted.phone_number).not.toBe(contact.phone_number);\n      expect(encrypted.whatsapp_id).not.toBe(contact.whatsapp_id);\n    });\n\n    test('should use decryptContact convenience function', () => {\n      const original = {\n        phone_number: '+9876543210',\n        whatsapp_id: 'wa:987',\n      };\n\n      const encrypted = encryptContact(original);\n      const decrypted = decryptContact(encrypted);\n\n      expect(decrypted.phone_number).toBe(original.phone_number);\n      expect(decrypted.whatsapp_id).toBe(original.whatsapp_id);\n    });\n\n    test('should use encryptProfile convenience function', () => {\n      const profile = {\n        email: 'user@example.com',\n      };\n\n      const encrypted = encryptProfile(profile);\n\n      expect(encrypted.email).not.toBe(profile.email);\n    });\n\n    test('should use decryptProfile convenience function', () => {\n      const original = {\n        email: 'admin@example.com',\n      };\n\n      const encrypted = encryptProfile(original);\n      const decrypted = decryptProfile(encrypted);\n\n      expect(decrypted.email).toBe(original.email);\n    });\n  });\n\n  describe('Audit and Statistics', () => {\n    test('should track encryption statistics', () => {\n      const testEncryptor = new FieldEncryptor({ enableAuditLogging: true });\n      testEncryptor.clearAuditLogs();\n\n      // Perform various operations\n      testEncryptor.encryptField('value1', 'field1');\n      testEncryptor.encryptField('value2', 'field2');\n      testEncryptor.decryptField('encrypted', 'field3');\n\n      const stats = testEncryptor.getStatistics();\n\n      expect(stats.totalOperations).toBeGreaterThan(0);\n      expect(stats.successfulOperations).toBeGreaterThan(0);\n      expect(stats.successRate).toBeGreaterThan(0);\n      expect(stats.operationsByType).toBeDefined();\n    });\n\n    test('should filter audit logs', () => {\n      const testEncryptor = new FieldEncryptor({ enableAuditLogging: true });\n      testEncryptor.clearAuditLogs();\n\n      testEncryptor.encryptField('value1', 'phone');\n      testEncryptor.encryptField('value2', 'email');\n      testEncryptor.decryptField('encrypted', 'phone');\n\n      const phoneLogs = testEncryptor.getFilteredAuditLogs({\n        field: 'phone',\n      });\n\n      const emailLogs = testEncryptor.getFilteredAuditLogs({\n        field: 'email',\n      });\n\n      expect(phoneLogs.length).toBeGreaterThan(0);\n      expect(emailLogs.length).toBeGreaterThan(0);\n      phoneLogs.forEach(log => expect(log.field).toBe('phone'));\n      emailLogs.forEach(log => expect(log.field).toBe('email'));\n    });\n\n    test('should export audit logs as JSON', () => {\n      const testEncryptor = new FieldEncryptor({ enableAuditLogging: true });\n      testEncryptor.clearAuditLogs();\n\n      testEncryptor.encryptField('value', 'field');\n\n      const exported = testEncryptor.exportAuditLogs();\n\n      expect(typeof exported).toBe('string');\n      expect(() => JSON.parse(exported)).not.toThrow();\n\n      const parsed = JSON.parse(exported);\n      expect(Array.isArray(parsed)).toBe(true);\n    });\n  });\n\n  describe('System Verification', () => {\n    test('should verify encryption system is healthy', () => {\n      const verification = FieldEncryptor.verifyEncryption();\n\n      expect(verification.healthy).toBe(true);\n      expect(verification.status.keyLoaded).toBe(true);\n      expect(verification.status.testPassed).toBe(true);\n      expect(verification.message).toContain('operational');\n    });\n\n    test('should verify database encryption configuration', () => {\n      const verification = verifyDatabaseEncryption();\n\n      expect(verification.configured).toBe(true);\n      expect(verification.tablesConfigured).toContain('contacts');\n      expect(verification.tablesConfigured).toContain('profiles');\n      expect(verification.fieldsConfigured.contacts).toContain('phone_number');\n      expect(verification.fieldsConfigured.contacts).toContain('whatsapp_id');\n      expect(verification.fieldsConfigured.profiles).toContain('email');\n    });\n\n    test('should get encrypted fields for table', () => {\n      const contactFields = encryptor.getEncryptedFieldsForTable('contacts');\n      const profileFields = encryptor.getEncryptedFieldsForTable('profiles');\n\n      expect(contactFields).toContain('phone_number');\n      expect(contactFields).toContain('whatsapp_id');\n      expect(profileFields).toContain('email');\n    });\n\n    test('should check if field should be encrypted', () => {\n      expect(encryptor.shouldEncryptField('contacts', 'phone_number')).toBe(true);\n      expect(encryptor.shouldEncryptField('contacts', 'whatsapp_id')).toBe(true);\n      expect(encryptor.shouldEncryptField('contacts', 'name')).toBe(false);\n      expect(encryptor.shouldEncryptField('profiles', 'email')).toBe(true);\n      expect(encryptor.shouldEncryptField('profiles', 'full_name')).toBe(false);\n    });\n  });\n\n  describe('Error Recovery', () => {\n    test('should handle encryption errors gracefully', () => {\n      const testEncryptor = new FieldEncryptor({ enableAuditLogging: true });\n      testEncryptor.clearAuditLogs();\n\n      // Try to encrypt with invalid configuration (simulate error)\n      const originalKey = process.env.ENCRYPTION_KEY;\n      delete process.env.ENCRYPTION_KEY;\n\n      expect(() => {\n        testEncryptor.encryptField('value', 'field');\n      }).toThrow();\n\n      process.env.ENCRYPTION_KEY = originalKey;\n    });\n\n    test('should handle decryption errors gracefully', () => {\n      const testEncryptor = new FieldEncryptor({ enableAuditLogging: true });\n\n      expect(() => {\n        testEncryptor.decryptField('invalid-encrypted-data', 'field');\n      }).toThrow();\n    });\n\n    test('should log failed operations', () => {\n      const testEncryptor = new FieldEncryptor({ enableAuditLogging: true });\n      testEncryptor.clearAuditLogs();\n\n      const originalKey = process.env.ENCRYPTION_KEY;\n      delete process.env.ENCRYPTION_KEY;\n\n      try {\n        testEncryptor.encryptField('value', 'field');\n      } catch (error) {\n        // Expected to throw\n      }\n\n      process.env.ENCRYPTION_KEY = originalKey;\n\n      const logs = testEncryptor.getAuditLogs();\n      const failedLogs = logs.filter(log => !log.success);\n\n      expect(failedLogs.length).toBeGreaterThan(0);\n    });\n  });\n\n  describe('End-to-End Workflow', () => {\n    test('should complete full contact encryption workflow', () => {\n      // Step 1: Create plaintext contact\n      const contact = {\n        id: 'e2e-001',\n        organization_id: 'org-123',\n        phone_number: '+1234567890',\n        whatsapp_id: 'whatsapp:+1234567890',\n        name: 'End to End Test',\n        created_at: new Date().toISOString(),\n      };\n\n      // Step 2: Encrypt before database insert\n      const encrypted = encryptBeforeWrite('contacts', contact);\n      expect(encrypted.phone_number).not.toBe(contact.phone_number);\n      expect(encrypted.whatsapp_id).not.toBe(contact.whatsapp_id);\n\n      // Step 3: Simulate database storage (encrypted data)\n      // In real scenario, this would be stored in Supabase\n\n      // Step 4: Decrypt after database read\n      const decrypted = decryptAfterRead('contacts', encrypted);\n      expect(decrypted.phone_number).toBe(contact.phone_number);\n      expect(decrypted.whatsapp_id).toBe(contact.whatsapp_id);\n      expect(decrypted.name).toBe(contact.name);\n    });\n\n    test('should complete full profile encryption workflow', () => {\n      // Step 1: Create plaintext profile\n      const profile = {\n        id: 'e2e-002',\n        organization_id: 'org-123',\n        email: 'e2e@example.com',\n        full_name: 'E2E Test User',\n        role: 'agent' as const,\n      };\n\n      // Step 2: Encrypt before database insert\n      const encrypted = encryptBeforeWrite('profiles', profile);\n      expect(encrypted.email).not.toBe(profile.email);\n      expect(encrypted.full_name).toBe(profile.full_name);\n\n      // Step 3: Decrypt after database read\n      const decrypted = decryptAfterRead('profiles', encrypted);\n      expect(decrypted.email).toBe(profile.email);\n      expect(decrypted.full_name).toBe(profile.full_name);\n    });\n  });\n});\n"],"names":["describe","encryptor","beforeAll","testKey","crypto","randomBytes","toString","process","env","ENCRYPTION_KEY","FieldEncryptor","enableAuditLogging","afterAll","test","plaintext","encrypted","encryptField","expect","not","toBeNull","toBe","decrypted","decryptField","undefined","clearAuditLogs","logs","getAuditLogs","length","toBeGreaterThanOrEqual","contact","id","phone_number","whatsapp_id","name","encryptContact","original","decryptContact","profile","email","full_name","role","encryptProfile","decryptProfile","requests","field","value","results","batchEncrypt","toHaveLength","forEach","result","index","success","originalValues","map","String","encryptedResults","decryptRequests","decryptedResults","batchDecrypt","encryptBeforeWrite","decryptAfterRead","contacts","encryptRecords","record","decryptRecords","testEncryptor","stats","getStatistics","totalOperations","toBeGreaterThan","successfulOperations","successRate","operationsByType","toBeDefined","phoneLogs","getFilteredAuditLogs","emailLogs","log","exported","exportAuditLogs","JSON","parse","toThrow","parsed","Array","isArray","verification","verifyEncryption","healthy","status","keyLoaded","testPassed","message","toContain","verifyDatabaseEncryption","configured","tablesConfigured","fieldsConfigured","profiles","contactFields","getEncryptedFieldsForTable","profileFields","shouldEncryptField","originalKey","error","failedLogs","filter","organization_id","created_at","Date","toISOString"],"mappings":"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"}