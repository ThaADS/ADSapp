{"version":3,"names":["WhatsAppService","cov_1eh1rjxbsk","f","s","WhatsAppTemplates","validateWebhookSignature","constructor","accessToken","phoneNumberId","whatsapp","_client","WhatsAppClient","createFromOrganization","organizationId","supabase","_server","createClient","data","organization","from","select","eq","single","whatsapp_phone_number_id","b","Error","process","env","WHATSAPP_ACCESS_TOKEN","sendMessage","conversationId","content","senderId","messageType","conversation","whatsappResponse","sendTextMessage","contact","whatsapp_id","templateData","JSON","parse","sendTemplateMessage","name","language","components","imageData","sendImageMessage","url","caption","docData","sendDocumentMessage","filename","error","console","message","insert","conversation_id","whatsapp_message_id","messages","id","sender_type","sender_id","message_type","update","last_message_at","Date","toISOString","markMessageAsRead","messageId","markAsRead","is_read","read_at","downloadMedia","mediaId","mediaInfo","getMedia","mediaResponse","body","mimeType","mime_type","welcomeMessage","customerName","type","parameters","text","businessHoursMessage","awayMessage","agentName","payload","signature","appSecret","WHATSAPP_APP_SECRET","warn","expectedSignature","_crypto","default","createHmac","digest","timingSafeEqual","Buffer"],"sources":["C:\\Ai Projecten\\ADSapp\\src\\lib\\whatsapp\\service.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/server'\nimport { WhatsAppClient } from './client'\nimport crypto from 'crypto'\n\nexport class WhatsAppService {\n  private whatsapp: WhatsAppClient\n\n  constructor(accessToken: string, phoneNumberId: string) {\n    this.whatsapp = new WhatsAppClient(accessToken, phoneNumberId)\n  }\n\n  static async createFromOrganization(organizationId: string) {\n    const supabase = await createClient()\n\n    const { data: organization } = await supabase\n      .from('organizations')\n      .select('*')\n      .eq('id', organizationId)\n      .single()\n\n    if (!organization?.whatsapp_phone_number_id) {\n      throw new Error('WhatsApp not configured for this organization')\n    }\n\n    const accessToken = process.env.WHATSAPP_ACCESS_TOKEN\n    if (!accessToken) {\n      throw new Error('WhatsApp access token not configured')\n    }\n\n    return new WhatsAppService(accessToken, organization.whatsapp_phone_number_id)\n  }\n\n  async sendMessage(\n    conversationId: string,\n    content: string,\n    senderId: string,\n    messageType: 'text' | 'template' | 'image' | 'document' = 'text'\n  ) {\n    const supabase = await createClient()\n\n    // Get conversation and contact details\n    const { data: conversation } = await supabase\n      .from('conversations')\n      .select('*, contact:contacts(*)')\n      .eq('id', conversationId)\n      .single()\n\n    if (!conversation) {\n      throw new Error('Conversation not found')\n    }\n\n    let whatsappResponse\n    try {\n      // Send message via WhatsApp API\n      switch (messageType) {\n        case 'text':\n          whatsappResponse = await this.whatsapp.sendTextMessage(\n            conversation.contact.whatsapp_id,\n            content\n          )\n          break\n        case 'template':\n          // For template messages, content should include template details\n          const templateData = JSON.parse(content)\n          whatsappResponse = await this.whatsapp.sendTemplateMessage(\n            conversation.contact.whatsapp_id,\n            templateData.name,\n            templateData.language || 'en',\n            templateData.components || []\n          )\n          break\n        case 'image':\n          const imageData = JSON.parse(content)\n          whatsappResponse = await this.whatsapp.sendImageMessage(\n            conversation.contact.whatsapp_id,\n            imageData.url,\n            imageData.caption\n          )\n          break\n        case 'document':\n          const docData = JSON.parse(content)\n          whatsappResponse = await this.whatsapp.sendDocumentMessage(\n            conversation.contact.whatsapp_id,\n            docData.url,\n            docData.filename,\n            docData.caption\n          )\n          break\n        default:\n          throw new Error(`Unsupported message type: ${messageType}`)\n      }\n    } catch (error) {\n      console.error('WhatsApp API Error:', error)\n      throw new Error('Failed to send WhatsApp message')\n    }\n\n    // Store message in database\n    const { data: message, error } = await supabase\n      .from('messages')\n      .insert({\n        conversation_id: conversationId,\n        whatsapp_message_id: whatsappResponse.messages?.[0]?.id,\n        sender_type: 'agent',\n        sender_id: senderId,\n        content: messageType === 'text' ? content : `[${messageType}] ${content}`,\n        message_type: messageType,\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Database error:', error)\n      throw new Error('Failed to store message')\n    }\n\n    // Update conversation last_message_at\n    await supabase\n      .from('conversations')\n      .update({\n        last_message_at: new Date().toISOString(),\n      })\n      .eq('id', conversationId)\n\n    return message\n  }\n\n  async markMessageAsRead(messageId: string) {\n    const supabase = await createClient()\n\n    // Get message details\n    const { data: message } = await supabase\n      .from('messages')\n      .select('*')\n      .eq('id', messageId)\n      .single()\n\n    if (!message?.whatsapp_message_id) {\n      throw new Error('Message not found or missing WhatsApp ID')\n    }\n\n    try {\n      await this.whatsapp.markAsRead(message.whatsapp_message_id)\n\n      // Update database\n      await supabase\n        .from('messages')\n        .update({\n          is_read: true,\n          read_at: new Date().toISOString(),\n        })\n        .eq('id', messageId)\n    } catch (error) {\n      console.error('Failed to mark message as read:', error)\n      throw error\n    }\n  }\n\n  async downloadMedia(mediaId: string) {\n    try {\n      // Get media URL from WhatsApp API\n      const mediaInfo = await this.whatsapp.getMedia(mediaId)\n\n      // Download the actual media file\n      const mediaResponse = await this.whatsapp.downloadMedia(mediaInfo.url)\n\n      return {\n        data: mediaResponse.body,\n        mimeType: mediaInfo.mime_type,\n        filename: `media_${mediaId}`,\n      }\n    } catch (error) {\n      console.error('Failed to download media:', error)\n      throw error\n    }\n  }\n}\n\n// Utility functions for WhatsApp message templates\nexport class WhatsAppTemplates {\n  static welcomeMessage(customerName?: string) {\n    return {\n      name: 'welcome_message',\n      language: 'en',\n      components: [\n        {\n          type: 'body',\n          parameters: [\n            {\n              type: 'text',\n              text: customerName || 'Customer'\n            }\n          ]\n        }\n      ]\n    }\n  }\n\n  static businessHoursMessage() {\n    return {\n      name: 'business_hours',\n      language: 'en',\n      components: []\n    }\n  }\n\n  static awayMessage(agentName?: string) {\n    return {\n      name: 'agent_away',\n      language: 'en',\n      components: [\n        {\n          type: 'body',\n          parameters: [\n            {\n              type: 'text',\n              text: agentName || 'Support Team'\n            }\n          ]\n        }\n      ]\n    }\n  }\n}\n\n// WhatsApp Business API webhook validation\nexport function validateWebhookSignature(payload: string, signature: string): boolean {\n  // crypto is now imported at the top\n  const appSecret = process.env.WHATSAPP_APP_SECRET\n\n  if (!appSecret) {\n    console.warn('WhatsApp app secret not configured')\n    return true // Skip validation in development\n  }\n\n  const expectedSignature = crypto\n    .createHmac('sha256', appSecret)\n    .update(payload)\n    .digest('hex')\n\n  return crypto.timingSafeEqual(\n    Buffer.from(signature),\n    Buffer.from(`sha256=${expectedSignature}`)\n  )\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}