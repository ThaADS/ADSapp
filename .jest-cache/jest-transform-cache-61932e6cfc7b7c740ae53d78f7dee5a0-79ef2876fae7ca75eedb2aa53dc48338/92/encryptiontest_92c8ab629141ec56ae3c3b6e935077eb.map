{"version":3,"sources":["C:\\Ai Projecten\\ADSapp\\tests\\unit\\lib\\security\\encryption.test.ts"],"sourcesContent":["/**\n * Encryption Unit Tests\n *\n * Tests AES-256-GCM encryption/decryption, data integrity,\n * key derivation, and tenant-specific encryption contexts.\n */\n\nimport * as crypto from 'crypto';\nimport {\n  encrypt,\n  decrypt,\n  validateEncryptedData,\n  encryptBatch,\n  decryptBatch,\n  reEncrypt,\n  testEncryption,\n  getEncryptionStatus,\n  __testing__,\n} from '@/lib/crypto/encryption';\nimport { ENCRYPTION_CONSTANTS } from '@/lib/crypto/types';\n\ndescribe('Encryption - AES-256-GCM', () => {\n  // Set test encryption key\n  const TEST_KEY = crypto.randomBytes(ENCRYPTION_CONSTANTS.KEY_SIZE);\n  const TEST_KEY_BASE64 = TEST_KEY.toString('base64');\n\n  beforeEach(() => {\n    // Set test environment variable\n    process.env.ENCRYPTION_KEY = TEST_KEY_BASE64;\n  });\n\n  afterEach(() => {\n    // Clean up environment\n    delete process.env.ENCRYPTION_KEY;\n    jest.clearAllMocks();\n  });\n\n  describe('Encryption Operations', () => {\n    it('should encrypt plaintext with AES-256-GCM successfully', () => {\n      // Arrange\n      const plaintext = '+1234567890'; // Sensitive phone number\n\n      // Act\n      const result = encrypt(plaintext);\n\n      // Assert\n      expect(result).toBeDefined();\n      expect(result.encrypted).toBeDefined();\n      expect(typeof result.encrypted).toBe('string');\n      expect(result.version).toBe(ENCRYPTION_CONSTANTS.CURRENT_VERSION);\n      expect(result.algorithm).toBe(ENCRYPTION_CONSTANTS.ALGORITHM);\n      expect(result.iv).toBeDefined();\n      expect(result.authTag).toBeDefined();\n\n      // Verify encrypted data is different from plaintext\n      expect(result.encrypted).not.toContain(plaintext);\n\n      // Verify encrypted data is valid base64\n      expect(() => Buffer.from(result.encrypted, 'base64')).not.toThrow();\n    });\n\n    it('should decrypt encrypted data back to original plaintext', () => {\n      // Arrange\n      const plaintext = 'sensitive-email@example.com';\n\n      // Act\n      const encrypted = encrypt(plaintext);\n      const decrypted = decrypt(encrypted.encrypted, encrypted.version);\n\n      // Assert\n      expect(decrypted.plaintext).toBe(plaintext);\n      expect(decrypted.version).toBe(encrypted.version);\n      expect(decrypted.algorithm).toBe(encrypted.algorithm);\n    });\n\n    it('should fail authentication with corrupted ciphertext', () => {\n      // Arrange\n      const plaintext = 'secret-data';\n      const encrypted = encrypt(plaintext);\n\n      // Corrupt the encrypted data (flip a bit in the middle)\n      const buffer = Buffer.from(encrypted.encrypted, 'base64');\n      buffer[Math.floor(buffer.length / 2)] ^= 0xff;\n      const corruptedData = buffer.toString('base64');\n\n      // Act & Assert\n      // Corrupting ciphertext causes auth tag verification to fail\n      expect(() => {\n        decrypt(corruptedData, encrypted.version);\n      }).toThrow(/authentication|verification|failed|corrupted/i);\n    });\n  });\n\n  describe('Data Integrity & Authentication', () => {\n    it('should detect tampered authentication tag', () => {\n      // Arrange\n      const plaintext = 'critical-financial-data';\n      const encrypted = encrypt(plaintext);\n\n      // Extract components\n      const buffer = Buffer.from(encrypted.encrypted, 'base64');\n      const ivLength = ENCRYPTION_CONSTANTS.IV_SIZE;\n      const authTagLength = ENCRYPTION_CONSTANTS.AUTH_TAG_SIZE;\n\n      // Tamper with the authentication tag\n      const authTagStart = buffer.length - authTagLength;\n      buffer[authTagStart] ^= 0xff;\n      const tamperedData = buffer.toString('base64');\n\n      // Act & Assert\n      // Tampering with auth tag causes decryption to fail\n      expect(() => {\n        decrypt(tamperedData, encrypted.version);\n      }).toThrow(/failed/i);\n    });\n\n    it('should validate encrypted data structure correctly', () => {\n      // Arrange\n      const plaintext = 'test-data';\n      const encrypted = encrypt(plaintext);\n\n      // Act\n      const validationResult = validateEncryptedData(encrypted.encrypted, encrypted.version);\n\n      // Assert\n      expect(validationResult.valid).toBe(true);\n      expect(validationResult.details?.hasVersion).toBe(true);\n      expect(validationResult.details?.hasEncrypted).toBe(true);\n      expect(validationResult.details?.isBase64).toBe(true);\n      expect(validationResult.details?.hasValidStructure).toBe(true);\n      expect(validationResult.error).toBeUndefined();\n    });\n\n    it('should detect invalid encrypted data structure', () => {\n      // Act\n      const result1 = validateEncryptedData('', 'v1');\n      const result2 = validateEncryptedData('invalid-base64!@#$', 'v1');\n      const result3 = validateEncryptedData('abc', 'v1'); // Too short\n\n      // Assert\n      expect(result1.valid).toBe(false);\n      expect(result1.error).toContain('empty');\n\n      expect(result2.valid).toBe(false);\n      // Invalid base64 characters still decode, but the result may be too short\n      expect(result2.error).toBeDefined();\n\n      expect(result3.valid).toBe(false);\n      expect(result3.error).toContain('too short');\n    });\n  });\n\n  describe('Batch Operations', () => {\n    it('should encrypt multiple values in batch', () => {\n      // Arrange\n      const plaintexts = [\n        'user1@example.com',\n        '+1234567890',\n        'Social Security Number: 123-45-6789',\n        'Credit Card: 4532-1234-5678-9010',\n      ];\n\n      // Act\n      const results = encryptBatch(plaintexts);\n\n      // Assert\n      expect(results).toHaveLength(plaintexts.length);\n      results.forEach((result, index) => {\n        expect(result.encrypted).toBeDefined();\n        expect(result.encrypted).not.toContain(plaintexts[index]);\n        expect(result.version).toBe(ENCRYPTION_CONSTANTS.CURRENT_VERSION);\n\n        // Verify each can be decrypted\n        const decrypted = decrypt(result.encrypted, result.version);\n        expect(decrypted.plaintext).toBe(plaintexts[index]);\n      });\n    });\n\n    it('should decrypt multiple values in batch', () => {\n      // Arrange\n      const plaintexts = ['value1', 'value2', 'value3'];\n      const encrypted = encryptBatch(plaintexts);\n      const encryptedValues = encrypted.map((e) => ({\n        data: e.encrypted,\n        version: e.version,\n      }));\n\n      // Act\n      const decrypted = decryptBatch(encryptedValues);\n\n      // Assert\n      expect(decrypted).toHaveLength(plaintexts.length);\n      decrypted.forEach((result, index) => {\n        expect(result.plaintext).toBe(plaintexts[index]);\n      });\n    });\n  });\n\n  describe('Key Rotation', () => {\n    it('should re-encrypt data with new key version', () => {\n      // Arrange\n      const plaintext = 'data-to-rotate';\n      const currentVersion = 'v1';\n      const newVersion = 'v2';\n\n      // Encrypt with current key\n      const encrypted = encrypt(plaintext, { version: currentVersion });\n\n      // Create new key for v2\n      const newKey = crypto.randomBytes(ENCRYPTION_CONSTANTS.KEY_SIZE);\n\n      // Act\n      const reEncrypted = reEncrypt(\n        encrypted.encrypted,\n        currentVersion,\n        newVersion,\n        { key: TEST_KEY, version: currentVersion },\n        { key: newKey, version: newVersion }\n      );\n\n      // Assert\n      expect(reEncrypted.version).toBe(newVersion);\n      expect(reEncrypted.encrypted).not.toBe(encrypted.encrypted);\n\n      // Verify decryption with new key works\n      const decrypted = decrypt(reEncrypted.encrypted, newVersion, { key: newKey });\n      expect(decrypted.plaintext).toBe(plaintext);\n    });\n  });\n\n  describe('Encryption System Status', () => {\n    it('should report encryption system as operational', () => {\n      // Act\n      const status = getEncryptionStatus();\n\n      // Assert\n      expect(status.keyLoaded).toBe(true);\n      expect(status.version).toBe(ENCRYPTION_CONSTANTS.CURRENT_VERSION);\n      expect(status.algorithm).toBe(ENCRYPTION_CONSTANTS.ALGORITHM);\n      expect(status.testPassed).toBe(true);\n    });\n\n    it('should pass round-trip encryption test', () => {\n      // Arrange\n      const testData = 'test-round-trip-data-12345';\n\n      // Act\n      const testResult = testEncryption(testData);\n\n      // Assert\n      expect(testResult).toBe(true);\n    });\n  });\n});\n"],"names":["describe","TEST_KEY","crypto","randomBytes","ENCRYPTION_CONSTANTS","KEY_SIZE","TEST_KEY_BASE64","toString","beforeEach","process","env","ENCRYPTION_KEY","afterEach","jest","clearAllMocks","it","plaintext","result","encrypt","expect","toBeDefined","encrypted","toBe","version","CURRENT_VERSION","algorithm","ALGORITHM","iv","authTag","not","toContain","Buffer","from","toThrow","decrypted","decrypt","buffer","Math","floor","length","corruptedData","ivLength","IV_SIZE","authTagLength","AUTH_TAG_SIZE","authTagStart","tamperedData","validationResult","validateEncryptedData","valid","details","hasVersion","hasEncrypted","isBase64","hasValidStructure","error","toBeUndefined","result1","result2","result3","plaintexts","results","encryptBatch","toHaveLength","forEach","index","encryptedValues","map","e","data","decryptBatch","currentVersion","newVersion","newKey","reEncrypted","reEncrypt","key","status","getEncryptionStatus","keyLoaded","testPassed","testData","testResult","testEncryption"],"mappings":"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"}