---
phase: 08-foundation-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260124_channel_abstraction.sql
  - src/types/channels.ts
autonomous: true

must_haves:
  truths:
    - "channel_connections, channel_messages, channel_adapters_config tables exist in database"
    - "RLS policies prevent cross-tenant access to all new tables"
    - "CanonicalMessage and ChannelAdapter TypeScript interfaces are defined"
  artifacts:
    - path: "supabase/migrations/20260124_channel_abstraction.sql"
      provides: "Database schema for multi-channel messaging"
      contains: "CREATE TABLE channel_connections"
    - path: "src/types/channels.ts"
      provides: "TypeScript types for channel abstraction"
      exports: ["CanonicalMessage", "ChannelAdapter", "ChannelType", "SendResult"]
  key_links:
    - from: "channel_connections"
      to: "contacts"
      via: "foreign key contact_id"
    - from: "channel_messages"
      to: "conversations"
      via: "foreign key conversation_id"
---

<objective>
Create database schema and TypeScript type definitions for the channel abstraction layer.

Purpose: Establish the data foundation that all future channel adapters depend on. This enables multi-channel message storage with proper RLS isolation per organization.

Output:
- Migration file creating 3 new tables with RLS policies
- TypeScript types defining CanonicalMessage format and ChannelAdapter interface
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-foundation-layer/08-RESEARCH.md

Key schema from research (Section 5):
- channel_connections: Links contacts to their channel identifiers
- channel_messages: Stores messages with canonical format + channel metadata
- channel_adapters_config: Stores channel credentials per organization

Key types from research (Section 4.2):
- CanonicalMessage: Channel-agnostic message format
- ChannelAdapter: Interface for all channel implementations
- ChannelType, ChannelFeature enums
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for channel abstraction tables</name>
  <files>supabase/migrations/20260124_channel_abstraction.sql</files>
  <action>
Create a SQL migration file with the following tables from the research document Section 5.1:

1. **channel_connections table**:
   - id UUID PRIMARY KEY
   - organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE
   - contact_id UUID NOT NULL REFERENCES contacts(id) ON DELETE CASCADE
   - channel_type TEXT NOT NULL CHECK IN ('whatsapp', 'instagram', 'facebook', 'sms')
   - channel_identifier TEXT NOT NULL
   - display_name TEXT, avatar_url TEXT, is_primary BOOLEAN DEFAULT false, is_active BOOLEAN DEFAULT true
   - channel_metadata JSONB DEFAULT '{}'
   - verified_at TIMESTAMPTZ, last_message_at TIMESTAMPTZ, message_count INTEGER DEFAULT 0
   - created_at, updated_at TIMESTAMPTZ
   - UNIQUE(organization_id, channel_type, channel_identifier)

2. **channel_messages table**:
   - id UUID PRIMARY KEY
   - organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE
   - conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE
   - channel_connection_id UUID NOT NULL REFERENCES channel_connections(id) ON DELETE CASCADE
   - channel_message_id TEXT NOT NULL
   - direction TEXT NOT NULL CHECK IN ('inbound', 'outbound')
   - sender_type TEXT NOT NULL CHECK IN ('contact', 'agent', 'system')
   - sender_id UUID REFERENCES profiles(id) ON DELETE SET NULL
   - content_type TEXT NOT NULL CHECK IN ('text', 'media', 'rich', 'system')
   - content TEXT NOT NULL
   - media JSONB, rich_content JSONB
   - reply_to_message_id UUID REFERENCES channel_messages(id) ON DELETE SET NULL
   - status TEXT NOT NULL DEFAULT 'sent' CHECK IN ('pending', 'sent', 'delivered', 'read', 'failed')
   - delivered_at, read_at TIMESTAMPTZ
   - failed_reason TEXT, error_code TEXT, error_message TEXT, retry_count INTEGER DEFAULT 0
   - channel_metadata JSONB DEFAULT '{}'
   - created_at, updated_at TIMESTAMPTZ

3. **channel_adapters_config table**:
   - id UUID PRIMARY KEY
   - organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE
   - channel_type TEXT NOT NULL CHECK IN ('whatsapp', 'instagram', 'facebook', 'sms')
   - access_token_encrypted TEXT, refresh_token_encrypted TEXT
   - phone_number_id TEXT, business_account_id TEXT, page_id TEXT, webhook_verify_token TEXT
   - config JSONB DEFAULT '{}'
   - is_active BOOLEAN DEFAULT true, last_sync_at TIMESTAMPTZ
   - sync_status TEXT CHECK IN ('active', 'error', 'disconnected'), sync_error TEXT
   - features JSONB DEFAULT '[]'
   - created_at, updated_at TIMESTAMPTZ
   - UNIQUE(organization_id, channel_type)

4. **Add indexes** for:
   - org_contact lookups on channel_connections
   - conversation lookups on channel_messages
   - channel_message_id lookups
   - status filtering for pending/failed messages

5. **Enable RLS** on all tables with tenant isolation policies using:
   - current_setting('app.current_organization_id', true)::uuid
   - Both USING and WITH CHECK clauses

6. **Add updated_at triggers** using the existing update_updated_at_column() function.

Wrap the entire migration in a BEGIN/COMMIT transaction.
  </action>
  <verify>
Run: `npm run migration:apply` or if local, verify file exists and has valid SQL syntax.
Check: Tables have RLS enabled with USING and WITH CHECK clauses.
  </verify>
  <done>
Migration file exists with channel_connections, channel_messages, channel_adapters_config tables, all indexes, RLS policies, and triggers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for channel abstraction</name>
  <files>src/types/channels.ts</files>
  <action>
Create a new TypeScript file defining channel abstraction types based on research Section 4.2 and Section 2.3:

1. **ChannelType enum**:
   ```typescript
   export enum ChannelType {
     WHATSAPP = 'whatsapp',
     INSTAGRAM = 'instagram',
     FACEBOOK = 'facebook',
     SMS = 'sms'
   }
   ```

2. **ChannelFeature enum**:
   - RICH_CONTENT, MEDIA, READ_RECEIPTS, TYPING_INDICATORS
   - LOCATION_SHARING, CONTACT_CARDS, REACTIONS

3. **CanonicalMessage interface** (from research Section 2.3):
   - id: string, conversationId: string
   - channelType: ChannelType, channelMessageId: string
   - direction: 'inbound' | 'outbound'
   - senderType: 'contact' | 'agent' | 'system', senderId?: string
   - contentType: 'text' | 'media' | 'rich' | 'system', content: string
   - media?: MediaContent, richContent?: RichContent
   - replyToMessageId?: string
   - status: MessageStatus, deliveredAt?: Date, readAt?: Date
   - channelMetadata: Record<string, unknown>
   - timestamp: Date, createdAt: Date, updatedAt: Date

4. **MediaContent interface**:
   - type: 'image' | 'video' | 'audio' | 'document'
   - url: string, mimeType: string
   - filename?: string, thumbnailUrl?: string, size?: number

5. **RichContent interface**:
   - type: 'button' | 'list' | 'location' | 'contact'
   - payload: Record<string, unknown>

6. **SendResult interface**:
   - success: boolean, channelMessageId?: string
   - error?: string, retryable?: boolean

7. **MessageStatus type**: 'pending' | 'sent' | 'delivered' | 'read' | 'failed'

8. **ValidationResult interface**:
   - valid: boolean, errors: string[]

9. **HealthStatus interface**:
   - isHealthy: boolean, latency?: number
   - rateLimit?: { remaining: number, resetAt: Date }
   - lastError?: string

10. **ChannelAdapter interface**:
    - readonly channelType: ChannelType
    - readonly name: string
    - send(message: CanonicalMessage): Promise<SendResult>
    - receive(webhookPayload: unknown): Promise<CanonicalMessage>
    - getStatus(channelMessageId: string): Promise<MessageStatus>
    - supportsFeature(feature: ChannelFeature): boolean
    - getFeatures(): ChannelFeature[]
    - validateMessage(message: CanonicalMessage): ValidationResult
    - healthCheck(): Promise<HealthStatus>

11. **ChannelConnection, ChannelMessage, ChannelAdapterConfig** database row types matching the SQL schema.

Export all types.
  </action>
  <verify>
Run: `npm run type-check`
All types should compile without errors.
  </verify>
  <done>
src/types/channels.ts exists with all interfaces exported and compiles without TypeScript errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Migration file exists at supabase/migrations/20260124_channel_abstraction.sql
2. Types file exists at src/types/channels.ts
3. `npm run type-check` passes
4. Migration can be applied (syntax valid)
</verification>

<success_criteria>
- Database migration file creates 3 tables with RLS
- TypeScript types define CanonicalMessage and ChannelAdapter
- All RLS policies use organization_id for tenant isolation
- Types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-foundation-layer/08-01-SUMMARY.md`
</output>
