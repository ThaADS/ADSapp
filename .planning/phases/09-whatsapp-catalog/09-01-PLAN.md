---
phase: 09-whatsapp-catalog
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260124_whatsapp_catalog.sql
  - src/types/whatsapp-catalog.ts
autonomous: true

must_haves:
  truths:
    - "whatsapp_catalogs table exists with RLS enforcing organization isolation"
    - "whatsapp_products table stores cached product data with full-text search index"
    - "whatsapp_product_messages table tracks sent product messages"
  artifacts:
    - path: "supabase/migrations/20260124_whatsapp_catalog.sql"
      provides: "Database schema for catalog feature"
    - path: "src/types/whatsapp-catalog.ts"
      provides: "TypeScript types for catalog entities"
      exports: ["WhatsAppCatalog", "WhatsAppProduct", "WhatsAppProductMessage", "ProductSection"]
---

<objective>
Create database schema and TypeScript types for WhatsApp catalog feature.

Purpose: Establish the data layer for storing catalog configuration, cached products, and product message tracking with proper RLS policies.

Output:
- Migration with 3 tables: whatsapp_catalogs, whatsapp_products, whatsapp_product_messages
- RLS policies for organization isolation
- TypeScript types for all catalog entities
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/09-whatsapp-catalog/09-RESEARCH.md (Part 3: Database Schema Design)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration</name>
  <files>supabase/migrations/20260124_whatsapp_catalog.sql</files>
  <action>
Create migration file with:

1. **whatsapp_catalogs table** - Catalog config per organization:
   - id, organization_id, catalog_id, catalog_name
   - Sync status: last_sync_at, sync_status (pending/syncing/success/error), sync_error, product_count
   - Settings: is_enabled, auto_sync_enabled, auto_sync_interval_hours
   - UNIQUE(organization_id) - one catalog per org

2. **whatsapp_products table** - Cached products:
   - id, organization_id, catalog_id (FK)
   - Product data: meta_product_id, retailer_id (SKU), name, description
   - Pricing: price_amount (cents), price_currency
   - Media: image_url, product_url
   - Metadata: availability, brand, category, raw_data (JSONB)
   - UNIQUE(catalog_id, retailer_id)

3. **whatsapp_product_messages table** - Message tracking:
   - id, organization_id, conversation_id, message_id
   - message_type (single/multi/catalog)
   - product_ids (UUID[]), retailer_ids (TEXT[])
   - Message content: catalog_id, header_text, body_text, footer_text, sections (JSONB)
   - Tracking: sent_at, delivered_at, read_at
   - Cart: cart_received, cart_received_at, cart_data (JSONB)

4. **RLS Policies** using organization_id check pattern:
   - Users can SELECT their organization's data
   - Admins/owners can manage catalogs and products

5. **Indexes**:
   - organization_id on all tables
   - catalog_id on products
   - retailer_id on products
   - Full-text search on products (name, description)
   - sent_at DESC on product_messages
  </action>
  <verify>
Run: `npm run type-check` after types are created
  </verify>
  <done>
supabase/migrations/20260124_whatsapp_catalog.sql exists with all 3 tables and RLS policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types</name>
  <files>src/types/whatsapp-catalog.ts</files>
  <action>
Create TypeScript types matching the database schema:

```typescript
// Catalog sync status
export type CatalogSyncStatus = 'pending' | 'syncing' | 'success' | 'error'

// Product availability
export type ProductAvailability = 'in stock' | 'out of stock' | 'preorder' | 'available for order'

// Product message type
export type ProductMessageType = 'single' | 'multi' | 'catalog'

// Catalog configuration
export interface WhatsAppCatalog {
  id: string
  organization_id: string
  catalog_id: string
  catalog_name: string | null
  last_sync_at: string | null
  sync_status: CatalogSyncStatus
  sync_error: string | null
  product_count: number
  is_enabled: boolean
  auto_sync_enabled: boolean
  auto_sync_interval_hours: number
  created_at: string
  updated_at: string
}

// Cached product
export interface WhatsAppProduct {
  id: string
  organization_id: string
  catalog_id: string
  meta_product_id: string
  retailer_id: string  // SKU used in messages
  name: string
  description: string | null
  price_amount: number | null  // In smallest currency unit (cents)
  price_currency: string
  availability: ProductAvailability
  image_url: string | null
  product_url: string | null
  brand: string | null
  category: string | null
  raw_data: Record<string, unknown> | null
  is_active: boolean
  synced_at: string
  created_at: string
  updated_at: string
}

// Product message tracking
export interface WhatsAppProductMessage {
  id: string
  organization_id: string
  conversation_id: string
  message_id: string | null
  message_type: ProductMessageType
  product_ids: string[]
  retailer_ids: string[]
  catalog_id: string
  header_text: string | null
  body_text: string | null
  footer_text: string | null
  sections: ProductSection[] | null
  sent_at: string
  delivered_at: string | null
  read_at: string | null
  cart_received: boolean
  cart_received_at: string | null
  cart_data: CartData | null
  created_at: string
}

// Section for multi-product messages
export interface ProductSection {
  title: string
  product_items: { product_retailer_id: string }[]
}

// Cart data from customer order
export interface CartData {
  catalog_id: string
  product_items: CartItem[]
  text?: string
}

export interface CartItem {
  product_retailer_id: string
  quantity: number
  item_price: number
  currency: string
}

// API request/response types
export interface CatalogConfigRequest {
  catalog_id: string
  catalog_name?: string
}

export interface CatalogSyncResponse {
  success: boolean
  products_synced: number
  errors?: string[]
}

export interface ProductsListResponse {
  products: WhatsAppProduct[]
  total: number
  hasMore: boolean
}

export interface SendProductMessageRequest {
  conversation_id: string
  product_retailer_id: string
  body_text?: string
  footer_text?: string
}

export interface SendProductListMessageRequest {
  conversation_id: string
  header_text: string
  body_text: string
  footer_text?: string
  sections: {
    title: string
    product_retailer_ids: string[]
  }[]
}

// Meta API response types
export interface MetaCatalogProduct {
  id: string
  retailer_id: string
  name: string
  description?: string
  price: string  // Price in cents as string
  currency: string
  availability: string
  image_url?: string
  url?: string
  brand?: string
  category?: string
}

export interface MetaCatalogProductsResponse {
  data: MetaCatalogProduct[]
  paging?: {
    cursors: {
      before: string
      after: string
    }
    next?: string
  }
}
```

Export all types.
  </action>
  <verify>
Run: `npm run type-check`
All types should compile without errors.
  </verify>
  <done>
src/types/whatsapp-catalog.ts exists with all catalog-related types.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Migration file exists with 3 tables
2. All tables have RLS policies
3. TypeScript types match database schema
4. `npm run type-check` passes
</verification>

<success_criteria>
- Database schema supports catalog, products, and message tracking
- RLS policies enforce organization isolation
- TypeScript types enable type-safe development
- Full-text search enabled on products
</success_criteria>

<output>
After completion, create `.planning/phases/09-whatsapp-catalog/09-01-SUMMARY.md`
</output>
