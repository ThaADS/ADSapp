---
phase: 09-whatsapp-catalog
plan: 06
type: execute
wave: 4
depends_on: ["09-03"]
files_modified:
  - src/app/api/webhooks/whatsapp/route.ts
  - src/lib/whatsapp/order-handler.ts
autonomous: true

must_haves:
  truths:
    - "Webhook handles order message type from cart submissions"
    - "Cart data is stored in whatsapp_product_messages table"
    - "Order creates a message in conversation for agent visibility"
  artifacts:
    - path: "src/lib/whatsapp/order-handler.ts"
      provides: "Order webhook handler"
      exports: ["handleCartOrder"]
  key_links:
    - from: "src/app/api/webhooks/whatsapp/route.ts"
      to: "src/lib/whatsapp/order-handler.ts"
      via: "handleCartOrder import"
---

<objective>
Handle cart/order webhooks when customers submit their shopping cart.

Purpose: When customers select products and send their cart, capture the order data for agent follow-up.

Output:
- Order handler for cart webhooks
- Updated webhook route to process orders
- Order tracking in database
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/09-whatsapp-catalog/09-RESEARCH.md (Part 6: Webhook Handling)

Existing webhook:
@src/app/api/webhooks/whatsapp/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order handler service</name>
  <files>src/lib/whatsapp/order-handler.ts</files>
  <action>
Create order handler for cart webhooks:

```typescript
import { createClient } from '@/lib/supabase/server'
import type { CartData, CartItem } from '@/types/whatsapp-catalog'

export interface OrderWebhookPayload {
  catalog_id: string
  product_items: {
    product_retailer_id: string
    quantity: number
    item_price: number
    currency: string
  }[]
  text?: string
}

export interface OrderHandlerResult {
  success: boolean
  conversationId?: string
  messageId?: string
  error?: string
}

/**
 * Handle a cart order webhook from WhatsApp
 * Called when customer sends their cart after adding products
 */
export async function handleCartOrder(
  organizationId: string,
  contactId: string,
  order: OrderWebhookPayload,
  messageTimestamp: string
): Promise<OrderHandlerResult> {
  const supabase = await createClient()

  try {
    // 1. Find or create conversation with contact
    const { data: conversation, error: convError } = await supabase
      .from('conversations')
      .select('id')
      .eq('organization_id', organizationId)
      .eq('contact_id', contactId)
      .eq('status', 'active')
      .order('created_at', { ascending: false })
      .limit(1)
      .single()

    let conversationId: string

    if (convError || !conversation) {
      // Create new conversation
      const { data: newConv, error: createError } = await supabase
        .from('conversations')
        .insert({
          organization_id: organizationId,
          contact_id: contactId,
          status: 'active',
          channel: 'whatsapp',
          last_message_at: messageTimestamp
        })
        .select('id')
        .single()

      if (createError || !newConv) {
        return { success: false, error: 'Failed to create conversation' }
      }
      conversationId = newConv.id
    } else {
      conversationId = conversation.id

      // Update conversation last message time
      await supabase
        .from('conversations')
        .update({ last_message_at: messageTimestamp })
        .eq('id', conversationId)
    }

    // 2. Calculate order total
    const totalAmount = order.product_items.reduce(
      (sum, item) => sum + (item.item_price * item.quantity),
      0
    )
    const currency = order.product_items[0]?.currency || 'USD'

    // 3. Format order summary for message content
    const orderSummary = formatOrderSummary(order)

    // 4. Create message record
    const { data: message, error: msgError } = await supabase
      .from('messages')
      .insert({
        conversation_id: conversationId,
        organization_id: organizationId,
        direction: 'inbound',
        content: orderSummary,
        message_type: 'order',
        status: 'delivered',
        received_at: messageTimestamp,
        metadata: {
          order: {
            catalog_id: order.catalog_id,
            total_amount: totalAmount,
            currency: currency,
            item_count: order.product_items.length,
            text: order.text
          }
        }
      })
      .select('id')
      .single()

    if (msgError) {
      console.error('Failed to create order message:', msgError)
      return { success: false, error: 'Failed to create message' }
    }

    // 5. Get product IDs from database
    const retailerIds = order.product_items.map(item => item.product_retailer_id)
    const { data: products } = await supabase
      .from('whatsapp_products')
      .select('id, retailer_id')
      .eq('organization_id', organizationId)
      .in('retailer_id', retailerIds)

    const productMap = new Map((products || []).map(p => [p.retailer_id, p.id]))
    const productIds = retailerIds.map(id => productMap.get(id)).filter(Boolean)

    // 6. Track in product messages table
    const cartData: CartData = {
      catalog_id: order.catalog_id,
      product_items: order.product_items.map(item => ({
        product_retailer_id: item.product_retailer_id,
        quantity: item.quantity,
        item_price: item.item_price,
        currency: item.currency
      })),
      text: order.text
    }

    await supabase
      .from('whatsapp_product_messages')
      .insert({
        organization_id: organizationId,
        conversation_id: conversationId,
        message_id: message.id,
        message_type: 'single', // Order is response to product message
        product_ids: productIds,
        retailer_ids: retailerIds,
        catalog_id: order.catalog_id,
        cart_received: true,
        cart_received_at: messageTimestamp,
        cart_data: cartData
      })

    return {
      success: true,
      conversationId,
      messageId: message.id
    }

  } catch (error) {
    console.error('Error handling cart order:', error)
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    }
  }
}

/**
 * Format order details into readable message content
 */
function formatOrderSummary(order: OrderWebhookPayload): string {
  const lines: string[] = ['ðŸ›’ New Order Received']

  if (order.text) {
    lines.push('')
    lines.push(`Customer note: "${order.text}"`)
  }

  lines.push('')
  lines.push('Items:')

  let total = 0
  const currency = order.product_items[0]?.currency || 'USD'

  for (const item of order.product_items) {
    const itemTotal = item.item_price * item.quantity
    total += itemTotal
    lines.push(`â€¢ ${item.product_retailer_id} x${item.quantity} - ${formatCurrency(itemTotal, item.currency)}`)
  }

  lines.push('')
  lines.push(`Total: ${formatCurrency(total, currency)}`)

  return lines.join('\n')
}

/**
 * Format currency amount
 */
function formatCurrency(amount: number, currency: string): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: currency
  }).format(amount / 100) // Amount is in cents
}

export default handleCartOrder
```
  </action>
  <verify>
Run: `npm run type-check`
Service should compile without errors.
  </verify>
  <done>
src/lib/whatsapp/order-handler.ts exists with handleCartOrder function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update webhook to handle orders</name>
  <files>src/app/api/webhooks/whatsapp/route.ts</files>
  <action>
Update the existing WhatsApp webhook to handle order message types.

1. **Add import at top**:
   ```typescript
   import { handleCartOrder } from '@/lib/whatsapp/order-handler'
   ```

2. **In the message processing logic**, add handling for order type:

   Find where message types are handled (text, image, etc.) and add:

   ```typescript
   // Handle order messages (cart submissions)
   if (message.type === 'order' && message.order) {
     console.log('[WhatsApp Webhook] Processing order from:', message.from)

     const result = await handleCartOrder(
       organizationId,
       contactId,
       {
         catalog_id: message.order.catalog_id,
         product_items: message.order.product_items,
         text: message.order.text
       },
       new Date(parseInt(message.timestamp) * 1000).toISOString()
     )

     if (result.success) {
       console.log('[WhatsApp Webhook] Order processed, conversation:', result.conversationId)
     } else {
       console.error('[WhatsApp Webhook] Order processing failed:', result.error)
     }

     return // Order handled, continue to next message
   }
   ```

3. **Update the WhatsApp message type definition** if needed to include order type:

   ```typescript
   interface WhatsAppMessage {
     // ... existing fields
     type: 'text' | 'image' | 'video' | 'audio' | 'document' | 'location' | 'contacts' | 'interactive' | 'order'
     order?: {
       catalog_id: string
       product_items: {
         product_retailer_id: string
         quantity: number
         item_price: number
         currency: string
       }[]
       text?: string
     }
   }
   ```

Important: Preserve all existing webhook functionality. The order handling is additive.
  </action>
  <verify>
Run: `npm run type-check`
Run: `npm run lint`
  </verify>
  <done>
src/app/api/webhooks/whatsapp/route.ts handles order message type.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Order handler processes cart submissions
2. Orders create messages in conversations
3. Cart data is stored for tracking
4. Webhook correctly routes order messages
5. `npm run type-check` passes
6. `npm run lint` passes
</verification>

<success_criteria>
- Cart orders from WhatsApp are captured
- Order creates visible message for agent
- Cart items and totals are tracked
- Order summary is human-readable
- Existing webhook functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/09-whatsapp-catalog/09-06-SUMMARY.md`
</output>
