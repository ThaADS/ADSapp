---
phase: 09-whatsapp-catalog
plan: 05
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - src/components/settings/CatalogSettings.tsx
  - src/app/dashboard/settings/integrations/page.tsx
autonomous: true

must_haves:
  truths:
    - "CatalogSettings displays sync status and errors"
    - "User can configure catalog ID and trigger manual sync"
    - "Settings page includes catalog configuration section"
  artifacts:
    - path: "src/components/settings/CatalogSettings.tsx"
      provides: "Catalog configuration component"
      exports: ["CatalogSettings"]
  key_links:
    - from: "src/components/settings/CatalogSettings.tsx"
      to: "src/app/api/whatsapp/catalog/route.ts"
      via: "fetch /api/whatsapp/catalog"
---

<objective>
Create catalog settings UI for configuration and sync management.

Purpose: Allow admins to configure their WhatsApp catalog connection, view sync status, and trigger manual syncs.

Output:
- CatalogSettings component with configuration form
- Integration with settings page
- Sync status display with error handling
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/09-whatsapp-catalog/09-RESEARCH.md (Part 5: CatalogSettings)

Existing settings patterns:
@src/app/dashboard/settings/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CatalogSettings component</name>
  <files>src/components/settings/CatalogSettings.tsx</files>
  <action>
Create CatalogSettings component:

```tsx
'use client'

import * as React from 'react'
import { useState, useEffect, useCallback } from 'react'
import {
  RefreshCw,
  CheckCircle,
  XCircle,
  AlertCircle,
  Clock,
  Package,
  Save,
  Trash2,
  ExternalLink,
  Loader2
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Switch } from '@/components/ui/switch'
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle
} from '@/components/ui/card'
import {
  Alert,
  AlertDescription,
  AlertTitle
} from '@/components/ui/alert'
import { cn } from '@/lib/utils'
import type { WhatsAppCatalog, CatalogSyncStatus } from '@/types/whatsapp-catalog'

export function CatalogSettings() {
  const [catalog, setCatalog] = useState<WhatsAppCatalog | null>(null)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [syncing, setSyncing] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState<string | null>(null)

  // Form state
  const [catalogId, setCatalogId] = useState('')
  const [catalogName, setCatalogName] = useState('')

  // Fetch current catalog config
  const fetchCatalog = useCallback(async () => {
    try {
      const response = await fetch('/api/whatsapp/catalog')
      if (!response.ok) {
        throw new Error('Failed to fetch catalog')
      }
      const data = await response.json()
      setCatalog(data.catalog)
      if (data.catalog) {
        setCatalogId(data.catalog.catalog_id)
        setCatalogName(data.catalog.catalog_name || '')
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load catalog')
    } finally {
      setLoading(false)
    }
  }, [])

  useEffect(() => {
    fetchCatalog()
  }, [fetchCatalog])

  // Save catalog config
  const handleSave = async () => {
    if (!catalogId.trim()) {
      setError('Catalog ID is required')
      return
    }

    setSaving(true)
    setError(null)
    setSuccess(null)

    try {
      const response = await fetch('/api/whatsapp/catalog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          catalog_id: catalogId.trim(),
          catalog_name: catalogName.trim() || undefined
        })
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to save catalog')
      }

      const data = await response.json()
      setCatalog(data.catalog)
      setSuccess('Catalog configuration saved')
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to save catalog')
    } finally {
      setSaving(false)
    }
  }

  // Trigger sync
  const handleSync = async () => {
    setSyncing(true)
    setError(null)
    setSuccess(null)

    try {
      const response = await fetch('/api/whatsapp/catalog/sync', {
        method: 'POST'
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to sync catalog')
      }

      const data = await response.json()
      setSuccess(`Synced ${data.products_synced} products`)

      // Refresh catalog data
      await fetchCatalog()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to sync catalog')
    } finally {
      setSyncing(false)
    }
  }

  // Delete catalog
  const handleDelete = async () => {
    if (!confirm('Are you sure you want to remove the catalog configuration? This will delete all synced products.')) {
      return
    }

    setSaving(true)
    setError(null)

    try {
      const response = await fetch('/api/whatsapp/catalog', {
        method: 'DELETE'
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to delete catalog')
      }

      setCatalog(null)
      setCatalogId('')
      setCatalogName('')
      setSuccess('Catalog configuration removed')
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to delete catalog')
    } finally {
      setSaving(false)
    }
  }

  // Status badge component
  const StatusBadge = ({ status }: { status: CatalogSyncStatus }) => {
    const variants: Record<CatalogSyncStatus, { icon: React.ReactNode; className: string; label: string }> = {
      pending: {
        icon: <Clock className="w-4 h-4" />,
        className: 'bg-yellow-100 text-yellow-800',
        label: 'Pending'
      },
      syncing: {
        icon: <RefreshCw className="w-4 h-4 animate-spin" />,
        className: 'bg-blue-100 text-blue-800',
        label: 'Syncing'
      },
      success: {
        icon: <CheckCircle className="w-4 h-4" />,
        className: 'bg-green-100 text-green-800',
        label: 'Synced'
      },
      error: {
        icon: <XCircle className="w-4 h-4" />,
        className: 'bg-red-100 text-red-800',
        label: 'Error'
      }
    }

    const variant = variants[status]

    return (
      <span className={cn('inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-sm font-medium', variant.className)}>
        {variant.icon}
        {variant.label}
      </span>
    )
  }

  if (loading) {
    return (
      <Card>
        <CardContent className="flex items-center justify-center py-8">
          <Loader2 className="w-8 h-8 animate-spin text-muted-foreground" />
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Package className="w-5 h-5" />
          WhatsApp Product Catalog
        </CardTitle>
        <CardDescription>
          Connect your Meta Commerce Manager catalog to send product messages
        </CardDescription>
      </CardHeader>

      <CardContent className="space-y-6">
        {/* Error/Success alerts */}
        {error && (
          <Alert variant="destructive">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>Error</AlertTitle>
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}

        {success && (
          <Alert className="border-green-500 bg-green-50">
            <CheckCircle className="h-4 w-4 text-green-500" />
            <AlertTitle className="text-green-800">Success</AlertTitle>
            <AlertDescription className="text-green-700">{success}</AlertDescription>
          </Alert>
        )}

        {/* Status section (when configured) */}
        {catalog && (
          <div className="space-y-4 p-4 bg-muted/50 rounded-lg">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium">Status</span>
              <StatusBadge status={catalog.sync_status} />
            </div>

            <div className="flex items-center justify-between">
              <span className="text-sm font-medium">Products</span>
              <span className="text-sm text-muted-foreground">
                {catalog.product_count} products synced
              </span>
            </div>

            {catalog.last_sync_at && (
              <div className="flex items-center justify-between">
                <span className="text-sm font-medium">Last Sync</span>
                <span className="text-sm text-muted-foreground">
                  {new Date(catalog.last_sync_at).toLocaleString()}
                </span>
              </div>
            )}

            {catalog.sync_error && (
              <Alert variant="destructive" className="mt-2">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription>{catalog.sync_error}</AlertDescription>
              </Alert>
            )}

            <Button
              onClick={handleSync}
              disabled={syncing || catalog.sync_status === 'syncing'}
              className="w-full"
            >
              {syncing ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Syncing...
                </>
              ) : (
                <>
                  <RefreshCw className="w-4 h-4 mr-2" />
                  Sync Now
                </>
              )}
            </Button>
          </div>
        )}

        {/* Configuration form */}
        <div className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="catalogId">Catalog ID</Label>
            <Input
              id="catalogId"
              placeholder="Enter your catalog ID"
              value={catalogId}
              onChange={(e) => setCatalogId(e.target.value)}
            />
            <p className="text-xs text-muted-foreground">
              Find your catalog ID in{' '}
              <a
                href="https://business.facebook.com/commerce"
                target="_blank"
                rel="noopener noreferrer"
                className="text-primary hover:underline inline-flex items-center gap-1"
              >
                Meta Commerce Manager
                <ExternalLink className="w-3 h-3" />
              </a>
            </p>
          </div>

          <div className="space-y-2">
            <Label htmlFor="catalogName">Display Name (optional)</Label>
            <Input
              id="catalogName"
              placeholder="My Product Catalog"
              value={catalogName}
              onChange={(e) => setCatalogName(e.target.value)}
            />
          </div>
        </div>
      </CardContent>

      <CardFooter className="flex justify-between">
        {catalog ? (
          <>
            <Button
              variant="destructive"
              onClick={handleDelete}
              disabled={saving}
            >
              <Trash2 className="w-4 h-4 mr-2" />
              Remove Catalog
            </Button>
            <Button
              onClick={handleSave}
              disabled={saving || !catalogId.trim()}
            >
              {saving ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Saving...
                </>
              ) : (
                <>
                  <Save className="w-4 h-4 mr-2" />
                  Update
                </>
              )}
            </Button>
          </>
        ) : (
          <Button
            onClick={handleSave}
            disabled={saving || !catalogId.trim()}
            className="ml-auto"
          >
            {saving ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Saving...
              </>
            ) : (
              <>
                <Save className="w-4 h-4 mr-2" />
                Connect Catalog
              </>
            )}
          </Button>
        )}
      </CardFooter>
    </Card>
  )
}

export default CatalogSettings
```
  </action>
  <verify>
Run: `npm run type-check`
Component should compile without errors.
  </verify>
  <done>
src/components/settings/CatalogSettings.tsx exists with status display, sync trigger, and configuration form.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate with settings page</name>
  <files>src/app/dashboard/settings/integrations/page.tsx</files>
  <action>
Check if integrations settings page exists, and add CatalogSettings component.

If page exists, add the import and component:

```typescript
import { CatalogSettings } from '@/components/settings/CatalogSettings'

// In the component JSX, add:
<CatalogSettings />
```

If page doesn't exist, create a new integrations page with the catalog settings:

```tsx
import { Metadata } from 'next'
import { CatalogSettings } from '@/components/settings/CatalogSettings'

export const metadata: Metadata = {
  title: 'Integrations | Settings',
  description: 'Manage your integrations'
}

export default function IntegrationsSettingsPage() {
  return (
    <div className="container max-w-4xl py-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Integrations</h1>
        <p className="text-muted-foreground">
          Connect external services to enhance your messaging capabilities
        </p>
      </div>

      <CatalogSettings />
    </div>
  )
}
```

If there's an existing WhatsApp settings page, integrate there instead.
  </action>
  <verify>
Run: `npm run type-check`
Run: `npm run build` to verify page renders
  </verify>
  <done>
CatalogSettings is accessible from a settings page.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. CatalogSettings component displays sync status
2. User can enter catalog ID and save configuration
3. Sync button triggers product sync
4. Errors are displayed clearly
5. Component is accessible from settings
6. `npm run type-check` passes
7. `npm run build` passes
</verification>

<success_criteria>
- Catalog ID can be configured
- Sync status shows (pending/syncing/success/error)
- Last sync time is displayed
- Manual sync can be triggered
- Errors are displayed with actionable messages
- Configuration can be removed
</success_criteria>

<output>
After completion, create `.planning/phases/09-whatsapp-catalog/09-05-SUMMARY.md`
</output>
