# Plan 21-01: Database Schema for Twilio WhatsApp

## Objective
Create database migration for Twilio WhatsApp integration tables with proper RLS policies.

## Requirements Addressed
- **TWWA-01**: User can connect Twilio WhatsApp account via Account SID and Auth Token (storage)

## Files to Create

### 1. `supabase/migrations/20260203_twilio_whatsapp.sql`

```sql
-- Phase 21: Twilio WhatsApp Channel
-- Database schema for Twilio WhatsApp integration
-- Supports bidirectional WhatsApp messaging via Twilio API

-- =============================================================================
-- TWILIO WHATSAPP CONNECTIONS TABLE
-- =============================================================================
-- Stores Twilio WhatsApp account credentials per organization

CREATE TABLE IF NOT EXISTS twilio_whatsapp_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Twilio credentials (encrypted)
  twilio_account_sid TEXT NOT NULL,
  twilio_auth_token_hash TEXT NOT NULL, -- Encrypted auth token

  -- WhatsApp number configuration
  whatsapp_number TEXT NOT NULL, -- E.164 format (+1234567890)
  whatsapp_number_sid TEXT, -- Twilio Phone Number SID (optional)
  friendly_name TEXT,

  -- Status
  is_active BOOLEAN NOT NULL DEFAULT true,
  webhook_configured BOOLEAN NOT NULL DEFAULT false,
  last_verified_at TIMESTAMPTZ,

  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Each org can have multiple WhatsApp numbers, but each number is unique globally
  UNIQUE(whatsapp_number)
);

-- Indexes
CREATE INDEX idx_twilio_wa_connections_org ON twilio_whatsapp_connections(organization_id);
CREATE INDEX idx_twilio_wa_connections_number ON twilio_whatsapp_connections(whatsapp_number);
CREATE INDEX idx_twilio_wa_connections_active ON twilio_whatsapp_connections(is_active) WHERE is_active = true;

-- RLS Policies
ALTER TABLE twilio_whatsapp_connections ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own org twilio whatsapp connections"
  ON twilio_whatsapp_connections FOR SELECT
  USING (organization_id IN (
    SELECT organization_id FROM profiles WHERE id = auth.uid()
  ));

CREATE POLICY "Admins can manage twilio whatsapp connections"
  ON twilio_whatsapp_connections FOR ALL
  USING (organization_id IN (
    SELECT organization_id FROM profiles
    WHERE id = auth.uid() AND role IN ('owner', 'admin')
  ));

-- =============================================================================
-- TWILIO WHATSAPP WEBHOOK EVENTS TABLE (Idempotency)
-- =============================================================================

CREATE TABLE IF NOT EXISTS twilio_whatsapp_webhook_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  connection_id UUID REFERENCES twilio_whatsapp_connections(id) ON DELETE CASCADE,

  -- Event identification
  message_sid TEXT NOT NULL,
  event_type TEXT NOT NULL CHECK (event_type IN ('message', 'status')),
  payload_hash TEXT,

  -- Processing
  processed_at TIMESTAMPTZ,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processed', 'failed')),
  error_message TEXT,

  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  UNIQUE(message_sid, event_type)
);

-- Index
CREATE INDEX idx_twilio_wa_webhook_events_status ON twilio_whatsapp_webhook_events(status) WHERE status = 'pending';
CREATE INDEX idx_twilio_wa_webhook_events_sid ON twilio_whatsapp_webhook_events(message_sid);

-- =============================================================================
-- UPDATED_AT TRIGGER
-- =============================================================================

CREATE TRIGGER update_twilio_whatsapp_connections_updated_at
  BEFORE UPDATE ON twilio_whatsapp_connections
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- COMMENTS
-- =============================================================================

COMMENT ON TABLE twilio_whatsapp_connections IS 'Twilio WhatsApp account connections per organization';
COMMENT ON TABLE twilio_whatsapp_webhook_events IS 'Webhook event log for idempotency';
```

## Verification

1. Run migration: `npm run migration:apply`
2. Verify tables exist in Supabase dashboard
3. Test RLS policies with different user roles
4. Confirm indexes are created

## Dependencies

- Existing `organizations` table
- Existing `profiles` table
- Existing `update_updated_at_column()` function

## Success Criteria

- [ ] Migration applies without errors
- [ ] `twilio_whatsapp_connections` table exists with all columns
- [ ] `twilio_whatsapp_webhook_events` table exists with all columns
- [ ] RLS policies restrict access to organization members
- [ ] Only admins/owners can insert/update/delete connections
- [ ] Indexes created for performance
