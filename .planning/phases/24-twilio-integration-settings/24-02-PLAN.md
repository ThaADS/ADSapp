# Plan 24-02: Provider Switching Service & API

## Overview
Create service layer and API endpoints for WhatsApp provider management.

## Requirements Addressed
- TWWI-01: ChannelAdapter compliance (adapter factory with provider selection)
- TWWI-02: Provider switching UI (API foundation)

## Deliverables

### 1. WhatsApp Provider Service
**File:** `src/lib/integrations/whatsapp/provider-service.ts`

```typescript
// Core service functions:
export async function getActiveProvider(organizationId: string): Promise<WhatsAppProvider>
export async function setActiveProvider(organizationId: string, provider: WhatsAppProvider): Promise<void>
export async function getProviderSettings(organizationId: string): Promise<WhatsAppProviderSettings>
export async function updateProviderSettings(organizationId: string, settings: Partial<WhatsAppProviderSettings>): Promise<void>

// Adapter factory with provider awareness
export async function getWhatsAppAdapter(organizationId: string): Promise<ChannelAdapter>
```

### 2. Provider Settings API
**File:** `src/app/api/integrations/whatsapp/provider/route.ts`

```typescript
// GET /api/integrations/whatsapp/provider
// Get current provider settings for organization
{
  activeProvider: 'twilio',
  fallbackEnabled: false,
  cloudApiConnected: true,
  twilioConnected: true,
  ...
}

// PUT /api/integrations/whatsapp/provider
// Update provider settings
// Body: { activeProvider: 'twilio', fallbackEnabled: true, ... }
```

### 3. Provider Health Check API
**File:** `src/app/api/integrations/whatsapp/provider/health/route.ts`

```typescript
// GET /api/integrations/whatsapp/provider/health
// Check health of both providers
{
  cloudApi: { connected: true, healthy: true, latency: 120 },
  twilio: { connected: true, healthy: true, latency: 85 }
}
```

### 4. Update Router Integration
Update `src/lib/channels/adapters/index.ts` to use provider service:

```typescript
export async function createWhatsAppAdapter(organizationId: string): Promise<ChannelAdapter> {
  const provider = await getActiveProvider(organizationId)

  if (provider === 'twilio') {
    return TwilioWhatsAppAdapter.createForOrganization(organizationId)
  }

  return WhatsAppAdapter.createForOrganization(organizationId)
}
```

## Acceptance Criteria
- [x] Provider service manages settings correctly
- [x] API endpoints for GET/PUT provider settings
- [x] Health check returns status for both providers
- [x] Adapter factory creates correct adapter based on provider setting
- [x] Fallback logic works when enabled

## Dependencies
- Plan 24-01 (database schema)
