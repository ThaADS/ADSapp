# Plan 24-01: WhatsApp Provider Settings Schema

## Overview
Add database schema for WhatsApp provider selection per organization.

## Requirements Addressed
- TWWI-02: Provider switching UI (database foundation)

## Deliverables

### 1. Database Migration
**File:** `supabase/migrations/20260203_whatsapp_provider_settings.sql`

```sql
-- WhatsApp provider settings per organization
CREATE TABLE IF NOT EXISTS whatsapp_provider_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Provider selection: 'cloud_api' (Meta) or 'twilio'
  active_provider TEXT NOT NULL DEFAULT 'cloud_api' CHECK (active_provider IN ('cloud_api', 'twilio')),

  -- Fallback configuration
  fallback_enabled BOOLEAN NOT NULL DEFAULT false,
  fallback_provider TEXT CHECK (fallback_provider IN ('cloud_api', 'twilio')),

  -- Connection references
  cloud_api_connection_id UUID REFERENCES whatsapp_connections(id),
  twilio_connection_id UUID REFERENCES twilio_whatsapp_connections(id),

  -- Feature flags
  prefer_templates_from TEXT DEFAULT 'active' CHECK (prefer_templates_from IN ('active', 'cloud_api', 'twilio')),

  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE(organization_id)
);

-- RLS policies
ALTER TABLE whatsapp_provider_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own org provider settings"
  ON whatsapp_provider_settings FOR SELECT
  USING (organization_id IN (
    SELECT organization_id FROM profiles WHERE id = auth.uid()
  ));

CREATE POLICY "Admins can manage provider settings"
  ON whatsapp_provider_settings FOR ALL
  USING (organization_id IN (
    SELECT organization_id FROM profiles
    WHERE id = auth.uid() AND role IN ('owner', 'admin')
  ));
```

### 2. TypeScript Types
**File:** `src/types/whatsapp-settings.ts`

```typescript
export type WhatsAppProvider = 'cloud_api' | 'twilio'

export interface WhatsAppProviderSettings {
  id: string
  organizationId: string
  activeProvider: WhatsAppProvider
  fallbackEnabled: boolean
  fallbackProvider: WhatsAppProvider | null
  cloudApiConnectionId: string | null
  twilioConnectionId: string | null
  preferTemplatesFrom: 'active' | 'cloud_api' | 'twilio'
  createdAt: Date
  updatedAt: Date
}

export interface WhatsAppProviderSettingsRow {
  id: string
  organization_id: string
  active_provider: string
  fallback_enabled: boolean
  fallback_provider: string | null
  cloud_api_connection_id: string | null
  twilio_connection_id: string | null
  prefer_templates_from: string
  created_at: string
  updated_at: string
}
```

## Acceptance Criteria
- [x] Migration creates whatsapp_provider_settings table
- [x] RLS policies enforce organization isolation
- [x] TypeScript types match database schema
- [x] Default provider is 'cloud_api' for existing organizations

## Dependencies
- Phase 21 (twilio_whatsapp_connections table exists)
