---
phase: 11-team-collaboration
plan: 06
type: execute
wave: 4
depends_on: ["11-02", "11-03", "11-04"]
files_modified:
  - src/components/inbox/conversation-notes.tsx
  - src/components/inbox/mention-renderer.tsx
  - src/components/profile/user-profile-sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "Conversation notes UI uses MentionEditor for input"
    - "Mentions in notes render as clickable links"
    - "Clicking a mention opens user profile sidebar"
  artifacts:
    - path: "src/components/inbox/conversation-notes.tsx"
      provides: "Updated notes component with MentionEditor"
      contains: "MentionEditor"
    - path: "src/components/inbox/mention-renderer.tsx"
      provides: "Component to render note HTML with clickable mentions"
      contains: "data-type=\"mention\""
    - path: "src/components/profile/user-profile-sidebar.tsx"
      provides: "User profile sidebar shown on mention click"
      contains: "UserProfileSidebar"
  key_links:
    - from: "conversation-notes.tsx"
      to: "MentionEditor"
      via: "import"
      pattern: "import.*MentionEditor"
    - from: "mention-renderer.tsx"
      to: "user-profile-sidebar.tsx"
      via: "onClick handler"
      pattern: "onClick.*profile"
---

<objective>
Integrate MentionEditor into conversation notes UI and add clickable mention links to user profiles.

Purpose: Complete the @mention user experience - from typing to clicking through to user profile (MENT-01, MENT-06).

Output: Full end-to-end @mention experience in conversation notes.
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-team-collaboration/11-02-SUMMARY.md
@.planning/phases/11-team-collaboration/11-03-SUMMARY.md
@.planning/phases/11-team-collaboration/11-04-SUMMARY.md
@src/components/inbox/conversation-notes.tsx
@src/components/inbox/mention-editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mention renderer component for displaying notes</name>
  <files>src/components/inbox/mention-renderer.tsx</files>
  <action>
Create component to render note HTML with clickable mentions:

```typescript
'use client'

import { useCallback } from 'react'
import DOMPurify from 'dompurify'

interface MentionRendererProps {
  html: string
  onMentionClick: (userId: string) => void
}

export function MentionRenderer({ html, onMentionClick }: MentionRendererProps) {
  // Sanitize HTML
  const sanitizedHtml = DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'span', 'a', 'ul', 'ol', 'li'],
    ALLOWED_ATTR: ['class', 'data-type', 'data-id', 'data-label', 'href'],
  })

  const handleClick = useCallback(
    (e: React.MouseEvent) => {
      const target = e.target as HTMLElement
      if (target.getAttribute('data-type') === 'mention') {
        const userId = target.getAttribute('data-id')
        if (userId) {
          e.preventDefault()
          onMentionClick(userId)
        }
      }
    },
    [onMentionClick]
  )

  return (
    <div
      className="note-content prose prose-sm max-w-none"
      onClick={handleClick}
      dangerouslySetInnerHTML={{ __html: sanitizedHtml }}
    />
  )
}
```

Add CSS (in component or global styles):
```css
.note-content .mention {
  background-color: #e0f2fe; /* sky-100 */
  color: #0369a1; /* sky-700 */
  border-radius: 4px;
  padding: 2px 4px;
  font-weight: 500;
  cursor: pointer;
  text-decoration: none;
}
.note-content .mention:hover {
  background-color: #bae6fd; /* sky-200 */
  text-decoration: underline;
}
```
  </action>
  <verify>
```bash
npm run type-check
```
Component compiles and exports.
  </verify>
  <done>MentionRenderer created with clickable mentions</done>
</task>

<task type="auto">
  <name>Task 2: Create user profile sidebar component</name>
  <files>src/components/profile/user-profile-sidebar.tsx</files>
  <action>
Create sidebar to display user profile when mention is clicked:

```typescript
'use client'

import { useEffect, useState } from 'react'
import { X, Mail, Shield, User } from 'lucide-react'
import { createClient } from '@/lib/supabase/client'

interface UserProfile {
  id: string
  full_name: string | null
  email: string
  avatar_url: string | null
  role: string
  created_at: string
}

interface UserProfileSidebarProps {
  userId: string | null
  onClose: () => void
}

export function UserProfileSidebar({ userId, onClose }: UserProfileSidebarProps) {
  const [profile, setProfile] = useState<UserProfile | null>(null)
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    if (!userId) {
      setProfile(null)
      return
    }

    async function fetchProfile() {
      setLoading(true)
      const supabase = createClient()

      const { data, error } = await supabase
        .from('profiles')
        .select('id, full_name, email, avatar_url, role, created_at')
        .eq('id', userId)
        .single()

      if (!error && data) {
        setProfile(data)
      }
      setLoading(false)
    }

    fetchProfile()
  }, [userId])

  if (!userId) return null

  return (
    <div className="fixed inset-y-0 right-0 w-80 bg-white shadow-xl z-50 flex flex-col">
      {/* Header */}
      <div className="flex items-center justify-between border-b px-4 py-3">
        <h2 className="font-semibold text-gray-900">Team Member</h2>
        <button
          onClick={onClose}
          className="p-1 rounded hover:bg-gray-100"
          aria-label="Close profile"
        >
          <X className="h-5 w-5 text-gray-500" />
        </button>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-4">
        {loading ? (
          <div className="flex items-center justify-center py-8">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600" />
          </div>
        ) : profile ? (
          <div className="space-y-6">
            {/* Avatar and name */}
            <div className="text-center">
              {profile.avatar_url ? (
                <img
                  src={profile.avatar_url}
                  alt={profile.full_name || 'User'}
                  className="h-20 w-20 rounded-full mx-auto"
                />
              ) : (
                <div className="h-20 w-20 rounded-full bg-emerald-100 mx-auto flex items-center justify-center">
                  <User className="h-10 w-10 text-emerald-600" />
                </div>
              )}
              <h3 className="mt-3 text-lg font-semibold text-gray-900">
                {profile.full_name || 'No name'}
              </h3>
              <p className="text-sm text-gray-500 capitalize">{profile.role}</p>
            </div>

            {/* Details */}
            <div className="space-y-3">
              <div className="flex items-center gap-3 text-sm">
                <Mail className="h-4 w-4 text-gray-400" />
                <span className="text-gray-700">{profile.email}</span>
              </div>
              <div className="flex items-center gap-3 text-sm">
                <Shield className="h-4 w-4 text-gray-400" />
                <span className="text-gray-700 capitalize">{profile.role}</span>
              </div>
            </div>

            {/* Member since */}
            <div className="text-sm text-gray-500">
              Member since {new Date(profile.created_at).toLocaleDateString('nl-NL', {
                year: 'numeric',
                month: 'long',
              })}
            </div>
          </div>
        ) : (
          <div className="text-center py-8 text-gray-500">
            User not found
          </div>
        )}
      </div>
    </div>
  )
}
```
  </action>
  <verify>
```bash
npm run type-check
```
Component compiles and exports.
  </verify>
  <done>UserProfileSidebar created for displaying mentioned user profiles</done>
</task>

<task type="auto">
  <name>Task 3: Update ConversationNotes to use MentionEditor and clickable mentions</name>
  <files>src/components/inbox/conversation-notes.tsx</files>
  <action>
Update the existing ConversationNotes component:

1. **Replace textarea with MentionEditor:**
   - Import MentionEditor from './mention-editor'
   - Replace the textarea JSX with MentionEditor component
   - Pass onSubmit handler that receives (html, plainText)

2. **Use MentionRenderer for displaying notes:**
   - Import MentionRenderer from './mention-renderer'
   - Replace the plain text display with MentionRenderer
   - Pass note.content (HTML) instead of plain text

3. **Add UserProfileSidebar state and rendering:**
   - Import UserProfileSidebar
   - Add state: `const [selectedUserId, setSelectedUserId] = useState<string | null>(null)`
   - Pass onMentionClick handler to MentionRenderer
   - Render UserProfileSidebar when selectedUserId is set

4. **Update save handler:**
   - Send HTML content to API
   - API already handles HTML parsing and mention extraction

Key changes to the component structure:
```typescript
import { MentionEditor } from './mention-editor'
import { MentionRenderer } from './mention-renderer'
import { UserProfileSidebar } from '@/components/profile/user-profile-sidebar'

// Add state for profile sidebar
const [selectedUserId, setSelectedUserId] = useState<string | null>(null)

// Update handleSaveNote to work with MentionEditor
const handleSaveNote = async (html: string, plainText: string) => {
  if (!html.trim()) return
  // ... existing save logic with html content
}

// In render:
{isAddingNote && (
  <MentionEditor
    onSubmit={handleSaveNote}
    placeholder="Write a note... Use @ to mention team members"
    disabled={isLoading}
  />
)}

// For displaying notes:
<MentionRenderer
  html={note.content}
  onMentionClick={(userId) => setSelectedUserId(userId)}
/>

// At the end of component:
<UserProfileSidebar
  userId={selectedUserId}
  onClose={() => setSelectedUserId(null)}
/>
```

Note: The existing note interface needs to be updated to include `content` (HTML) instead of just plain text content. The API changes from Plan 03 already support this.
  </action>
  <verify>
```bash
npm run type-check
npm run build
```
Component compiles and builds successfully.
  </verify>
  <done>ConversationNotes uses MentionEditor and clickable mentions</done>
</task>

</tasks>

<verification>
1. Typing @ shows team member suggestions
2. Selecting a suggestion inserts mention
3. Saved note displays with styled mentions
4. Clicking mention opens profile sidebar
5. Profile sidebar shows user details
6. Closing sidebar works
</verification>

<success_criteria>
- MentionEditor integrated into conversation notes
- Notes display with clickable mention styling
- Profile sidebar opens on mention click
- Full end-to-end mention flow works
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Complete @mention system with editor, real-time notifications, and clickable profile links</what-built>
  <how-to-verify>
    1. Open a conversation in the inbox
    2. In the notes section, type "@" - expect to see team member dropdown
    3. Use arrow keys to navigate, Enter to select
    4. Save the note
    5. Verify mention appears with blue background styling
    6. Click on the mention - expect profile sidebar to open
    7. Check notification badge (may need to test with another user/browser)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/11-team-collaboration/11-06-SUMMARY.md`
</output>
