---
phase: 11-team-collaboration
plan: 04
type: execute
wave: 3
depends_on: ["11-01"]
files_modified:
  - src/stores/notifications.ts
  - src/components/notifications/mention-subscriber.tsx
  - src/components/notifications/notification-badge.tsx
  - src/app/api/mentions/[id]/viewed/route.ts
autonomous: true

must_haves:
  truths:
    - "User sees notification badge increment when mentioned"
    - "Notification appears within 2 seconds of mention creation"
    - "Badge count decrements when mention is marked viewed"
  artifacts:
    - path: "src/stores/notifications.ts"
      provides: "Zustand store for notification state"
      exports: ["useNotificationStore"]
    - path: "src/components/notifications/mention-subscriber.tsx"
      provides: "Supabase Realtime subscription component"
      contains: "postgres_changes"
    - path: "src/components/notifications/notification-badge.tsx"
      provides: "Notification bell with badge"
      contains: "aria-live"
  key_links:
    - from: "mention-subscriber.tsx"
      to: "mentions"
      via: "Supabase Realtime subscription"
      pattern: "channel.*mentions"
    - from: "notification-badge.tsx"
      to: "useNotificationStore"
      via: "Zustand hook"
      pattern: "useNotificationStore"
---

<objective>
Implement real-time notification delivery using Supabase Realtime subscriptions and Zustand state.

Purpose: Mentioned users see notification badge update in real-time without page refresh (MENT-02 requirement).

Output: Notification system with Realtime subscription, badge component, and API to mark as viewed.
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-team-collaboration/11-RESEARCH.md
@.planning/phases/11-team-collaboration/11-01-SUMMARY.md
@src/types/mentions.ts
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand notification store</name>
  <files>src/stores/notifications.ts</files>
  <action>
Create Zustand store for notification state:

```typescript
import { create } from 'zustand'
import { MentionNotification } from '@/types/mentions'

interface NotificationState {
  // Mention notifications
  mentions: MentionNotification[]
  unreadMentionCount: number

  // Actions
  addMention: (mention: MentionNotification) => void
  markMentionViewed: (mentionId: string) => void
  setUnreadCount: (count: number) => void
  clearMentions: () => void
}

export const useNotificationStore = create<NotificationState>((set) => ({
  mentions: [],
  unreadMentionCount: 0,

  addMention: (mention) =>
    set((state) => ({
      mentions: [mention, ...state.mentions].slice(0, 50), // Keep max 50
      unreadMentionCount: state.unreadMentionCount + 1,
    })),

  markMentionViewed: (mentionId) =>
    set((state) => ({
      mentions: state.mentions.map((m) =>
        m.id === mentionId ? { ...m, viewed: true } : m
      ),
      unreadMentionCount: Math.max(0, state.unreadMentionCount - 1),
    })),

  setUnreadCount: (count) =>
    set({ unreadMentionCount: count }),

  clearMentions: () =>
    set({ mentions: [], unreadMentionCount: 0 }),
}))
```
  </action>
  <verify>
```bash
npm run type-check
```
Store compiles and exports hook.
  </verify>
  <done>Notification store created with mention state management</done>
</task>

<task type="auto">
  <name>Task 2: Create Realtime subscription component and notification badge</name>
  <files>
src/components/notifications/mention-subscriber.tsx
src/components/notifications/notification-badge.tsx
  </files>
  <action>
**mention-subscriber.tsx:**
```typescript
'use client'

import { useEffect } from 'react'
import { createClient } from '@/lib/supabase/client'
import { useNotificationStore } from '@/stores/notifications'

interface MentionSubscriberProps {
  userId: string
}

export function MentionSubscriber({ userId }: MentionSubscriberProps) {
  const { addMention, setUnreadCount } = useNotificationStore()

  useEffect(() => {
    const supabase = createClient()

    // Fetch initial unread count
    supabase
      .from('mentions')
      .select('id', { count: 'exact', head: true })
      .eq('mentioned_user_id', userId)
      .is('viewed_at', null)
      .then(({ count }) => setUnreadCount(count || 0))

    // Subscribe to new mentions
    const channel = supabase
      .channel(`mentions-${userId}`)
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'mentions',
          filter: `mentioned_user_id=eq.${userId}`,
        },
        async (payload) => {
          const mention = payload.new as any

          // Fetch note and author details
          const { data: note } = await supabase
            .from('conversation_notes')
            .select(`
              id,
              content_plain,
              conversation_id,
              profiles:created_by (id, full_name, avatar_url)
            `)
            .eq('id', mention.note_id)
            .single()

          if (note) {
            addMention({
              id: mention.id,
              type: 'mention',
              title: `${note.profiles?.full_name || 'Someone'} mentioned you`,
              message: note.content_plain.slice(0, 100),
              conversation_id: note.conversation_id,
              note_id: note.id,
              mentioning_user: {
                id: note.profiles?.id || '',
                full_name: note.profiles?.full_name || null,
                avatar_url: note.profiles?.avatar_url || null,
              },
              created_at: mention.created_at,
              viewed: false,
            })
          }
        }
      )
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'mentions',
          filter: `mentioned_user_id=eq.${userId}`,
        },
        (payload) => {
          // Decrement count when viewed_at changes from null
          const newRow = payload.new as any
          const oldRow = payload.old as any
          if (newRow.viewed_at && !oldRow.viewed_at) {
            setUnreadCount((prev: number) => Math.max(0, prev - 1))
          }
        }
      )
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [userId, addMention, setUnreadCount])

  return null // Invisible subscriber component
}
```

**notification-badge.tsx:**
```typescript
'use client'

import { Bell } from 'lucide-react'
import { useNotificationStore } from '@/stores/notifications'

interface NotificationBadgeProps {
  onClick?: () => void
}

export function NotificationBadge({ onClick }: NotificationBadgeProps) {
  const unreadCount = useNotificationStore((state) => state.unreadMentionCount)

  return (
    <button
      onClick={onClick}
      className="relative p-2 rounded-lg hover:bg-gray-100"
      aria-label={`Notifications, ${unreadCount} unread`}
    >
      <Bell className="h-5 w-5 text-gray-600" />
      {unreadCount > 0 && (
        <span
          className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
          aria-live="polite"
        >
          {unreadCount > 99 ? '99+' : unreadCount}
        </span>
      )}
    </button>
  )
}
```
  </action>
  <verify>
```bash
npm run type-check
```
Components compile without errors.
  </verify>
  <done>Realtime subscription and badge components ready</done>
</task>

<task type="auto">
  <name>Task 3: Create API endpoint to mark mention as viewed</name>
  <files>src/app/api/mentions/[id]/viewed/route.ts</files>
  <action>
Create API to mark mention as viewed:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import {
  requireAuthenticatedUser,
  getUserOrganization,
  createSuccessResponse,
  createErrorResponse,
} from '@/lib/api-utils'

export const dynamic = 'force-dynamic'

// Mark mention as viewed
export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id: mentionId } = await params
    const user = await requireAuthenticatedUser()
    const userOrg = await getUserOrganization(user.id)

    const supabase = await createClient()

    // Update mention only if it belongs to the current user
    const { data, error } = await supabase
      .from('mentions')
      .update({ viewed_at: new Date().toISOString() })
      .eq('id', mentionId)
      .eq('mentioned_user_id', user.id)
      .eq('organization_id', userOrg.organization_id)
      .is('viewed_at', null) // Only update if not already viewed
      .select()
      .single()

    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
      throw error
    }

    if (!data) {
      return NextResponse.json(
        { error: 'Mention not found or already viewed' },
        { status: 404 }
      )
    }

    return createSuccessResponse({ mention: data })
  } catch (error) {
    console.error('Error marking mention as viewed:', error)
    return createErrorResponse(error)
  }
}
```

Create parent directory structure if needed:
- src/app/api/mentions/[id]/viewed/route.ts
  </action>
  <verify>
```bash
npm run type-check
```
API route compiles.
  </verify>
  <done>Mark-as-viewed API endpoint created</done>
</task>

</tasks>

<verification>
1. MentionSubscriber receives INSERT events via Realtime
2. Badge count updates within 2 seconds of mention
3. Mark-as-viewed API updates database
4. Badge decrements when mention viewed
5. aria-live attribute announces badge changes
</verification>

<success_criteria>
- Real-time subscription active for current user
- Badge shows unread count
- Count updates in <2 seconds
- Mark-as-viewed API works
- Accessible announcements for screen readers
</success_criteria>

<output>
After completion, create `.planning/phases/11-team-collaboration/11-04-SUMMARY.md`
</output>
