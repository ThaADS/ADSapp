---
phase: 11-team-collaboration
plan: 02
type: execute
wave: 2
depends_on: []
files_modified:
  - src/components/inbox/mention-editor.tsx
  - src/components/inbox/mention-list.tsx
  - src/components/inbox/mention-suggestion.ts
autonomous: true

must_haves:
  truths:
    - "User can type @ and see team member suggestions"
    - "Dropdown is keyboard navigable (arrow keys + enter)"
    - "Screen reader announces suggestions correctly"
  artifacts:
    - path: "src/components/inbox/mention-editor.tsx"
      provides: "Tiptap editor with @mention extension"
      min_lines: 80
    - path: "src/components/inbox/mention-list.tsx"
      provides: "Accessible suggestion dropdown component"
      contains: "role=\"listbox\""
    - path: "src/components/inbox/mention-suggestion.ts"
      provides: "Suggestion configuration for Tiptap"
      exports: ["suggestion"]
  key_links:
    - from: "mention-editor.tsx"
      to: "/api/team/members"
      via: "fetch in suggestion items"
      pattern: "fetch.*api/team/members"
---

<objective>
Create Tiptap rich text editor with @mention functionality and accessible suggestion dropdown.

Purpose: Enable users to type @ and see autocomplete suggestions of team members, with full keyboard navigation and screen reader support (WAI-ARIA combobox pattern).

Output: MentionEditor component ready to replace plain textarea in conversation notes.
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-team-collaboration/11-RESEARCH.md
@src/components/inbox/conversation-notes.tsx
@src/app/api/team/members/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Tiptap dependencies</name>
  <files>package.json</files>
  <action>
Install Tiptap packages:

```bash
npm install @tiptap/react @tiptap/extension-mention @tiptap/suggestion @tiptap/starter-kit @tiptap/pm tippy.js
```

Note: tippy.js is still needed for positioning the suggestion popup in Tiptap 2.x (research note about v3 removing it applies to future version).

Verify packages added to package.json dependencies.
  </action>
  <verify>
```bash
npm ls @tiptap/react @tiptap/extension-mention
```
Both packages installed and resolvable.
  </verify>
  <done>Tiptap packages installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create accessible MentionList dropdown component</name>
  <files>src/components/inbox/mention-list.tsx</files>
  <action>
Create WAI-ARIA compliant suggestion dropdown:

```typescript
'use client'

import { forwardRef, useEffect, useImperativeHandle, useState } from 'react'
import type { SuggestionProps } from '@tiptap/suggestion'
import { MentionSuggestion } from '@/types/mentions'

interface MentionListProps extends SuggestionProps {
  items: MentionSuggestion[]
}

export const MentionList = forwardRef<any, MentionListProps>((props, ref) => {
  const [selectedIndex, setSelectedIndex] = useState(0)

  // Implementation with:
  // - role="listbox" on container
  // - role="option" on each item
  // - aria-selected on highlighted item
  // - aria-label for context
  // - Avatar image (if available), full_name, role display
  // - Keyboard handlers: ArrowUp, ArrowDown, Enter, Escape
  // - Click handler to select item
  // - Empty state message

  useImperativeHandle(ref, () => ({
    onKeyDown: ({ event }: { event: KeyboardEvent }) => {
      // Handle ArrowUp, ArrowDown, Enter
      // Return true if handled, false otherwise
    },
  }))

  return (
    <div
      className="mention-dropdown bg-white rounded-lg shadow-lg border max-h-64 overflow-y-auto"
      role="listbox"
      aria-label="Team member suggestions"
    >
      {/* Map items with proper ARIA attributes */}
    </div>
  )
})

MentionList.displayName = 'MentionList'
```

Include Tailwind styling:
- White background, rounded corners, shadow
- Hover state on items
- Selected item highlight (bg-emerald-50)
- Avatar as 32x32 circle, fallback to initials
- Name in semibold, role in gray text
  </action>
  <verify>
Component exports without TypeScript errors:
```bash
npm run type-check
```
  </verify>
  <done>MentionList component renders with full accessibility attributes</done>
</task>

<task type="auto">
  <name>Task 3: Create suggestion configuration and MentionEditor component</name>
  <files>
src/components/inbox/mention-suggestion.ts
src/components/inbox/mention-editor.tsx
  </files>
  <action>
**mention-suggestion.ts:**
Create Tiptap suggestion configuration that:
- Fetches team members from `/api/team/members?search={query}`
- Filters client-side by full_name (secondary filter)
- Limits to 5 suggestions
- Uses ReactRenderer with MentionList component
- Uses tippy.js for positioning (bottom-start placement)
- Handles onStart, onUpdate, onKeyDown, onExit lifecycle

**mention-editor.tsx:**
Create Tiptap editor component:

```typescript
'use client'

import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import Mention from '@tiptap/extension-mention'
import { suggestion } from './mention-suggestion'

interface MentionEditorProps {
  onSubmit: (html: string, plainText: string) => void
  placeholder?: string
  disabled?: boolean
}

export function MentionEditor({ onSubmit, placeholder, disabled }: MentionEditorProps) {
  const editor = useEditor({
    extensions: [
      StarterKit.configure({
        // Disable features not needed for notes
        heading: false,
        blockquote: false,
        codeBlock: false,
        horizontalRule: false,
      }),
      Mention.configure({
        HTMLAttributes: {
          class: 'mention',
          'data-type': 'mention',
        },
        suggestion,
        renderText({ node }) {
          return `@${node.attrs.label}`
        },
      }),
    ],
    immediatelyRender: false, // CRITICAL for Next.js SSR
    content: '',
    editorProps: {
      attributes: {
        class: 'prose prose-sm focus:outline-none min-h-[80px] px-3 py-2',
        'aria-label': 'Note editor with @mention support',
      },
    },
  })

  const handleSubmit = () => {
    if (!editor || !editor.getText().trim()) return
    const html = editor.getHTML()
    const plainText = editor.getText()
    onSubmit(html, plainText)
    editor.commands.clearContent()
  }

  return (
    <div className="mention-editor-wrapper">
      <EditorContent editor={editor} />
      {/* Submit button handled by parent */}
    </div>
  )
}
```

Add CSS for mention styling in the component or global CSS:
```css
.mention {
  background-color: #e0f2fe; /* sky-100 */
  color: #0369a1; /* sky-700 */
  border-radius: 4px;
  padding: 2px 4px;
  font-weight: 500;
  cursor: pointer;
}
.mention:hover {
  background-color: #bae6fd; /* sky-200 */
}
```
  </action>
  <verify>
1. TypeScript compiles:
```bash
npm run type-check
```
2. Component can be imported without runtime errors
  </verify>
  <done>MentionEditor component renders Tiptap with @mention autocomplete</done>
</task>

</tasks>

<verification>
1. Tiptap packages installed
2. Typing @ triggers suggestion dropdown
3. Arrow keys navigate suggestions
4. Enter/click selects suggestion
5. Mention inserted with data-id and data-label attributes
6. Screen reader announces "Team member suggestions" on dropdown
</verification>

<success_criteria>
- MentionEditor component exists and renders Tiptap editor
- @ trigger shows team member dropdown
- Keyboard navigation works (up/down/enter/escape)
- WAI-ARIA attributes present (role="listbox", role="option", aria-selected)
- Mentions render with sky-blue background styling
</success_criteria>

<output>
After completion, create `.planning/phases/11-team-collaboration/11-02-SUMMARY.md`
</output>
