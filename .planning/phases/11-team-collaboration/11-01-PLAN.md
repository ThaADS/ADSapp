---
phase: 11-team-collaboration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260125_team_mentions.sql
  - src/types/mentions.ts
autonomous: true

must_haves:
  truths:
    - "conversation_notes table exists with RLS policies"
    - "mentions table exists with RLS policies"
    - "Realtime publication enabled for mentions table"
  artifacts:
    - path: "supabase/migrations/20260125_team_mentions.sql"
      provides: "Database schema for notes and mentions"
      contains: "CREATE TABLE conversation_notes"
    - path: "src/types/mentions.ts"
      provides: "TypeScript types for mentions system"
      exports: ["ConversationNote", "Mention", "MentionNotification"]
  key_links:
    - from: "conversation_notes"
      to: "conversations"
      via: "conversation_id foreign key"
      pattern: "REFERENCES conversations\\(id\\)"
    - from: "mentions"
      to: "conversation_notes"
      via: "note_id foreign key"
      pattern: "REFERENCES conversation_notes\\(id\\)"
---

<objective>
Create database schema for team mentions including conversation_notes and mentions tables with RLS policies.

Purpose: Foundation layer for the @mention system - relational tables replace JSONB notes array, enable tracking mention relationships and notification state.

Output: Database migration and TypeScript types ready for API implementation.
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-team-collaboration/11-RESEARCH.md
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for conversation_notes and mentions tables</name>
  <files>supabase/migrations/20260125_team_mentions.sql</files>
  <action>
Create migration with:

1. **conversation_notes table:**
   - id UUID PRIMARY KEY
   - conversation_id UUID NOT NULL (FK to conversations)
   - organization_id UUID NOT NULL (FK to organizations)
   - content TEXT NOT NULL (HTML with mention data attributes)
   - content_plain TEXT NOT NULL (plain text for search/preview)
   - created_by UUID NOT NULL (FK to profiles)
   - created_at, updated_at TIMESTAMPTZ
   - Composite FK constraint on (conversation_id, organization_id)

2. **mentions table:**
   - id UUID PRIMARY KEY
   - note_id UUID NOT NULL (FK to conversation_notes ON DELETE CASCADE)
   - conversation_id UUID NOT NULL (FK to conversations)
   - organization_id UUID NOT NULL (FK to organizations)
   - mentioned_user_id UUID NOT NULL (FK to profiles)
   - mentioning_user_id UUID NOT NULL (FK to profiles)
   - viewed_at TIMESTAMPTZ (nullable - tracks when user saw mention)
   - email_sent_at TIMESTAMPTZ (nullable - tracks email notification)
   - created_at TIMESTAMPTZ
   - UNIQUE(note_id, mentioned_user_id) - one mention record per user per note

3. **Indexes:**
   - idx_conversation_notes_conversation ON conversation_notes(conversation_id)
   - idx_conversation_notes_org ON conversation_notes(organization_id)
   - idx_mentions_mentioned_user ON mentions(mentioned_user_id) WHERE viewed_at IS NULL
   - idx_mentions_email_pending ON mentions(mentioned_user_id, created_at) WHERE email_sent_at IS NULL

4. **RLS Policies:**
   - conversation_notes: SELECT/INSERT/UPDATE/DELETE only where organization_id matches user's org
   - mentions: SELECT/INSERT/UPDATE only where organization_id matches user's org

5. **Realtime:**
   - ALTER PUBLICATION supabase_realtime ADD TABLE mentions;

6. **Updated_at trigger:**
   - Apply existing update_updated_at_column() trigger to conversation_notes

Do NOT create data migration from JSONB - that will be a separate manual step after verification.
  </action>
  <verify>
Migration applies successfully:
```bash
npx supabase migration list --linked
```
Verify tables exist in Supabase dashboard or via SQL query.
  </verify>
  <done>conversation_notes and mentions tables exist with RLS policies and Realtime enabled</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for mentions system</name>
  <files>src/types/mentions.ts</files>
  <action>
Create TypeScript types:

```typescript
// Conversation note (stored in database)
export interface ConversationNote {
  id: string
  conversation_id: string
  organization_id: string
  content: string // HTML with mention data attributes
  content_plain: string // Plain text for search/preview
  created_by: string
  created_at: string
  updated_at: string
  // Joined data
  profiles?: {
    full_name: string | null
    avatar_url: string | null
  }
}

// Mention record (for tracking notification state)
export interface Mention {
  id: string
  note_id: string
  conversation_id: string
  organization_id: string
  mentioned_user_id: string
  mentioning_user_id: string
  viewed_at: string | null
  email_sent_at: string | null
  created_at: string
}

// Notification payload for real-time updates
export interface MentionNotification {
  id: string
  type: 'mention'
  title: string
  message: string // Truncated note content
  conversation_id: string
  note_id: string
  mentioning_user: {
    id: string
    full_name: string | null
    avatar_url: string | null
  }
  created_at: string
  viewed: boolean
}

// Team member for mention suggestions
export interface MentionSuggestion {
  id: string
  full_name: string | null
  email: string
  avatar_url: string | null
  role: string
}

// Create note request body
export interface CreateNoteRequest {
  content: string // HTML from Tiptap
}

// Create note response
export interface CreateNoteResponse {
  note: ConversationNote
  mentions_created: number
}
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npm run type-check
```
  </verify>
  <done>Types exported and available for import in API routes and components</done>
</task>

</tasks>

<verification>
1. Migration file exists and is valid SQL
2. Tables queryable via Supabase client
3. RLS policies block cross-org access
4. Realtime enabled on mentions table
5. TypeScript types compile without errors
</verification>

<success_criteria>
- conversation_notes table created with all columns
- mentions table created with all columns
- RLS policies active on both tables
- Realtime publication includes mentions
- TypeScript types exported from src/types/mentions.ts
</success_criteria>

<output>
After completion, create `.planning/phases/11-team-collaboration/11-01-SUMMARY.md`
</output>
