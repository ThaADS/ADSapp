---
phase: 11-team-collaboration
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/app/api/conversations/[id]/notes/route.ts
  - src/app/api/conversations/[id]/notes/[noteId]/route.ts
  - src/lib/mentions/parser.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/conversations/[id]/notes creates note in conversation_notes table"
    - "Mention records are created for each @mention in the note"
    - "Self-mentions are ignored (user cannot mention themselves)"
  artifacts:
    - path: "src/app/api/conversations/[id]/notes/route.ts"
      provides: "Notes API using new relational tables"
      exports: ["GET", "POST"]
    - path: "src/lib/mentions/parser.ts"
      provides: "HTML parsing for mention extraction"
      exports: ["extractMentionIds", "stripHtml"]
  key_links:
    - from: "notes/route.ts"
      to: "conversation_notes"
      via: "supabase insert"
      pattern: "from\\('conversation_notes'\\)"
    - from: "notes/route.ts"
      to: "mentions"
      via: "supabase insert"
      pattern: "from\\('mentions'\\)"
---

<objective>
Update Notes API to use new relational tables and create mention records.

Purpose: Migrate from JSONB storage to relational tables, enable mention tracking for notifications and email.

Output: API routes that save notes to conversation_notes table and create mention records.
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-team-collaboration/11-RESEARCH.md
@.planning/phases/11-team-collaboration/11-01-SUMMARY.md
@src/app/api/conversations/[id]/notes/route.ts
@src/types/mentions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mention parsing utilities</name>
  <files>src/lib/mentions/parser.ts</files>
  <action>
Create utilities for extracting mentions from Tiptap HTML:

```typescript
import { JSDOM } from 'jsdom'

/**
 * Extract user IDs from Tiptap mention HTML
 * Mentions are formatted as: <span data-type="mention" data-id="user-id" data-label="Name">@Name</span>
 */
export function extractMentionIds(html: string): string[] {
  const dom = new JSDOM(html)
  const doc = dom.window.document
  const mentions = doc.querySelectorAll('span[data-type="mention"][data-id]')

  const ids = new Set<string>()
  mentions.forEach((el) => {
    const id = el.getAttribute('data-id')
    if (id) ids.add(id)
  })

  return Array.from(ids)
}

/**
 * Strip HTML tags for plain text preview
 */
export function stripHtml(html: string): string {
  const dom = new JSDOM(html)
  return dom.window.document.body.textContent || ''
}

/**
 * Sanitize HTML content (basic - remove scripts, etc.)
 * For production, consider DOMPurify
 */
export function sanitizeNoteHtml(html: string): string {
  const dom = new JSDOM(html)
  const doc = dom.window.document

  // Remove script tags
  doc.querySelectorAll('script').forEach(el => el.remove())

  // Remove event handlers
  const allElements = doc.querySelectorAll('*')
  allElements.forEach(el => {
    Array.from(el.attributes).forEach(attr => {
      if (attr.name.startsWith('on')) {
        el.removeAttribute(attr.name)
      }
    })
  })

  return doc.body.innerHTML
}
```

Note: jsdom is already installed (used in tests). If needed for server-side, verify availability.
  </action>
  <verify>
```bash
npm run type-check
```
Functions compile and are importable.
  </verify>
  <done>Mention parser utilities exported and ready for use</done>
</task>

<task type="auto">
  <name>Task 2: Update Notes API routes to use relational tables</name>
  <files>
src/app/api/conversations/[id]/notes/route.ts
src/app/api/conversations/[id]/notes/[noteId]/route.ts
  </files>
  <action>
**Update GET /api/conversations/[id]/notes:**
- Query from `conversation_notes` table instead of JSONB
- Join with `profiles` table to get created_by_name
- Order by created_at DESC
- Return array of ConversationNote objects

**Update POST /api/conversations/[id]/notes:**
```typescript
export async function POST(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  try {
    const { id: conversationId } = await params
    const user = await requireAuthenticatedUser()
    const userOrg = await getUserOrganization(user.id)
    const organizationId = userOrg.organization_id

    const body = await request.json()
    const { content } = body  // HTML from Tiptap

    if (!content?.trim()) {
      return NextResponse.json({ error: 'Note content is required' }, { status: 400 })
    }

    const supabase = await createClient()

    // Verify conversation access
    const { data: conversation } = await supabase
      .from('conversations')
      .select('id')
      .eq('id', conversationId)
      .eq('organization_id', organizationId)
      .single()

    if (!conversation) {
      return NextResponse.json({ error: 'Conversation not found' }, { status: 404 })
    }

    // Parse and sanitize content
    const sanitizedContent = sanitizeNoteHtml(content)
    const plainText = stripHtml(sanitizedContent)
    const mentionedUserIds = extractMentionIds(sanitizedContent)

    // Insert note
    const { data: note, error: noteError } = await supabase
      .from('conversation_notes')
      .insert({
        conversation_id: conversationId,
        organization_id: organizationId,
        content: sanitizedContent,
        content_plain: plainText,
        created_by: user.id,
      })
      .select(`
        *,
        profiles:created_by (full_name, avatar_url)
      `)
      .single()

    if (noteError) throw noteError

    // Create mention records (skip self-mentions)
    let mentionsCreated = 0
    for (const mentionedUserId of mentionedUserIds) {
      if (mentionedUserId === user.id) continue  // Skip self-mention

      const { error: mentionError } = await supabase
        .from('mentions')
        .insert({
          note_id: note.id,
          conversation_id: conversationId,
          organization_id: organizationId,
          mentioned_user_id: mentionedUserId,
          mentioning_user_id: user.id,
        })

      if (!mentionError) mentionsCreated++
    }

    return createSuccessResponse({
      note,
      mentions_created: mentionsCreated
    }, 201)
  } catch (error) {
    console.error('Error creating note:', error)
    return createErrorResponse(error)
  }
}
```

**Update [noteId]/route.ts:**
- GET: Query from conversation_notes by id
- PUT: Update content and content_plain (mentions are immutable - don't update mention records)
- DELETE: Cascade delete will remove mention records automatically
  </action>
  <verify>
1. TypeScript compiles:
```bash
npm run type-check
```
2. API returns proper structure (test manually or via curl)
  </verify>
  <done>Notes API saves to relational tables and creates mention records</done>
</task>

</tasks>

<verification>
1. POST creates row in conversation_notes table
2. POST creates rows in mentions table for each @mention
3. Self-mentions are not created
4. GET returns notes with profile info
5. DELETE cascades to remove mention records
</verification>

<success_criteria>
- Notes stored in conversation_notes table (not JSONB)
- Mention records created on note creation
- Self-mentions filtered out
- API response includes mentions_created count
</success_criteria>

<output>
After completion, create `.planning/phases/11-team-collaboration/11-03-SUMMARY.md`
</output>
