---
phase: 11-team-collaboration
plan: 05
type: execute
wave: 3
depends_on: ["11-01", "11-03"]
files_modified:
  - src/lib/queues/mention-email-queue.ts
  - src/app/api/cron/mention-emails/route.ts
  - src/emails/mention-notification.tsx
autonomous: true

must_haves:
  truths:
    - "Email sent 5 minutes after mention if not viewed"
    - "Email NOT sent if mention was viewed before 5 minutes"
    - "Max 1 email per conversation per hour per user"
  artifacts:
    - path: "src/lib/queues/mention-email-queue.ts"
      provides: "BullMQ job queue for delayed emails"
      exports: ["emailQueue", "scheduleMentionEmail"]
    - path: "src/app/api/cron/mention-emails/route.ts"
      provides: "Cron endpoint to process pending emails"
      exports: ["GET"]
    - path: "src/emails/mention-notification.tsx"
      provides: "Email template for mention notification"
      exports: ["MentionNotificationEmail"]
  key_links:
    - from: "mention-email-queue.ts"
      to: "mentions"
      via: "check viewed_at before send"
      pattern: "viewed_at"
    - from: "cron/mention-emails/route.ts"
      to: "emailQueue"
      via: "process pending jobs"
      pattern: "emailQueue"
---

<objective>
Implement delayed email notifications for mentions using BullMQ job queue.

Purpose: Mentioned users who don't view the mention within 5 minutes receive email notification (MENT-03 requirement).

Output: Email queue system with delay, deduplication, and rate limiting.
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-team-collaboration/11-RESEARCH.md
@.planning/phases/11-team-collaboration/11-01-SUMMARY.md
@.planning/phases/11-team-collaboration/11-03-SUMMARY.md
@package.json (bullmq and ioredis already installed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email template for mention notifications</name>
  <files>src/emails/mention-notification.tsx</files>
  <action>
Create React Email template for mention notifications:

```typescript
import * as React from 'react'

interface MentionNotificationEmailProps {
  recipientName: string
  mentionerName: string
  notePreview: string
  conversationUrl: string
}

export function MentionNotificationEmail({
  recipientName,
  mentionerName,
  notePreview,
  conversationUrl,
}: MentionNotificationEmailProps) {
  return (
    <html>
      <head>
        <meta charSet="UTF-8" />
        <title>You were mentioned</title>
      </head>
      <body style={{ fontFamily: 'Arial, sans-serif', lineHeight: 1.6, color: '#333' }}>
        <div style={{ maxWidth: '600px', margin: '0 auto', padding: '20px' }}>
          <h1 style={{ color: '#059669', fontSize: '24px', marginBottom: '20px' }}>
            You were mentioned
          </h1>

          <p>Hi {recipientName},</p>

          <p>
            <strong>{mentionerName}</strong> mentioned you in a conversation note:
          </p>

          <blockquote
            style={{
              background: '#f3f4f6',
              borderLeft: '4px solid #059669',
              margin: '20px 0',
              padding: '15px',
              borderRadius: '4px',
            }}
          >
            {notePreview}
          </blockquote>

          <p>
            <a
              href={conversationUrl}
              style={{
                display: 'inline-block',
                background: '#059669',
                color: 'white',
                padding: '12px 24px',
                borderRadius: '6px',
                textDecoration: 'none',
                fontWeight: 'bold',
              }}
            >
              View Conversation
            </a>
          </p>

          <hr style={{ border: 'none', borderTop: '1px solid #e5e7eb', margin: '30px 0' }} />

          <p style={{ fontSize: '12px', color: '#6b7280' }}>
            You received this email because you were @mentioned in ADSapp.
            <br />
            To manage your notification preferences, visit your account settings.
          </p>
        </div>
      </body>
    </html>
  )
}

export function renderMentionNotificationEmail(props: MentionNotificationEmailProps): string {
  // Simple render for Resend (can use @react-email/render if needed)
  const { recipientName, mentionerName, notePreview, conversationUrl } = props

  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>You were mentioned</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <h1 style="color: #059669; font-size: 24px; margin-bottom: 20px;">
      You were mentioned
    </h1>

    <p>Hi ${recipientName},</p>

    <p><strong>${mentionerName}</strong> mentioned you in a conversation note:</p>

    <blockquote style="background: #f3f4f6; border-left: 4px solid #059669; margin: 20px 0; padding: 15px; border-radius: 4px;">
      ${notePreview}
    </blockquote>

    <p>
      <a href="${conversationUrl}" style="display: inline-block; background: #059669; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: bold;">
        View Conversation
      </a>
    </p>

    <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">

    <p style="font-size: 12px; color: #6b7280;">
      You received this email because you were @mentioned in ADSapp.
      <br>
      To manage your notification preferences, visit your account settings.
    </p>
  </div>
</body>
</html>
  `
}
```
  </action>
  <verify>
```bash
npm run type-check
```
Template compiles and exports render function.
  </verify>
  <done>Email template created for mention notifications</done>
</task>

<task type="auto">
  <name>Task 2: Create BullMQ email queue with delay and deduplication</name>
  <files>src/lib/queues/mention-email-queue.ts</files>
  <action>
Create BullMQ queue for delayed mention emails:

```typescript
import { Queue, Worker, Job } from 'bullmq'
import { Redis } from 'ioredis'
import { Resend } from 'resend'
import { createServiceRoleClient } from '@/lib/supabase/server'
import { renderMentionNotificationEmail } from '@/emails/mention-notification'

// Redis connection (use REDIS_URL env var)
const connection = new Redis(process.env.REDIS_URL || 'redis://localhost:6379', {
  maxRetriesPerRequest: null,
})

const resend = new Resend(process.env.RESEND_API_KEY)

// Job data interface
interface MentionEmailJobData {
  mentionId: string
  mentionedUserId: string
  conversationId: string
  noteContent: string
  mentionerName: string
  // For rate limiting
  rateLimitKey: string // Format: email-{conversationId}-{userId}
}

// Queue for delayed email jobs
export const emailQueue = new Queue<MentionEmailJobData>('mention-emails', {
  connection,
  defaultJobOptions: {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 5000,
    },
    removeOnComplete: 100, // Keep last 100 completed
    removeOnFail: 500,     // Keep last 500 failed
  },
})

// Worker processes jobs
export const emailWorker = new Worker<MentionEmailJobData>(
  'mention-emails',
  async (job: Job<MentionEmailJobData>) => {
    const { mentionId, mentionedUserId, conversationId, noteContent, mentionerName } = job.data

    const supabase = createServiceRoleClient()

    // Check if mention has been viewed or email already sent
    const { data: mention, error: mentionError } = await supabase
      .from('mentions')
      .select('viewed_at, email_sent_at')
      .eq('id', mentionId)
      .single()

    if (mentionError) {
      console.error('Failed to fetch mention:', mentionError)
      throw mentionError
    }

    // Skip if already viewed or email sent
    if (mention?.viewed_at || mention?.email_sent_at) {
      return { skipped: true, reason: mention.viewed_at ? 'viewed' : 'already_sent' }
    }

    // Get user's email
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('email, full_name')
      .eq('id', mentionedUserId)
      .single()

    if (profileError || !profile?.email) {
      return { skipped: true, reason: 'no_email' }
    }

    // Generate email content
    const conversationUrl = `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/inbox/${conversationId}`
    const emailHtml = renderMentionNotificationEmail({
      recipientName: profile.full_name || 'there',
      mentionerName,
      notePreview: noteContent.slice(0, 200) + (noteContent.length > 200 ? '...' : ''),
      conversationUrl,
    })

    // Send email via Resend
    const { data: emailResult, error: emailError } = await resend.emails.send({
      from: process.env.RESEND_FROM_EMAIL || 'notifications@example.com',
      to: profile.email,
      subject: `${mentionerName} mentioned you in a conversation`,
      html: emailHtml,
    })

    if (emailError) {
      console.error('Failed to send mention email:', emailError)
      throw emailError
    }

    // Mark email as sent
    await supabase
      .from('mentions')
      .update({ email_sent_at: new Date().toISOString() })
      .eq('id', mentionId)

    return { sent: true, messageId: emailResult?.id }
  },
  {
    connection,
    concurrency: 5, // Process 5 jobs in parallel
  }
)

// Track recent emails per conversation-user for rate limiting
const recentEmails = new Map<string, number>()

/**
 * Schedule delayed email for a mention
 * Rate limited: max 1 email per conversation per hour per user
 */
export async function scheduleMentionEmail(
  mentionId: string,
  mentionedUserId: string,
  conversationId: string,
  noteContent: string,
  mentionerName: string
): Promise<{ scheduled: boolean; reason?: string }> {
  // Rate limit key
  const rateLimitKey = `email-${conversationId}-${mentionedUserId}`

  // Check if email was sent recently (within 1 hour)
  const lastSent = recentEmails.get(rateLimitKey)
  const oneHourAgo = Date.now() - 60 * 60 * 1000

  if (lastSent && lastSent > oneHourAgo) {
    return { scheduled: false, reason: 'rate_limited' }
  }

  // Schedule email for 5 minutes from now
  await emailQueue.add(
    'mention-email',
    {
      mentionId,
      mentionedUserId,
      conversationId,
      noteContent,
      mentionerName,
      rateLimitKey,
    },
    {
      delay: 5 * 60 * 1000, // 5 minutes
      jobId: `mention-${mentionId}`, // Prevent duplicate jobs for same mention
    }
  )

  // Update rate limit tracker
  recentEmails.set(rateLimitKey, Date.now())

  // Clean old entries from rate limit map (prevent memory leak)
  if (recentEmails.size > 10000) {
    for (const [key, time] of recentEmails) {
      if (time < oneHourAgo) {
        recentEmails.delete(key)
      }
    }
  }

  return { scheduled: true }
}

/**
 * Cancel pending email when mention is viewed
 */
export async function cancelMentionEmail(mentionId: string): Promise<void> {
  try {
    const job = await emailQueue.getJob(`mention-${mentionId}`)
    if (job) {
      await job.remove()
    }
  } catch (error) {
    console.error('Failed to cancel mention email job:', error)
  }
}
```

Note: This requires REDIS_URL and RESEND_FROM_EMAIL environment variables.
  </action>
  <verify>
```bash
npm run type-check
```
Queue and worker compile without errors.
  </verify>
  <done>BullMQ queue created with 5-minute delay and rate limiting</done>
</task>

<task type="auto">
  <name>Task 3: Integrate email scheduling into notes API</name>
  <files>src/app/api/conversations/[id]/notes/route.ts</files>
  <action>
Update the POST handler to schedule email after creating mention records:

Add import at top:
```typescript
import { scheduleMentionEmail } from '@/lib/queues/mention-email-queue'
```

After creating mention record in the loop, add:
```typescript
// Schedule delayed email (5 minutes)
const emailResult = await scheduleMentionEmail(
  mention.id,
  mentionedUserId,
  conversationId,
  note.content_plain,
  userOrg.full_name || user.email || 'Someone'
)

if (emailResult.scheduled) {
  console.log(`Email scheduled for mention ${mention.id}`)
}
```

Also update the mark-as-viewed API (src/app/api/mentions/[id]/viewed/route.ts) to cancel pending email:

```typescript
import { cancelMentionEmail } from '@/lib/queues/mention-email-queue'

// After updating viewed_at, cancel pending email
await cancelMentionEmail(mentionId)
```
  </action>
  <verify>
```bash
npm run type-check
```
Integration compiles without errors.
  </verify>
  <done>Email scheduling integrated into notes creation flow</done>
</task>

</tasks>

<verification>
1. Creating a note with @mention schedules email job
2. Email job waits 5 minutes before processing
3. Email NOT sent if mention viewed within 5 minutes
4. Rate limiting prevents >1 email per conversation/user/hour
5. Email contains correct preview and link
</verification>

<success_criteria>
- BullMQ queue processes mention email jobs
- 5-minute delay before sending
- Viewed mentions skip email
- Rate limiting active (1/hour per conversation per user)
- Email template renders correctly
</success_criteria>

<output>
After completion, create `.planning/phases/11-team-collaboration/11-05-SUMMARY.md`
</output>
