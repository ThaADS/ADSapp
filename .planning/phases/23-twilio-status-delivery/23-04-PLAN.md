# Plan 23-04: Failed Message Retry API

## Overview
Create API for retrying failed messages with proper error handling.

## Requirements Addressed
- TWWS-02: Failed message error display with retry option

## Deliverables

### 1. Retry Message API
**File:** `src/app/api/messages/[id]/retry/route.ts`

```typescript
// POST /api/messages/[id]/retry
// Retry sending a failed message
{
  success: true,
  newMessageId: 'uuid',
  newChannelMessageId: 'SMxxxxxxxx'
}
```

### 2. Retry Logic
- Validate message is in failed/undelivered state
- Create new message record (preserve original for history)
- Resend via TwilioWhatsAppClient
- Update original message metadata with retry reference

### 3. Error Code Mapping
**File:** `src/lib/integrations/twilio-whatsapp/error-codes.ts`

Map Twilio error codes to user-friendly messages:
```typescript
export const TWILIO_ERROR_MESSAGES: Record<string, TwilioErrorInfo> = {
  '63001': {
    code: '63001',
    message: 'Invalid phone number',
    userMessage: 'The recipient phone number is invalid or not registered on WhatsApp.',
    retryable: false,
  },
  '63003': {
    code: '63003',
    message: 'Rate limit exceeded',
    userMessage: 'Too many messages sent. Please wait a moment and try again.',
    retryable: true,
    retryAfterSeconds: 60,
  },
  // ... more codes
}
```

### 4. Bulk Retry API
**File:** `src/app/api/conversations/[id]/messages/retry-failed/route.ts`

Retry all failed messages in a conversation:
```typescript
// POST /api/conversations/[id]/messages/retry-failed
{
  retried: 3,
  failed: 1,
  results: [...]
}
```

## Acceptance Criteria
- [x] Single message retry endpoint
- [x] Bulk retry endpoint for conversation
- [x] Error code mapping with user messages
- [x] Retryable vs non-retryable distinction
- [x] Original message preserved for history

## Dependencies
- Plan 23-02 (error codes captured)
- Plan 23-03 (status API works)
