# Plan 23-01: Message Status Schema Enhancement

## Overview
Enhance database schema to track complete message status history and timestamps from Twilio.

## Requirements Addressed
- TWWS-03: Accurate timestamps from Twilio stored and displayed

## Deliverables

### 1. Migration: Message Status History Table
Create `twilio_whatsapp_message_status_history` table to track all status transitions.

**File:** `supabase/migrations/20260203_twilio_whatsapp_status.sql`

```sql
-- Message status history for audit trail
CREATE TABLE IF NOT EXISTS twilio_whatsapp_message_status_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  message_id UUID REFERENCES messages(id) ON DELETE CASCADE,
  channel_message_id TEXT NOT NULL, -- Twilio MessageSid
  status TEXT NOT NULL,
  previous_status TEXT,
  error_code TEXT,
  error_message TEXT,
  twilio_timestamp TIMESTAMPTZ, -- Timestamp from Twilio
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX idx_message_status_history_message
  ON twilio_whatsapp_message_status_history(message_id);
CREATE INDEX idx_message_status_history_channel_message
  ON twilio_whatsapp_message_status_history(channel_message_id);
CREATE INDEX idx_message_status_history_org_created
  ON twilio_whatsapp_message_status_history(organization_id, created_at DESC);

-- RLS
ALTER TABLE twilio_whatsapp_message_status_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own org status history"
  ON twilio_whatsapp_message_status_history FOR SELECT
  USING (organization_id IN (
    SELECT organization_id FROM profiles WHERE id = auth.uid()
  ));
```

### 2. Add sent_at column to messages table
```sql
-- Add sent_at if not exists
ALTER TABLE messages
ADD COLUMN IF NOT EXISTS sent_at TIMESTAMPTZ;

-- Index for sent_at queries
CREATE INDEX IF NOT EXISTS idx_messages_sent_at
  ON messages(sent_at) WHERE sent_at IS NOT NULL;
```

### 3. TypeScript Types
Add types for status history to `src/types/twilio-whatsapp.ts`.

## Acceptance Criteria
- [ ] Migration creates status history table with RLS
- [ ] sent_at column added to messages
- [ ] TypeScript types defined for status history
- [ ] Indexes created for query performance

## Dependencies
- Phase 21 complete (base tables exist)
