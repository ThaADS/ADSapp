# Plan 23-02: Enhanced Status Callback Handler

## Overview
Enhance webhook handler to capture Twilio timestamps and record status history.

## Requirements Addressed
- TWWS-01: Status callbacks from Twilio update UI state
- TWWS-03: Accurate timestamps from Twilio

## Deliverables

### 1. Update webhook-handler.ts
Enhance `processStatusCallback` to:
- Record status history entry
- Use Twilio timestamps when available
- Track previous status for transitions

**Updates to:** `src/lib/integrations/twilio-whatsapp/webhook-handler.ts`

```typescript
// Add to processStatusCallback:
// 1. Query current status before update
// 2. Insert status history record
// 3. Use Twilio timestamp from webhook (if available)
```

### 2. Parse Twilio Timestamps
Twilio sends timestamps in specific format. Add parsing:
- `DateCreated` - Message creation time
- `DateSent` - When message was sent
- `DateUpdated` - Last status update time

### 3. Track Error Codes
Common Twilio error codes to handle:
- 63001: Invalid destination number
- 63003: Rate limit exceeded
- 63007: WhatsApp policy violation
- 63016: Message content policy violation
- 30003: Unreachable destination
- 30005: Unknown destination
- 30006: Landline or unreachable

## Acceptance Criteria
- [ ] Status history recorded for each status change
- [ ] Twilio timestamps parsed and stored
- [ ] Previous status tracked in history
- [ ] Error codes and messages captured

## Dependencies
- Plan 23-01 (schema exists)
