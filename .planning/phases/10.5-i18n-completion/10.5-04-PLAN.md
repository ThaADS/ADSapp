---
phase: 10.5-i18n-completion
plan: 04
type: execute
wave: 3
depends_on: ["10.5-02", "10.5-03"]
files_modified:
  - src/lib/email/auth-emails.ts
  - src/lib/email/email-templates.tsx
  - src/app/api/auth/signup/route.ts
  - src/app/api/auth/reset-password/route.ts
  - src/app/api/auth/magic-link/route.ts
autonomous: true

must_haves:
  truths:
    - "Auth emails (confirmation, reset, magic link) are sent in user's preferred language"
    - "Emails use professional branded design with ADSapp logo and colors"
    - "Email content comes from translation files, not hardcoded strings"
  artifacts:
    - path: "src/lib/email/auth-emails.ts"
      provides: "Localized auth email sending functions"
      exports: ["sendConfirmationEmail", "sendPasswordResetEmail", "sendMagicLinkEmail"]
    - path: "src/lib/email/email-templates.tsx"
      provides: "React email template components"
      exports: ["ConfirmationEmail", "PasswordResetEmail", "MagicLinkEmail"]
  key_links:
    - from: "src/lib/email/auth-emails.ts"
      to: "src/locales/*/emails.json"
      via: "translation loading"
      pattern: "getNamespaceDictionary.*emails"
    - from: "src/lib/email/auth-emails.ts"
      to: "Resend API"
      via: "resend.emails.send"
      pattern: "resend\\.emails\\.send"
    - from: "src/app/api/auth/*/route.ts"
      to: "src/lib/email/auth-emails.ts"
      via: "function import and call"
      pattern: "import.*sendConfirmationEmail|sendPasswordResetEmail|sendMagicLinkEmail"
---

<objective>
Create localized auth email templates and sending functions using Resend.

Purpose: Enable localized system emails for email confirmation, password reset, and magic link authentication. Emails display in user's preferred language with professional ADSapp branding.

Output:
- React email template components for auth emails
- Email sending functions that use translations based on locale
- Integration with auth API routes to call these functions

Note on scope: Team member invitation emails are handled by existing `src/lib/email/team-invitations.ts` and are out of scope for this plan. This plan covers auth-triggered emails only (confirmation, password reset, magic link).
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10.5-i18n-completion/10.5-CONTEXT.md
@.planning/phases/10.5-i18n-completion/10.5-RESEARCH.md
@.planning/phases/10.5-i18n-completion/10.5-03-SUMMARY.md

Reference existing email implementation:
@src/lib/email/team-invitations.ts (pattern for Resend usage)
@src/locales/en/emails.json
@src/locales/nl/emails.json
@src/lib/i18n/dictionaries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email template components</name>
  <files>src/lib/email/email-templates.tsx</files>
  <action>
Create src/lib/email/email-templates.tsx with React components for email templates.

Note: We're NOT using react-email library (to avoid adding dependencies). Instead, create simple React functional components that return HTML strings, following the existing pattern in team-invitations.ts.

```typescript
/**
 * Email Template Components
 * Generates branded HTML emails for auth flows with i18n support
 */

import type { Locale } from '@/../i18n.config'

// Brand colors
const BRAND_BLUE = '#2563eb'
const BRAND_BLUE_DARK = '#1d4ed8'
const TEXT_PRIMARY = '#1f2937'
const TEXT_SECONDARY = '#6b7280'
const BG_LIGHT = '#f9fafb'

// Shared email styles
const containerStyle = `
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
  line-height: 1.6;
  color: ${TEXT_PRIMARY};
  max-width: 600px;
  margin: 0 auto;
  padding: 20px;
`

const cardStyle = `
  background-color: #ffffff;
  border-radius: 8px;
  padding: 40px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
`

const buttonStyle = `
  display: inline-block;
  background-color: ${BRAND_BLUE};
  color: #ffffff;
  padding: 14px 32px;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 600;
`

const logoStyle = `
  text-align: center;
  margin-bottom: 30px;
`

const footerStyle = `
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid #e5e7eb;
  font-size: 14px;
  color: ${TEXT_SECONDARY};
`

interface EmailTranslations {
  common: {
    greeting: string
    greetingWithName: string
    regards: string
    team: string
    footer: string
    securityNotice: string
    linkExpiry: string
  }
  [key: string]: unknown
}

interface BaseEmailProps {
  locale: Locale
  translations: EmailTranslations
  actionUrl: string
}

/**
 * Email layout wrapper with ADSapp branding
 */
function emailLayout(content: string, locale: Locale): string {
  return `
<!DOCTYPE html>
<html lang="${locale}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADSapp</title>
</head>
<body style="${containerStyle}">
  <div style="${cardStyle}">
    <div style="${logoStyle}">
      <h1 style="color: ${BRAND_BLUE}; margin: 0; font-size: 28px;">ADSapp</h1>
    </div>
    ${content}
  </div>
</body>
</html>
  `.trim()
}

/**
 * Interpolate parameters into translation string
 */
function interpolate(text: string, params?: Record<string, string | number>): string {
  if (!params) return text
  return text.replace(/\{(\w+)\}/g, (_, key) => params[key]?.toString() ?? `{${key}}`)
}

// Type for email-specific translations
interface ConfirmationTranslations extends EmailTranslations {
  confirmation: {
    subject: string
    title: string
    body: string
    button: string
    linkText: string
    notYou: string
  }
}

export function generateConfirmationEmail(
  translations: ConfirmationTranslations,
  locale: Locale,
  confirmationUrl: string
): string {
  const t = translations.confirmation
  const common = translations.common

  const content = `
    <h2 style="color: ${TEXT_PRIMARY}; margin-bottom: 20px;">${t.title}</h2>
    <p>${common.greeting},</p>
    <p>${t.body}</p>
    <div style="text-align: center; margin: 30px 0;">
      <a href="${confirmationUrl}" style="${buttonStyle}">${t.button}</a>
    </div>
    <p style="font-size: 14px; color: ${TEXT_SECONDARY};">
      ${t.linkText}<br>
      <a href="${confirmationUrl}" style="color: ${BRAND_BLUE}; word-break: break-all;">${confirmationUrl}</a>
    </p>
    <div style="background-color: ${BG_LIGHT}; border-left: 4px solid ${BRAND_BLUE}; padding: 12px 16px; margin: 20px 0; font-size: 14px;">
      ${t.notYou}
    </div>
    <div style="${footerStyle}">
      <p>${common.regards},<br>${common.team}</p>
      <p>${common.footer}</p>
    </div>
  `

  return emailLayout(content, locale)
}

interface PasswordResetTranslations extends EmailTranslations {
  passwordReset: {
    subject: string
    title: string
    body: string
    button: string
    linkText: string
    expiry: string
    notYou: string
  }
}

export function generatePasswordResetEmail(
  translations: PasswordResetTranslations,
  locale: Locale,
  resetUrl: string
): string {
  const t = translations.passwordReset
  const common = translations.common

  const content = `
    <h2 style="color: ${TEXT_PRIMARY}; margin-bottom: 20px;">${t.title}</h2>
    <p>${common.greeting},</p>
    <p>${t.body}</p>
    <div style="text-align: center; margin: 30px 0;">
      <a href="${resetUrl}" style="${buttonStyle}">${t.button}</a>
    </div>
    <p style="font-size: 14px; color: ${TEXT_SECONDARY};">
      ${t.linkText}<br>
      <a href="${resetUrl}" style="color: ${BRAND_BLUE}; word-break: break-all;">${resetUrl}</a>
    </p>
    <div style="background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 16px; margin: 20px 0; font-size: 14px;">
      <strong>⏰</strong> ${t.expiry}
    </div>
    <div style="background-color: ${BG_LIGHT}; border-left: 4px solid ${BRAND_BLUE}; padding: 12px 16px; margin: 20px 0; font-size: 14px;">
      ${t.notYou}
    </div>
    <div style="${footerStyle}">
      <p>${common.regards},<br>${common.team}</p>
      <p>${common.footer}</p>
    </div>
  `

  return emailLayout(content, locale)
}

interface MagicLinkTranslations extends EmailTranslations {
  magicLink: {
    subject: string
    title: string
    body: string
    button: string
    linkText: string
    expiry: string
    notYou: string
  }
}

export function generateMagicLinkEmail(
  translations: MagicLinkTranslations,
  locale: Locale,
  magicLinkUrl: string
): string {
  const t = translations.magicLink
  const common = translations.common

  const content = `
    <h2 style="color: ${TEXT_PRIMARY}; margin-bottom: 20px;">${t.title}</h2>
    <p>${common.greeting},</p>
    <p>${t.body}</p>
    <div style="text-align: center; margin: 30px 0;">
      <a href="${magicLinkUrl}" style="${buttonStyle}">${t.button}</a>
    </div>
    <p style="font-size: 14px; color: ${TEXT_SECONDARY};">
      ${t.linkText}<br>
      <a href="${magicLinkUrl}" style="color: ${BRAND_BLUE}; word-break: break-all;">${magicLinkUrl}</a>
    </p>
    <div style="background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px 16px; margin: 20px 0; font-size: 14px;">
      <strong>⏰</strong> ${t.expiry}
    </div>
    <div style="background-color: ${BG_LIGHT}; border-left: 4px solid ${BRAND_BLUE}; padding: 12px 16px; margin: 20px 0; font-size: 14px;">
      ${t.notYou}
    </div>
    <div style="${footerStyle}">
      <p>${common.regards},<br>${common.team}</p>
      <p>${common.footer}</p>
    </div>
  `

  return emailLayout(content, locale)
}

// Re-export for use in auth-emails.ts
export type { ConfirmationTranslations, PasswordResetTranslations, MagicLinkTranslations }
```
  </action>
  <verify>
1. File exists at src/lib/email/email-templates.tsx
2. `npm run type-check` passes
3. Exports generateConfirmationEmail, generatePasswordResetEmail, generateMagicLinkEmail
  </verify>
  <done>Email template components created with branded HTML and localization support</done>
</task>

<task type="auto">
  <name>Task 2: Create auth email sending functions</name>
  <files>src/lib/email/auth-emails.ts</files>
  <action>
Create src/lib/email/auth-emails.ts with functions to send localized auth emails via Resend.

```typescript
/**
 * Auth Email Service
 * Sends localized authentication emails via Resend
 */

import { Resend } from 'resend'
import type { Locale } from '@/../i18n.config'
import {
  generateConfirmationEmail,
  generatePasswordResetEmail,
  generateMagicLinkEmail,
  type ConfirmationTranslations,
  type PasswordResetTranslations,
  type MagicLinkTranslations,
} from './email-templates'

// Initialize Resend (gracefully handles missing API key)
const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null
const fromEmail = process.env.RESEND_FROM_EMAIL || 'ADSapp <noreply@adsapp.com>'

/**
 * Load email translations for a locale
 */
async function loadEmailTranslations(locale: Locale): Promise<Record<string, unknown>> {
  try {
    const translations = await import(`@/locales/${locale}/emails.json`)
    return translations.default || translations
  } catch (error) {
    console.warn(`Failed to load email translations for ${locale}, falling back to English`)
    const fallback = await import('@/locales/en/emails.json')
    return fallback.default || fallback
  }
}

interface SendConfirmationEmailParams {
  to: string
  locale: Locale
  confirmationUrl: string
}

/**
 * Send email confirmation email
 */
export async function sendConfirmationEmail({
  to,
  locale,
  confirmationUrl,
}: SendConfirmationEmailParams): Promise<void> {
  if (!resend) {
    console.warn('RESEND_API_KEY not configured. Skipping confirmation email to:', to)
    return
  }

  try {
    const translations = await loadEmailTranslations(locale) as ConfirmationTranslations

    const html = generateConfirmationEmail(translations, locale, confirmationUrl)
    const subject = translations.confirmation?.subject || 'Confirm your email address'

    const { error } = await resend.emails.send({
      from: fromEmail,
      to,
      subject,
      html,
      tags: [
        { name: 'category', value: 'auth-confirmation' },
        { name: 'locale', value: locale },
      ],
    })

    if (error) {
      throw new Error(`Failed to send confirmation email: ${error.message}`)
    }
  } catch (error) {
    console.error('Error sending confirmation email:', error)
    throw error
  }
}

interface SendPasswordResetEmailParams {
  to: string
  locale: Locale
  resetUrl: string
}

/**
 * Send password reset email
 */
export async function sendPasswordResetEmail({
  to,
  locale,
  resetUrl,
}: SendPasswordResetEmailParams): Promise<void> {
  if (!resend) {
    console.warn('RESEND_API_KEY not configured. Skipping password reset email to:', to)
    return
  }

  try {
    const translations = await loadEmailTranslations(locale) as PasswordResetTranslations

    const html = generatePasswordResetEmail(translations, locale, resetUrl)
    const subject = translations.passwordReset?.subject || 'Reset your password'

    const { error } = await resend.emails.send({
      from: fromEmail,
      to,
      subject,
      html,
      tags: [
        { name: 'category', value: 'auth-password-reset' },
        { name: 'locale', value: locale },
      ],
    })

    if (error) {
      throw new Error(`Failed to send password reset email: ${error.message}`)
    }
  } catch (error) {
    console.error('Error sending password reset email:', error)
    throw error
  }
}

interface SendMagicLinkEmailParams {
  to: string
  locale: Locale
  magicLinkUrl: string
}

/**
 * Send magic link email
 */
export async function sendMagicLinkEmail({
  to,
  locale,
  magicLinkUrl,
}: SendMagicLinkEmailParams): Promise<void> {
  if (!resend) {
    console.warn('RESEND_API_KEY not configured. Skipping magic link email to:', to)
    return
  }

  try {
    const translations = await loadEmailTranslations(locale) as MagicLinkTranslations

    const html = generateMagicLinkEmail(translations, locale, magicLinkUrl)
    const subject = translations.magicLink?.subject || 'Your sign-in link'

    const { error } = await resend.emails.send({
      from: fromEmail,
      to,
      subject,
      html,
      tags: [
        { name: 'category', value: 'auth-magic-link' },
        { name: 'locale', value: locale },
      ],
    })

    if (error) {
      throw new Error(`Failed to send magic link email: ${error.message}`)
    }
  } catch (error) {
    console.error('Error sending magic link email:', error)
    throw error
  }
}

/**
 * Get user's preferred locale from database or fallback
 * Utility function for auth flows that don't have locale context
 */
export async function getUserLocale(userId: string): Promise<Locale> {
  try {
    const { createClient } = await import('@/lib/supabase/server')
    const supabase = await createClient()

    const { data: profile } = await supabase
      .from('profiles')
      .select('preferred_language')
      .eq('id', userId)
      .single()

    if (profile?.preferred_language === 'nl' || profile?.preferred_language === 'en') {
      return profile.preferred_language
    }
  } catch (error) {
    console.warn('Failed to get user locale:', error)
  }

  return 'en' // Default fallback
}

/**
 * Get locale from email address (for new user registration)
 * Uses browser locale if available via cookie, otherwise defaults to English
 */
export async function getLocaleForNewUser(email: string): Promise<Locale> {
  // For new users, we could:
  // 1. Check if email domain suggests a locale (e.g., .nl domain)
  // 2. Use a cookie set during the signup flow
  // For now, default to English for new users
  // The user can change their preference after signup

  // Simple heuristic: Dutch email domains get Dutch
  if (email.endsWith('.nl') || email.includes('@nl.')) {
    return 'nl'
  }

  return 'en'
}
```
  </action>
  <verify>
1. File exists at src/lib/email/auth-emails.ts
2. `npm run type-check` passes
3. Exports sendConfirmationEmail, sendPasswordResetEmail, sendMagicLinkEmail
4. Functions load translations and use Resend
  </verify>
  <done>Auth email sending functions created with localization and Resend integration</done>
</task>

<task type="auto">
  <name>Task 3: Integrate email functions with auth API routes</name>
  <files>src/app/api/auth/signup/route.ts, src/app/api/auth/reset-password/route.ts, src/app/api/auth/magic-link/route.ts</files>
  <action>
Integrate the new localized email functions into the existing auth API routes.

For each auth route that sends emails:

1. **Signup route (src/app/api/auth/signup/route.ts or similar):**
   - Import sendConfirmationEmail from '@/lib/email/auth-emails'
   - After successful user creation, determine locale using getLocaleForNewUser(email)
   - Call sendConfirmationEmail({ to: email, locale, confirmationUrl })
   - Handle errors gracefully (log but don't fail signup if email fails)

2. **Password reset route (src/app/api/auth/reset-password/route.ts or forgot-password):**
   - Import sendPasswordResetEmail from '@/lib/email/auth-emails'
   - Import getUserLocale from '@/lib/email/auth-emails'
   - Before sending reset email, get locale via getUserLocale(userId) if user exists
   - Call sendPasswordResetEmail({ to: email, locale, resetUrl })

3. **Magic link route (src/app/api/auth/magic-link/route.ts or similar):**
   - Import sendMagicLinkEmail from '@/lib/email/auth-emails'
   - Import getUserLocale from '@/lib/email/auth-emails'
   - Get locale via getUserLocale(userId) if user exists, else use 'en'
   - Call sendMagicLinkEmail({ to: email, locale, magicLinkUrl })

Important notes:
- Check if routes exist first; some may use Supabase Auth directly without custom routes
- If using Supabase Auth's built-in email handling, document this limitation for future migration
- Wrap email sending in try/catch to prevent auth flow failures from email errors
- Log email sending success/failure for debugging

If no custom auth routes exist (relying on Supabase Auth templates), add a note to SUMMARY.md explaining:
- Current state: Using Supabase Auth built-in emails (not localized)
- Created functions: Ready to use when custom auth flows are implemented
- Future work: Replace Supabase Auth emails with custom flows using these functions
  </action>
  <verify>
1. Check which auth routes exist: `ls src/app/api/auth/`
2. For each modified route, ensure imports are added correctly
3. `npm run type-check` passes
4. If routes don't exist, verify SUMMARY.md documents the situation
  </verify>
  <done>Auth API routes call localized email functions, OR documentation explains Supabase Auth limitation</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript:**
   - `npm run type-check` passes

2. **Files exist:**
   - src/lib/email/email-templates.tsx
   - src/lib/email/auth-emails.ts

3. **Code quality:**
   - `npm run lint` passes

4. **Exports:**
   - email-templates.tsx exports generate* functions
   - auth-emails.ts exports send* functions
</verification>

<success_criteria>
1. Email template components generate branded HTML with translations
2. Auth email functions load locale-specific translations
3. Emails are sent via Resend with proper tags
4. TypeScript passes
</success_criteria>

<output>
After completion, create `.planning/phases/10.5-i18n-completion/10.5-04-SUMMARY.md`
</output>
