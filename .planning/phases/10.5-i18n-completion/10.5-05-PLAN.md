---
phase: 10.5-i18n-completion
plan: 05
type: execute
wave: 3
depends_on: ["10.5-02"]
files_modified:
  - src/components/settings/language-settings.tsx
  - src/app/dashboard/settings/profile/page.tsx
  - src/locales/en/settings.json
  - src/locales/nl/settings.json
autonomous: true

must_haves:
  truths:
    - "User can change language preference from profile settings"
    - "Language change persists to database"
    - "Interface updates to new language after saving preference"
  artifacts:
    - path: "src/components/settings/language-settings.tsx"
      provides: "Language preference UI component"
      exports: ["LanguageSettings"]
  key_links:
    - from: "src/components/settings/language-settings.tsx"
      to: "profiles.preferred_language"
      via: "Supabase update"
      pattern: "update.*preferred_language"
---

<objective>
Add language preference settings UI to user profile settings.

Purpose: Allow users to explicitly choose their preferred language (Dutch or English) from their profile settings page. This preference is saved to the database and takes priority over cookie/browser detection.

Output:
- LanguageSettings component for profile settings
- Integration into existing profile settings page
- Translation keys for language settings UI
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10.5-i18n-completion/10.5-CONTEXT.md
@.planning/phases/10.5-i18n-completion/10.5-RESEARCH.md

Reference existing settings components:
@src/app/dashboard/settings/profile/page.tsx
@src/locales/en/settings.json
@src/locales/nl/settings.json
@src/components/providers/translation-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LanguageSettings component</name>
  <files>src/components/settings/language-settings.tsx</files>
  <action>
Create src/components/settings/language-settings.tsx - a client component for changing language preference.

```typescript
'use client'

import { useState } from 'react'
import { useTranslations, useLocale, useSetLocale } from '@/components/providers/translation-provider'
import { createClient } from '@/lib/supabase/client'
import { locales, localeNames, localeFlags, type Locale } from '@/../i18n.config'

interface LanguageSettingsProps {
  userId: string
  currentPreference: Locale | null
}

export function LanguageSettings({ userId, currentPreference }: LanguageSettingsProps) {
  const t = useTranslations('settings')
  const currentLocale = useLocale()
  const setLocale = useSetLocale()

  const [selectedLocale, setSelectedLocale] = useState<Locale>(
    currentPreference || currentLocale
  )
  const [isSaving, setIsSaving] = useState(false)
  const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle')

  const handleSave = async () => {
    setIsSaving(true)
    setSaveStatus('idle')

    try {
      const supabase = createClient()

      const { error } = await supabase
        .from('profiles')
        .update({ preferred_language: selectedLocale })
        .eq('id', userId)

      if (error) throw error

      setSaveStatus('success')

      // Update the UI locale if changed
      if (selectedLocale !== currentLocale) {
        // Small delay to show success message before reload
        setTimeout(() => {
          setLocale(selectedLocale)
        }, 500)
      }
    } catch (error) {
      console.error('Failed to save language preference:', error)
      setSaveStatus('error')
    } finally {
      setIsSaving(false)
    }
  }

  const hasChanges = selectedLocale !== (currentPreference || currentLocale)

  return (
    <div className="space-y-4">
      <div>
        <h3 className="text-lg font-medium text-gray-900">
          {t('language.title', 'Language Preference')}
        </h3>
        <p className="text-sm text-gray-500">
          {t('language.description', 'Choose your preferred language for the interface.')}
        </p>
      </div>

      <div className="grid gap-3">
        {locales.map((locale) => (
          <label
            key={locale}
            className={`
              flex items-center p-4 border rounded-lg cursor-pointer transition-colors
              ${selectedLocale === locale
                ? 'border-blue-500 bg-blue-50'
                : 'border-gray-200 hover:border-gray-300'
              }
            `}
          >
            <input
              type="radio"
              name="language"
              value={locale}
              checked={selectedLocale === locale}
              onChange={(e) => setSelectedLocale(e.target.value as Locale)}
              className="sr-only"
            />
            <span className="text-2xl mr-3">{localeFlags[locale]}</span>
            <div className="flex-1">
              <span className="font-medium text-gray-900">
                {localeNames[locale]}
              </span>
              <span className="block text-sm text-gray-500">
                {locale === 'nl' ? 'Nederlands' : 'English'}
              </span>
            </div>
            {selectedLocale === locale && (
              <svg
                className="h-5 w-5 text-blue-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fillRule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clipRule="evenodd"
                />
              </svg>
            )}
          </label>
        ))}
      </div>

      {/* Save button and status */}
      <div className="flex items-center gap-4">
        <button
          onClick={handleSave}
          disabled={!hasChanges || isSaving}
          className={`
            px-4 py-2 rounded-md font-medium transition-colors
            ${hasChanges && !isSaving
              ? 'bg-blue-600 text-white hover:bg-blue-700'
              : 'bg-gray-100 text-gray-400 cursor-not-allowed'
            }
          `}
        >
          {isSaving
            ? t('language.saving', 'Saving...')
            : t('language.save', 'Save Preference')
          }
        </button>

        {saveStatus === 'success' && (
          <span className="text-sm text-green-600">
            {t('language.saved', 'Language preference saved!')}
          </span>
        )}

        {saveStatus === 'error' && (
          <span className="text-sm text-red-600">
            {t('language.error', 'Failed to save. Please try again.')}
          </span>
        )}
      </div>

      <p className="text-xs text-gray-400">
        {t('language.note', 'The page will reload to apply your new language preference.')}
      </p>
    </div>
  )
}
```

Key features:
- Radio buttons for language selection with flags
- Saves to database on click
- Shows visual feedback (saving, success, error)
- Reloads page to apply new language
- Uses translation keys with fallbacks
  </action>
  <verify>
1. File exists at src/components/settings/language-settings.tsx
2. `npm run type-check` passes
3. Component exports LanguageSettings
  </verify>
  <done>LanguageSettings component created with locale selection and database save</done>
</task>

<task type="auto">
  <name>Task 2: Add language translations to settings files</name>
  <files>src/locales/en/settings.json, src/locales/nl/settings.json</files>
  <action>
Add language settings translations to both settings.json files.

**For src/locales/en/settings.json:**
Add a "language" section to the existing JSON (merge with existing content):

```json
{
  "language": {
    "title": "Language Preference",
    "description": "Choose your preferred language for the ADSapp interface.",
    "save": "Save Preference",
    "saving": "Saving...",
    "saved": "Language preference saved!",
    "error": "Failed to save. Please try again.",
    "note": "The page will reload to apply your new language preference."
  }
}
```

**For src/locales/nl/settings.json:**
Add Dutch translations:

```json
{
  "language": {
    "title": "Taalvoorkeur",
    "description": "Kies je voorkeurstaal voor de ADSapp interface.",
    "save": "Voorkeur Opslaan",
    "saving": "Opslaan...",
    "saved": "Taalvoorkeur opgeslagen!",
    "error": "Opslaan mislukt. Probeer het opnieuw.",
    "note": "De pagina wordt opnieuw geladen om je nieuwe taalvoorkeur toe te passen."
  }
}
```

Important: Read the existing settings.json files first and ADD these keys - don't replace the entire file. Use the Edit tool to add the language section.
  </action>
  <verify>
1. Both settings.json files contain "language" section
2. JSON is valid in both files
3. Keys match between EN and NL
  </verify>
  <done>Language settings translations added to both EN and NL settings.json</done>
</task>

<task type="auto">
  <name>Task 3: Integrate LanguageSettings into profile page</name>
  <files>src/app/dashboard/settings/profile/page.tsx</files>
  <action>
Add the LanguageSettings component to the existing profile settings page.

**Step 1: Add import at top of file**
```typescript
import { LanguageSettings } from '@/components/settings/language-settings'
```

**Step 2: Update profile data query to include preferred_language**
Find the Supabase query that fetches profile data (likely `.from('profiles').select(...)`) and ensure preferred_language is included:
```typescript
// If using .select('*'), preferred_language is already included
// If using specific fields, add preferred_language:
.select('id, full_name, email, avatar_url, preferred_language')
```

**Step 3: Add LanguageSettings component to the JSX**
Find the main content area (after other settings sections like name, email, avatar) and add:
```typescript
{/* Language Settings Section */}
<div className="border-t border-gray-200 pt-6 mt-6">
  <LanguageSettings
    userId={profile.id}
    currentPreference={profile.preferred_language as 'nl' | 'en' | null}
  />
</div>
```

Place this after existing settings sections but before any footer/save buttons.

**Step 4: Verify profile data has correct type**
If TypeScript complains about preferred_language, ensure the profile type includes:
```typescript
preferred_language?: string | null
```
  </action>
  <verify>
1. `grep -n "LanguageSettings" src/app/dashboard/settings/profile/page.tsx` shows import and usage
2. `grep -n "preferred_language" src/app/dashboard/settings/profile/page.tsx` shows field is queried
3. `npm run type-check` passes
4. `npm run lint` passes
  </verify>
  <done>LanguageSettings integrated into profile settings page with userId and currentPreference props</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript:**
   - `npm run type-check` passes

2. **Functional verification (manual):**
   - Navigate to /dashboard/settings/profile
   - Should see language selection section
   - Select a different language
   - Click save
   - Page should reload in new language

3. **Persistence:**
   - After changing language, refresh page
   - Language should stay the same (from database, not just cookie)

4. **Code quality:**
   - `npm run lint` passes
</verification>

<success_criteria>
1. LanguageSettings component renders language options
2. Saving preference updates database
3. Language change is reflected in UI after save
4. Translations exist for both EN and NL
</success_criteria>

<output>
After completion, create `.planning/phases/10.5-i18n-completion/10.5-05-SUMMARY.md`
</output>
