---
phase: 10.5-i18n-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/onboarding/layout.tsx
  - supabase/migrations/20260128_add_preferred_language.sql
  - src/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Onboarding pages display translated text instead of translation keys"
    - "Users have preferred_language column in profiles table"
    - "preferred_language accepts only 'nl' or 'en' values"
  artifacts:
    - path: "src/app/onboarding/layout.tsx"
      provides: "TranslationProvider wrapping for onboarding flow"
      exports: ["default"]
    - path: "supabase/migrations/20260128_add_preferred_language.sql"
      provides: "Database schema for language preference"
      contains: "preferred_language"
  key_links:
    - from: "src/app/onboarding/layout.tsx"
      to: "src/components/providers/translation-provider.tsx"
      via: "TranslationProvider import"
      pattern: "TranslationProvider.*locale.*translations"
---

<objective>
Fix the TranslationProvider gap for onboarding pages and add database schema for user language preferences.

Purpose: This resolves the "ik zie de sleutels" (I see the keys) bug where onboarding pages show translation keys instead of translated text. Also establishes database storage for persistent language preferences.

Output:
- Onboarding layout.tsx wrapping children with TranslationProvider
- Database migration adding preferred_language column to profiles table
- Updated TypeScript types
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.5-i18n-completion/10.5-CONTEXT.md
@.planning/phases/10.5-i18n-completion/10.5-RESEARCH.md

Reference existing patterns:
@src/app/dashboard/layout.tsx (TranslationProvider pattern)
@src/app/auth/layout.tsx (TranslationProvider pattern)
@src/components/providers/translation-provider.tsx
@src/lib/i18n/server.ts
@src/lib/i18n/dictionaries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding layout with TranslationProvider</name>
  <files>src/app/onboarding/layout.tsx</files>
  <action>
Create a new layout file for the onboarding route that wraps children with TranslationProvider. Follow the exact pattern from auth/layout.tsx:

1. Import TranslationProvider from '@/components/providers/translation-provider'
2. Import getServerLocale from '@/lib/i18n/server'
3. Import getDictionary from '@/lib/i18n/dictionaries'
4. Create async function OnboardingLayout
5. Get locale via await getServerLocale()
6. Get translations via await getDictionary(locale)
7. Return children wrapped in TranslationProvider with locale and translations props

This is a server component - no 'use client' directive needed.
  </action>
  <verify>
1. File exists at src/app/onboarding/layout.tsx
2. TypeScript compilation: `npm run type-check` passes
3. Grep for TranslationProvider in the file: should find it
  </verify>
  <done>Onboarding layout wraps children with TranslationProvider, identical pattern to auth/layout.tsx</done>
</task>

<task type="auto">
  <name>Task 2: Create database migration for preferred_language</name>
  <files>supabase/migrations/20260128_add_preferred_language.sql</files>
  <action>
Create a migration file that adds the preferred_language column to the profiles table:

```sql
-- Migration: Add preferred_language column to profiles
-- Purpose: Store user's language preference (nl or en)
-- Part of Phase 10.5: i18n Completion

-- Add column with constraint (nullable - null means use cookie/browser fallback)
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS preferred_language TEXT
  CHECK (preferred_language IS NULL OR preferred_language IN ('nl', 'en'));

-- Add comment for documentation
COMMENT ON COLUMN profiles.preferred_language IS
  'User preferred language (nl/en). NULL means use cookie/browser detection as fallback.';

-- Index for efficient lookups (optional but recommended)
CREATE INDEX IF NOT EXISTS idx_profiles_preferred_language
  ON profiles(preferred_language)
  WHERE preferred_language IS NOT NULL;
```

Key decisions:
- Column is nullable (NULL = use existing cookie/browser detection)
- Constraint limits values to 'nl' or 'en' only
- Partial index only indexes non-null values for efficiency
  </action>
  <verify>
1. File exists at supabase/migrations/20260128_add_preferred_language.sql
2. SQL syntax is valid (no syntax errors)
3. Contains CHECK constraint for 'nl' and 'en'
  </verify>
  <done>Migration file created with preferred_language column, CHECK constraint, and index</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript database types</name>
  <files>src/types/database.ts</files>
  <action>
Add the preferred_language field to the profiles table type definition.

Find the `profiles` table definition in the Tables interface (likely under `public` schema) and add:

```typescript
preferred_language: string | null  // 'nl' | 'en' | null
```

To both:
1. The Row type (for reading)
2. The Insert type (for creating) - as optional
3. The Update type (for updating) - as optional

Search for `profiles:` in the database.ts file and add the field to all three type definitions (Row, Insert, Update).

Note: The actual type is `'nl' | 'en' | null` but database.ts typically uses `string | null` for TEXT columns. The constraint is enforced at database level.
  </action>
  <verify>
1. `npm run type-check` passes
2. Grep for 'preferred_language' in src/types/database.ts shows it exists
  </verify>
  <done>TypeScript types updated to include preferred_language field in profiles table</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TranslationProvider coverage:**
   - Run dev server: `npm run dev`
   - Navigate to /onboarding (after login)
   - Should see translated text, NOT translation keys like "onboarding.title"

2. **TypeScript:**
   - `npm run type-check` passes with no errors

3. **Code quality:**
   - `npm run lint` passes

4. **Files exist:**
   - src/app/onboarding/layout.tsx exists
   - supabase/migrations/20260128_add_preferred_language.sql exists
</verification>

<success_criteria>
1. Onboarding layout.tsx exists and wraps with TranslationProvider
2. Migration file creates preferred_language column with proper constraints
3. TypeScript types include preferred_language field
4. All type checking and linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/10.5-i18n-completion/10.5-01-SUMMARY.md`
</output>
