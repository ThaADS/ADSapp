---
phase: 10.5-i18n-completion
plan: 02
type: execute
wave: 2
depends_on: ["10.5-01"]
files_modified:
  - src/lib/i18n/server.ts
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "Logged-in users see interface in their database-stored language preference"
    - "Language preference persists across sessions without relying on cookies"
    - "Users without database preference fall back to cookie/browser detection"
  artifacts:
    - path: "src/lib/i18n/server.ts"
      provides: "Server-side locale detection with database priority"
      exports: ["getServerLocale", "getServerLocaleWithUser"]
    - path: "middleware.ts"
      provides: "Middleware locale detection with database check"
  key_links:
    - from: "src/lib/i18n/server.ts"
      to: "profiles.preferred_language"
      via: "Supabase query"
      pattern: "preferred_language"
    - from: "middleware.ts"
      to: "profiles.preferred_language"
      via: "Supabase query for authenticated users"
      pattern: "preferred_language"
---

<objective>
Update locale detection to prioritize database-stored language preferences for authenticated users.

Purpose: Implement the language priority chain (DB > Cookie > Browser) so users' language preferences persist reliably across sessions and devices.

Output:
- Updated server.ts with database preference lookup
- Updated middleware.ts with database check for authenticated users
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10.5-i18n-completion/10.5-CONTEXT.md
@.planning/phases/10.5-i18n-completion/10.5-RESEARCH.md
@.planning/phases/10.5-i18n-completion/10.5-01-SUMMARY.md

Reference files to modify:
@src/lib/i18n/server.ts
@middleware.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database preference lookup to server.ts</name>
  <files>src/lib/i18n/server.ts</files>
  <action>
Update src/lib/i18n/server.ts to add a new function that checks database preference for authenticated users.

Add a new exported function `getServerLocaleWithUser` that:

1. Takes an optional userId parameter
2. If userId is provided:
   - Query profiles table for preferred_language where id = userId
   - If found and valid ('nl' or 'en'), return it
3. Fall back to existing getServerLocale() logic (cookie > header > default)

```typescript
/**
 * Get locale with database priority for authenticated users
 * Priority: 1. Database (preferred_language) 2. Cookie 3. Header 4. Default
 */
export async function getServerLocaleWithUser(userId?: string): Promise<Locale> {
  // If we have a user ID, check database first
  if (userId) {
    try {
      const { createClient } = await import('@/lib/supabase/server')
      const supabase = await createClient()

      const { data: profile } = await supabase
        .from('profiles')
        .select('preferred_language')
        .eq('id', userId)
        .single()

      if (profile?.preferred_language && locales.includes(profile.preferred_language as Locale)) {
        return profile.preferred_language as Locale
      }
    } catch (error) {
      // Database lookup failed, fall back to cookie/header
      console.warn('Failed to get language preference from database:', error)
    }
  }

  // Fall back to existing logic
  return getServerLocale()
}
```

Keep the existing getServerLocale() function unchanged for backward compatibility.
  </action>
  <verify>
1. `npm run type-check` passes
2. New function getServerLocaleWithUser is exported
3. Function handles both with and without userId
  </verify>
  <done>server.ts has getServerLocaleWithUser function that checks database preference first</done>
</task>

<task type="auto">
  <name>Task 2: Update middleware for database preference</name>
  <files>middleware.ts</files>
  <action>
Update middleware.ts to check database preference for authenticated users.

Modify the locale detection logic in the middleware function:

1. After the session is refreshed and we have a user (`user.data.user`), query their preferred_language
2. If preferred_language exists and is valid, use it
3. Otherwise, fall back to existing cookie/browser detection

The key change is in the locale detection section (around line 140-158). Update it to:

```typescript
// Detect and set locale (safe, non-blocking)
try {
  let locale: Locale = getLocale(request) // Default to existing cookie/browser logic

  // For authenticated users, check database preference first
  const { data: { user } } = await supabase.auth.getUser()

  if (user) {
    try {
      const { data: profile } = await supabase
        .from('profiles')
        .select('preferred_language')
        .eq('id', user.id)
        .single()

      if (profile?.preferred_language && isValidLocale(profile.preferred_language)) {
        locale = profile.preferred_language as Locale
      }
    } catch (profileError) {
      // Profile lookup failed, use cookie/browser fallback
      console.warn('Profile locale lookup failed:', profileError)
    }
  }

  // Set locale cookie (always, to keep it in sync with DB preference)
  sessionResponse.cookies.set(LOCALE_COOKIE, locale, {
    path: '/',
    maxAge: 60 * 60 * 24 * 365, // 1 year
    sameSite: 'lax',
  })

  // Add locale header for server components to access
  sessionResponse.headers.set('x-locale', locale)
} catch (localeError) {
  // Locale detection failed, continue without it
  console.warn('Locale detection failed:', localeError)
}
```

Important: The middleware already has access to supabase client from the session handler. Reuse that client for the profile lookup to avoid creating a new connection.

Note: We're setting the cookie even for DB-preference users to keep cookie in sync - this helps with edge cases and SSR.
  </action>
  <verify>
1. `npm run type-check` passes
2. Middleware queries profiles table for authenticated users
3. Falls back gracefully if database query fails
  </verify>
  <done>Middleware checks database preference for authenticated users before cookie/browser</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript:**
   - `npm run type-check` passes

2. **Functional verification (manual):**
   - Log in as user
   - Set preferred_language in database via Supabase dashboard
   - Refresh page
   - Interface should display in the database-set language
   - Clear cookies and refresh - still uses database language (not browser)

3. **Fallback verification:**
   - New user without preferred_language uses cookie/browser detection
   - Anonymous users use cookie/browser detection
</verification>

<success_criteria>
1. getServerLocaleWithUser function exists and works
2. Middleware queries database for authenticated users
3. Language priority order is correctly implemented: DB > Cookie > Browser
4. TypeScript passes, no runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/10.5-i18n-completion/10.5-02-SUMMARY.md`
</output>
