# Plan 25-03: Re-enable Deferred Tests

**Phase:** 25 - Database Types & Technical Debt
**Plan:** 03 of 04
**Wave:** 2 (Parallel with 25-02)
**Date:** 2026-02-03

## Objective

Move all 24 deferred test files from `tests/_deferred/` back to their proper locations and fix any type/mock issues.

## Prerequisites

- Plan 25-01 complete (fresh database types)
- Understanding of Jest mocking patterns

## Success Criteria

1. All 24 deferred tests moved to active test directories
2. All tests pass without type errors
3. No tests skipped or disabled
4. CI pipeline runs all tests

## Current State

```bash
# List deferred tests
ls tests/_deferred/
# Expected: 24 files
```

## Tasks

### Task 1: Inventory Deferred Tests

Categorize tests by failure reason:
- **Type errors**: Tests failing due to database type drift
- **Mock issues**: Tests failing due to missing/outdated mocks
- **Dependency issues**: Tests failing due to missing dependencies

### Task 2: Fix Test Infrastructure

Update test setup files:
- `jest.config.js` - Ensure paths are correct
- `tests/setup.ts` - Update mock configurations
- `tests/fixtures/` - Update test data to match new types

### Task 3: Move and Fix Tests

For each test file:
1. Move from `tests/_deferred/` to proper location
2. Update imports for new type structure
3. Fix mock implementations
4. Run test in isolation: `npm test -- <file>`
5. Verify pass

### Task 4: Update CI Configuration

Ensure CI runs all tests:
- Remove any exclusion patterns for `_deferred/`
- Update test coverage thresholds

## Files to Move

| Source | Destination | Category |
|--------|-------------|----------|
| `tests/_deferred/unit/*.test.ts` | `tests/unit/` | Unit tests |
| `tests/_deferred/integration/*.test.ts` | `tests/integration/` | Integration tests |
| `tests/_deferred/components/*.test.tsx` | `tests/components/` | Component tests |

## Common Test Fixes

### Fix 1: Supabase Mock Updates
```typescript
// Before
jest.mock('@/lib/supabase/server', () => ({
  createClient: () => mockSupabase
}))

// After
jest.mock('@/lib/supabase/server', () => ({
  createClient: async () => mockSupabase
}))
```

### Fix 2: Type-safe Mock Data
```typescript
// Before
const mockOrg = { id: '123', name: 'Test' }

// After
import { Database } from '@/types/database'
type Organization = Database['public']['Tables']['organizations']['Row']
const mockOrg: Partial<Organization> = {
  id: '123-uuid',
  name: 'Test',
  // ... other required fields
}
```

### Fix 3: Async/Await in Tests
```typescript
// Before
it('should fetch data', () => {
  const result = getData()
  expect(result).toBeDefined()
})

// After
it('should fetch data', async () => {
  const result = await getData()
  expect(result).toBeDefined()
})
```

## Validation

```bash
# Run all tests
npm run test

# Check no tests are skipped
npm run test -- --testPathIgnorePatterns=[]

# Verify coverage includes moved tests
npm run test:coverage
```

## Test Categories

### Unit Tests (Priority 1)
- `encryption.test.ts` - Security utilities
- `validation.test.ts` - Input validation
- `channels/*.test.ts` - Channel adapters

### Integration Tests (Priority 2)
- `api/*.test.ts` - API route tests
- `auth/*.test.ts` - Authentication flows

### Component Tests (Priority 3)
- `inbox/*.test.tsx` - Inbox components
- `settings/*.test.tsx` - Settings components

## Estimated Effort

- Duration: 2-4 hours
- Complexity: Medium
- Risk: Low (tests only)

## Dependencies

- Plan 25-01 (database types)

## Notes

- Some tests may need complete rewrites if mock patterns changed significantly
- Focus on getting tests passing, not perfect coverage
- Document any tests that are genuinely obsolete (features removed)
