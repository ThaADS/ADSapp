# Plan 22-01: Database Schema for Twilio Templates

## Objective
Create database schema for storing and caching Twilio WhatsApp message templates.

## Requirements Addressed
- **TWWT-01**: View Twilio Content API templates (storage layer)

## Files to Create

### 1. `supabase/migrations/20260203_twilio_whatsapp_templates.sql`

```sql
/**
 * Twilio WhatsApp Templates Schema
 * Purpose: Store and cache Twilio Content API templates
 * Date: 2026-02-03
 */

-- =============================================================================
-- Twilio WhatsApp Templates Table
-- =============================================================================

CREATE TABLE IF NOT EXISTS twilio_whatsapp_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  connection_id UUID NOT NULL REFERENCES twilio_whatsapp_connections(id) ON DELETE CASCADE,

  -- Twilio Content API fields
  content_sid TEXT NOT NULL,           -- Twilio Content SID (HXxxxxxxx)
  friendly_name TEXT NOT NULL,
  language TEXT NOT NULL DEFAULT 'en',

  -- Template content
  template_type TEXT NOT NULL,         -- twilio/text, twilio/media, twilio/quick-reply, etc.
  body TEXT,                           -- Template body text
  variables JSONB DEFAULT '[]'::jsonb, -- Array of variable names/positions

  -- Media (if applicable)
  media_url TEXT,
  media_type TEXT,

  -- Quick replies / buttons (if applicable)
  actions JSONB DEFAULT '[]'::jsonb,

  -- Status
  approval_status TEXT DEFAULT 'approved', -- approved, pending, rejected

  -- Sync tracking
  last_synced_at TIMESTAMPTZ DEFAULT now(),
  raw_response JSONB,                  -- Full Twilio API response for debugging

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- Unique constraint: one template per content_sid per connection
  UNIQUE(connection_id, content_sid)
);

-- =============================================================================
-- Indexes
-- =============================================================================

-- Fast lookup by organization
CREATE INDEX idx_twilio_whatsapp_templates_org
  ON twilio_whatsapp_templates(organization_id);

-- Fast lookup by connection
CREATE INDEX idx_twilio_whatsapp_templates_connection
  ON twilio_whatsapp_templates(connection_id);

-- Search by friendly name
CREATE INDEX idx_twilio_whatsapp_templates_name
  ON twilio_whatsapp_templates(friendly_name);

-- Filter by language
CREATE INDEX idx_twilio_whatsapp_templates_language
  ON twilio_whatsapp_templates(language);

-- Filter by type
CREATE INDEX idx_twilio_whatsapp_templates_type
  ON twilio_whatsapp_templates(template_type);

-- =============================================================================
-- RLS Policies
-- =============================================================================

ALTER TABLE twilio_whatsapp_templates ENABLE ROW LEVEL SECURITY;

-- Users can view templates for their organization
CREATE POLICY "Users can view own org templates"
  ON twilio_whatsapp_templates FOR SELECT
  USING (
    organization_id IN (
      SELECT organization_id FROM profiles WHERE id = auth.uid()
    )
  );

-- Only admins/owners can manage templates (sync operations)
CREATE POLICY "Admins can manage templates"
  ON twilio_whatsapp_templates FOR ALL
  USING (
    organization_id IN (
      SELECT organization_id FROM profiles
      WHERE id = auth.uid() AND role IN ('owner', 'admin')
    )
  );

-- =============================================================================
-- Triggers
-- =============================================================================

-- Auto-update updated_at timestamp
CREATE TRIGGER update_twilio_whatsapp_templates_updated_at
  BEFORE UPDATE ON twilio_whatsapp_templates
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- Template Send Log (for analytics)
-- =============================================================================

CREATE TABLE IF NOT EXISTS twilio_whatsapp_template_sends (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  template_id UUID NOT NULL REFERENCES twilio_whatsapp_templates(id) ON DELETE CASCADE,
  message_id UUID REFERENCES messages(id) ON DELETE SET NULL,
  conversation_id UUID REFERENCES conversations(id) ON DELETE SET NULL,
  contact_id UUID REFERENCES contacts(id) ON DELETE SET NULL,

  -- Variable values used
  variables_used JSONB DEFAULT '{}'::jsonb,

  -- Result
  twilio_message_sid TEXT,
  status TEXT DEFAULT 'pending', -- pending, sent, delivered, failed
  error_code TEXT,
  error_message TEXT,

  -- Timestamps
  sent_at TIMESTAMPTZ DEFAULT now(),
  delivered_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT now()
);

-- Index for analytics queries
CREATE INDEX idx_twilio_template_sends_org
  ON twilio_whatsapp_template_sends(organization_id);

CREATE INDEX idx_twilio_template_sends_template
  ON twilio_whatsapp_template_sends(template_id);

CREATE INDEX idx_twilio_template_sends_sent_at
  ON twilio_whatsapp_template_sends(sent_at);

-- RLS for template sends
ALTER TABLE twilio_whatsapp_template_sends ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own org template sends"
  ON twilio_whatsapp_template_sends FOR SELECT
  USING (
    organization_id IN (
      SELECT organization_id FROM profiles WHERE id = auth.uid()
    )
  );

CREATE POLICY "Users can insert template sends"
  ON twilio_whatsapp_template_sends FOR INSERT
  WITH CHECK (
    organization_id IN (
      SELECT organization_id FROM profiles WHERE id = auth.uid()
    )
  );
```

### 2. Update `src/types/twilio-whatsapp.ts`

Add template types:

```typescript
// =============================================================================
// Template Types
// =============================================================================

export interface TwilioWhatsAppTemplate {
  id: string
  organizationId: string
  connectionId: string
  contentSid: string
  friendlyName: string
  language: string
  templateType: TwilioTemplateType
  body: string | null
  variables: TwilioTemplateVariable[]
  mediaUrl: string | null
  mediaType: string | null
  actions: TwilioTemplateAction[]
  approvalStatus: 'approved' | 'pending' | 'rejected'
  lastSyncedAt: Date
  createdAt: Date
  updatedAt: Date
}

export type TwilioTemplateType =
  | 'twilio/text'
  | 'twilio/media'
  | 'twilio/quick-reply'
  | 'twilio/call-to-action'
  | 'twilio/list-picker'
  | 'twilio/card'

export interface TwilioTemplateVariable {
  key: string        // e.g., "1", "2", "3"
  name?: string      // Optional friendly name
  defaultValue?: string
}

export interface TwilioTemplateAction {
  type: 'QUICK_REPLY' | 'URL' | 'PHONE_NUMBER'
  title: string
  url?: string
  phoneNumber?: string
}

export interface TwilioTemplateSend {
  id: string
  organizationId: string
  templateId: string
  messageId: string | null
  conversationId: string | null
  contactId: string | null
  variablesUsed: Record<string, string>
  twilioMessageSid: string | null
  status: 'pending' | 'sent' | 'delivered' | 'failed'
  errorCode: string | null
  errorMessage: string | null
  sentAt: Date
  deliveredAt: Date | null
  createdAt: Date
}

// Database row types
export interface TwilioWhatsAppTemplateRow {
  id: string
  organization_id: string
  connection_id: string
  content_sid: string
  friendly_name: string
  language: string
  template_type: string
  body: string | null
  variables: TwilioTemplateVariable[]
  media_url: string | null
  media_type: string | null
  actions: TwilioTemplateAction[]
  approval_status: string
  last_synced_at: string
  raw_response: unknown
  created_at: string
  updated_at: string
}

export interface TwilioTemplateSendRow {
  id: string
  organization_id: string
  template_id: string
  message_id: string | null
  conversation_id: string | null
  contact_id: string | null
  variables_used: Record<string, string>
  twilio_message_sid: string | null
  status: string
  error_code: string | null
  error_message: string | null
  sent_at: string
  delivered_at: string | null
  created_at: string
}

// Content API response types
export interface TwilioContentApiTemplate {
  sid: string
  account_sid: string
  friendly_name: string
  language: string
  variables: Record<string, string>
  types: Record<string, TwilioContentType>
  url: string
  date_created: string
  date_updated: string
}

export interface TwilioContentType {
  body?: string
  media?: string[]
  actions?: TwilioContentAction[]
}

export interface TwilioContentAction {
  type: string
  title: string
  url?: string
  phone?: string
}
```

## Verification

1. Run migration: `npx supabase db push`
2. Verify tables created in Supabase dashboard
3. Check RLS policies are active
4. TypeScript types compile without errors

## Dependencies

- Plan 21-01 (twilio_whatsapp_connections table must exist)
- Existing organizations, messages, conversations, contacts tables

## Success Criteria

- [ ] twilio_whatsapp_templates table created with all columns
- [ ] twilio_whatsapp_template_sends table created for analytics
- [ ] RLS policies enforce organization isolation
- [ ] Indexes created for performance
- [ ] TypeScript types defined for templates
