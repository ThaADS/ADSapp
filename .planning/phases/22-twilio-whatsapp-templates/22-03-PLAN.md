# Plan 22-03: Template Messaging API

## Objective
Create API routes for template management and sending template messages with variable substitution.

## Requirements Addressed
- **TWWT-01**: View Twilio Content API templates (list endpoint)
- **TWWT-02**: Send template messages (send endpoint)
- **TWWT-03**: Auto-populate template variables (variable mapping)

## Files to Create

### 1. `src/app/api/integrations/twilio-whatsapp/templates/route.ts`

```typescript
/**
 * Twilio WhatsApp Templates API
 * Purpose: List and manage templates
 * Date: 2026-02-03
 */

import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import {
  getTemplatesForOrganization,
  syncTwilioTemplates,
} from '@/lib/integrations/twilio-whatsapp/template-sync'

/**
 * GET /api/integrations/twilio-whatsapp/templates
 * List all templates for the organization
 */
export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient()

    // Verify authentication
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Get user's organization
    const { data: profile } = await supabase
      .from('profiles')
      .select('organization_id')
      .eq('id', user.id)
      .single()

    if (!profile) {
      return NextResponse.json({ error: 'Profile not found' }, { status: 404 })
    }

    // Get templates
    const templates = await getTemplatesForOrganization(profile.organization_id)

    // Get sync status
    const { data: connection } = await supabase
      .from('twilio_whatsapp_connections')
      .select('id, last_verified_at')
      .eq('organization_id', profile.organization_id)
      .eq('is_active', true)
      .single()

    return NextResponse.json({
      templates,
      syncStatus: connection
        ? {
            connectionId: connection.id,
            lastSyncedAt: connection.last_verified_at,
          }
        : null,
    })
  } catch (error) {
    console.error('Templates list error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

/**
 * POST /api/integrations/twilio-whatsapp/templates
 * Trigger template sync
 */
export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient()

    // Verify authentication
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Get user's organization and verify admin role
    const { data: profile } = await supabase
      .from('profiles')
      .select('organization_id, role')
      .eq('id', user.id)
      .single()

    if (!profile) {
      return NextResponse.json({ error: 'Profile not found' }, { status: 404 })
    }

    if (!['owner', 'admin'].includes(profile.role)) {
      return NextResponse.json(
        { error: 'Insufficient permissions' },
        { status: 403 }
      )
    }

    // Get active connection
    const { data: connection } = await supabase
      .from('twilio_whatsapp_connections')
      .select('id')
      .eq('organization_id', profile.organization_id)
      .eq('is_active', true)
      .single()

    if (!connection) {
      return NextResponse.json(
        { error: 'No active Twilio WhatsApp connection found' },
        { status: 404 }
      )
    }

    // Sync templates
    const result = await syncTwilioTemplates(connection.id)

    if (!result.success) {
      return NextResponse.json(
        { error: result.error || 'Sync failed' },
        { status: 400 }
      )
    }

    return NextResponse.json({
      success: true,
      synced: result.synced,
      added: result.added,
      updated: result.updated,
      removed: result.removed,
    })
  } catch (error) {
    console.error('Templates sync error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

### 2. `src/app/api/integrations/twilio-whatsapp/templates/send/route.ts`

```typescript
/**
 * Twilio WhatsApp Template Send API
 * Purpose: Send template messages with variable substitution
 * Date: 2026-02-03
 */

import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { createServiceRoleClient } from '@/lib/supabase/server'
import { QueryValidators } from '@/lib/supabase/server'
import { getTwilioWhatsAppClient } from '@/lib/integrations/twilio-whatsapp/client'
import { getTemplateById } from '@/lib/integrations/twilio-whatsapp/template-sync'

// Variable mapping from contact fields
const VARIABLE_MAPPING: Record<string, string> = {
  '1': 'name',
  '2': 'phone_number',
  '3': 'email',
  name: 'name',
  phone: 'phone_number',
  email: 'email',
}

/**
 * POST /api/integrations/twilio-whatsapp/templates/send
 * Send a template message to a contact
 */
export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient()

    // Verify authentication
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Get user's organization
    const { data: profile } = await supabase
      .from('profiles')
      .select('organization_id')
      .eq('id', user.id)
      .single()

    if (!profile) {
      return NextResponse.json({ error: 'Profile not found' }, { status: 404 })
    }

    // Parse request body
    const body = await request.json()
    const { templateId, contactId, conversationId, customVariables } = body

    // Validate inputs
    if (!templateId) {
      return NextResponse.json(
        { error: 'Template ID is required' },
        { status: 400 }
      )
    }

    const templateValidation = QueryValidators.uuid(templateId)
    if (!templateValidation.isValid) {
      return NextResponse.json(
        { error: 'Invalid template ID' },
        { status: 400 }
      )
    }

    if (!contactId && !conversationId) {
      return NextResponse.json(
        { error: 'Either contactId or conversationId is required' },
        { status: 400 }
      )
    }

    // Get template
    const template = await getTemplateById(templateId, profile.organization_id)
    if (!template) {
      return NextResponse.json(
        { error: 'Template not found' },
        { status: 404 }
      )
    }

    // Get contact (either directly or via conversation)
    let contact
    let conversation

    if (conversationId) {
      const convValidation = QueryValidators.uuid(conversationId)
      if (!convValidation.isValid) {
        return NextResponse.json(
          { error: 'Invalid conversation ID' },
          { status: 400 }
        )
      }

      const { data: conv } = await supabase
        .from('conversations')
        .select('id, contact_id, contacts(id, name, phone_number, whatsapp_id, email, custom_fields)')
        .eq('id', conversationId)
        .eq('organization_id', profile.organization_id)
        .single()

      if (!conv) {
        return NextResponse.json(
          { error: 'Conversation not found' },
          { status: 404 }
        )
      }

      conversation = conv
      contact = conv.contacts
    } else {
      const contactValidation = QueryValidators.uuid(contactId)
      if (!contactValidation.isValid) {
        return NextResponse.json(
          { error: 'Invalid contact ID' },
          { status: 400 }
        )
      }

      const { data: c } = await supabase
        .from('contacts')
        .select('id, name, phone_number, whatsapp_id, email, custom_fields')
        .eq('id', contactId)
        .eq('organization_id', profile.organization_id)
        .single()

      if (!c) {
        return NextResponse.json(
          { error: 'Contact not found' },
          { status: 404 }
        )
      }

      contact = c
    }

    // Get phone number
    const phoneNumber = contact.whatsapp_id || contact.phone_number
    if (!phoneNumber) {
      return NextResponse.json(
        { error: 'Contact has no WhatsApp number' },
        { status: 400 }
      )
    }

    // Build content variables from template variables + contact data
    const contentVariables: Record<string, string> = {}

    for (const variable of template.variables) {
      const key = variable.key

      // Check custom variables first
      if (customVariables && customVariables[key]) {
        contentVariables[key] = customVariables[key]
        continue
      }

      // Map to contact field
      const fieldName = VARIABLE_MAPPING[key] || variable.name
      if (fieldName && contact[fieldName]) {
        contentVariables[key] = contact[fieldName]
      } else if (contact.custom_fields && contact.custom_fields[fieldName]) {
        contentVariables[key] = contact.custom_fields[fieldName]
      } else if (variable.defaultValue) {
        contentVariables[key] = variable.defaultValue
      }
    }

    // Get Twilio client and send
    const client = await getTwilioWhatsAppClient(profile.organization_id)
    const result = await client.sendTemplateMessage(
      phoneNumber,
      template.contentSid,
      contentVariables
    )

    if (!result.sid) {
      return NextResponse.json(
        {
          error: result.errorMessage || 'Failed to send template message',
          errorCode: result.errorCode,
        },
        { status: 400 }
      )
    }

    // Record the send in template_sends table
    const serviceSupabase = createServiceRoleClient()

    // Create or get conversation if needed
    let finalConversationId = conversation?.id

    if (!finalConversationId) {
      // Check for existing conversation
      const { data: existingConv } = await serviceSupabase
        .from('conversations')
        .select('id')
        .eq('organization_id', profile.organization_id)
        .eq('contact_id', contact.id)
        .eq('channel', 'twilio_whatsapp')
        .single()

      if (existingConv) {
        finalConversationId = existingConv.id
      } else {
        // Create new conversation
        const { data: newConv } = await serviceSupabase
          .from('conversations')
          .insert({
            organization_id: profile.organization_id,
            contact_id: contact.id,
            channel: 'twilio_whatsapp',
            status: 'open',
            last_message_at: new Date().toISOString(),
          })
          .select('id')
          .single()

        finalConversationId = newConv?.id
      }
    }

    // Create message record
    const { data: message } = await serviceSupabase
      .from('messages')
      .insert({
        conversation_id: finalConversationId,
        organization_id: profile.organization_id,
        channel: 'twilio_whatsapp',
        channel_message_id: result.sid,
        direction: 'outbound',
        content: template.body || `[Template: ${template.friendlyName}]`,
        content_type: 'template',
        sender_type: 'user',
        sender_id: user.id,
        status: 'sent',
        metadata: {
          template_id: template.id,
          template_name: template.friendlyName,
          content_sid: template.contentSid,
          variables: contentVariables,
        },
      })
      .select('id')
      .single()

    // Record template send
    await serviceSupabase.from('twilio_whatsapp_template_sends').insert({
      organization_id: profile.organization_id,
      template_id: template.id,
      message_id: message?.id,
      conversation_id: finalConversationId,
      contact_id: contact.id,
      variables_used: contentVariables,
      twilio_message_sid: result.sid,
      status: 'sent',
    })

    // Update conversation last_message_at
    if (finalConversationId) {
      await serviceSupabase
        .from('conversations')
        .update({ last_message_at: new Date().toISOString() })
        .eq('id', finalConversationId)
    }

    return NextResponse.json({
      success: true,
      messageSid: result.sid,
      messageId: message?.id,
      conversationId: finalConversationId,
      variablesUsed: contentVariables,
    })
  } catch (error) {
    console.error('Template send error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

### 3. `src/app/api/integrations/twilio-whatsapp/templates/[id]/route.ts`

```typescript
/**
 * Twilio WhatsApp Single Template API
 * Purpose: Get template details and preview
 * Date: 2026-02-03
 */

import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { QueryValidators } from '@/lib/supabase/server'
import { getTemplateById } from '@/lib/integrations/twilio-whatsapp/template-sync'

/**
 * GET /api/integrations/twilio-whatsapp/templates/[id]
 * Get a single template with preview
 */
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params
    const supabase = await createClient()

    // Verify authentication
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Validate template ID
    const validation = QueryValidators.uuid(id)
    if (!validation.isValid) {
      return NextResponse.json(
        { error: 'Invalid template ID' },
        { status: 400 }
      )
    }

    // Get user's organization
    const { data: profile } = await supabase
      .from('profiles')
      .select('organization_id')
      .eq('id', user.id)
      .single()

    if (!profile) {
      return NextResponse.json({ error: 'Profile not found' }, { status: 404 })
    }

    // Get template
    const template = await getTemplateById(id, profile.organization_id)

    if (!template) {
      return NextResponse.json(
        { error: 'Template not found' },
        { status: 404 }
      )
    }

    // Generate preview with placeholder variables
    let preview = template.body || ''
    for (const variable of template.variables) {
      const placeholder = `{{${variable.key}}}`
      const displayName = variable.name || `Variable ${variable.key}`
      preview = preview.replace(placeholder, `[${displayName}]`)
    }

    return NextResponse.json({
      template,
      preview,
    })
  } catch (error) {
    console.error('Template get error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

## Verification

1. Test GET /api/integrations/twilio-whatsapp/templates returns template list
2. Test POST /api/integrations/twilio-whatsapp/templates triggers sync
3. Test POST /api/integrations/twilio-whatsapp/templates/send with:
   - Valid template and contact
   - Variable substitution from contact fields
   - Custom variables override
4. Test GET /api/integrations/twilio-whatsapp/templates/[id] returns preview

## Dependencies

- Plan 22-01 (database schema)
- Plan 22-02 (template sync service)
- Plan 21-02 (Twilio client with sendTemplateMessage)
- Existing conversations, messages, contacts tables

## Success Criteria

- [ ] Templates list endpoint returns all org templates
- [ ] Sync endpoint triggers template refresh from Twilio
- [ ] Send endpoint delivers template message via Twilio
- [ ] Variables auto-populated from contact data
- [ ] Custom variables can override auto-populated values
- [ ] Message recorded in messages table with template metadata
- [ ] Template send logged in template_sends table
- [ ] Single template endpoint returns preview with placeholders
