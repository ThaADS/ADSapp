---
phase: 10-zapier-integration
plan: 05
type: execute
wave: 1
depends_on: ["10-01", "10-02", "10-03"]
files_modified:
  - src/app/api/integrations/zapier/actions/send-message/route.ts
  - src/app/api/integrations/zapier/actions/contacts/route.ts
  - src/app/api/integrations/zapier/actions/contacts/[id]/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Zapier can send WhatsApp messages via action endpoint"
    - "Zapier can create contacts via action endpoint"
    - "Zapier can update contacts via action endpoint"
    - "All action endpoints are rate limited and authenticated"
  artifacts:
    - path: "src/app/api/integrations/zapier/actions/send-message/route.ts"
      provides: "Send message action for Zapier"
      exports: ["POST"]
    - path: "src/app/api/integrations/zapier/actions/contacts/route.ts"
      provides: "Create contact action for Zapier"
      exports: ["POST"]
    - path: "src/app/api/integrations/zapier/actions/contacts/[id]/route.ts"
      provides: "Update contact action for Zapier"
      exports: ["PUT"]
  key_links:
    - from: "send-message/route.ts"
      to: "WhatsAppService"
      via: "sendMessage call"
      pattern: "WhatsAppService.*sendMessage|whatsapp.*send"
    - from: "contacts/route.ts"
      to: "contacts table"
      via: "supabase insert"
      pattern: "supabase.*contacts.*insert"
    - from: "contacts/[id]/route.ts"
      to: "contacts table"
      via: "supabase update"
      pattern: "supabase.*contacts.*update"
---

<objective>
Implement Zapier action endpoints for sending messages and managing contacts

Purpose: Enable Zapier to perform actions in ADSapp - send WhatsApp messages, create contacts, and update contacts. This closes Gap 2 from VERIFICATION.md (ZAP-04, ZAP-05).

Output:
- Send message action (POST /api/integrations/zapier/actions/send-message)
- Create contact action (POST /api/integrations/zapier/actions/contacts)
- Update contact action (PUT /api/integrations/zapier/actions/contacts/{id})
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-zapier-integration/10-01-SUMMARY.md
@.planning/phases/10-zapier-integration/10-02-SUMMARY.md
@.planning/phases/10-zapier-integration/10-03-SUMMARY.md

# Key existing files to reference
@src/lib/integrations/zapier/middleware.ts
@src/lib/integrations/zapier/index.ts
@src/types/zapier.ts
@src/lib/whatsapp/service.ts
@src/app/api/contacts/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Send Message Action Endpoint</name>
  <files>
    src/app/api/integrations/zapier/actions/send-message/route.ts
  </files>
  <action>
Create POST /api/integrations/zapier/actions/send-message endpoint:

1. Use withZapierMiddleware() wrapper with:
   - rateLimitType: 'actions' (100 req/min)
   - requiredScopes: ['messages:write']

2. Parse request body matching SendMessageRequest from src/types/zapier.ts:
   ```typescript
   interface SendMessageRequest {
     to: string              // Phone number (E.164 format)
     channel?: 'whatsapp'    // Currently only WhatsApp supported
     message?: {
       type: 'text'
       text: string
     }
     template?: {
       name: string
       language: string
       components?: Array<{ type: string; parameters: Array<{ type: string; text?: string }> }>
     }
   }
   ```

3. Validate inputs:
   - `to` is required and must be valid phone format
   - Either `message` or `template` must be provided (not both)
   - If message, text is required and non-empty
   - If template, name and language are required

4. Find or create contact and conversation:
   ```typescript
   const supabase = createServiceRoleClient()

   // Normalize phone to E.164
   const normalizedPhone = normalizePhoneNumber(body.to)

   // Find existing contact
   let { data: contact } = await supabase
     .from('contacts')
     .select('id, whatsapp_id')
     .eq('organization_id', context.organizationId)
     .eq('phone_number', normalizedPhone)
     .single()

   // Create contact if not exists
   if (!contact) {
     const { data: newContact } = await supabase
       .from('contacts')
       .insert({
         organization_id: context.organizationId,
         name: normalizedPhone,  // Use phone as placeholder name
         phone_number: normalizedPhone,
         whatsapp_id: normalizedPhone.replace('+', '')
       })
       .select()
       .single()
     contact = newContact
   }

   // Find or create conversation
   let { data: conversation } = await supabase
     .from('conversations')
     .select('id')
     .eq('contact_id', contact.id)
     .eq('channel', 'whatsapp')
     .single()

   if (!conversation) {
     const { data: newConversation } = await supabase
       .from('conversations')
       .insert({
         organization_id: context.organizationId,
         contact_id: contact.id,
         channel: 'whatsapp',
         status: 'open'
       })
       .select()
       .single()
     conversation = newConversation
   }
   ```

5. Send message via WhatsAppService:
   ```typescript
   import { WhatsAppService } from '@/lib/whatsapp/service'

   const whatsappService = await WhatsAppService.createFromOrganization(
     context.organizationId,
     supabase
   )

   let messageType: 'text' | 'template' = 'text'
   let content: string

   if (body.message) {
     messageType = 'text'
     content = body.message.text
   } else if (body.template) {
     messageType = 'template'
     content = JSON.stringify(body.template)
   }

   const message = await whatsappService.sendMessage(
     conversation.id,
     content,
     context.userId,  // System user ID
     messageType
   )
   ```

6. Return SendMessageResponse:
   ```typescript
   {
     success: true,
     message_id: message.id,
     status: message.status,
     sent_at: message.created_at
   }
   ```

7. Error handling - return ZapierActionError format:
   ```typescript
   if (error) {
     return Response.json({
       success: false,
       error: {
         code: 'INTERNAL_ERROR',
         message: error.message
       }
     }, { status: 500 })
   }
   ```

Phone number normalization helper:
```typescript
function normalizePhoneNumber(phone: string): string {
  // Remove all non-digit characters except leading +
  let normalized = phone.replace(/[^\d+]/g, '')

  // Ensure starts with +
  if (!normalized.startsWith('+')) {
    normalized = '+' + normalized
  }

  return normalized
}
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/app/api/integrations/zapier/actions/send-message/route.ts
```
  </verify>
  <done>
- POST /api/integrations/zapier/actions/send-message sends WhatsApp messages
- Supports both text messages and template messages
- Auto-creates contact and conversation if not exists
- Uses withZapierMiddleware() for auth, rate limiting, and scope validation
- Returns standard Zapier action response format
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Contact Management Endpoints</name>
  <files>
    src/app/api/integrations/zapier/actions/contacts/route.ts
    src/app/api/integrations/zapier/actions/contacts/[id]/route.ts
  </files>
  <action>
Create POST /api/integrations/zapier/actions/contacts (create contact):

1. Use withZapierMiddleware() wrapper with:
   - rateLimitType: 'actions' (100 req/min)
   - requiredScopes: ['contacts:write']

2. Parse request body matching CreateContactRequest from src/types/zapier.ts:
   ```typescript
   interface CreateContactRequest {
     name: string
     phone: string
     email?: string
     tags?: string[]
     custom_fields?: Record<string, unknown>
   }
   ```

3. Validate inputs:
   - name is required and non-empty
   - phone is required and valid format
   - email (if provided) is valid format

4. Check for duplicate contact:
   ```typescript
   const supabase = createServiceRoleClient()
   const normalizedPhone = normalizePhoneNumber(body.phone)

   const { data: existing } = await supabase
     .from('contacts')
     .select('id')
     .eq('organization_id', context.organizationId)
     .eq('phone_number', normalizedPhone)
     .single()

   if (existing) {
     return Response.json({
       success: false,
       error: {
         code: 'INVALID_INPUT',
         message: 'Contact with this phone number already exists',
         field: 'phone'
       }
     }, { status: 400 })
   }
   ```

5. Create contact:
   ```typescript
   const { data: contact, error } = await supabase
     .from('contacts')
     .insert({
       organization_id: context.organizationId,
       name: body.name.trim(),
       phone_number: normalizedPhone,
       whatsapp_id: normalizedPhone.replace('+', ''),
       email: body.email?.trim(),
       tags: body.tags || [],
       custom_fields: body.custom_fields || {}
     })
     .select()
     .single()
   ```

6. Return CreateContactResponse:
   ```typescript
   {
     success: true,
     contact: {
       id: contact.id,
       name: contact.name,
       phone: contact.phone_number,
       email: contact.email,
       tags: contact.tags,
       custom_fields: contact.custom_fields,
       created_at: contact.created_at
     }
   }
   ```

---

Create PUT /api/integrations/zapier/actions/contacts/[id] (update contact):

1. Use withZapierMiddleware() wrapper with:
   - rateLimitType: 'actions' (100 req/min)
   - requiredScopes: ['contacts:write']

2. Extract contact ID from URL params

3. Parse request body matching UpdateContactRequest from src/types/zapier.ts:
   ```typescript
   interface UpdateContactRequest {
     name?: string
     email?: string
     tags?: string[]
     custom_fields?: Record<string, unknown>
   }
   ```

4. Verify contact exists and belongs to organization:
   ```typescript
   const supabase = createServiceRoleClient()

   const { data: contact } = await supabase
     .from('contacts')
     .select('*')
     .eq('id', contactId)
     .eq('organization_id', context.organizationId)
     .single()

   if (!contact) {
     return Response.json({
       success: false,
       error: {
         code: 'NOT_FOUND',
         message: 'Contact not found'
       }
     }, { status: 404 })
   }
   ```

5. Build update object (only include provided fields):
   ```typescript
   const updates: Record<string, unknown> = {}

   if (body.name !== undefined) updates.name = body.name.trim()
   if (body.email !== undefined) updates.email = body.email?.trim() || null
   if (body.tags !== undefined) updates.tags = body.tags
   if (body.custom_fields !== undefined) {
     // Merge custom fields instead of replacing
     updates.custom_fields = {
       ...(contact.custom_fields || {}),
       ...body.custom_fields
     }
   }

   if (Object.keys(updates).length === 0) {
     return Response.json({
       success: false,
       error: {
         code: 'INVALID_INPUT',
         message: 'No fields to update'
       }
     }, { status: 400 })
   }
   ```

6. Update contact:
   ```typescript
   const { data: updated, error } = await supabase
     .from('contacts')
     .update(updates)
     .eq('id', contactId)
     .select()
     .single()
   ```

7. Return UpdateContactResponse:
   ```typescript
   {
     success: true,
     contact: {
       id: updated.id,
       name: updated.name,
       phone: updated.phone_number,
       email: updated.email,
       tags: updated.tags,
       custom_fields: updated.custom_fields,
       updated_at: updated.updated_at
     }
   }
   ```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/app/api/integrations/zapier/actions/contacts/route.ts
npx tsc --noEmit src/app/api/integrations/zapier/actions/contacts/[id]/route.ts
```
  </verify>
  <done>
- POST /api/integrations/zapier/actions/contacts creates new contacts
- PUT /api/integrations/zapier/actions/contacts/{id} updates existing contacts
- Duplicate phone number check on create
- Organization isolation enforced
- Custom fields merged on update (not replaced)
- All endpoints use withZapierMiddleware() for auth and rate limiting
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compilation:
```bash
npx tsc --noEmit
```

2. Check file structure exists:
```bash
ls -la src/app/api/integrations/zapier/actions/
ls -la src/app/api/integrations/zapier/actions/contacts/
```

3. Verify endpoint handlers are exported:
```bash
grep -l "export async function POST" src/app/api/integrations/zapier/actions/*/route.ts
grep -l "export async function PUT" src/app/api/integrations/zapier/actions/contacts/*/route.ts
```
</verification>

<success_criteria>
1. POST /api/integrations/zapier/actions/send-message sends WhatsApp messages (text or template)
2. POST /api/integrations/zapier/actions/contacts creates contacts with validation
3. PUT /api/integrations/zapier/actions/contacts/{id} updates contacts
4. All endpoints use withZapierMiddleware() with appropriate scopes
5. Error responses follow ZapierActionError format
6. All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-zapier-integration/10-05-SUMMARY.md`
</output>
