---
phase: 10-zapier-integration
plan: 06
type: execute
wave: 2
depends_on: ["10-04", "10-05"]
files_modified:
  - zapier-app/index.js
  - zapier-app/package.json
  - zapier-app/authentication.js
  - zapier-app/triggers/new_message.js
  - zapier-app/triggers/new_contact.js
  - zapier-app/creates/send_message.js
  - zapier-app/creates/create_contact.js
  - zapier-app/creates/update_contact.js
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Zapier CLI project structure exists for ADSapp"
    - "OAuth authentication is configured for Zapier app"
    - "Triggers are defined for new messages and new contacts"
    - "Actions are defined for sending messages and managing contacts"
  artifacts:
    - path: "zapier-app/index.js"
      provides: "Zapier app entry point with triggers and actions"
      min_lines: 50
    - path: "zapier-app/authentication.js"
      provides: "OAuth 2.0 configuration for Zapier"
      min_lines: 30
    - path: "zapier-app/triggers/new_message.js"
      provides: "New message trigger definition"
      min_lines: 40
    - path: "zapier-app/creates/send_message.js"
      provides: "Send message action definition"
      min_lines: 40
  key_links:
    - from: "authentication.js"
      to: "/api/integrations/zapier/authorize"
      via: "authorizeUrl"
      pattern: "authorizeUrl.*zapier/authorize"
    - from: "triggers/new_message.js"
      to: "/api/integrations/zapier/hooks/subscribe"
      via: "subscribeHook"
      pattern: "subscribe.*hooks/subscribe"
    - from: "creates/send_message.js"
      to: "/api/integrations/zapier/actions/send-message"
      via: "perform"
      pattern: "perform.*actions/send-message"
---

<objective>
Create Zapier CLI app definition with OAuth authentication, triggers, and actions

Purpose: Define the ADSapp integration for Zapier Developer Platform so users can find and use ADSapp in the Zapier app directory. This closes Gap 3 from VERIFICATION.md (ZAP-05).

Output:
- Zapier CLI project structure (zapier-app/)
- OAuth 2.0 authentication configuration
- Trigger definitions (new message, new contact)
- Action definitions (send message, create/update contact)
- Pre-built Zap template ideas

Note: This plan requires manual Zapier Developer Platform registration. The code artifacts prepare the app for deployment.
</objective>

<execution_context>
@C:\Users\info\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\info\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-zapier-integration/10-04-PLAN.md
@.planning/phases/10-zapier-integration/10-05-PLAN.md

# Key existing files to reference
@src/types/zapier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zapier CLI Project Structure</name>
  <files>
    zapier-app/package.json
    zapier-app/.zapierapprc
    zapier-app/index.js
    zapier-app/authentication.js
  </files>
  <action>
Create the Zapier CLI project structure at the project root level (not inside src/).

Create zapier-app/package.json:
```json
{
  "name": "adsapp-zapier",
  "version": "1.0.0",
  "description": "ADSapp - WhatsApp Business Inbox integration for Zapier",
  "main": "index.js",
  "scripts": {
    "test": "zapier test",
    "push": "zapier push",
    "validate": "zapier validate"
  },
  "engines": {
    "node": ">=18",
    "npm": ">=8"
  },
  "dependencies": {
    "zapier-platform-core": "^15.0.0"
  },
  "devDependencies": {
    "zapier-platform-cli": "^15.0.0"
  }
}
```

Create zapier-app/.zapierapprc:
```json
{
  "id": 0,
  "key": "App0"
}
```
Note: The id and key are placeholders - they get updated when you run `zapier register` on Zapier Developer Platform.

Create zapier-app/authentication.js:
```javascript
/**
 * ADSapp OAuth 2.0 Authentication for Zapier
 *
 * Uses Authorization Code Grant with PKCE
 */

const BASE_URL = process.env.ADSAPP_API_URL || 'https://app.adsapp.com'

const authentication = {
  type: 'oauth2',
  connectionLabel: '{{organization_name}}',

  oauth2Config: {
    // Authorization URL - user is redirected here to grant access
    authorizeUrl: {
      url: `${BASE_URL}/api/integrations/zapier/authorize`,
      params: {
        client_id: '{{process.env.CLIENT_ID}}',
        redirect_uri: '{{bundle.inputData.redirect_uri}}',
        response_type: 'code',
        scope: 'messages:read messages:write contacts:read contacts:write triggers:read triggers:write',
        state: '{{bundle.inputData.state}}'
      }
    },

    // Token exchange URL - exchange authorization code for access token
    getAccessToken: {
      url: `${BASE_URL}/api/integrations/zapier/token`,
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: {
        grant_type: 'authorization_code',
        code: '{{bundle.inputData.code}}',
        client_id: '{{process.env.CLIENT_ID}}',
        client_secret: '{{process.env.CLIENT_SECRET}}',
        redirect_uri: '{{bundle.inputData.redirect_uri}}'
      }
    },

    // Refresh token URL - get new access token using refresh token
    refreshAccessToken: {
      url: `${BASE_URL}/api/integrations/zapier/token`,
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: {
        grant_type: 'refresh_token',
        refresh_token: '{{bundle.authData.refresh_token}}',
        client_id: '{{process.env.CLIENT_ID}}',
        client_secret: '{{process.env.CLIENT_SECRET}}'
      }
    },

    // Scopes requested
    scope: 'messages:read messages:write contacts:read contacts:write triggers:read triggers:write',

    // Enable automatic token refresh
    autoRefresh: true
  },

  // Test the connection by getting the current user
  test: {
    url: `${BASE_URL}/api/integrations/zapier/me`,
    method: 'GET'
  }
}

module.exports = authentication
```

Create zapier-app/index.js:
```javascript
/**
 * ADSapp Zapier Integration
 *
 * WhatsApp Business Inbox integration for Zapier
 * Enables workflow automation with triggers and actions
 */

const authentication = require('./authentication')
const newMessage = require('./triggers/new_message')
const newContact = require('./triggers/new_contact')
const sendMessage = require('./creates/send_message')
const createContact = require('./creates/create_contact')
const updateContact = require('./creates/update_contact')

module.exports = {
  version: require('./package.json').version,
  platformVersion: require('zapier-platform-core').version,

  authentication,

  // Before each request, add the Authorization header
  beforeRequest: [
    (request, z, bundle) => {
      if (bundle.authData && bundle.authData.access_token) {
        request.headers.Authorization = `Bearer ${bundle.authData.access_token}`
      }
      return request
    }
  ],

  // After each response, check for 401 and trigger token refresh
  afterResponse: [
    (response, z, bundle) => {
      if (response.status === 401) {
        throw new z.errors.RefreshAuthError('Session expired')
      }
      return response
    }
  ],

  // Triggers - events that start Zaps
  triggers: {
    [newMessage.key]: newMessage,
    [newContact.key]: newContact
  },

  // Creates - actions that create/modify data
  creates: {
    [sendMessage.key]: sendMessage,
    [createContact.key]: createContact,
    [updateContact.key]: updateContact
  },

  // Searches - find existing data
  searches: {},

  // Resources - combine related triggers, creates, and searches
  resources: {}
}
```
  </action>
  <verify>
Check files exist:
```bash
ls -la zapier-app/
cat zapier-app/package.json
```
  </verify>
  <done>
- Zapier CLI project structure created at zapier-app/
- package.json with Zapier platform dependencies
- OAuth 2.0 authentication pointing to ADSapp endpoints
- Main index.js wiring triggers and actions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Trigger and Action Definitions</name>
  <files>
    zapier-app/triggers/new_message.js
    zapier-app/triggers/new_contact.js
    zapier-app/creates/send_message.js
    zapier-app/creates/create_contact.js
    zapier-app/creates/update_contact.js
  </files>
  <action>
Create trigger and action module files.

Create zapier-app/triggers/new_message.js:
```javascript
/**
 * New Message Trigger
 *
 * Triggers when a new WhatsApp message is received
 */

const BASE_URL = process.env.ADSAPP_API_URL || 'https://app.adsapp.com'

const subscribeHook = async (z, bundle) => {
  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/hooks/subscribe`,
    method: 'POST',
    body: {
      event: 'message.received',
      hookUrl: bundle.targetUrl,
      filters: bundle.inputData.filters
    }
  })
  return response.data
}

const unsubscribeHook = async (z, bundle) => {
  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/hooks/${bundle.subscribeData.id}`,
    method: 'DELETE'
  })
  return response.data
}

const perform = async (z, bundle) => {
  // REST Hook - data comes from webhook payload
  return [bundle.cleanedRequest]
}

const performList = async (z, bundle) => {
  // Polling fallback - get recent messages
  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/triggers/messages`,
    params: { limit: 10 }
  })
  return response.data.messages || []
}

module.exports = {
  key: 'new_message',
  noun: 'Message',

  display: {
    label: 'New Message Received',
    description: 'Triggers when a new WhatsApp message is received from a contact.',
    important: true
  },

  operation: {
    type: 'hook',

    inputFields: [
      {
        key: 'filter_tags',
        type: 'string',
        label: 'Filter by Tags',
        helpText: 'Only trigger for contacts with these tags (comma-separated)',
        required: false
      }
    ],

    perform,
    performList,
    performSubscribe: subscribeHook,
    performUnsubscribe: unsubscribeHook,

    sample: {
      id: 'msg_123456',
      event: 'message.received',
      timestamp: '2026-01-25T12:00:00Z',
      data: {
        message_id: 'msg_123456',
        conversation_id: 'conv_789',
        contact: {
          id: 'contact_456',
          name: 'John Doe',
          phone: '+1234567890'
        },
        content: {
          type: 'text',
          text: 'Hello, I have a question about my order.'
        },
        channel: 'whatsapp',
        received_at: '2026-01-25T12:00:00Z'
      }
    },

    outputFields: [
      { key: 'id', label: 'Event ID', type: 'string' },
      { key: 'data__message_id', label: 'Message ID', type: 'string' },
      { key: 'data__contact__name', label: 'Contact Name', type: 'string' },
      { key: 'data__contact__phone', label: 'Contact Phone', type: 'string' },
      { key: 'data__content__text', label: 'Message Text', type: 'string' },
      { key: 'data__received_at', label: 'Received At', type: 'datetime' }
    ]
  }
}
```

Create zapier-app/triggers/new_contact.js:
```javascript
/**
 * New Contact Trigger
 *
 * Triggers when a new contact is created in ADSapp
 */

const BASE_URL = process.env.ADSAPP_API_URL || 'https://app.adsapp.com'

const subscribeHook = async (z, bundle) => {
  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/hooks/subscribe`,
    method: 'POST',
    body: {
      event: 'contact.created',
      hookUrl: bundle.targetUrl
    }
  })
  return response.data
}

const unsubscribeHook = async (z, bundle) => {
  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/hooks/${bundle.subscribeData.id}`,
    method: 'DELETE'
  })
  return response.data
}

const perform = async (z, bundle) => {
  return [bundle.cleanedRequest]
}

const performList = async (z, bundle) => {
  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/triggers/contacts`,
    params: { limit: 10 }
  })
  return response.data.contacts || []
}

module.exports = {
  key: 'new_contact',
  noun: 'Contact',

  display: {
    label: 'New Contact Created',
    description: 'Triggers when a new contact is created in your ADSapp inbox.'
  },

  operation: {
    type: 'hook',

    inputFields: [],

    perform,
    performList,
    performSubscribe: subscribeHook,
    performUnsubscribe: unsubscribeHook,

    sample: {
      id: 'evt_789',
      event: 'contact.created',
      timestamp: '2026-01-25T12:00:00Z',
      data: {
        contact_id: 'contact_456',
        name: 'Jane Smith',
        phone: '+1987654321',
        email: 'jane@example.com',
        tags: ['vip', 'returning'],
        created_at: '2026-01-25T12:00:00Z'
      }
    },

    outputFields: [
      { key: 'data__contact_id', label: 'Contact ID', type: 'string' },
      { key: 'data__name', label: 'Name', type: 'string' },
      { key: 'data__phone', label: 'Phone', type: 'string' },
      { key: 'data__email', label: 'Email', type: 'string' },
      { key: 'data__tags', label: 'Tags', type: 'string' },
      { key: 'data__created_at', label: 'Created At', type: 'datetime' }
    ]
  }
}
```

Create zapier-app/creates/send_message.js:
```javascript
/**
 * Send Message Action
 *
 * Sends a WhatsApp message to a contact
 */

const BASE_URL = process.env.ADSAPP_API_URL || 'https://app.adsapp.com'

const perform = async (z, bundle) => {
  const body = {
    to: bundle.inputData.phone,
    channel: 'whatsapp'
  }

  if (bundle.inputData.message_type === 'template') {
    body.template = {
      name: bundle.inputData.template_name,
      language: bundle.inputData.template_language || 'en'
    }
  } else {
    body.message = {
      type: 'text',
      text: bundle.inputData.message_text
    }
  }

  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/actions/send-message`,
    method: 'POST',
    body
  })

  return response.data
}

module.exports = {
  key: 'send_message',
  noun: 'Message',

  display: {
    label: 'Send WhatsApp Message',
    description: 'Sends a WhatsApp message to a contact.',
    important: true
  },

  operation: {
    inputFields: [
      {
        key: 'phone',
        type: 'string',
        label: 'Phone Number',
        helpText: 'Phone number in E.164 format (e.g., +1234567890)',
        required: true
      },
      {
        key: 'message_type',
        type: 'string',
        label: 'Message Type',
        choices: ['text', 'template'],
        default: 'text',
        required: true
      },
      {
        key: 'message_text',
        type: 'text',
        label: 'Message Text',
        helpText: 'The text message to send (required for text messages)',
        required: false
      },
      {
        key: 'template_name',
        type: 'string',
        label: 'Template Name',
        helpText: 'The approved template name (required for template messages)',
        required: false
      },
      {
        key: 'template_language',
        type: 'string',
        label: 'Template Language',
        helpText: 'Template language code (default: en)',
        default: 'en',
        required: false
      }
    ],

    perform,

    sample: {
      success: true,
      message_id: 'msg_123456',
      status: 'sent',
      sent_at: '2026-01-25T12:00:00Z'
    },

    outputFields: [
      { key: 'success', label: 'Success', type: 'boolean' },
      { key: 'message_id', label: 'Message ID', type: 'string' },
      { key: 'status', label: 'Status', type: 'string' },
      { key: 'sent_at', label: 'Sent At', type: 'datetime' }
    ]
  }
}
```

Create zapier-app/creates/create_contact.js:
```javascript
/**
 * Create Contact Action
 *
 * Creates a new contact in ADSapp
 */

const BASE_URL = process.env.ADSAPP_API_URL || 'https://app.adsapp.com'

const perform = async (z, bundle) => {
  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/actions/contacts`,
    method: 'POST',
    body: {
      name: bundle.inputData.name,
      phone: bundle.inputData.phone,
      email: bundle.inputData.email,
      tags: bundle.inputData.tags ? bundle.inputData.tags.split(',').map(t => t.trim()) : []
    }
  })

  return response.data
}

module.exports = {
  key: 'create_contact',
  noun: 'Contact',

  display: {
    label: 'Create Contact',
    description: 'Creates a new contact in your ADSapp inbox.'
  },

  operation: {
    inputFields: [
      {
        key: 'name',
        type: 'string',
        label: 'Name',
        helpText: 'Contact full name',
        required: true
      },
      {
        key: 'phone',
        type: 'string',
        label: 'Phone Number',
        helpText: 'Phone number in E.164 format (e.g., +1234567890)',
        required: true
      },
      {
        key: 'email',
        type: 'string',
        label: 'Email',
        helpText: 'Contact email address',
        required: false
      },
      {
        key: 'tags',
        type: 'string',
        label: 'Tags',
        helpText: 'Comma-separated tags to apply to the contact',
        required: false
      }
    ],

    perform,

    sample: {
      success: true,
      contact: {
        id: 'contact_456',
        name: 'John Doe',
        phone: '+1234567890',
        email: 'john@example.com',
        tags: ['lead', 'website'],
        created_at: '2026-01-25T12:00:00Z'
      }
    },

    outputFields: [
      { key: 'success', label: 'Success', type: 'boolean' },
      { key: 'contact__id', label: 'Contact ID', type: 'string' },
      { key: 'contact__name', label: 'Name', type: 'string' },
      { key: 'contact__phone', label: 'Phone', type: 'string' },
      { key: 'contact__email', label: 'Email', type: 'string' },
      { key: 'contact__tags', label: 'Tags', type: 'string' },
      { key: 'contact__created_at', label: 'Created At', type: 'datetime' }
    ]
  }
}
```

Create zapier-app/creates/update_contact.js:
```javascript
/**
 * Update Contact Action
 *
 * Updates an existing contact in ADSapp
 */

const BASE_URL = process.env.ADSAPP_API_URL || 'https://app.adsapp.com'

const perform = async (z, bundle) => {
  const body = {}

  if (bundle.inputData.name) body.name = bundle.inputData.name
  if (bundle.inputData.email) body.email = bundle.inputData.email
  if (bundle.inputData.tags) body.tags = bundle.inputData.tags.split(',').map(t => t.trim())

  const response = await z.request({
    url: `${BASE_URL}/api/integrations/zapier/actions/contacts/${bundle.inputData.contact_id}`,
    method: 'PUT',
    body
  })

  return response.data
}

module.exports = {
  key: 'update_contact',
  noun: 'Contact',

  display: {
    label: 'Update Contact',
    description: 'Updates an existing contact in your ADSapp inbox.'
  },

  operation: {
    inputFields: [
      {
        key: 'contact_id',
        type: 'string',
        label: 'Contact ID',
        helpText: 'The ID of the contact to update',
        required: true
      },
      {
        key: 'name',
        type: 'string',
        label: 'Name',
        helpText: 'New contact name',
        required: false
      },
      {
        key: 'email',
        type: 'string',
        label: 'Email',
        helpText: 'New email address',
        required: false
      },
      {
        key: 'tags',
        type: 'string',
        label: 'Tags',
        helpText: 'Comma-separated tags (replaces existing tags)',
        required: false
      }
    ],

    perform,

    sample: {
      success: true,
      contact: {
        id: 'contact_456',
        name: 'John Smith',
        phone: '+1234567890',
        email: 'john.smith@example.com',
        tags: ['vip', 'returning'],
        updated_at: '2026-01-25T12:30:00Z'
      }
    },

    outputFields: [
      { key: 'success', label: 'Success', type: 'boolean' },
      { key: 'contact__id', label: 'Contact ID', type: 'string' },
      { key: 'contact__name', label: 'Name', type: 'string' },
      { key: 'contact__phone', label: 'Phone', type: 'string' },
      { key: 'contact__email', label: 'Email', type: 'string' },
      { key: 'contact__tags', label: 'Tags', type: 'string' },
      { key: 'contact__updated_at', label: 'Updated At', type: 'datetime' }
    ]
  }
}
```
  </action>
  <verify>
Check files exist and are valid JavaScript:
```bash
ls -la zapier-app/triggers/
ls -la zapier-app/creates/
node -c zapier-app/triggers/new_message.js
node -c zapier-app/creates/send_message.js
```
  </verify>
  <done>
- Trigger definitions created: new_message, new_contact
- Action definitions created: send_message, create_contact, update_contact
- All modules export required Zapier schema
- REST Hook patterns implemented for triggers
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Register App on Zapier Developer Platform</name>
  <action>
Register the ADSapp integration on Zapier Developer Platform.

This step requires human action because:
1. Zapier Developer Platform requires a Zapier account
2. OAuth client credentials must be obtained from the Zapier console
3. The app must be manually registered and configured

After registering, update the following files with actual values:
1. zapier-app/.zapierapprc - Update `id` with the app ID from Zapier
2. Set environment variables: CLIENT_ID, CLIENT_SECRET, ADSAPP_API_URL

Note: This checkpoint can be deferred. The code artifacts (Tasks 1-2) are complete and can be deployed later.
  </action>
  <instructions>
1. Go to https://developer.zapier.com/
2. Click "Start a Zapier Integration"
3. Name: "ADSapp - WhatsApp Business Inbox"
4. Description: "Connect your WhatsApp Business inbox to 5000+ apps. Automate message sending, contact management, and more."
5. Category: "Customer Support", "Marketing Automation"
6. Logo: Upload ADSapp logo (512x512 PNG)

After creation:
1. Note the App ID and update zapier-app/.zapierapprc
2. Go to "Authentication" tab
   - Type: OAuth 2.0
   - Client ID: (copy this value)
   - Client Secret: (copy this value)
   - Authorization URL: https://app.adsapp.com/api/integrations/zapier/authorize
   - Access Token URL: https://app.adsapp.com/api/integrations/zapier/token
   - Scopes: messages:read messages:write contacts:read contacts:write triggers:read triggers:write

3. Deploy the app:
   ```bash
   cd zapier-app
   npm install
   zapier login
   zapier push
   ```

4. Test the integration in Zapier Editor
  </instructions>
  <resume-signal>
Type "registered" when app is registered on Zapier Developer Platform, or "deferred" to skip this step for now.
  </resume-signal>
</task>

</tasks>

<verification>
After completing Tasks 1-2:

1. Check Zapier app structure:
```bash
ls -la zapier-app/
ls -la zapier-app/triggers/
ls -la zapier-app/creates/
```

2. Validate JavaScript syntax:
```bash
node -c zapier-app/index.js
node -c zapier-app/authentication.js
```

3. If Zapier CLI is installed locally:
```bash
cd zapier-app && npm install && npm run validate
```
</verification>

<success_criteria>
1. Zapier CLI project structure exists at zapier-app/
2. OAuth 2.0 authentication configured pointing to ADSapp endpoints
3. Triggers defined: new_message, new_contact
4. Actions defined: send_message, create_contact, update_contact
5. All JavaScript files have valid syntax
6. (Optional) App registered on Zapier Developer Platform
</success_criteria>

<output>
After completion, create `.planning/phases/10-zapier-integration/10-06-SUMMARY.md`
</output>
