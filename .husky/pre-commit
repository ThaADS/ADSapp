#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ADSapp Pre-commit Hook
# Runs quality checks before allowing commits

echo "= Running pre-commit checks..."

# 1. TypeScript Type Checking
echo "=Ø TypeScript type checking..."
npm run type-check || {
    echo "L TypeScript type checking failed. Fix errors before committing."
    exit 1
}

# 2. ESLint on Staged Files
echo "=' Running ESLint on staged files..."
npx lint-staged || {
    echo "L ESLint failed. Fix linting errors before committing."
    exit 1
}

# 3. Prettier Format Check on Staged Files
echo "=… Checking code formatting..."
npx prettier --check $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|css|scss|md)$') || {
    echo "L Code formatting issues detected. Run 'npm run format' to fix."
    exit 1
}

# 4. Run Tests on Affected Files (optional, can be slow)
if [ "${SKIP_PRE_COMMIT_TESTS:-false}" != "true" ]; then
    echo ">ê Running tests on affected files..."
    npm run test -- --bail --findRelatedTests $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep -v '.test.ts' | grep -v '.spec.ts') || {
        echo "L Tests failed. Fix failing tests before committing."
        exit 1
    }
fi

# 5. Check for console.log statements (warning only)
CONSOLE_LOGS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -n 'console\.log' || true)
if [ -n "$CONSOLE_LOGS" ]; then
    echo "   Warning: console.log statements found:"
    echo "$CONSOLE_LOGS"
    echo "Consider removing them or using proper logging."
fi

# 6. Check for TODO comments in critical paths (warning only)
TODO_COMMENTS=$(git diff --cached --name-only --diff-filter=ACM | grep 'src/app/api' | xargs grep -n 'TODO' || true)
if [ -n "$TODO_COMMENTS" ]; then
    echo "   Warning: TODO comments found in API routes:"
    echo "$TODO_COMMENTS"
fi

# 7. Check for large files
MAX_FILE_SIZE=500000  # 500KB
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read file; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ "$size" -gt "$MAX_FILE_SIZE" ]; then
            echo "$file ($size bytes)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo "   Warning: Large files detected:"
    echo "$LARGE_FILES"
    echo "Consider if these files should be committed."
fi

echo " Pre-commit checks passed!"
